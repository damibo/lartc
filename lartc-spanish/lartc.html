Done.
YPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
>

<script type="text/javascript" src="/static/js/analytics.js" ></script>
<link type="text/css" rel="stylesheet" href="/static/css/banner-styles.css"/>



<TITLE
>Enrutamiento avanzado y control de tr√°fico en Linux</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"></HEAD
><BODY
CLASS="BOOK"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script> if (window.archive_analytics) { window.archive_analytics.values['server_name']="wwwb-app13.us.archive.org";}; </script>

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1420070399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/www.gulic.org\/comos\/LARTC\/lartc.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 475;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "11";
var displayMonth = "Jun";
var displayYear = "2004";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" lang="en" class="__wb_banner_div" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px">


<div id="wm-ipp-inside" class="__wb_banner_div" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://www.gulic.org/comos/LARTC/lartc.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20040611091246" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;width: inherit !important" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20040408020516/http://www.gulic.org/comos/LARTC/lartc.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="8 Apr 2004"><strong>APR</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 9:12:46 Jun 11, 2004">JUN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20040803165827/http://www.gulic.org/comos/LARTC/lartc.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="3 Aug 2004"><strong>AUG</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20040408020516/http://www.gulic.org/comos/LARTC/lartc.html" title="2:05:16 Apr 8, 2004" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 9:12:46 Jun 11, 2004">11</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20040803165827/http://www.gulic.org/comos/LARTC/lartc.html" title="16:58:27 Aug 3, 2004" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
                       2003
                       
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 9:12:46 Jun 11, 2004">2004</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20051119032849/http://www.gulic.org/comos/LARTC/lartc.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="19 Nov 2005"><strong>2005</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20040611091246*/http://www.gulic.org/comos/LARTC/lartc.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>21 captures</strong></a>
           <div class="__wb_banner_div" style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">8 Jan 04 - 28 May 10</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:475px;height:27px;" href="" id="wm-graph-anchor">
       <div class="__wb_banner_div" id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:475px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="475"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=475_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:5:110101011101_2005:-1:011000000010_2006:-1:000000000000_2007:-1:010000010001_2008:-1:010000011000_2009:-1:010001000010_2010:-1:000010000000_2011:-1:000000000000_2012:-1:000000000000_2013:-1:000000000000_2014:-1:000000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->
<DIV
CLASS="BOOK"
><A
NAME="LARTC"
></A
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>Enrutamiento avanzado y control de tr√°fico en Linux</A
></H1
><H3
CLASS="AUTHOR"
><A
NAME="AEN5"
></A
>Bert Hubert</H3
><DIV
CLASS="AFFILIATION"
><SPAN
CLASS="ORGNAME"
>Netherlabs BV<BR></SPAN
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:bert.hubert@netherlabs.nl"
>bert.hubert@netherlabs.nl</A
>&#62;</CODE
></P
></DIV
></DIV
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Thomas Graf (Section Author)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:tgraf%suug.ch"
>tgraf%suug.ch</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Gregory Maxwell (autor de secciones)</SPAN
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Remco van Mook (autor de secciones)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:remco@virtu.nl"
>remco@virtu.nl</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Martijn van Oosterhout (autor de secciones)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:kleptog@cupid.suninternet.com"
>kleptog@cupid.suninternet.com</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Paul B Schroeder (autor de secciones)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:paulsch@us.ibm.com"
>paulsch@us.ibm.com</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Jasper Spaans (autor de secciones)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:jasper@spaans.ds9a.nl"
>jasper@spaans.ds9a.nl</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Pedro Larroy (autor de secciones)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:piotr%member.fsf.org"
>piotr%member.fsf.org</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><SPAN
CLASS="COLLAB"
><SPAN
CLASS="COLLABNAME"
>Ricardo J. C√°rdenes (traductor al castellano)</SPAN
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:ricardo%conysis.com"
>ricardo%conysis.com</A
>&#62;</CODE
></P
></DIV
></DIV
><BR></SPAN
><DIV
><DIV
CLASS="ABSTRACT"
><P
></P
><A
NAME="AEN58"
></A
><P
>Una introducci√≥n bastante pr√°ctica a
     <SPAN
CLASS="APPLICATION"
>iproute2</SPAN
>, el control de tr√°fico y un poco
     de <SPAN
CLASS="APPLICATION"
>netfilter</SPAN
>.
     </P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Tabla de contenidos</B
></DT
><DT
>1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DEDICATION"
>Dedicatoria</A
></DT
><DT
>2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO"
>Introducci√≥n</A
></DT
><DD
><DL
><DT
>2.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.DISCLAIMER"
>Descargo de responsabilidad y licencia</A
></DT
><DT
>2.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.PRIOR"
>Conocimientos previos</A
></DT
><DT
>2.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.LINUX"
>Qu√© puede hacer Linux por usted</A
></DT
><DT
>2.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.HOUSKEEPING"
>Notas de mantenimiento</A
></DT
><DT
>2.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.CVS"
>Acceso, CVS y env√≠o de actualizaciones</A
></DT
><DT
>2.6. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.MLIST"
>Lista de correo</A
></DT
><DT
>2.7. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.INTRO.LAYOUT"
>Disposici√≥n de este documento</A
></DT
></DL
></DD
><DT
>3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPROUTE2"
>Introducci√≥n a iproute2</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPROUTE2.WHY"
>¬øPor qu√© iproute2?</A
></DT
><DT
>3.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPROUTE2.TOUR"
>revisi√≥n de iproute2</A
></DT
><DT
>3.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPROUTE2.PACKAGE"
>Prerequisitos</A
></DT
><DT
>3.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPROUTE2.EXPLORE"
>Explorar la configuraci√≥n actual</A
></DT
><DD
><DL
><DT
>3.4.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN207"
><B
CLASS="COMMAND"
>ip</B
> nos muestra nuestros enlaces</A
></DT
><DT
>3.4.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN216"
><B
CLASS="COMMAND"
>ip</B
> nos muestra nuestras direcciones IP</A
></DT
><DT
>3.4.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN226"
><B
CLASS="COMMAND"
>ip</B
> nos muestra nuestras rutas</A
></DT
></DL
></DD
><DT
>3.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPROUTE2.ARP"
>ARP</A
></DT
></DL
></DD
><DT
>4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.RPDB"
>Reglas (base de datos de normas de rutado)</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.RPDB.SIMPLE"
>Normas de encaminamiento por origen sencillas</A
></DT
><DT
>4.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.RPDB.MULTIPLE-LINKS"
>Encaminamiento con varios enlaces de salida/proveedores</A
></DT
><DD
><DL
><DT
>4.2.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN279"
>Acceso dividido</A
></DT
><DT
>4.2.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN309"
>Equilibrio de carga</A
></DT
></DL
></DD
></DL
></DD
><DT
>5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.TUNNEL"
>GRE y otros t√∫neles</A
></DT
><DD
><DL
><DT
>5.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.TUNNEL.REMARKS"
>Breve inciso sobre los t√∫neles:</A
></DT
><DT
>5.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.TUNNEL.IP-IP"
>T√∫neles IP sobre IP</A
></DT
><DT
>5.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.TUNNEL.GRE"
>T√∫neles GRE</A
></DT
><DD
><DL
><DT
>5.3.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN349"
>T√∫neles IPv4</A
></DT
><DT
>5.3.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN367"
>T√∫neles IPv6</A
></DT
></DL
></DD
><DT
>5.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.TUNNEL.USERLAND"
>T√∫neles en espacio de usuario</A
></DT
></DL
></DD
><DT
>6. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPV6-TUNNEL"
>T√∫neles IPv6 con Cisco o la 6bone</A
></DT
><DD
><DL
><DT
>6.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.TUNNEL-IPV6.ADDRESSING"
>T√∫neles IPv6</A
></DT
></DL
></DD
><DT
>7. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC"
>IPsec: IP segura sobre Internet</A
></DT
><DD
><DL
><DT
>7.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.INTRO"
>Introducci√≥n al intercambio manual de claves</A
></DT
><DT
>7.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.AUTOMATIC.KEYING"
>Intercambio autom√°tico de claves</A
></DT
><DD
><DL
><DT
>7.2.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.KEYING.THEORY"
>Teor√≠a</A
></DT
><DT
>7.2.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.AUTOMATIC.KEYING.EXAMPLE"
>Ejemplo</A
></DT
><DT
>7.2.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.X509"
>Uso de certificados X.509 para el intercambio autom√°tico de claves</A
></DT
></DL
></DD
><DT
>7.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.TUNNEL"
>T√∫neles con IPSEC</A
></DT
><DT
>7.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.OTHER"
>Otro software IPSEC</A
></DT
><DT
>7.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.INTEROP"
>Interoperaci√≥n de IPSEC con otros sistemas</A
></DT
><DD
><DL
><DT
>7.5.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.INTEROP.WIN32"
>Windows</A
></DT
></DL
></DD
></DL
></DD
><DT
>8. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.MULTICAST"
>Enrutado multicast</A
></DT
><DT
>9. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC"
>Disciplinas de colas (qdiscs) para gesti√≥n del ancho de banda</A
></DT
><DD
><DL
><DT
>9.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC.EXPLAIN"
>Las colas y disciplinas de cola explicadas</A
></DT
><DT
>9.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC.CLASSLESS"
>Disciplinas de cola simples, sin clases</A
></DT
><DD
><DL
><DT
>9.2.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN666"
>pfifo_fast</A
></DT
><DT
>9.2.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN700"
>Token Bucket Filter</A
></DT
><DT
>9.2.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.SFQ"
>Stochastic Fairness Queueing</A
></DT
></DL
></DD
><DT
>9.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC.ADVICE"
>Consejos sobre en qu√© momento usar qu√© cola</A
></DT
><DT
>9.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC.TERMINOLOGY"
>Terminolog√≠a</A
></DT
><DT
>9.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC.CLASSFUL"
>Disciplinas de cola con clases</A
></DT
><DD
><DL
><DT
>9.5.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN882"
>El flujo dentro de las qdisc con clases y sus clases</A
></DT
><DT
>9.5.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN888"
>La familia qdisc: ra√≠ces, controladores, hermanos y padres</A
></DT
><DT
>9.5.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN908"
>La qdisc PRIO</A
></DT
><DT
>9.5.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN944"
>La famosa qdisc CBQ</A
></DT
><DT
>9.5.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1077"
>Hierarchical Token Bucket</A
></DT
></DL
></DD
><DT
>9.6. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC.FILTERS"
>Clasificar paquetes con filtros</A
></DT
><DD
><DL
><DT
>9.6.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1105"
>Algunos ejemplos sencillos de filtrado</A
></DT
><DT
>9.6.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.FILTERING.SIMPLE"
>Todas las √≥rdenes de filtrado que necesitar√° normalmente</A
></DT
></DL
></DD
><DT
>9.7. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IMQ"
>El dispositivo intermedio de encolado (IMQ)</A
></DT
><DD
><DL
><DT
>9.7.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1156"
>Configuraci√≥n de ejemplo</A
></DT
></DL
></DD
></DL
></DD
><DT
>10. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.LOADSHARE"
>Compartir la carga sobre varias interfaces</A
></DT
><DD
><DL
><DT
>10.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.LOADSHARE.CAVEATS"
>Problemas</A
></DT
><DT
>10.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.LOADSHARE.OTHER"
>Otras posibilidades</A
></DT
></DL
></DD
><DT
>11. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.NETFILTER"
>Netfilter e iproute (marcado de paquetes)</A
></DT
><DT
>12. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-FILTER"
>Filtros avanzados para (re)clasificar paquetes</A
></DT
><DD
><DL
><DT
>12.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-FILTER.U32"
>El clasificador <VAR
CLASS="OPTION"
>u32</VAR
></A
></DT
><DD
><DL
><DT
>12.1.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1291"
>Selector U32</A
></DT
><DT
>12.1.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1305"
>Selectores generales</A
></DT
><DT
>12.1.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1332"
>Selectores espec√≠ficos</A
></DT
></DL
></DD
><DT
>12.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-FILTER.ROUTE"
>El clasificador <VAR
CLASS="OPTION"
>route</VAR
></A
></DT
><DT
>12.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-FILTER.POLICING"
>Filtros de control (Policing filters)</A
></DT
><DD
><DL
><DT
>12.3.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1376"
>Formas de control</A
></DT
><DT
>12.3.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1398"
>Acciones de sobrel√≠mite</A
></DT
><DT
>12.3.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1418"
>Ejemplos</A
></DT
></DL
></DD
><DT
>12.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-FILTER.HASHING"
>Filtros de hash para filtrado masivo muy r√°pido</A
></DT
><DT
>12.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-FILTER.IPV6"
>Filtrado de tr√°fico IPv6</A
></DT
><DD
><DL
><DT
>12.5.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1445"
>¬øC√≥mo es que no funcionan los filtros tc para IPv6?</A
></DT
><DT
>12.5.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1450"
>Marcar paquetes IPv6 usando ip6tables</A
></DT
><DT
>12.5.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1455"
>Usar el selector u32 para filtrar paquetes IPv6</A
></DT
></DL
></DD
></DL
></DD
><DT
>13. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.KERNEL"
>Par√°metros de red del n√∫cleo</A
></DT
><DD
><DL
><DT
>13.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.KERNEL.RPF"
>Reverse Path Filtering</A
></DT
><DT
>13.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.KERNEL.OBSCURE"
>Configuraciones oscuras</A
></DT
><DD
><DL
><DT
>13.2.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1491"
>ipv4 gen√©rica</A
></DT
><DT
>13.2.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1674"
>Configuraci√≥n por dispositivo</A
></DT
><DT
>13.2.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1731"
>Normas de vecinos (Neighbor policy)</A
></DT
><DT
>13.2.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1787"
>Configuraci√≥n de encaminamiento</A
></DT
></DL
></DD
></DL
></DD
><DT
>14. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC"
>Disciplinas de cola avanzadas y poco conocidas</A
></DT
><DD
><DL
><DT
>14.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.BFIFO-PFIFO"
><VAR
CLASS="LITERAL"
>bfifo</VAR
>/<VAR
CLASS="LITERAL"
>pfifo</VAR
></A
></DT
><DD
><DL
><DT
>14.1.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1870"
>Par√°metros y uso</A
></DT
></DL
></DD
><DT
>14.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.CSZ"
>Algoritmo Clark-Shenker-Zhang (CSZ)</A
></DT
><DT
>14.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.DSMARK"
>DSMARK</A
></DT
><DD
><DL
><DT
>14.3.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1911"
>Introducci√≥n</A
></DT
><DT
>14.3.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1916"
>¬øCon qu√© se relaciona Dsmark?</A
></DT
><DT
>14.3.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1920"
>Principios de los Servicios Diferenciados</A
></DT
><DT
>14.3.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1928"
>Trabajar con Dsmark</A
></DT
><DT
>14.3.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1944"
>C√≥mo trabaja SCH_DSMARK.</A
></DT
><DT
>14.3.6. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1961"
>Filtro TC_INDEX</A
></DT
></DL
></DD
><DT
>14.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.INGRESS"
>Qdisc de entrada (Ingress)</A
></DT
><DD
><DL
><DT
>14.4.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1987"
>Par√°metros y uso</A
></DT
></DL
></DD
><DT
>14.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.RED"
>Random Early Detection (RED)</A
></DT
><DT
>14.6. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.GRED"
>Generic Random Early Detection</A
></DT
><DT
>14.7. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.VC-ATM"
>Emulaci√≥n VC/ATM</A
></DT
><DT
>14.8. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC.WRR"
>Weighted Round Robin (WRR)</A
></DT
></DL
></DD
><DT
>15. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK"
>Recetario</A
></DT
><DD
><DL
><DT
>15.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.SLA"
>Llevar varios sitios con diferentes SLA<A
NAME="AEN2034"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#FTN.AEN2034"
><SPAN
CLASS="footnote"
>[5]</SPAN
></A
></A
></DT
><DT
>15.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.SYNFLOOD-PROTECT"
>Proteger la m√°quina frente a inundaciones SYN</A
></DT
><DT
>15.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.ICMP-RATELIMIT"
>Limitar la tasa de ICMP para prevenir dDoS</A
></DT
><DT
>15.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.INTERACTIVE-PRIO"
>Priorizado de tr√°fico interactivo</A
></DT
><DT
>15.5. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.SQUID"
>Cach√© transparente de web usando <SPAN
CLASS="APPLICATION"
>netfilter</SPAN
>,
	<SPAN
CLASS="APPLICATION"
>iproute2</SPAN
>, <SPAN
CLASS="APPLICATION"
>ipchains</SPAN
> y
	<SPAN
CLASS="APPLICATION"
>squid</SPAN
></A
></DT
><DD
><DL
><DT
>15.5.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2150"
>Diagrama de flujo del tr√°fico tras la implementaci√≥n</A
></DT
></DL
></DD
><DT
>15.6. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.MTU-DISCOVERY"
>Sortear los problemas de Path MTU Discovery con configuraciones de MTU por ruta</A
></DT
><DD
><DL
><DT
>15.6.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2165"
>Soluci√≥n</A
></DT
></DL
></DD
><DT
>15.7. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.MTU-MSS"
>Sortear los problemas de Path MTU Discovery con MSS Clamping
  (para usuarios de ADSL, cable, PPPoE y PPtP)</A
></DT
><DT
>15.8. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.ULTIMATE-TC"
>El acondicionador de tr√°fico definitivo: baja latencia, env√≠os y
descargas r√°pidos</A
></DT
><DD
><DL
><DT
>15.8.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2211"
>Por qu√© no funciona bien por defecto</A
></DT
><DT
>15.8.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2234"
>El script (CBQ)</A
></DT
><DT
>15.8.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2242"
>El script (HTB)</A
></DT
></DL
></DD
><DT
>15.9. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.RATELIMIT.SINGLE"
>Limitar la tasa a una √∫nica m√°quina o m√°scara de red</A
></DT
><DT
>15.10. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.FULLNAT.INTRO"
>Ejemplo de una soluci√≥n de nat completo con QoS</A
></DT
><DD
><DL
><DT
>15.10.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2281"
>Empecemos optimizando ese ancho de banda escaso</A
></DT
><DT
>15.10.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2317"
>Clasifici√≥n de paquetes</A
></DT
><DT
>15.10.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2337"
>Mejora de nuestra configuraci√≥n</A
></DT
><DT
>15.10.4. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2342"
>Hacer todo lo anterior durante el arranque</A
></DT
></DL
></DD
></DL
></DD
><DT
>16. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.BRIDGING"
>Hacer bridges y pseudo-bridges con Proxy ARP</A
></DT
><DD
><DL
><DT
>16.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.BRIDGING.IPTABLES"
>Estado del bridging e iptables</A
></DT
><DT
>16.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.BRIDGING.SHAPING"
>Bridging y ajustes (shaping)</A
></DT
><DT
>16.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.BRIDGING.PROXY-ARP"
>Pseudo-bridges con Proxy-ARP</A
></DT
><DD
><DL
><DT
>16.3.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2369"
>ARP y Proxy-ARP</A
></DT
><DT
>16.3.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2376"
>Implement√°ndolo</A
></DT
></DL
></DD
></DL
></DD
><DT
>17. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING"
>Encaminamiento din√°mico - OSPF y BGP</A
></DT
><DD
><DL
><DT
>17.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.OSPF"
>Configurar OSPF con Zebra</A
></DT
><DD
><DL
><DT
>17.1.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.OSPF.PREREQ"
>Prerequisitos</A
></DT
><DT
>17.1.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.OSPF.ZEBRACFG"
>Configuraci√≥n de Zebra</A
></DT
><DT
>17.1.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.OSPF.RUNNING"
>Ejecutar Zebra</A
></DT
></DL
></DD
><DT
>17.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.BGP"
>Configurar BGP4 con Zebra</A
></DT
><DD
><DL
><DT
>17.2.1. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.BGP.NETMAP"
>Mapa de red (Ejemplo)</A
></DT
><DT
>17.2.2. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.DYNAMIC-ROUTING.BGP.CONFIG"
>Configuraci√≥n (Ejemplo)</A
></DT
><DT
>17.2.3. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2517"
>Comprobar la configuraci√≥n</A
></DT
></DL
></DD
></DL
></DD
><DT
>18. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.OTHER"
>Otras posibilidades</A
></DT
><DT
>19. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.FURTHER"
>Otras lecturas</A
></DT
><DT
>20. <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ACK"
>Reconocimientos</A
></DT
></DL
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.DEDICATION"
></A
>Cap√≠tulo 1. Dedicatoria</H1
><P
>      Este documento est√° dedicado a un mont√≥n de personas, y es mi
      intenci√≥n devolverles algo. Una lista de unos pocos:
    </P
><P
>&#13;      <P
></P
><UL
><LI
><P
>	    Rusty Russell
	  </P
></LI
><LI
><P
>	    Alexey N. Kuznetsov
	  </P
></LI
><LI
><P
>	    Los buenos chicos de Google
	  </P
></LI
><LI
><P
>	    El personal de Casema Internet
	  </P
></LI
></UL
>
	
    </P
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.INTRO"
></A
>Cap√≠tulo 2. Introducci√≥n</H1
><P
>Bienvenido, gentil lector.</P
><P
>      Con este documento espero iluminarte en c√≥mo hacer m√°s con el
      enrutamiento de Linux 2.2/2.4. Aunque la mayor√≠a de los usuarios lo
      desconozca, est√°n usando herramientas que permiten hacer cosas
      espectaculares. Ordenes tales como <B
CLASS="COMMAND"
>route</B
> e
      <B
CLASS="COMMAND"
>ifconfig</B
> en realidad son envolturas realmente
      delgadas alrededor de la poderosa infraestructura de iproute2.</P
><P
>      Espero que este C√≥mo sea tan legible como los de Rusty Russell,
      famoso (entre otras cosas) por netfilter.
    </P
><P
>      Siempre puede localizarnos escribiendo al <A
HREF="mailto:HOWTO@ds9a.nl"
TARGET="_top"
>equipo del HOWTO</A
>
      (h√°galo en ingl√©s). Sin embargo, le pedimos que considere enviar
      el mensaje a la lista de correo (vea la secci√≥n correspondiente)
      si tiene dudas que no est√©n relacionadas directamente con este
      documento. No somos un servicio de atenci√≥n gratuita, aunque a
      menudo respondamos a las preguntas que nos hacen en la lista.</P
><P
>Antes de que se pierda en este C√≥mo, si lo √∫nico que desea es hacer un
control de tr√°fico sencillo, s√°ltese todo lo dem√°s y vaya directo al
cap√≠tulo <I
CLASS="CITETITLE"
><A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.OTHER"
>Other possibilities</A
></I
>, y lea sobre
CBQ.init.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.DISCLAIMER"
>2.1. Descargo de responsabilidad y licencia</A
></H2
><P
>Este documento se distribuye con la esperanza de que sea √∫til,
pero SIN NINGUN TIPO DE GARANTIA; incluso sin las garant√≠as
impl√≠citas MERCANTILES o DE ADECUACION PARA UN PROPOSITO PARTICULAR.</P
><P
>En breve, si su backbone STM-64 se desconfigura y empieza a repartir
pornograf√≠a a sus clientes m√°s estimados, no es culpa nuestra. Lo
sentimos.</P
><P
>Copyright (c) 2002 by bert hubert, Gregory Maxwell, Martijn van
Oosterhout, Remco van Mook, Paul B. Schroeder and others. This material may
be distributed only subject to the terms and conditions set forth in the
Open Publication License, v1.0 or later (the latest version is presently
available at http://www.opencontent.org/openpub/).</P
><P
>Copie y distribuya (vendi√©ndolo o regal√°ndolo) este documento en cualquier
formato. Le pedimos que env√≠e correcciones y comentarios al mantenedor del
documento.</P
><P
>Tambi√©n le pedimos que si publica este C√≥mo en papel, env√≠e algunas
muestras a los autores para <SPAN
CLASS="QUOTE"
>"prop√≥sitos de revisi√≥n"</SPAN
> :-)</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.PRIOR"
>2.2. Conocimientos previos</A
></H2
><P
>Tal como implica el t√≠tulo, este es un C√≥mo <SPAN
CLASS="QUOTE"
>"Avanzado"</SPAN
>.
Aunque no es ciencia espacial de ninguna manera, se asumen ciertos
conocimientos previos.</P
><P
>Aqu√≠ hay algunas referencias que pueden ayudarle a aprender algo m√°s:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
><A
HREF="/web/20040611091246/http://netfilter.samba.org/unreliable-guides/networking-concepts-HOWTO/index.html"
TARGET="_top"
>      El C√≥mo de conceptos de redes de Rusty Russell</A
>. Tambi√©n
      dispone de una
      <A
HREF="/web/20040611091246/http://www.insflug.org/COMOs/conceptos-de-redes-COMO/conceptos-de-redes-COMO.html"
TARGET="_top"
>      versi√≥n en castellano</A
>.</DT
><DD
><P
>Muy buena introducci√≥n, que explica lo que es una red, y c√≥mo se
    conecta con otras.
    </P
></DD
><DT
>Redes en Linux C√≥mo (Previamente Net-3 Como)</DT
><DD
><P
>Gran material, aunque un poco exhaustivo. Le ense√±a un mont√≥n de
    cosas que ya deben estar configuradas si es capaz de conectar a
    Internet. Deber√≠a estar en
    <TT
CLASS="FILENAME"
>/usr/doc/HOWTO/NET3-4-HOWTO.txt</TT
> pero tambi√©n lo
    puede encontrar
    <A
HREF="/web/20040611091246/http://www.linuxports.com/howto/networking"
TARGET="_top"
>en
    l√≠nea</A
> (y en castellano
    <A
HREF="/web/20040611091246/http://www.insflug.org/COMOs/Redes-En-Linux-Como/Redes-En-Linux-Como.html"
TARGET="_top"
>aqu√≠</A
>).
    </P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.LINUX"
>2.3. Qu√© puede hacer Linux por usted</A
></H2
><P
>Una peque√±a lista de cosas posibles:</P
><P
></P
><UL
><LI
><P
>Mejorar el ancho de banda de ciertos computadores
  </P
></LI
><LI
><P
>Mejorar el ancho de banda HACIA ciertos computadores
  </P
></LI
><LI
><P
>Ayudarle a compartir su ancho de banda de forma justa
  </P
></LI
><LI
><P
>Proteger su red ante ataques DoS
  </P
></LI
><LI
><P
>Proteger a Internet de sus clientes
  </P
></LI
><LI
><P
>Multiplexar varios servidores como uno solo, para equilibrio
  de carga o disponibilidad mejorada
  </P
></LI
><LI
><P
>Restringir el acceso a sus computadores
  </P
></LI
><LI
><P
>Limitar el acceso de sus usuarios a otras m√°quinas
  </P
></LI
><LI
><P
>Hacer enrutamiento basado en el id de los usarios (¬°s√≠!),
  direcci√≥n MAC, direcci√≥n IP de origen, puerto, tipo de servicio, hora
  del d√≠a o contenido
  </P
></LI
></UL
><P
>Actualmente, no mucha gente usa estas capacidades avanzadas. Esto sucede
por varias razones. Mientras que la documentaci√≥n existente es exahustiva,
no es muy pr√°ctica. El control de tr√°fico est√° casi sin documentar.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.HOUSKEEPING"
>2.4. Notas de mantenimiento</A
></H2
><P
>Hay varias cosas que habr√≠a que resaltar sobre este documento. Aunque
que lo he escrito en su mayor√≠a, realmente no quer√≠a que fuese as√≠. Creo
mucho en el Open Source, de manera que le animo a que me env√≠e sus
impresiones, actualizaciones, parches, etc. No dude en informarme de
fallos de ortograf√≠a o errores por antig√ºedad. (Nota: lo siguiente s√≥lo
tiene sentido en el documento original) Si mi ingl√©s parece algo
acartonado, por favor, tenga en cuenta que no soy un hablante nativo.
Si√©ntase libre de enviarme sugerencias.</P
><P
>Si cree que est√° mejor cualificado para mantener una secci√≥n, o piensa que
puede crear y mantener nuevas secciones, sea bienvenido. El SGML de este
C√≥mo est√° disponible v√≠a CVS, y me gustar√≠a que trabajase m√°s gente en √©l.</P
><P
>Como ayuda para esto, podr√° encontrar varias notas FIXME. ¬°Los parches
siempre vienen bien! Cuando se encuentre con un FIXME, deber√≠a saber que
est√° entrando en territorio desconocido. Esto no quiere decir que no haya
errores en otras partes, pero tenga especial cuidado. Si ha comprobado que
algo es v√°lido, por favor, h√°ganoslo saber para eliminar la nota de FIXME.</P
><P
>Sobre este C√≥mo, me voy a tomar una serie de libertades. Por ejemplo,
postulo una conexi√≥n a Internet de 10Mbit, aunque s√© muy bien que esto no
es nada com√∫n.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.CVS"
>2.5. Acceso, CVS y env√≠o de actualizaciones</A
></H2
><P
>El lugar can√≥nico de este C√≥mo es
<A
HREF="/web/20040611091246/http://www.ds9a.nl/lartc"
TARGET="_top"
>√©ste</A
>.</P
><P
>Ahora disponemos de acceso an√≥nimo a CVS para todo el mundo. Esto es bueno
por varias razones. Puede actualizar de forma sencilla a nuevas versiones
de este C√≥mo y enviar parches es f√°cil.</P
><P
>M√°s a√∫n, permite a los autores trabajar en el fuente de forma
independiente, lo cual es bueno.</P
><PRE
CLASS="SCREEN"
>$ export CVSROOT=:pserver:anon@outpost.ds9a.nl:/var/cvsroot
$ cvs login
CVS password: [introduzca "cvs" (sin comillas)]
$ cvs co 2.4routing
cvs server: Updating 2.4routing
U 2.4routing/lartc.db</PRE
><P
>Si ha hecho cambios y quiere contribuir con ellos, ejecute
<KBD
CLASS="USERINPUT"
>cvs -z3 diff -uBb</KBD
>,
y env√≠e el resultado a <CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:howto@ds9a.nl"
>howto@ds9a.nl</A
>&#62;</CODE
>, que nosotros
podemos integrarlo de forma sencilla. ¬°Gracias! Por favor, aseg√∫rese de
que edita el fichero .db. Por cierto, los otros ficheros se generan
partiendo de √©ste.</P
><P
>Se proporciona un Makefile que le ayudar√° a crear postscript, dvi, pdf,
html y texto plano. Puede que necesite instalar
<SPAN
CLASS="APPLICATION"
>docbook</SPAN
>, <SPAN
CLASS="APPLICATION"
>docbook-utils</SPAN
>,
<SPAN
CLASS="APPLICATION"
>ghostscript</SPAN
> y <SPAN
CLASS="APPLICATION"
>tetex</SPAN
>
para obtener todos los formatos.</P
><P
>¬°Procure no editar 2.4routing.sgml! Contiene una versi√≥n antigua de este
HOWTO. El fichero correcto es lartc.db.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.MLIST"
>2.6. Lista de correo</A
></H2
><P
>Los autores reciben un creciente n√∫mero de mensajes sobre este C√≥mo.
Debido al claro inter√©s de la comunidad, se ha decidido crear una lista de
correo donde la gente pueda hablar entre s√≠ sobre Advanced Routing
and Traffic Control. Puede suscribirse a la lista (se habla en ingl√©s)
<A
HREF="/web/20040611091246/http://mailman.ds9a.nl/mailman/listinfo/lartc"
TARGET="_top"
>aqu√≠</A
>.</P
><P
>Deber√≠a precisar que los autores no suelen responder preguntas que no se
hagan a la lista. Nos gustar√≠a que el archivo de la lista se convirtiera
en algo as√≠ como una base de conocimiento. Si tiene una pregunta, s√≠rvase
buscar antes en el archivo, y s√≥lo despu√©s env√≠ela a la lista.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.INTRO.LAYOUT"
>2.7. Disposici√≥n de este documento</A
></H2
><P
>Vamos a empezar a hacer cosas interesantes casi inmediatamente, lo que
tambi√©n significa que inicialmente habr√°n partes no del todo explicadas, o
que no est√©n perfectas. Por favor, lea superficialmente esas partes y
asuma que todo se aclarar√° m√°s adelante.</P
><P
>Enrutar y filtrar son dos cosas distintas. El filtrado est√° bastante bien
documentado en los C√≥mo de Rusty, disponibles aqu√≠:</P
><P
></P
><UL
><LI
><P
><A
HREF="/web/20040611091246/http://netfilter.samba.org/unreliable-guides/"
TARGET="_top"
>    Rusty's Remarkably Unreliable Guides</A
>
  </P
></LI
></UL
><P
>Vamos a centrarnos principalmente en las posibilidades de combinar
netfilter e iproute2.</P
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.IPROUTE2"
></A
>Cap√≠tulo 3. Introducci√≥n a iproute2</H1
><DIV
CLASS="SECT1"
><H2
CLASS="SECT1"
><A
NAME="LARTC.IPROUTE2.WHY"
>3.1. ¬øPor qu√© iproute2?</A
></H2
><P
>La mayor√≠a de las distribuciones de Linux, y la mayor√≠a de los UNIX, usan
actualmente las venerables √≥rdenes <B
CLASS="COMMAND"
>arp</B
>,
<B
CLASS="COMMAND"
>ifconfig</B
> y <B
CLASS="COMMAND"
>route</B
>
Aunque funcionan, muestran cierto comportamiento inesperado apartir de
Linux 2.2.
Por ejemplo, los t√∫neles GRE son parte integral del enrutado hoy d√≠a, pero
precisan herramientas completamente diferentes.</P
><P
>Con <SPAN
CLASS="APPLICATION"
>iproute2</SPAN
>, los t√∫neles son una parte
integral del juego de herramientas.</P
><P
>Los n√∫cleos Linux 2.2 y superiores incluyen un subsistema de red
completamente redise√±ado. Este nuevo c√≥digo de red proporciona a Linux un
rendimiento y caracter√≠sticas con poca competencia en el panorama general
de los SO. En realiadd, el nuevo c√≥digo de enrutado, filtrado y
clasificaci√≥n tiene m√°s posibilidades que el que porporcionan muchos
enrutadores y cortafuegos dedicados y productos de control de tr√°fico.</P
><P
>Seg√∫n se inventan nuevos conceptos de red, la gente encuentra maneras de
emplastarlos encima de la infraestructura existente en los SO. Este
continuo apilamiento de porquer√≠a ha llevado a c√≥digo de red lleno de
comportamientos extra√±os, muy parecido a lo que sucede con los idiomas
humanos. En el pasado, Linux emul√≥ la forma de SunOS de gestionar muchas
de estas cosas, pero no era ideal.</P
><P
>Esta nueva infraestructura hace posible expresar claramente
caracter√≠sticas que antes estaban m√°s all√° del alcance de Linux.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPROUTE2.TOUR"
>3.2. revisi√≥n de iproute2</A
></H2
><P
>Linux tiene un sistema sofisticado para proporcionar ancho de banda
llamado Traffic Control. Este sistema soporta varios m√©todos de
clasificaci√≥n, priorizado, compartici√≥n y limitaci√≥n tanto de tr√°fico
entrante como saliente.</P
><P
>Empezaremos con un peque√±o ¬´tour¬ª por las posibilidades de iproute2.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPROUTE2.PACKAGE"
>3.3. Prerequisitos</A
></H2
><P
>Deber√≠a asegurarse de que tiene instaladas las herramientas de espacio de
usuario. Este paquete se llama ¬´iproute¬ª tanto en RedHat como en Debian, y
en cualquier caso, puede encontrarlo en
<TT
CLASS="FILENAME"
>ftp://ftp.inr.ac.ru/ip-routing/iproute2-2.2.4-now-ss??????.tar.gz"</TT
>.</P
><P
>Tambi√©n puede buscar
<A
HREF="/web/20040611091246/ftp://ftp.inr.ac.ru/ip-routing/iproute2-current.tar.gz"
TARGET="_top"
>aqu√≠</A
> 
la √∫ltima versi√≥n.</P
><P
>Algunas partes de iproute precisan que active ciertas opciones del n√∫cleo.
Tambi√©n deber√≠a saber que todas las versiones de RedHat hasta la 6.2,
incluida, vienen con la mayor√≠a de capacidades de control de tr√°fico en el
n√∫cleo de serie.</P
><P
>RedHat 7.2 lo tiene todo de serie.</P
><P
>Tambi√©n debe asegurarse de que tiene soporte de netlink, en caso de que
escoja configurar su propio n√∫cleo. Iproute2 lo necesita.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPROUTE2.EXPLORE"
>3.4. Explorar la configuraci√≥n actual</A
></H2
><P
>Puede que le sorprenda, ¬°pero iproute2 ya est√° configurado! Las √≥rdenes
<B
CLASS="COMMAND"
>ifconfig</B
> y <B
CLASS="COMMAND"
>route</B
> actuales ya usan
las llamadas a sistema avanzadas, pero en su mayor√≠a con configuraciones
por defecto (es decir, aburridas).</P
><P
>La herramienta <B
CLASS="COMMAND"
>ip</B
> es central, y le pediremos que nos
muestre nuestras interfaces.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN207"
>3.4.1. <B
CLASS="COMMAND"
>ip</B
> nos muestra nuestros enlaces</A
></H3
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ ip link list
1: lo: &#60;LOOPBACK,UP&#62; mtu 3924 qdisc noqueue 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: dummy: &#60;BROADCAST,NOARP&#62; mtu 1500 qdisc noop 
    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
3: eth0: &#60;BROADCAST,MULTICAST,PROMISC,UP&#62; mtu 1400 qdisc pfifo_fast qlen 100
    link/ether 48:54:e8:2a:47:16 brd ff:ff:ff:ff:ff:ff
4: eth1: &#60;BROADCAST,MULTICAST,PROMISC,UP&#62; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:e0:4c:39:24:78 brd ff:ff:ff:ff:ff:ff
3764: ppp0: &#60;POINTOPOINT,MULTICAST,NOARP,UP&#62; mtu 1492 qdisc pfifo_fast qlen 10
    link/ppp &#13;</PRE
><P
>Puede que para usted var√≠e, pero esto es lo que muestra mi enrutador NAT
en casa. S√≥lo voy a explicar parte de la salida ya que no todo es
directamente relevante.</P
><P
>Primero vemos la interfaz loopback. Aunque su computador puede funcionar
sin una, le advierto que no lo haga. El tama√±o MTU (Maximum Transfer Unit)
es de 3924 octetos, y no se supone que deba encolar. Lo cual tiene sentido
porque la interfaz loopback es una fantas√≠a en la imaginaci√≥n del n√∫cleo.</P
><P
>Dejar√© de lado por ahora la interfaz dummy, que puede no estar presente en
su computador. Despu√©s est√°n mis dos interfaces de red f√≠sicas, una est√°
del lado de mi cable m√≥dem, y la otra sirve a mi segmento ethernet casero.
M√°s a√∫n, vemos una interfaz ppp0.</P
><P
>Observe la ausencia de direcciones IP. iproute desconecta los conceptos de
¬´enlace¬ª y ¬´direcci√≥n IP¬ª. De todas maneras, con el alias de IP, el
concepto de ¬´la¬ª direcci√≥n IP se ha vuelto bastante irrelevante.</P
><P
>Sin embargo, nos muestra las direcciones MAC, el identificador en hardware
de nuestras interfaces ethernet.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN216"
>3.4.2. <B
CLASS="COMMAND"
>ip</B
> nos muestra nuestras direcciones IP</A
></H3
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ ip address show        
1: lo: &#60;LOOPBACK,UP&#62; mtu 3924 qdisc noqueue 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 brd 127.255.255.255 scope host lo
2: dummy: &#60;BROADCAST,NOARP&#62; mtu 1500 qdisc noop 
    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
3: eth0: &#60;BROADCAST,MULTICAST,PROMISC,UP&#62; mtu 1400 qdisc pfifo_fast qlen 100
    link/ether 48:54:e8:2a:47:16 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.1/8 brd 10.255.255.255 scope global eth0
4: eth1: &#60;BROADCAST,MULTICAST,PROMISC,UP&#62; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:e0:4c:39:24:78 brd ff:ff:ff:ff:ff:ff
3764: ppp0: &#60;POINTOPOINT,MULTICAST,NOARP,UP&#62; mtu 1492 qdisc pfifo_fast qlen 10
    link/ppp 
    inet 212.64.94.251 peer 212.64.94.1/32 scope global ppp0</PRE
><P
>Esto contiene m√°s informaci√≥n. Nos muestra todas nuestras direcciones, y a
qu√© tarjetas pertenecen. ¬´inet¬ª significa Internet (IPv4). Hay muchas
otras familias de direcciones, pero no nos importan por el momento.</P
><P
>Examinemos eth0 m√°s de cerca. Dice que est√° relacionada con la direcci√≥n
inet ¬´10.0.0.1/8¬ª. ¬øQu√© significa esto? El /8 indica el n√∫mero de bits que
est√°n en la Direcci√≥n de Red. Hay 32 bit, de manera que quedan 24 bits que
son parte de nuestra red. Los primeros 8 bits de 10.0.0.1 corresponden a
10.0.0.0, nuestra Direcci√≥n de Red, y nuestra m√°scara de red (netmask) es
255.0.0.0.</P
><P
>Las otras m√°quinas est√°n conectadas a esta interfaz, de manera que
10.250.3.13 es accesible de forma directa desde eth0, al igual que
10.0.0.1, por ejemplo.</P
><P
>Con ppp0, vemos el mismo concepto, aunque los n√∫meros son diferentes. Su
direcci√≥n es 212.64.94.251, sin m√°scara de subred. Esto significa que
tenemos una conexi√≥n punto a punto y que cada direcci√≥n, con la excepci√≥n
de 212.64.94.251, es remota. Hay m√°s informaci√≥n, sin embargo. Nos dice
que en la otra punta del enlace hay, de nuevo, una √∫nica direcci√≥n,
212.64.94.1. El /32 nos dice que no hay ¬´bits de red¬ª.</P
><P
>Es absolutamente vital que comprenda bien estos conceptos. Rem√≠tase a la
documentaci√≥n mencionada al principio de este C√≥mo si tiene problemas.</P
><P
>Tambi√©n observar√° ¬´qdisc¬ª, que significa Disciplina de Cola (Queueing
Discipline). M√°s adelante veremos que es vital.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN226"
>3.4.3. <B
CLASS="COMMAND"
>ip</B
> nos muestra nuestras rutas</A
></H3
><P
>Bien, ya sabemos c√≥mo encontrar direcciones 10.x.y.z, y somos capaces de
alcanzar 212.64.94.1. Sin embargo, esto no es suficiente, de manera que
necesitamos instrucciones sobre c√≥mo alcanzar al resto del mundo. La
Internet est√° disponible mediante nuestra conexi√≥n ppp, y parece que
212.64.94.1 est√° deseando esparcir nuestros paquetes por el mundo, y
entregarnos resultados de vuelta.</P
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ ip route show
212.64.94.1 dev ppp0  proto kernel  scope link  src 212.64.94.251 
10.0.0.0/8 dev eth0  proto kernel  scope link  src 10.0.0.1 
127.0.0.0/8 dev lo  scope link 
default via 212.64.94.1 dev ppp0 </PRE
><P
>Bastante expl√≠cito. Las primeras 4 l√≠neas indican expl√≠citamente lo
que qued√≥ impl√≠cito con <B
CLASS="COMMAND"
>ip address show</B
>, y la √∫ltima
l√≠nea nos dice que el resto del mundo lo podemos encontrar mediante
212.64.94.1, nuestra pasarela por defecto. Podemos saber que es una
pasarela por la palabra ¬´via¬ª, que nos dice que necesitamos enviar
paquetes a 212.64.94.1, que ya se encargar√° del resto.</P
><P
>Como referencia, esto es lo que la vieja utilidad <B
CLASS="COMMAND"
>route</B
>
nos muestra:</P
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use
Iface
212.64.94.1     0.0.0.0         255.255.255.255 UH    0      0        0 ppp0
10.0.0.0        0.0.0.0         255.0.0.0       U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         212.64.94.1     0.0.0.0         UG    0      0        0 ppp0</PRE
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPROUTE2.ARP"
>3.5. ARP</A
></H2
><P
>ARP es el Address Resolution Protocol que se describe en el
<A
HREF="/web/20040611091246/http://www.faqs.org/rfcs/rfc826.html"
TARGET="_top"
>RFC 826</A
>.
ARP lo usa una m√°quina en red para averiguar la localizaci√≥n/direcci√≥n
hardware de otra m√°quina en la misma red local. Las m√°quinas en Internet
se conocen generalmente por sus nombres que se corresponden a direcciones
IP. As√≠ es como una m√°quina en la red foo.com es capaz de comunicarse con
otras m√°quinas que est√°n en la red bar.net. Una direcci√≥n IP, sin embargo,
no puede decirte la localizaci√≥n f√≠sica de una m√°quina. Aqu√≠ es donde
entra ARP.</P
><P
>Tomemos un ejemplo muy sencillo. Supongamos que tengo una red compuesta de
varias m√°quinas. Dos de ellas que est√°n en mi red son foo con direcci√≥n IP
10.0.0.1 y bar con direcci√≥n IP 10.0.0.2. Ahora foo quiere hacer ping
hacia bar para ver si est√° viva, pero, ¬°vaya!, foo no tiene idea de d√≥nde
est√° bar. De manera que cuando foo decide hacer ping hacia bar necesita
realizar una consulta ARP.
Esta consulta ARP es algo as√≠ como si foo gritase en la red ¬´¬°Bar
(10.0.0.2)! ¬øD√≥nde est√°s?¬ª Como resultado de esto, cada m√°quina de la red
escuchar√° el grito de foo, pero s√≥lo bar (10.0.0.2) responder√°. Bar
enviar√° entonces una respuesta ARP directamente a foo, que viene a ser
como si bar dijese, ¬´Foo (10.0.0.1), estoy aqu√≠ en 00:60:94:E9:08:12¬ª.
Despu√©s de esta sencilla transacci√≥n que sirve para localizar a su amigo
en la red, foo es capaz de comunicarse con bar hasta que olvide (su cach√©
arp) d√≥nde est√° bar (normalmente tras 15 minutos, en Unix).</P
><P
>Ahora, veamos c√≥mo funciona.
Puede ver la cach√©/tabla arp/neighbor actual de su m√°quina as√≠:</P
><PRE
CLASS="SCREEN"
>[root@espa041 /home/src/iputils]# ip neigh show
9.3.76.42 dev eth0 lladdr 00:60:08:3f:e9:f9 nud reachable
9.3.76.1 dev eth0 lladdr 00:06:29:21:73:c8 nud reachable</PRE
><P
>Como puede ver, mi m√°quina espa041 (9.3.76.41) sabe d√≥nde encontrar a
espa042 (9.3.76.42) y espagate (9.3.76.1). Ahora a√±adamos otra m√°quina a
la cach√© arp.</P
><PRE
CLASS="SCREEN"
>[root@espa041 /home/paulsch/.gnome-desktop]# ping -c 1 espa043
PING espa043.austin.ibm.com (9.3.76.43) from 9.3.76.41 : 56(84) bytes of data.
64 bytes from 9.3.76.43: icmp_seq=0 ttl=255 time=0.9 ms

--- espa043.austin.ibm.com ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 0.9/0.9/0.9 ms

[root@espa041 /home/src/iputils]# ip neigh show
9.3.76.43 dev eth0 lladdr 00:06:29:21:80:20 nud reachable
9.3.76.42 dev eth0 lladdr 00:60:08:3f:e9:f9 nud reachable
9.3.76.1 dev eth0 lladdr 00:06:29:21:73:c8 nud reachable</PRE
><P
>Como resultado de que espa041 intente contactar con espa043, se ha a√±adido
la direcci√≥n/localizaci√≥n hardware de espa043 a la cach√© arp/neighbor. De
manera que mientras no caduque la entrada de espa043 (como resultado de la
ausencia de comunicaci√≥n entre ambas), espa041 sabe d√≥nde encontrar a
espa043 y no necesita enviar una consulta ARP.</P
><P
>Ahora, eliminemos a espa043 de nuestra cach√© arp:</P
><PRE
CLASS="SCREEN"
>[root@espa041 /home/src/iputils]# ip neigh delete 9.3.76.43 dev eth0
[root@espa041 /home/src/iputils]# ip neigh show
9.3.76.43 dev eth0  nud failed
9.3.76.42 dev eth0 lladdr 00:60:08:3f:e9:f9 nud reachable
9.3.76.1 dev eth0 lladdr 00:06:29:21:73:c8 nud stale</PRE
><P
>Ahora espa041 ha vuelto a olvidar d√≥nde encontrar a espa043 y necesitar√°
enviar otra consulta ARP la siguiente vez que necesite comunicarse con
espa043. Tambi√©n puede ver en el listado anterior que espagate (9.3.76.1)
ha cambiado al estado ¬´stale¬ª. Esto significa que la localizaci√≥n mostrada
todav√≠a es v√°lida, pero tendr√° que ser confirmada en la primera
transacci√≥n que se haga con esa m√°quina.</P
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.RPDB"
></A
>Cap√≠tulo 4. Reglas (base de datos de normas de rutado)</H1
><P
>Si tiene una red grande, probablemente tenga que encargarse de las
necesidades de diferentes personas, que deber√≠an ser servidas de forma
diferente. La base de datos de normas de rutado (routing policy database)
le permite hacerlo teniendo varios conjuntos de tablas de rutado.</P
><P
>Si quiere usar esta caracter√≠stica, aseg√∫rese de que compila su n√∫cleo con
las opciones ¬´IP: advanced router¬ª e ¬´IP: policy routing¬ª.</P
><P
>Cuando el n√∫cleo necesita tomar una decisi√≥n de encaminamiento, busca la
tabla que necesita consultar. Por defecto, hay tres tablas. La antigua
herramienta "route" modifica las tablas principal y local, al igual que la
herramienta ip (por defecto).</P
><P
>Las reglas por defecto:</P
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ ip rule list
0:	from all lookup local 
32766:	from all lookup main 
32767:	from all lookup default</PRE
><P
>Aqu√≠ se lista la priorida de todas las reglas. Vemos que todas son
aplicables a todos los paquetes (¬´from all¬ª). Hemos visto anteriormente la
tabla ¬´main¬ª, mostrada por <KBD
CLASS="USERINPUT"
>ip route ls</KBD
>, pero las
tablas ¬´local¬ª y ¬´default¬ª son nuevas.</P
><P
>Si queremos hacer cosas interesantes, generaremos reglas que se refieran a
diferentes tablas que nos permitir√°n saltarnos las reglas generales de
rutado del sistema.</P
><P
>Si desea ver la sem√°ntica exacta de lo que hace el n√∫cleo cuando hay m√°s
de una regla v√°lida, vea la documentaci√≥n ip-cref de Alexey.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.RPDB.SIMPLE"
>4.1. Normas de encaminamiento por origen sencillas</A
></H2
><P
>Tomando de nuevo un ejemplo real, tengo 2 cable m√≥dems (en realidad 3,
pero acab√© devolviendo uno), conectados a un router Linux NAT
(¬´masquerading¬ª). La gente que vive aqu√≠ me paga por acceder a Internet.
Suponga que uno de mis compa√±eros de casa s√≥lo visita hotmail y desea
pagar menos. Esto me parece bien, pero acabar√° usando el cable m√≥dem de
menos prestaciones.</P
><P
>El cable m√≥dem ¬´r√°pido¬ª se conoce como 212.64.94.251 y es un enlace PPP a
212.64.94.1. El ¬´lento¬ª es conocido por varias IP, por ejemplo
212.64.78.148, y es un enlace a 195.96.98.253.</P
><P
>La tabla local:</P
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ ip route list table local
broadcast 127.255.255.255 dev lo  proto kernel  scope link  src 127.0.0.1 
local 10.0.0.1 dev eth0  proto kernel  scope host  src 10.0.0.1 
broadcast 10.0.0.0 dev eth0  proto kernel  scope link  src 10.0.0.1 
local 212.64.94.251 dev ppp0  proto kernel  scope host  src 212.64.94.251 
broadcast 10.255.255.255 dev eth0  proto kernel  scope link  src 10.0.0.1 
broadcast 127.0.0.0 dev lo  proto kernel  scope link  src 127.0.0.1 
local 212.64.78.148 dev ppp2  proto kernel  scope host  src 212.64.78.148 
local 127.0.0.1 dev lo  proto kernel  scope host  src 127.0.0.1 
local 127.0.0.0/8 dev lo  proto kernel  scope host  src 127.0.0.1 </PRE
><P
>Mont√≥n de cosas obvias, pero que hace falta especificar en alg√∫n sitio.
Bien, aqu√≠ est√°n. La tabla por defecto est√° vac√≠a.</P
><P
>Veamos la tabla ¬´main¬ª:</P
><PRE
CLASS="SCREEN"
>[ahu@home ahu]$ ip route list table main 
195.96.98.253 dev ppp2  proto kernel  scope link  src 212.64.78.148 
212.64.94.1 dev ppp0  proto kernel  scope link  src 212.64.94.251 
10.0.0.0/8 dev eth0  proto kernel  scope link  src 10.0.0.1 
127.0.0.0/8 dev lo  scope link 
default via 212.64.94.1 dev ppp0 </PRE
><P
>Ahora generaremos una nueva regla que llamaremos ¬´John¬ª, por nuestro
hipot√©tico compa√±ero. Aunque podemos trabajar con n√∫meros, es mucho m√°s
sencillo a√±adir nuestras tablas a /etc/iproute2/rt_tables.</P
><PRE
CLASS="SCREEN"
># echo 200 John &#62;&#62; /etc/iproute2/rt_tables
# ip rule add from 10.0.0.10 table John
# ip rule ls
0:	from all lookup local 
32765:	from 10.0.0.10 lookup John
32766:	from all lookup main 
32767:	from all lookup default</PRE
><P
>Ahora todo lo que queda es generar la tabla John, y refrescar la cach√© de
rutas:</P
><PRE
CLASS="SCREEN"
># ip route add default via 195.96.98.253 dev ppp2 table John
# ip route flush cache</PRE
><P
>Ya hemos terminado. Dejamos como ejercicio al lector implementar esto en
ip-up.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.RPDB.MULTIPLE-LINKS"
>4.2. Encaminamiento con varios enlaces de salida/proveedores</A
></H2
><P
>La siguiente es una configuraci√≥n com√∫n, en la que hay dos proveedores que
conectan una red local (o incluso una √∫nica m√°quina) a la gran Internet.

<PRE
CLASS="SCREEN"
>                                                                 ________
                                         +-------------+        /
                                         |             |       |
                            +------------+ Proveedor 1 +-------
        __                  |            |             |     /
    ___/  \_         +------+-------+    +-------------+    |
  _/        \__      |     if1      |                      /
 /             \     |              |                      |
|   Red local   -----+ Linux router |                      |     Internet
 \_           __/    |              |                      |
   \__     __/       |     if2      |                      \
      \___/          +------+-------+    +-------------+    |
                            |            |             |     \
                            +------------+ Proveedor 2 +-------
                                         |             |       |
                                         +-------------+        \________</PRE
></P
><P
>Normalmente surgen dos preguntas dada esta configuraci√≥n.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN279"
>4.2.1. Acceso dividido</A
></H3
><P
>	  La primera es c√≥mo enrutar respuestas a paquetes que vienen de
	  un proveedor particular, por ejemplo Proveedor 1, de vuelta por
	  el mismo camino.
	</P
><P
>	  Primero establezcamos algunos nombres simb√≥licos. Digamos que
	  <B
CLASS="COMMAND"
>$IF1</B
> es el nombre de la primera interfaz (if1
	  en la figura) y <B
CLASS="COMMAND"
>$IF2</B
> el nombre de la segunda.
	  Sean entonces <B
CLASS="COMMAND"
>$IP1</B
> la direcci√≥n IP asociada
	  con <B
CLASS="COMMAND"
>$IF1</B
> y <B
CLASS="COMMAND"
>$IP2</B
> la IP
	  asociada con <B
CLASS="COMMAND"
>$IF2</B
>. Luego, digamos que
	  <B
CLASS="COMMAND"
>$P1</B
> es la direcci√≥n IP de la pasarela a
	  Proveedor 1, y <B
CLASS="COMMAND"
>$P2</B
> la IP de la pasarela a
	  Proveedor 2. Por √∫ltimo, <B
CLASS="COMMAND"
>$P1_NET</B
> ser√° la red
	  IP donde est√° <B
CLASS="COMMAND"
>$P1</B
>, y
	  <B
CLASS="COMMAND"
>$P2_NET</B
> la red IP donde est√°
	  <B
CLASS="COMMAND"
>$P2</B
>.
	</P
><P
>	  Creamos dos tablas de encaminamiento adicionales, llam√©moslas
	  <B
CLASS="COMMAND"
>T1</B
> y <B
CLASS="COMMAND"
>T2</B
>. Las a√±adimos a
	  /etc/iproute2/rt_tables. Entonces las configuramos de la
	  siguiente manera:
	</P
><P
>	<PRE
CLASS="SCREEN"
>	  ip route add $P1_NET dev $IF1 src $IP1 table T1
	  ip route add default via $P1 table T1
	  ip route add $P2_NET dev $IF2 src $IP2 table T2
	  ip route add default via $P2 table T2
	</PRE
>
	  
	  Nada espectacular; simplemente hemos montado una ruta hacia una
	  pasarela, y una ruta por defecto mediante ella, tal como ser√≠a
	  el caso con un √∫nico proveedor, pero ponemos las rutas en tablas
	  separadas, una por proveedor. Observe que basta la ruta hacia la
	  red, ya que le indica c√≥mo encontrar cualquier m√°quina dentro de
	  esa red, lo que incluye la pasarela, como se especific√≥
	  anteriormente.
	</P
><P
>	  Despu√©s configuramos la tabla de rutas principal (main). Es una
	  buena idea encaminar las cosas a vecinos directos mediante la
	  interfaz conectada a ese vecino. Observe las opciones ¬´src¬ª, que
	  se aseguran que se escoge la direcci√≥n IP correcta.

	  <PRE
CLASS="SCREEN"
>	    ip route add $P1_NET dev $IF1 src $IP1
	    ip route add $P2_NET dev $IF2 src $IP2
	  </PRE
>

	  Luego, la ruta por defecto preferente:
	  
	  <PRE
CLASS="SCREEN"
>	    ip route add default via $P1
	  </PRE
>

	  A continuaci√≥n, configuramos las reglas de encaminamiento. Estas
	  son las que escogen qu√© tabla de rutas se usa. Querr√° asegurarse
	  de que encamina por una interfaz dada si ya tenemos una
	  direcci√≥n de origen correspondiente:
	  
	  <PRE
CLASS="SCREEN"
>	    ip rule add from $IP1 table T1
	    ip rule add from $IP2 table T2
	  </PRE
>

	  Estas √≥rdenes se aseguran de que todas las respuestas al tr√°fico
	  proveniente de una interfaz en particular ser√° contestado por
	  esta interfaz.
	</P
><P
>	<DIV
CLASS="WARNING"
><P
></P
><TABLE
CLASS="WARNING"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/warning.gif"
HSPACE="5"
ALT="Aviso"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>El lector Rod Roark se√±ala: ¬´Si $P0_NET es la red local y $IF0 su interfaz,
ser√≠an deseables las siguientes √≥rdenes adicionales:
<PRE
CLASS="SCREEN"
>ip route add $P0_NET     dev $IF0 table T1
ip route add $P2_NET     dev $IF2 table T1
ip route add 127.0.0.0/8 dev lo   table T1
ip route add $P0_NET     dev $IF0 table T2
ip route add $P1_NET     dev $IF1 table T2
ip route add 127.0.0.0/8 dev lo   table T2&#13;</PRE
>¬ª
	</P
></TD
></TR
></TABLE
></DIV
></P
><P
>	  Esta es la configuraci√≥n m√°s b√°sica. Funcionar√° para todos los
	  procesos que est√©n funcionando en el propio router, y para la
	  red local, si est√° enmascarada, y si no, entonces puede que
	  tenga un espacio IP de ambos proveedores, o que vaya a
	  enmascarar la salida por uno de los proveedores. En ambos casos,
	  querr√° a√±adir reglas escogiendo por cual proveedor encaminar
	  bas√°ndose en las direcciones IP de las m√°quinas en la red local.
 	</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN309"
>4.2.2. Equilibrio de carga</A
></H3
><P
>	  La segunda pregunta es c√≥mo equilibar el tr√°fico que va por los
	  dos proveedores. En realidad no es dif√≠cil si ya ha configurado
	  un acceso dividido como se indic√≥ previamente.
	  </P
><P
>	  En lugar de escoger uno de los proveedores como la salida por
	  defecto, configuraremos la ruta por defecto para que sea
	  multicamino (multipath route). Por defecto, el n√∫cleo
	  equilibrar√° las rutas sobre los dos proveedores. Esto se hace
	  como sigue (una vez m√°s, nos apoyamos en el ejemplo de la
	  secci√≥n sobre acceso dividido):

	  <PRE
CLASS="SCREEN"
>	    ip route add default scope global nexthop via $P1 dev $IF1 weight 1 \
	    nexthop via $P2 dev $IF2 weight 1
	  </PRE
>

	  Esto equilibrar√° las rutas sobre ambos proveedores. Los
	  par√°metros <B
CLASS="COMMAND"
>weight</B
> se pueden modificar para
	  favorecer a un proveedor sobre el otro.
	</P
><P
>	  Tenga en cuenta que el equilibrio no ser√° perfecto, ya que se
	  basa en rutas, y las rutas est√°n en cach√©. Esto significa que
	  las rutas usadas m√°s a menudo siempre ir√°n sobre el mismo
	  proveedor.
	</P
><P
>	  M√°s a√∫n, si realmente quiere hacer esto, probablemente tambi√©n
	  quiera los parches de Julian Anastasov que hay en <A
HREF="/web/20040611091246/http://www.ssi.bg/~ja/#routes"
TARGET="_top"
>http://www.ssi.bg/~ja/#routes</A
>,
	  la p√°gina del parche de rutas de Julian. Har√° m√°s sencillo el
	  trabajo.
	</P
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.TUNNEL"
></A
>Cap√≠tulo 5. GRE y otros t√∫neles</H1
><P
>Hay tres tipos de t√∫neles en Linux. Est√°n los t√∫neles IP sobre IP, los
t√∫neles GRE y t√∫neles que se realizan fuera del n√∫cleo (como por ejemplo,
PPTP).</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.TUNNEL.REMARKS"
>5.1. Breve inciso sobre los t√∫neles:</A
></H2
><P
>Los t√∫neles se pueden usar para hacer varias cosas poco usuales y bastante
interesantes. Tambi√©n pueden hacer que las cosas vayan horriblemente mal
si no los configura bien. No ponga su ruta por defecto sobre un
dispositivo de t√∫nel a menos que sepa <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>EXACTAMENTE</I
></SPAN
> lo
que est√° haciendo :-). M√°s a√∫n, los t√∫neles incrementan la carga, porque
necesitan un juego extra de cabeceras IP. Normalmente, esto significa 20
bytes por paquete, de manera que si el tama√±o normal de un paquete (MTU)
en una red es de 1500 bytes, un paquete enviado por un t√∫nel s√≥lo puede
ser de 1480 bytes como mucho. Esto no es necesariamente un problema, pero
aseg√∫rese de leer algo sobre fragmentaci√≥n/reensamblaje de paquetes IP si
planea conectar redes grandes con t√∫neles. Oh, y por supuesto, la manera
m√°s r√°pida de cavar un t√∫nel es cavar desde los dos extremos.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.TUNNEL.IP-IP"
>5.2. T√∫neles IP sobre IP</A
></H2
><P
>Este tipo de t√∫neles lleva disponible en Linux mucho tiempo. Precisa dos
m√≥dulos del n√∫cleo,
ipip.o y new_tunnel.o</P
><P
>Digamos que tenemos tres redes: las redes internas A y B, y una red
intermedia C (o Internet, por ejemplo).
De manera que tenemos la red A:</P
><PRE
CLASS="SCREEN"
>network 10.0.1.0
netmask 255.255.255.0
router  10.0.1.1</PRE
><P
>El router tiene la direcci√≥n 172.16.17.18 en la red C.</P
><P
>y la red B:</P
><PRE
CLASS="SCREEN"
>network 10.0.2.0
netmask 255.255.255.0
router  10.0.2.1</PRE
><P
>Cuyo router tiene la direcci√≥n 172.19.20.21 en la red C.</P
><P
>Hasta donde le concierne a C, asumimos que pasar√° cualquier paquete que
vaya de A a B y viceversa. Incluso puede usar Internet para esto.</P
><P
>Esto es lo que haremos:</P
><P
>Primero, asegurarnos de que los m√≥dulos est√°n instalados:</P
><PRE
CLASS="SCREEN"
>insmod ipip.o
insmod new_tunnel.o</PRE
><P
>Luego, en el router de la red A, hacemos lo siguiente:</P
><PRE
CLASS="SCREEN"
>ifconfig tunl0 10.0.1.1 pointopoint 172.19.20.21
route add -net 10.0.2.0 netmask 255.255.255.0 dev tunl0</PRE
><P
>Y en el de la red B:</P
><PRE
CLASS="SCREEN"
>ifconfig tunl0 10.0.2.1 pointopoint 172.16.17.18
route add -net 10.0.1.0 netmask 255.255.255.0 dev tunl0</PRE
><P
>Y si ha dejado de usar el t√∫nel:</P
><PRE
CLASS="SCREEN"
>ifconfig tunl0 down</PRE
><P
>Listo, ya lo tiene. Sin embargo, no puede enviar tr√°fico de difusi√≥n
(broadcast) o IPv6 mediante un t√∫nel IP-sobre-IP. Simplemente puede
conectar dos redes IPv4 que normalmente no podr√≠an comunicarse entre
ellas; eso es todo. En lo que respecta a la compatibilidad, este c√≥digo
lleva ah√≠ mucho tiempo, de manera que es compatible hasta con los n√∫cleos
1.3. Los t√∫neles IP-sobre-IP de Linux no funcionan con otros sistemas
operativos o routers, hasta donde yo s√©. Es sencillo, y funciona. Uselo si
lo necesita, en cualquier otro caso, use GRE.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.TUNNEL.GRE"
>5.3. T√∫neles GRE</A
></H2
><P
>GRE es un protocolo de tunelizado que desarroll√≥ Cisco originalmente, y
que puede hacer unas cu√°ntas cosas m√°s que los t√∫neles IP-sobre-IP. Por
ejemplo, puede transportar tr√°fico multicast e IPv6 sobre un t√∫nel GRE.</P
><P
>En Linux, necesitar√° el m√≥dulo ip_gre.o.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN349"
>5.3.1. T√∫neles IPv4</A
></H3
><P
>Primero hagamos un t√∫nel IPv4:</P
><P
>Digamos que tenemos 3 redes: las redes internas A y B, y una red
intermedia C (por ejemplo, Internet).</P
><P
>De manera que tenemos la red A:

<PRE
CLASS="SCREEN"
>network 10.0.1.0
netmask 255.255.255.0
router  10.0.1.1</PRE
>

El router tiene la direcci√≥n 172.16.17.18 en la red C.
Llamaremos a esta red neta (ok, no es muy original)</P
><P
>Y la red B:

<PRE
CLASS="SCREEN"
>network 10.0.2.0
netmask 255.255.255.0
router  10.0.2.1</PRE
>

El router tiene la direcci√≥n 172.19.20.21 en la red C.
Llamemos a esta red netb (seguimos con nuestra originalidad)</P
><P
>Hasta donde concierne a la red C, asumiremos que dejar√° pasar los paquetes
enviados de A a B y vicebersa. C√≥mo y por qu√©, no nos interesa.</P
><P
>En el router de la red A, haremos lo siguiente:</P
><PRE
CLASS="SCREEN"
>ip tunnel add netb mode gre remote 172.19.20.21 local 172.16.17.18 ttl 255
ip link set netb up
ip addr add 10.0.1.1 dev netb
ip route add 10.0.2.0/24 dev netb</PRE
><P
>Miremos esto con m√°s atenci√≥n. En la l√≠nea 1, hemos a√±adido un dispositivo
de t√∫nel, y le hemos llamado netb (bastante obvio porque es a donde
queremos llegar). M√°s a√∫n, le hemos dicho que use el protocolo GRE (mode
gre), que la direcci√≥n remota es 172.19.20.21 (el router en el otro
extremo), que nuestros paquetes de t√∫nel deber√≠an ser originados por
172.16.17.18 (lo que permite a nustro router tener varias direcciones IP
en la red C y decidir cual usar para el tunelizado) y que el campo TTL del
paquete deber√≠a establecerse en 255 (ttl 255).</P
><P
>La segunda l√≠nea habilita el dispositivo.</P
><P
>En la tercera l√≠nea le hemos dado a la reci√©n nacida interfaz netb la
direcci√≥n 10.0.1.1. Esto est√° bien para redes peque√±as, pero cuando
empiece una expedici√≥n de zapadores (MUCHOS t√∫neles), quiz√° debiera
considerar usar otro rango de IP para las interfaces de t√∫neles (en este
ejemplo, podr√≠a usar 10.0.3.0).</P
><P
>En la cuarta l√≠nea hemos establecido la ruta hacia la red B. F√≠jese la
notaci√≥n diferente para la m√°scara de red. Si no est√° familiarizado con
esta notaci√≥n, as√≠ es como funciona: escriba la m√°scara de red en forma
binaria, y cuente todos los unos. Si no sabe c√≥mo hacerlo, lim√≠tese a
recordar que 255.0.0.0 es /8, 255.255.0.0 es /16 y 255.255.255.0 es /24.
Ah, y 255.255.254.0 es /23, en caso de que tuviera curiosidad.</P
><P
>Pero ya hemos tenido bastante de esto; veamos el router de la red B.

<PRE
CLASS="SCREEN"
>ip tunnel add neta mode gre remote 172.16.17.18 local 172.19.20.21 ttl 255
ip link set neta up
ip addr add 10.0.2.1 dev neta
ip route add 10.0.1.0/24 dev neta</PRE
>

Y cuando vaya a eliminar el t√∫nel del router A:

<PRE
CLASS="SCREEN"
>ip link set netb down
ip tunnel del netb</PRE
>

Por supuesto, puede cambiar netb por neta para el router B.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN367"
>5.3.2. T√∫neles IPv6</A
></H3
><P
>Vea la secci√≥n 6 si quiere una peque√±a introducci√≥n a las direcciones
IPv6.</P
><P
>Vamos con los t√∫neles.</P
><P
>Asumamos que tiene la siguiente red IPv6, y que quiere conectarse a la
6bone, o con un amigo.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>Red 3ffe:406:5:1:5:a:2:1/96</PRE
>

Su direcci√≥n IPv4 es 172.16.17.18, y el router 6bone tiene la direcci√≥n
IPv4 172.22.23.24.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>ip tunnel add sixbone mode sit remote 172.22.23.24 local 172.16.17.18 ttl 255
ip link set sixbone up
ip addr add 3ffe:406:5:1:5:a:2:1/96 dev sixbone
ip route add 3ffe::/15 dev sixbone </PRE
>&#13;</P
><P
>Vamos a comentar esto. En la primera l√≠nea, hemos creado un dispositivo de
t√∫nel llamado sixbone. Le hemos dado modo sit (que es un t√∫nel IPv6 sobre
IPv4) y le dijimos d√≥nde debe ir (remote) y de d√≥nde viene (local). TTL se
pone al m√°ximo, 255. Despu√©s activamos el dispositivo (up). Tras esto,
a√±adimos nuestra propia direcci√≥n de red, y establecemos una ruta para
3ffe::/15 (que actualmente es la totalidad de la 6bone) a trav√©s del
t√∫nel.</P
><P
>Los t√∫neles GRE son actualmente el tipo preferido de t√∫neles. Es un
est√°ndar que est√° ampliamente adoptado fuera de la comunidad de Linux, y
por tanto una Cosa Buena.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.TUNNEL.USERLAND"
>5.4. T√∫neles en espacio de usuario</A
></H2
><P
>Literalmente, hay docenas de implementaciones de t√∫neles fuera del n√∫cleo.
Los m√°s conocidos por supuesto son PPP y PPTP, pero hay mucho m√°s (algunos
propietarios, algunos seguros, otros que ni siquiera usan IP) y que
realmente est√°n m√°s all√° del √°mbito de este C√≥mo.</P
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.IPV6-TUNNEL"
></A
>Cap√≠tulo 6. T√∫neles IPv6 con Cisco o la 6bone</H1
><P
>Por Marco Davids &lt;marco@sara.nl&gt;</P
><P
>NOTA al mantenedor:</P
><P
>Hasta donde s√©, estos t√∫neles IPv6-IPv4 no son por definici√≥n t√∫neles GRE.
Podr√≠a tunelizar IPv6 sobre IPv4 mediante dispositivos GRE (GRE tuneliza
CUALQUIER cosa sobre IPv4), pero el dispositivo que se usa qu√≠ (¬´sit¬ª)
s√≥lo tuneliza IPv6 sobre IPv4 y por lo tanto es algo diferente.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.TUNNEL-IPV6.ADDRESSING"
>6.1. T√∫neles IPv6</A
></H2
><P
>Esta es otra aplicaci√≥n de las capacidades para tunelizado de Linux. Es
popular entre la gente que ha adoptado IPv6 tempranamente, o pioneros, si
lo prefiere. El ejemplo pr√°ctico descrito m√°s adelante no es, ciertamente,
la √∫nica manera de hacer t√∫neles IPv6. Sin embargo, es el m√©todo que se
usa a menudo para hacer t√∫neles entre Linux y un router Cisco con
posibilidades de IPv6 y la experiencia nos dice que tras lo que mucha
gente anda. Apuesto 10 a 1 a que esto se aplica a usted tambi√©n ;-)</P
><P
>Notas breves sobre las direcciones IPv6:</P
><P
>Las direcciones IPv6 son, comparadas con las IPv4, realmente grandes: 128
bits frente a 32. Y nos proporciona justo lo que necesitamos: muchas,
muchas direcciones IP:
340.282.266.920.938.463.463.374.607.431.768.211.465, para ser precisos.
Aparte de esto, se supone que IPv6 (o IPng, de IP Next Generation) traer√°
una reducci√≥n el tama√±o de las tablas de rutas de los router principales
de Internet, una configuraci√≥n m√°s sencilla para el equipamiento, mejor
seguridad en el nivel de IP y mejor soporte para QoS (calidad de
servicio).</P
><P
>Un ejemplo: 2002:836b:9820:0000:0000:0000:836b:9886</P
><P
>Escribir direcciones IPv6 puede ser una gran molestia. Por tanto, nos
facilitaremos la vida siguiendo algunas reglas:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>No use ceros sin significado (a la izquierda). Igual que hace en IPv4.&#13;</P
></LI
><LI
><P
>Use dos puntos (:) para separara cada grupo de 16 bits o dos bytes.&#13;</P
></LI
><LI
><P
>Cuando tenga muchos ceros consecutivos,
puede abreviarlos con ::. S√≥lo puede hacer esto una vez por cada
direcci√≥n, y s√≥lo en grupos de 16 bits.</P
></LI
></UL
>&#13;</P
><P
>La direcci√≥n 2002:836b:9820:0000:0000:0000:836b:9886 puede escribirse
2002:836b:9820::836b:9886, que es algo m√°s sencilla.</P
><P
>En otro ejemplo, la direcci√≥n 3ffe:0000:0000:0000:0000:0020:34A1:F32C
puede simplificarse como 3ffe::20:34A1:F32C, que es mucho m√°s corta.</P
><P
>Se pretende que IPv6 sea el sucesor de la actual IPv4. Debido a que es una
tecnolog√≠a relativamente nueva, no hay ninguna red mundial IPv6 nativa.
Se est√° introduciendo la 6bone para posibilitar la aceleraci√≥n del cambio.</P
><P
>Las redes IPv6 nativas se conectan unas a otras encapsulando el protocolo
IPv6 en paquetes IPv4 y envi√°ndolos mediante la infraestructura IPv4 ya
existente desde un sitio IPv6 a otro.</P
><P
>Aqu√≠ es justo donde entran los t√∫neles.</P
><P
>Para poder usar IPv6, deber√≠amos tener un n√∫cleo que lo admita. Hay muchos
documentos buenos sobre c√≥mo conseguirlo. Pero todo se reduce a unos pocos
pasos:

<P
></P
><UL
><LI
><P
>Obtenga una distribuci√≥n Linux reciente, con una glibc adecuada.</P
></LI
><LI
><P
>Luego, consiga una fuente actualizada del n√∫cleo.</P
></LI
></UL
>

Si lo tiene todo, puede seguir adelante y compilar un n√∫cleo con
capacidades de IPv6:

<P
></P
><UL
><LI
><P
>Vaya a /usr/src/linux y escriba:</P
></LI
><LI
><P
>make menuconfig</P
></LI
><LI
><P
>Escoja ¬´Networking Options¬ª</P
></LI
><LI
><P
>Marque ¬´The IPv6 protocol¬ª, ¬´IPv6: enable EUI-64 token format¬ª, ¬´IPv6:
disable provider based addresses¬ª</P
></LI
></UL
>

CONSEJO: No use la opci√≥n de m√≥dulo. A menudo no funciona bien.</P
><P
>En otras palabras, compile IPv6 dentro del n√∫cleo.
Una vez hecho esto, guarde su configuraci√≥n y compile el n√∫cleo.</P
><P
>CONSEJO: Antes de hacerlo, considere la posibilidad de editar el Makefile:
EXTRAVERSION = -x ; --&#62; ; EXTRAVERSION = -x-IPv6</P
><P
>Hay un mont√≥n de documentaci√≥n sobre c√≥mo compilar e instalar un n√∫cleo,
sin embargo este documento se refiere a otras cosas. Si tiene problemas en
esta etapa, vaya a buscar algo de documentaci√≥n sobre la compilaci√≥n del
n√∫cleo de acuerdo con sus propias especificaciones.</P
><P
>El fichero /usr/src/linux/README podr√≠a ser un buen sitio donde empezar.
Tras haber hecho todo esto, y reiniciado con su nuevo n√∫cleo, puede que
quiera ejecutar "/sbin/ifconfig -a" y ver el nuevo "sit0-device". SIT
significa Simple Internet Transition. Puede felicitarse a s√≠ mismo; ahora
est√° un paso m√°s cerca de IP, la Pr√≥xima Generaci√≥n ;-)</P
><P
>Ahora vamos con el siguiente paso. Quiere conectar su m√°quina, o incluso
su LAN entera a otras redes que puedan trabajar con IPv6. Puede ser la
¬´6bone¬ª, que est√° configurada especialmente para este prop√≥sito particular.</P
><P
>Asumamos que tiene la siguiente red IPv6: 3ffe:604:6:8::/64 y que quiere
conectar con la 6bone, o con un amigo. F√≠jese que la notaci√≥n /64 de
subred funciona igual que con cualquier direcci√≥n IP normal.</P
><P
>Su direcci√≥n IPv4 es 145.100.24.181 y el router de 6bone tiene la
direcci√≥n IPv4 145.100.1.5</P
><PRE
CLASS="SCREEN"
># ip tunnel add sixbone mode sit remote 145.100.1.5 [local 145.100.24.181 ttl 255]
# ip link set sixbone up
# ip addr add 3FFE:604:6:7::2/126 dev sixbone
# ip route add 3ffe::0/16 dev sixbone</PRE
><P
>Comentemos esto. En la primera l√≠nea, hemos creado un dispositivo de t√∫nel
llamado sixbone. Le hemos dado el modo sit (que es tunelizado IPv6 sobre
IPv4) y le hemos dicho d√≥nde debe ir (remote) y de d√≥nde viene (local). El
TTL se establece al m√°ximo, 255.</P
><P
>Despu√©s activamos el dispositivo (up). Tras esto, a√±adimos nuestra propia
direcci√≥n de red, y establecemos una ruta para 3ffe::/15 (que actualmente
es la totalidad de la 6bone) a trav√©s del t√∫nel. Si la m√°quina en la que
trabaja es su pasarela IPv6, quiz√° le interesa a√±adir estas l√≠neas:</P
><PRE
CLASS="SCREEN"
># echo 1 &#62;/proc/sys/net/ipv6/conf/all/forwarding
# /usr/local/sbin/radvd</PRE
><P
>En la √∫ltima arrancamos radvd, que es (como zebra) un demonio anunciador
de rutas, para dar soporte a las capacidades de autoconfiguraci√≥n de IPv6.
B√∫squelo en su motor de b√∫squeda favorito si lo desea.
Puede comprobar las cosas as√≠:</P
><PRE
CLASS="SCREEN"
># /sbin/ip -f inet6 addr</PRE
><P
>Si tiene radvd ejecut√°ndose en la pasarela IPv6 y arranca una m√°quina
Linux con capacidades IPv6 en su LAN, podr√° disfrutar de los beneficios de
la autoconfiguraci√≥n de IPv6:</P
><PRE
CLASS="SCREEN"
># /sbin/ip -f inet6 addr
1: lo: &lt;LOOPBACK,UP&gt; mtu 3924 qdisc noqueue inet6 ::1/128 scope host

3: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
inet6 3ffe:604:6:8:5054:4cff:fe01:e3d6/64 scope global dynamic
valid_lft forever preferred_lft 604646sec inet6 fe80::5054:4cff:fe01:e3d6/10 
scope link</PRE
><P
>Podr√≠a ir m√°s all√° y configurar el programa bind para que trabaje con
direcciones IPv6. El tipo A tiene un equivalente para IPv6: AAAA. El
equivalente de in-addr.arpa es: ip6.int. Hay mucha informaci√≥n disponible
sobre este tema.</P
><P
>Hay disponible un n√∫mero creciente de aplicaciones que pueden trabajar con
IPv6, incluyendo secure shell, telnet, inetd, el navegador Mozilla, el
servidor web Apache y muchos otros. Pero se sale del √°mbito de este
documento sobre Rutado ;-)</P
><P
>Por el lado del Cisco la configuraci√≥n deber√≠a parecerse a esto:

<PRE
CLASS="SCREEN"
>!
interface Tunnel1
description IPv6 tunnel
no ip address
no ip directed-broadcast
ipv6 address 3FFE:604:6:7::1/126
tunnel source Serial0
tunnel destination 145.100.24.181
tunnel mode ipv6ip
!
ipv6 route 3FFE:604:6:8::/64 Tunnel1</PRE
>

Pero si no tiene un Cisco a su disposici√≥n, pruebe uno de los muchos
proveedores de t√∫neles IPv6 disponibles en Internet. Est√°n deseando
configurar su Cisco con un t√∫nel extra para usted. La mayor√≠a lo hacen
mediante una interfaz web amigable. Busque ¬´ipv6 tunnel broker¬ª en su
buscador favorito.</P
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.IPSEC"
></A
>Cap√≠tulo 7. IPsec: IP segura sobre Internet</H1
><P
>      Hoy d√≠a hay dos tipos de IPSEC disponibles para Linux. Para 2.2 y
      2.4, existe FreeS/WAN, que es la primera gran implementaci√≥n. Tienen 
      <A
HREF="/web/20040611091246/http://www.freeswan.org/"
TARGET="_top"
>un sitio oficial</A
> y
      se mantiene <A
HREF="/web/20040611091246/http://www.freeswan.ca/"
TARGET="_top"
>otro no
      oficial</A
>. Tradicionalmente, no se ha juntado FreeS/WAN con el
      n√∫cleo principal por varias razones. Las mencionadas m√°s a menudo
      son problemas "pol√≠ticos" por la posibilidad de que habiendo
      americanos (de EEUU) trabajando en cifrado, pueda comprometerse su
      exportabilidad. M√°s a√∫n, no se integra muy bien con el n√∫cleo de
      Linux, lo que le hace mal candidato para una fusi√≥n.
    </P
><P
>      Adem√°s, <A
HREF="/web/20040611091246/http://www.edlug.ed.ac.uk/archive/Sep2002/msg00244.html"
TARGET="_top"
>muchas</A
>
      personas <A
HREF="/web/20040611091246/http://lists.freeswan.org/pipermail/design/2002-November/003901.html"
TARGET="_top"
>han
      expresado sus reservas</A
> sobre la calidad del c√≥digo. Para
      configurar FreeS/WAN, <A
HREF="/web/20040611091246/http://www.freeswan.org/doc.html"
TARGET="_top"
>dispone</A
> de un mont√≥n
      de <A
HREF="/web/20040611091246/http://www.freeswan.ca/docs/freeswan-1.99/doc/index.html"
TARGET="_top"
>documentaci√≥n</A
>.
    </P
><P
>      Desde Linux 2.5.47, hay una implementaci√≥n nativa de IPSEC en el
      n√∫cleo. Fue escrita por Alexey Kuznetsov y Dave Miller, inspirados
      por el trabajo del grupo USAGI IPv6. Con su inclusi√≥n en el n√∫cleo,
      tambi√©n se integr√≥ la CryptoAPI de James Morris (que hace la parte
      de cifrado).
    </P
><P
>      Este COMO s√≥lo documentar√° la versi√≥n 2.5+ de IPSEC. Recomendamos
      FreeS/WAN por ahora para los usuarios de Linux 2.4, pero tenga en
      cuenta que su configuraci√≥n difiere de la de IPSEC nativo.
      Relacionado con esto, ahora existen <A
HREF="/web/20040611091246/http://gondor.apana.org.au/~herbert/freeswan/"
TARGET="_top"
>parches</A
>
      para hacer que el c√≥digo de espacio de usuario de FreeS/WAN funcione
      con el IPSEC nativo de Linux.
    </P
><P
>	Desde 2.5.49, IPSEC funciona sin necesidad de parches.
	</P
><P
>      <DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/note.gif"
HSPACE="5"
ALT="Nota"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>	  Parece que hay herramientas disponibles <A
HREF="/web/20040611091246/http://sourceforge.net/projects/ipsec-tools"
TARGET="_top"
>aqu√≠</A
>.
	  Se dispone de varios programas, siendo el que enlazamos basado
	  en Racoon.
	</P
><P
>	Cuando compile el n√∫cleo, aseg√∫rese de activar "PF_KEY", "AH",
	"ESP" y ¬°todo lo que hay en CryptoAPI!
	</P
></TD
></TR
></TABLE
></DIV
>
      <DIV
CLASS="WARNING"
><P
></P
><TABLE
CLASS="WARNING"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/warning.gif"
HSPACE="5"
ALT="Aviso"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>	  ¬°El autor de este cap√≠tulo es un completo incompetente con
	  IPSEC! Si encuentra los inevitables errores, por favor
	  com√©nteselo a bert hubert <CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:ahu@ds9a.nl"
>ahu@ds9a.nl</A
>&#62;</CODE
>.
	</P
></TD
></TR
></TABLE
></DIV
>
    </P
><P
>      Primero, vamos a mostrar c√≥mo establecer de forma manual
      comunicaci√≥n segura entre dos m√°quinas. Gran parte de este proceso
      se puede automatizar, pero veremos c√≥mo hacerlo a mano para
      familiarizarnos con lo que pasa "entre bambalinas".
    </P
><P
>	Puede saltarse la siguiente secci√≥n si s√≥lo est√° interesado en el
	intercambio autom√°tico de claves (automatic keying), pero tenga en
	cuenta que tener conocimientos sobre el intercambio manual es
	√∫til.
    </P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPSEC.INTRO"
>7.1. Introducci√≥n al intercambio manual de claves</A
></H2
><P
>	IPSEC es un tema complicado. Hay mucha informaci√≥n en la red, pero
	este COMO se concentrar√° en ense√±arle a ponerlo a funcionar y
	explicar los principios b√°sicos. Todos los ejemplos est√°n basados
	en Racoon, que encontrar√° en el enlace anterior.
      </P
><P
>	<DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/note.gif"
HSPACE="5"
ALT="Nota"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>	    ¬°Muchas configuraciones de iptables eliminan paquetes de
	    IPSEC! Para dejar pasar IPSEC, use: "iptables -A xxx -p 50 -j
	    ACCEPT" e "iptables -A xxx -p 51 -j ACCEPT"
	  </P
></TD
></TR
></TABLE
></DIV
>
      </P
><P
>	IPSEC ofrece una versi√≥n segura del Internet Protocol. La
	seguridad en este contexto significa dos cosas diferentes: cifrado
	y autentificaci√≥n.
	Una visi√≥n inocente de la seguridad ofrece s√≥lo cifrado, pero es
	sencillo demostrar que esto es insuficiente: puedes estar
	comunic√°ndote de forma cifrada, pero no hay garant√≠as de que en el
	otro extremo est√© quien t√∫ esperas.
      </P
><P
>	IPSEC admite "Encapsulated Security Payload" (ESP) para el cifrado
	y "Authentication Header" (AH) para autentificar al otro extremo.
	Puede configurarlos ambos, o decidir usar s√≥lo uno.
      </P
><P
>	Tanto ESP como AH dependen de asociaciones de seguridad (security
	associations). Una asociaci√≥n de seguridad (SA) consiste en
	origen, destino y una instrucci√≥n. Un ejemplo de autentificaci√≥n
	por SA podr√≠a ser as√≠:
	<PRE
CLASS="SCREEN"
>	  add 10.0.0.11 10.0.0.216 ah 15700 -A hmac-md5 "1234567890123456";
	</PRE
>
	Esto significa ¬´el tr√°fico que va de 10.0.0.11 a 10.0.0.216 que
	necesita AH puede ser firmado usando HMAC-MD5 usando la clave
	1234567890123456¬ª. Esta instrucci√≥n va etiquetada con el
	identificador SPI ("Security Parameter Index") "15700", hablaremos
	de ello m√°s adelante. La parte interesante sobre los SA es que son
	sim√©tricos. Ambos extremos de una conversaci√≥n comparten
	exactamente el mismo SA; en el otro extremo no encontraremos una
	copia especular. Tenga en cuenta sin embargo que no hay una regla
	"autoreverse": esta SA s√≥lo describe una autentificaci√≥n posible
	desde 10.0.0.11 a 10.0.0.216. Para tener tr√°fico en las dos
	direcciones, hacen falta dos SA.
      </P
><P
>	Un ejemplo de SA ESP:
	<PRE
CLASS="SCREEN"
>add 10.0.0.11 10.0.0.216 esp 15701 -E 3des-cbc "123456789012123456789012";
	</PRE
>
	Aqu√≠ dice que ¬´el tr√°fico que va de 10.0.0.11 a 10.0.0.216 que
	necesita cifrado puede serlo usando 3des-cbc con la clave
	123456789012123456789012¬ª. El identificador SPI es "15701".
      </P
><P
>	Hasta ahora, hemos visto que las SA describen instrucciones
	posibles, pero en realidad no describen normas sobre cu√°ndo se
	deben usar. En realidad, podr√≠a haber un n√∫mero arbitrario de SA
	id√©nticas que s√≥lo difiriesen en sus id SPI. Casualmente, SPI
	significa Security Parameter Index. Para hacer cifrado realmente,
	necesitamos describir una norma (policy). Esta norma puede incluir
	cosas como ¬´usa ipsec si est√° disponible¬ª o ¬´corta el tr√°fico a
	menos que haya ipsec¬ª.
      </P
><P
>	Una Security Policy (SP) t√≠pica podr√≠a parecerse a esto:
	<PRE
CLASS="SCREEN"
>spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
   esp/transport//require
   ah/transport//require;
	</PRE
>
	Si se introduce en el sistema 10.0.0.216, esto quiere decir que
	todo el tr√°fico que vaya hacia 10.0.0.11 debe ir cifrado y
	encapsulado en una cabecera de autentificaci√≥n AH. F√≠jese que no
	se indica qu√© SA ha de usarse; determinar esto se deja como
	ejercicio para el n√∫cleo.
      </P
><P
>	En otras palabras, una Security Policy (norma de seguridad)
	especifica QUE queremos; mientras que una Security Association
	describe COMO lo queremos.</P
><P
>	Los paquetes salientes son etiquetados con el SA SPI ("el c√≥mo")
	que el n√∫cleo use para cifrado y autentificaci√≥n, de manera que el
	otro extremo pueda buscar la instrucci√≥n de verificaci√≥n y
	decodificaci√≥n correspondiente.
      </P
><P
>	Lo que sigue es una configuraci√≥n muy simple para hablar desde la
	m√°quina 10.0.0.216 con la 10.0.0.11 usando cifrado y
	autentificaci√≥n. F√≠jese que el camino inverso (reverse path) es
	texto plano en esta primera versi√≥n, de manera que no deber√≠a usar
	esta configuraci√≥n en producci√≥n.
      </P
><P
>	En la m√°quina 10.0.0.216:
	<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";

spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
   esp/transport//require
   ah/transport//require;
	</PRE
>
      </P
><P
>	En la m√°quina 10.0.0.11, las mismas Security Association, sin
	Security Policy:
	<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";
	</PRE
>
      </P
><P
>	Con esta configuraci√≥n (puede ejecutar los ficheros si tiene
	"setkey" en /sbin), "ping 10.0.0.11" desde 10.0.0.216 deber√≠a dar
	resultados similares a este usando tcpdump:
	<PRE
CLASS="SCREEN"
>22:37:52 10.0.0.216 &gt; 10.0.0.11: AH(spi=0x00005fb4,seq=0xa): ESP(spi=0x00005fb5,seq=0xa) (DF)
22:37:52 10.0.0.11 &gt; 10.0.0.216: icmp: echo reply
	</PRE
>
	F√≠jese en c√≥mo el ping que vuelve de 10.0.0.11 es de hecho visible
	claramente. El ping inicial no lo puede leer tcpdump por supuesto,
	pero muestra el Security Parameter Index de AH y ESP, que le dice
	a 10.0.0.11 c√≥mo verificar la autenticidad de nuestro paquete y
	c√≥mo descrifrarlo.
      </P
><P
>	De todas maneras, hay que mencionar algunas cosas. La
	configuraci√≥n anterior aparece en muchos ejemplos de IPSEC y es
	muy peligrosa. El problema es que lo anterior contiene normas
	sobre c√≥mo deber√≠a tratar 10.0.0.216 los paquetes que van a
	10.0.0.11, y explica c√≥mo deber√≠a tratar 10.0.0.11 estos paquetes,
	¬°pero NO indica a 10.0.0.11 que descarte tr√°fico sin autentificar
	o cifrar!
      </P
><P
>	Cualquiera puede ahora insertar datos falsos y completamente sin
	cifrar y 10.0.0.11 los aceptar√°. Para remediarlo, necesitamos una
	norma de tr√°fico entrante para 10.0.0.11, como sigue:
	<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
spdadd 10.0.0.216 10.0.0.11 any -P IN ipsec
   esp/transport//require
   ah/transport//require;
	</PRE
>
	Esto le dice a 10.0.0.11 que cualquier tr√°fico que venga de
	10.0.0.216 debe tener ESP y AH v√°lidos.
      </P
><P
>	Ahora, para completar esta configuraci√≥n, necesitamos que el
	tr√°fico devuelto sea tambi√©n cifrado y autentificado, por
	supuesto. La configuraci√≥n completa en 10.0.0.216:
	<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
flush;
spdflush;

# AH
add 10.0.0.11 10.0.0.216 ah 15700 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";

# ESP
add 10.0.0.11 10.0.0.216 esp 15701 -E 3des-cbc "123456789012123456789012";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";

spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
           esp/transport//require
           ah/transport//require;

spdadd 10.0.0.11 10.0.0.216 any -P in ipsec
           esp/transport//require
           ah/transport//require;

	</PRE
>
      </P
><P
>	Y en 10.0.0.11:
	<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
flush;
spdflush;

# AH
add 10.0.0.11 10.0.0.216 ah 15700 -A hmac-md5 "1234567890123456";
add 10.0.0.216 10.0.0.11 ah 24500 -A hmac-md5 "1234567890123456";

# ESP
add 10.0.0.11 10.0.0.216 esp 15701 -E 3des-cbc "123456789012123456789012";
add 10.0.0.216 10.0.0.11 esp 24501 -E 3des-cbc "123456789012123456789012";


spdadd 10.0.0.11 10.0.0.216 any -P out ipsec
           esp/transport//require
           ah/transport//require;

spdadd 10.0.0.216 10.0.0.11 any -P in ipsec
           esp/transport//require
           ah/transport//require;

	</PRE
>
      </P
><P
>	F√≠jese que en este ejemplo hemos usado claves id√©nticas para ambas
	direcciones de tr√°fico. Sin embargo, esto no es necesario.
      </P
><P
>	Para comprobar la configuraci√≥n que hemos creado, ejecute
	<B
CLASS="COMMAND"
>setkey -D</B
>, que muestra las asociaciones de
	seguridad, o <B
CLASS="COMMAND"
>setkey -DP</B
> que muestra las normas
	configuradas.
      </P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPSEC.AUTOMATIC.KEYING"
>7.2. Intercambio autom√°tico de claves</A
></H2
><P
>	En la secci√≥n anterior configuramos el cifrado usando secretos
	compartidos (claves compartidas) sencillos. En otras palabras, para
	mantenernos seguros, necesitamos transferir nuestra configuraci√≥n
	de cifrado sobre un canal del que nos fiemos. Si fu√©ramos a
	configurar el otro extremo con telnet, cualquier tercero podr√≠a
	conocer nuestro secreto compartido y la configuraci√≥n no ser√≠a
	segura.
      </P
><P
>	M√°s a√∫n, como nuestro secreto est√° compartido, ya no es secreto.
	El extremo remoto puede hacer poco con nuestra clave, pero
	necesitamos estar seguros de que usamos una clave diferente para
	comunicarnos con todos nuestros colaboradores. Esto precisa un
	gran n√∫mero de claves: si hay 10 partes involucradas, necesitamos
	al menos 50 claves diferentes.
      </P
><P
>	Aparte del problema de la clave sim√©trica, tambi√©n hay necesidad
	de renovar la clave. Si un tercero consigue capturar suficiente
	tr√°fico, podr√≠a estar en situaci√≥n de obtener la clave por
	ingenier√≠a inversa. Esto se previente pasando a nuevas claves de
	vez en cu√°ndo, pero es un proceso que necesita ser automatizado.
      </P
><P
>	Otro problema es que con las claves manuales descritas
	anteriormente definimos exactamente los algoritmos y longitud de
	claves a usar, algo que precisa de un mont√≥n de coordinaci√≥n con
	las partes remotas. Es deseable ser capaz de describir una norma
	de claves m√°s amplia, como ¬´podemos usar 3DES y Blowfish con al
	menos las siguientes longitudes de clave¬ª.
      </P
><P
>	Para resolver estos problemas, IPSEC proporciona Internet Key
	Exchange para intercambiar autom√°ticamente claves generadas al
	azar que se transmiten usando tecnolog√≠a de de cifrado asim√©trico,
	de acuerdo con detalles de algoritmo negociados.
      </P
><P
>	La implementaci√≥n de IPSEC de Linux 2.5 funciona con el demonio
	IKE "racoon" de KAME. Desde el 9 de noviembre, se puede compilar
	la versi√≥n de racoon que acompa√±a a la distribuci√≥n de iptools de
	Alexey, aunque necesitar√° eliminar #include &lt;net/route.h&gt; en
	dos ficheros. De forma alternativa, he proporcionado una
<A
HREF="/web/20040611091246/http://ds9a.nl/ipsec/racoon.bz2"
TARGET="_top"
>versi√≥n precompilada</A
>.
      </P
><P
>	<DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/note.gif"
HSPACE="5"
ALT="Nota"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>		IKE necesita acceso al puerto UDP 500; aseg√∫rese de que
		iptables no lo bloquea.
       	  </P
></TD
></TR
></TABLE
></DIV
>
	</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.IPSEC.KEYING.THEORY"
>7.2.1. Teor√≠a</A
></H3
><P
>		Como se explic√≥ anteriormente, el intercambio autom√°tico
		hace por nosotros un mont√≥n de trabajo. Espec√≠ficamente,
		crea asociaciones de seguridad sobre la marcha. Sin
		embargo, no establece normas por nosotros, que es como
		debe ser.
	</P
><P
>	Por tanto, para beneficiarse de IKE, configure una norma, pero no
	proporcione ninguna SA. Si el n√∫cleo descubre que hay una norma
	IPSEC, pero no una asociaci√≥n de seguridad, se lo dir√° al demonio
	IKE, que entonces intentar√° negociar una.
	</P
><P
>	Reiterando, una Security Policy especifica QUE queremos; una
	Security Association describe COMO lo queremos. Usar el
	intercambio autom√°tico nos permite abstraernos especificando s√≥lo
	qu√© queremos.
	</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.IPSEC.AUTOMATIC.KEYING.EXAMPLE"
>7.2.2. Ejemplo</A
></H3
><P
>	El racoon de Kame viene con una gran cantidad de opciones, la
	mayor√≠a de las cuales tiene valores adecuados por defecto, de
	manera que no necesitamos tocarlos. Como describimos antes, el
	operador necesita definir una norma de seguridad, pero no
	asociaciones de seguridad. Le dejaremos la negociaci√≥n al demonio
	IKE.
	</P
><P
>	En este ejemplo, 10.0.0.11 y 10.0.0.216 van a volver a configurar
	comunicaciones seguras, pero esta vez con la ayuda de racoon. Por
	sencillez esta configuraci√≥n usar√° claves pre-compartidas, los
	temidos ¬´secretos compartidos¬ª. Los certificados X.509 los
	discutimos en una secci√≥n aparte; vea
	<A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.X509"
>Secci√≥n 7.2.3</A
>.</P
><P
> Vamos a ce√±irnos a una configuraci√≥n casi por defecto, id√©ntica en
ambas m√°quinas:
	</P
><P
><PRE
CLASS="SCREEN"
>path pre_shared_key "/usr/local/etc/racoon/psk.txt";

remote anonymous
{
        exchange_mode aggressive,main;
        doi ipsec_doi;
        situation identity_only;

        my_identifier address;

        lifetime time 2 min;   # sec,min,hour
        initial_contact on;
        proposal_check obey;    # obey, strict or claim

        proposal {
                encryption_algorithm 3des;
                hash_algorithm sha1;
                authentication_method pre_shared_key;
                dh_group 2 ;
        }
}

sainfo anonymous
{
        pfs_group 1;
        lifetime time 2 min;
        encryption_algorithm 3des ;
        authentication_algorithm hmac_sha1;
                compression_algorithm deflate ;
}</PRE
>
	</P
><P
>	Un mont√≥n de configuraci√≥n (creo que a√∫n podemos eliminar m√°s para
	acercarnos a la configuraci√≥n por defecto). Pocas cosas a
	resaltar. Hemos preparado dos configuraciones an√≥nimas que sirven
	para todos los extremos remotos, haciendo m√°s sencilla cualquier
	configuraci√≥n posterior. No hay necesidad de entradas diferentes
	por m√°quina, a menos que realmente las queramos.</P
><P
>	M√°s a√∫n, hemos configurado de manera que nos identificamos a
	nosotros mismo bas√°ndonos en la direcci√≥n IP ("my_identifier
	address"), y declaramos que podemos hacer 3des, sha1, y que
	usaremos una clave pre-compartida (pre-shared), que est√° en
	psk.txt.
	</P
><P
>	Ahora en psk.txt, configuraremos dos entradas, que difieren en
	ambas m√°quinas.
En 10.0.0.11:
<PRE
CLASS="SCREEN"
>10.0.0.216      clave2</PRE
>
En 10.0.0.216:
<PRE
CLASS="SCREEN"
>10.0.0.11       clave2</PRE
>
        Make sure these files are owned by root, and set to mode 0600,
racoon will not trust their contents otherwise. Note that these files are
mirrors from eachother.
	Aseg√∫rese de que estos ficheros pertenecen al root, en modo 0600,
	ya que racoon no confiar√° en su contenido de otro modo. F√≠jese en
	que los ficheros son especulares.
	</P
><P
>	Ahora estamos preparados para configurar la norma deseada, que es
	bastante simple. En la m√°quina 10.0.0.216:
<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
flush;
spdflush;

spdadd 10.0.0.216 10.0.0.11 any -P out ipsec
        esp/transport//require;

spdadd 10.0.0.11 10.0.0.216 any -P in ipsec
        esp/transport//require;</PRE
>
Y en 10.0.0.11:
<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
flush;
spdflush;

spdadd 10.0.0.11 10.0.0.216 any -P out ipsec
        esp/transport//require;

spdadd 10.0.0.216 10.0.0.11 any -P in ipsec
        esp/transport//require;</PRE
>
F√≠jese en que de nuevo estas normas son especulares.
	</P
><P
>	¬°Ahora estamos listos para lanzar racoon! Una vez lanzado, en el
	momento que hagamos telnet de 10.0.0.11 a 10.0.0.216, o viceversa,
	racoon empezar√° a negociar:
<PRE
CLASS="SCREEN"
>12:18:44: INFO: isakmp.c:1689:isakmp_post_acquire(): IPsec-SA
  request for 10.0.0.11 queued due to no phase1 found.
12:18:44: INFO: isakmp.c:794:isakmp_ph1begin_i(): initiate new
  phase 1 negotiation: 10.0.0.216[500]&#60;=&#62;10.0.0.11[500]
12:18:44: INFO: isakmp.c:799:isakmp_ph1begin_i(): begin Aggressive mode.
12:18:44: INFO: vendorid.c:128:check_vendorid(): received Vendor ID:
  KAME/racoon
12:18:44: NOTIFY: oakley.c:2037:oakley_skeyid(): couldn't find
  the proper pskey, try to get one by the peer's address.
12:18:44: INFO: isakmp.c:2417:log_ph1established(): ISAKMP-SA
  established 10.0.0.216[500]-10.0.0.11[500]
spi:044d25dede78a4d1:ff01e5b4804f0680
12:18:45: INFO: isakmp.c:938:isakmp_ph2begin_i(): initiate new phase 2
  negotiation: 10.0.0.216[0]&#60;=&#62;10.0.0.11[0]
12:18:45: INFO: pfkey.c:1106:pk_recvupdate(): IPsec-SA established:
  ESP/Transport 10.0.0.11-&#62;10.0.0.216 spi=44556347(0x2a7e03b)
12:18:45: INFO: pfkey.c:1318:pk_recvadd(): IPsec-SA established:
  ESP/Transport 10.0.0.216-&#62;10.0.0.11 spi=15863890(0xf21052)</PRE
></P
><P
>	Si ahora ejecutamos setkey -D, que nos muestra las asociaciones de
	seguridad, las encontraremos:
<PRE
CLASS="SCREEN"
>10.0.0.216 10.0.0.11
        esp mode=transport spi=224162611(0x0d5c7333) reqid=0(0x00000000)
        E: 3des-cbc  5d421c1b d33b2a9f 4e9055e3 857db9fc 211d9c95 ebaead04
        A: hmac-sha1  c5537d66 f3c5d869 bd736ae2 08d22133 27f7aa99
        seq=0x00000000 replay=4 flags=0x00000000 state=mature
        created: Nov 11 12:28:45 2002   current: Nov 11 12:29:16 2002
        diff: 31(s)     hard: 600(s)    soft: 480(s)
        last: Nov 11 12:29:12 2002      hard: 0(s)      soft: 0(s)
        current: 304(bytes)     hard: 0(bytes)  soft: 0(bytes)
        allocated: 3    hard: 0 soft: 0
        sadb_seq=1 pid=17112 refcnt=0
10.0.0.11 10.0.0.216
        esp mode=transport spi=165123736(0x09d79698) reqid=0(0x00000000)
        E: 3des-cbc  d7af8466 acd4f14c 872c5443 ec45a719 d4b3fde1 8d239d6a
        A: hmac-sha1  41ccc388 4568ac49 19e4e024 628e240c 141ffe2f
        seq=0x00000000 replay=4 flags=0x00000000 state=mature
        created: Nov 11 12:28:45 2002   current: Nov 11 12:29:16 2002
        diff: 31(s)     hard: 600(s)    soft: 480(s)
        last:                           hard: 0(s)      soft: 0(s)
        current: 231(bytes)     hard: 0(bytes)  soft: 0(bytes)
        allocated: 2    hard: 0 soft: 0
        sadb_seq=0 pid=17112 refcnt=0</PRE
>
As√≠ como las normas de seguridad que configuramos nosotros mismos:
<PRE
CLASS="SCREEN"
>10.0.0.11[any] 10.0.0.216[any] tcp
        in ipsec
        esp/transport//require
        created:Nov 11 12:28:28 2002 lastused:Nov 11 12:29:12 2002
        lifetime:0(s) validtime:0(s)
        spid=3616 seq=5 pid=17134
        refcnt=3
10.0.0.216[any] 10.0.0.11[any] tcp
        out ipsec
        esp/transport//require
        created:Nov 11 12:28:28 2002 lastused:Nov 11 12:28:44 2002
        lifetime:0(s) validtime:0(s)
        spid=3609 seq=4 pid=17134
        refcnt=3</PRE
></P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN537"
>7.2.2.1. Problemas y defectos conocidos</A
></H4
><P
>		Si esto no funciona, compruebe que todos los ficheros de
		configuraci√≥n pertenecen a root, y que s√≥lo pueden ser
		le√≠dos por root. Para arrancar racoon en primer plano, use
		"-F". Para forzarlo a leer determinado fichero de
		configuraci√≥n, en lugar del especificado al compilar, use
		"-f". Si quiere una cantidad abusiva de detalles, a√±ada
		la sentencia "log debug;" a racoon.conf.
	</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.IPSEC.X509"
>7.2.3. Uso de certificados X.509 para el intercambio autom√°tico de claves</A
></H3
><P
>        As mentioned before, the use of shared secrets is hard because
they
aren't easily shared and once shared, are no longer secret. Luckily, there
is asymmetric encryption technology to help resolve this.
	Como mencionamos antes, el uso de secretos compartidos es dif√≠cil
	porque no son f√°ciles de compartir, y una vez compartidos, dejan
	de ser secretos. Por suerte, hay tecnolog√≠a de cifrado asim√©trico
	que nos ayuda a resolver esto.
	</P
><P
>	Si cada participante en IPSEC crea claves p√∫blica y privada, se
	puede configurar comunicaciones seguras entre ambas partes
	publicando sus claves p√∫blicas y normativa de configuraci√≥n.
	</P
><P
>	Crear una clave es relativamente sencillo, aunque requiere algo de
	trabajo. Lo que sigue se basa en la herramienta "openssl".
	</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN545"
>7.2.3.1. Crear un certificado X.509 para su m√°quina</A
></H4
><P
>	OpenSSL cuenta con mucha infraestructura para claves que pueden
	ser o no firmadas por autoridades de certificaci√≥n. Ahora mismo,
	nos saltaremos toda la infraestructura y practicaremos un poco de
	la vieja seguridad de Snake Oil, y lo haremos sin un certificado
	autorizado.
	</P
><P
>	Primero emitiremos una "petici√≥n de certificado" para nuestra
	m√°quina, llamada "laptop":
<PRE
CLASS="SCREEN"
>$ openssl req -new -nodes -newkey rsa:1024 -sha1 -keyform PEM -keyout \
  laptop.private -outform PEM -out request.pem</PRE
>
Esto nos hace algunas preguntas:
<PRE
CLASS="SCREEN"
>Country Name (2 letter code) [AU]:NL
State or Province Name (full name) [Some-State]:.
Locality Name (eg, city) []:Delft
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Linux Advanced
Routing &#38; Traffic Control
Organizational Unit Name (eg, section) []:laptop
Common Name (eg, YOUR name) []:bert hubert
Email Address []:ahu@ds9a.nl

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:</PRE
>
	Dejamos a su discreci√≥n la forma la completitud con que quiera
	rellenar esto. Puede o no querer poner ah√≠ el nombre de la
	m√°quina, dependiendo en sus necesidades de seguridad. En este
	ejemplo, lo hemos hecho.</P
><P
>	Ahora "autofirmaremos" esta petici√≥n:
<PRE
CLASS="SCREEN"
>$ openssl x509 -req -in request.pem -signkey laptop.private -out \
  laptop.public
Signature ok
subject=/C=NL/L=Delft/O=Linux Advanced Routing &amp; Traffic \
  Control/OU=laptop/CN=bert hubert/Email=ahu@ds9a.nl
Getting Private key</PRE
>
	Ahora podemos descartar el fichero "request.pem".
	</P
><P
>	Repita este procedimiento con todas las m√°quinas para las que
	necesite una clave. Puede distribuir el fichero ".public" con
	impunidad, ¬°pero esconda el fichero ".private"!
	</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN554"
>7.2.3.2. Configuraci√≥n y puesta en marcha</A
></H4
><P
>	Una vez tenermos un par de claves p√∫blica y privada para nuestras
	m√°quinas podemos decirle a racoon que las use.
	</P
><P
>	Volvemos a nuestra configuraci√≥n anterior y las dos m√°quinas,
	10.0.0.11 ("upstairs") y 10.0.0.216 ("laptop")
	</P
><P
>	A√±adimos al fichero <TT
CLASS="FILENAME"
>racoon.conf</TT
> de 10.0.0.11:
<PRE
CLASS="SCREEN"
>path certificate "/usr/local/etc/racoon/certs";

remote 10.0.0.216
{
        exchange_mode aggressive,main;
        my_identifier asn1dn;
        peers_identifier asn1dn;

        certificate_type x509 "upstairs.public" "upstairs.private";

        peers_certfile "laptop.public";
        proposal {
                encryption_algorithm 3des;
                hash_algorithm sha1;
                authentication_method rsasig;
                dh_group 2 ;
        }
}</PRE
>
	Esto le dice a racoon que los certificados los encontrar√° en
	<TT
CLASS="FILENAME"
>/usr/local/etc/racoon/certs/</TT
>. M√°s a√∫n,
	contiene elementos de configuraci√≥n espec√≠ficos para el extremo
	10.0.0.216.
	</P
><P
>	Las l√≠neas "asn1dn" le dicen a racoon que el identificador de los
	extremos tanto local como remoto ser√°n extra√≠dos de las claves
	p√∫blicas. Estos son los "subject=/C=NL/L=Delft/O=Linux Advanced
	Routing &amp; Traffic Control/OU=laptop/CN=bert
	hubert/Email=ahu@ds9a.nl" que vimos en la salida anterior.
	</P
><P
>	La l√≠nea <B
CLASS="COMMAND"
>certificate_type</B
> configura las claves
	p√∫blica y privada. La orden <B
CLASS="COMMAND"
>peers_certfile</B
>
	configura racoon para que lea la clave p√∫blica del extremo remoto
	del fichero <TT
CLASS="FILENAME"
>laptop.public</TT
>.
	</P
><P
>	La entrada <B
CLASS="COMMAND"
>proposal</B
> no ha cambiado con respecto
	a lo que vimos antes, con la excepci√≥n de que
	<B
CLASS="COMMAND"
>authentication_method</B
> ahora es
	<B
CLASS="COMMAND"
>rsasig</B
>, indicando el uso de claves RSA
	p√∫blica/privada para la autentificaci√≥n.
	</P
><P
>	El a√±adido a la configuraci√≥n de 10.0.0.216 es casi id√©ntico,
	excepto por su naturaleza especular habitual:
<PRE
CLASS="SCREEN"
>path certificate "/usr/local/etc/racoon/certs";

remote 10.0.0.11
{
        exchange_mode aggressive,main;
        my_identifier asn1dn;
        peers_identifier asn1dn;

        certificate_type x509 "laptop.public" "laptop.private";

        peers_certfile "upstairs.public";

        proposal {
                encryption_algorithm 3des;
                hash_algorithm sha1;
                authentication_method rsasig;
                dh_group 2 ;
        }
}</PRE
></P
><P
>	Ahora que hemos definido estas sentencias en ambas m√°quinas, s√≥lo
	necesitamos poner en su sitio los ficheros de claves. La m√°quina
	"upstairs" necesita tener <TT
CLASS="FILENAME"
>upstairs.private</TT
>,
	<TT
CLASS="FILENAME"
>upstairs.public</TT
>, y
	<TT
CLASS="FILENAME"
>laptop.public</TT
> en
	<TT
CLASS="FILENAME"
>/usr/local/etc/racoon/certs</TT
>. Aseg√∫rese de que
	este directorio pertenece a root y tiene modo 0700, ¬°o racoon
	rechazar√° leerlo!</P
><P
>La m√°quina "laptop" necesita tener <TT
CLASS="FILENAME"
>laptop.private</TT
>,
<TT
CLASS="FILENAME"
>laptop.public</TT
>, y <TT
CLASS="FILENAME"
>upstairs.public</TT
>
en <TT
CLASS="FILENAME"
>/usr/local/etc/racoon/certs</TT
>. En otras palabras,
cada m√°quina necesita sus propias claves p√∫blica y privada y adem√°s, la
clave p√∫blica de la remota.</P
><P
>	Verifique que existe una Security Policy (ejecute las l√≠neas
	"spdadd" que hay en <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.IPSEC.AUTOMATIC.KEYING.EXAMPLE"
>Secci√≥n 7.2.2</A
>).
	Entonces lance racoon y todo deber√≠a funcionar.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN585"
>7.2.3.3. C√≥mo configurar t√∫neles de forma segura</A
></H4
><P
>        To setup secure communications with a remote party, we must
exchange
public keys. While the public key does not need to be kept a secret, on
the
contrary, it is very important to be sure that it is in fact the unaltered
key. In other words, you need to be certain there is no 'man in the
middle'.
	Para configurar comunicaciones seguras con un extremo remoto,
	debemos intercambiar claves p√∫blicas. Mientras no hace falta
	mantener en secreto la clave p√∫blica, sino al contrario, es muy
	importante asegurarse de que en realidad es la clave sin
	alteraciones. En otras palabras, debe tener la certeza de que no
	hay un "hombre en medio"<A
NAME="AEN588"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#FTN.AEN588"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
>
	</P
><P
>Para facilitarlo, OpenSSL proporciona la orden "digest":
<PRE
CLASS="SCREEN"
>$ openssl dgst upstairs.public
MD5(upstairs.public)= 78a3bddafb4d681c1ca8ed4d23da4ff1</PRE
></P
><P
>	Ahora, todo lo que necesitamos hacer es comprobar si el otro
	participante ve el mismo "digest". Esto se puede hacer
	encontr√°ndose en la vida real, o quiz√° por tel√©fono, ¬°asegur√°ndose
	de que el n√∫mero del otro no se envi√≥ en el mismo mensaje que
	conten√≠a la clave!
	</P
><P
>	Otra manera de hacer esto es usar una Trusted Third Party (un
	tercero de confianza) que tenga una Certificate Authority
	(autoridad certificadore). Esta CA firmar√≠a nuestra clave, la que
	hicimos anteriomente.
	</P
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPSEC.TUNNEL"
>7.3. T√∫neles con IPSEC</A
></H2
><P
>	Hasta ahora, s√≥lo hemos visto IPSEC en el modo llamado de
	"transporte", donde ambos puntos entienden directamente IPSEC.
	Como este no suele ser el caso, es necesario que s√≥lo los routers
	entiendan IPSEC, y que hagan el trabajo para las otras m√°quinas
	tras ellos. A esto se llama "modo t√∫nel".
      </P
><P
>	Configurar esto es facil√≠simo. Para meter en un t√∫nel todo el
	tr√°fico de 130.161.0.0/16 a 10.0.0.216 pasando por 10.0.0.11,
	hacemos lo siguiente en 10.0.0.216:
<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
flush;
spdflush;

add 10.0.0.216 10.0.0.11 esp 34501
        -m tunnel
        -E 3des-cbc "123456789012123456789012";

spdadd 10.0.0.0/24 130.161.0.0/16 any -P out ipsec
           esp/tunnel/10.0.0.216-10.0.0.11/require;</PRE
>
	F√≠jese en el "-m tunnel", ¬°es de vital importancia! Esto configura
	una SA de cifrado ESP entre los extremos del t√∫nel, 10.0.0.216 y
	10.0.0.11.
      </P
><P
>	Lo siguiente es configurar el t√∫nel en s√≠. Se instruye al n√∫cleo
	para que cifre todo el tr√°fico que tiene que encaminar desde
	10.0.0.0/24 a 130.161.0.0. M√°s a√∫n, este tr√°fico tiene que ser
	enviado a 10.0.0.11.
      </P
><P
>	10.0.0.11 tambi√©n necesita algo de configuraci√≥n:
<PRE
CLASS="SCREEN"
>#!/sbin/setkey -f
flush;
spdflush;

add 10.0.0.216 10.0.0.11 esp 34501
        -m tunnel
        -E 3des-cbc "123456789012123456789012";

spdadd 10.0.0.0/24 130.161.0.0/16 any -P in ipsec
           esp/tunnel/10.0.0.216-10.0.0.11/require;</PRE
>
	F√≠jese en que es exactamente id√©ntico, excepto por el cambio de
	"-P out" a "-P in". Igual que con los ejemplos anteriores, ahora
	s√≥lo hemos configurado el tr√°fico en una direcci√≥n. Completar la
	otra parte del t√∫nel se deja como ejercicio al lector.
      </P
><P
>	Otro nombre para esta configuraci√≥n es "proxy ESP", que es algo
	m√°s claro.
      </P
><P
>	<DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/note.gif"
HSPACE="5"
ALT="Nota"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>	    ¬°El t√∫nel IPSEC necesita tener activo IP Forwarding en el
	    n√∫cleo!
	  </P
></TD
></TR
></TABLE
></DIV
>
      </P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPSEC.OTHER"
>7.4. Otro software IPSEC</A
></H2
><P
>	Thomas Walpuski informa que ha escrito un parche para hacer que el
	isakpmd de OpenBSD funcione con el IPSEC de Linux 2.5. Es m√°s, ¬°el
	repositorio principal de CVS de isakpmd ahora contiene este
	c√≥digo! Tiene algunas notas <A
HREF="/web/20040611091246/http://bender.thinknerd.de/~thomas/IPsec/isakmpd-linux.html"
TARGET="_top"
>en
	su p√°gina</A
>.
      </P
><P
>&#13;	isakpmd es bastante diferente del racoon mencionado anteriormente,
	pero a mucha gente le gusta. Podr√° encontrarlo <A
HREF="/web/20040611091246/http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/"
TARGET="_top"
>aqu√≠</A
>.
	Le m√°s sobre el CVS de OpenBSD <A
HREF="/web/20040611091246/http://www.openbsd.org/anoncvs.html"
TARGET="_top"
>aqu√≠</A
>. Thomas tambi√©n ha
	puest un <A
HREF="/web/20040611091246/http://bender.thinknerd.de/~thomas/IPsec/isakmpd.tgz"
TARGET="_top"
>fichero
	tar</A
> a disposici√≥n de aquellos que no se sientan c√≥modos
	con CVS o patch.

      </P
><P
>	M√°s a√∫n, hay parches para hacer que las herramientas de usuario de
	FreeS/WAN trabajen con el IPSEC nativo de Linux 2.5, y podr√°
	encontrarlos <A
HREF="/web/20040611091246/http://gondor.apana.org.au/~herbert/freeswan/"
TARGET="_top"
>aqu√≠</A
>.
    </P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IPSEC.INTEROP"
>7.5. Interoperaci√≥n de IPSEC con otros sistemas</A
></H2
><P
>	FIXME: Escribir esto
      </P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.IPSEC.INTEROP.WIN32"
>7.5.1. Windows</A
></H3
><P
>	Andreas Jellinghaus &lt;aj@dungeon.inka.de&gt; informa: "win2k:
	funciona. clave pre_compartida usando la direcci√≥n ip para
	autentificaci√≥n (no pienso que windows soporte cadenas fqdn o
	userfqdn). Tambi√©n deber√≠an funcionar los certificados, pero no lo
	he probado.".

	</P
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.MULTICAST"
></A
>Cap√≠tulo 8. Enrutado multicast</H1
><P
>FIXME: ¬°Sin editor!</P
><P
>El Multicast-HOWTO es antiguo (relativamente hablando) y por esa raz√≥n
podr√≠a ser poco preciso o incluso una mala gu√≠a en algunos puntos.</P
><P
>Antes de que pueda encaminar tr√°fico multicast, necesita configurar el
n√∫cleo Linux para que admita el tipo de enrutado multicast que desea.
Para esto, a su vez, se necesita que decida qu√© tipo de encaminamiento
multicast espera usar. Esencialmente hay cuatro tipos "comunes": DVMRP (la
versi√≥n Multicast del protocolo RIP unicas), MOSPF (lo mismo pero para
OSPF), PIM-SM ("Protocol Independent Multicasting - Sparse Mode", que
asume que los usuarios de cualquier grupo multicast est√°n esparcidos, en
lugar de concentrados), y PIM-DM (lo mismo, pero en "Modo Denso", que
asume que hay concentraciones significativas de usuarios en el mismo grupo
multicast).</P
><P
>En el n√∫cleo Linux, ver√° que no aparecen estas opciones. Esto es debido a
que el protocolo en s√≠ lo controla una aplicaci√≥n de enrutado, como Zebra,
mrouted o pimd. Sin embargo, a√∫n as√≠ hace falta que tenga una buena idea
de lo que va a usar, para escoger las opciones adecuadas en el n√∫cleo.</P
><P
>Para todo el encaminamiento multicasat, definitivamente necesitar√° activar
¬´multicasting¬ª y ¬´multicast routing¬ª. Esto es suficiente para DVMRP y
MOSPF. Si va a usar PIM, tambi√©n debe activar PIMv1 o PIMv2, dependiendo
de si el tipo de red al que conecta usa la versi√≥n 1 o la 2 del protocolo
PIM.</P
><P
>Una vez tenga preparado todo lo que necesita, y tenga el n√∫cleo de Linux
compilado, podr√° ver que los protocolos IP que se listan durante el
arranque ahora incluyen IGMP. Este protocolo sirve para gestionar grupos
multicast. En el momento de escribir esto, Linux admite s√≥lo las versiones
1 y 2 de IGMP, aunque existe la versi√≥n 3 y ha sido documentada. Esto en
realidad no nos afecta mucho, ya que IGMPv3 todav√≠a es demasiado nueva
como para que sus capacidades extra vayan a ser muy √∫tiles. Como IGMP
trata con grpos, s√≥lo vamos a usar las caracter√≠sticas presentes en la
versi√≥n m√°s sencilla de IGMP sobre grupos enteros. En la mayor√≠a de los
casos encontrar√° IGMPv2, aunque todav√≠a se usa mucho IGMPv1.</P
><P
>Seguimos. Hemos activado multicasting. Ahora, tenemos que decirle al
n√∫cleo de Linux que haga algo con √©l, para poder empezar a encaminar. Esto
significa a√±adir la red virtual Multicast a la tabla del router:</P
><P
>ip route add 224.0.0.0/4 dev eth0</P
><P
>(¬°Asumiendo, por supuesto, que est√° haciendo multicast sobre eth0!
Sustituya el dispositivo por el que haya escogido.)</P
><P
>Ahora, d√≠gale a Linux que reenv√≠e paquetes...</P
><P
>echo 1 &#62; /proc/sys/net/ipv4/ip_forward</P
><P
>En este momento, puede que se est√© preguntando si con esto llegar√° a hacer
algo en alg√∫n momento. Por tanto, para probar nuestra conexi√≥n, haremos
ping al grupo por defecto, 224.0.0.1, para ver si alguien est√° vivo. Todas
las m√°quinas de su LAN con el multicast activo
<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>deber√≠an</I
></SPAN
> responder, pero nadie m√°s. Comprobar√° que
ninguna de las m√°quinas que responden tiene la direcci√≥n IP 224.0.0.1.
¬°Qu√© sorpresa! Esta es una direcci√≥n de grupo (¬´difusi√≥n¬ª o ¬´broadcast¬ª
para suscriptores), y todos los miembros del grupo responder√°n con su
propia direcci√≥n, no con la direcci√≥n de grupo.</P
><P
>ping -c 2 224.0.0.1</P
><P
>En este momento, estamos preparados para hacer el verdadero encaminamiento
de multicast. Bueno, eso asumiendo que tenga dos redes entre las que crear
la ruta.</P
><P
>(¬°Continuar√°!)</P
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.QDISC"
></A
>Cap√≠tulo 9. Disciplinas de colas (qdiscs) para gesti√≥n del ancho de banda</H1
><P
>Cuando descubr√≠ esto, <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>realmente</I
></SPAN
> me impact√≥. Linux
2.2/2.4 viene con todo lo necesario para gestionar el ancho de banda en
formas comparables a los sistemas dedicados de alto nivel para gesti√≥n de
ancho de banda.</P
><P
>Linux va incluso m√°s all√° de lo que proporcionan Frame y ATM.</P
><P
>Para prevenir confusiones, sepa que <B
CLASS="COMMAND"
>tc</B
> usa las
siguientes reglas para la especificaci√≥n de ancho de banda:
 
<PRE
CLASS="LITERALLAYOUT"
>mbps = 1024 kbps = 1024 * 1024 bps =&#62; byte/s
mbit = 1024 kbit =&#62; kilobit/s.
mb = 1024 kb = 1024 * 1024 b =&#62; byte
mbit = 1024 kbit =&#62; kilobit.</PRE
>

Internamente, los n√∫meros se almacenan en bps y b.</P
><P
>Pero cuando <B
CLASS="COMMAND"
>tc</B
> imprime las tasas, usa lo
siguiente:</P
><PRE
CLASS="LITERALLAYOUT"
>1Mbit = 1024 Kbit = 1024 * 1024 bps =&#62; byte/s</PRE
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.QDISC.EXPLAIN"
>9.1. Las colas y disciplinas de cola explicadas</A
></H2
><P
>Con el encolamiento determinamos la manera en que se
<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>ENVIAN</I
></SPAN
> los datos. Es importante darse cuenta de que
s√≥lo podemos dar forma a lo que transmitimos.</P
><P
>De la manera en que trabaja Internet, no tenemos control directo sobre lo
que la gente nos env√≠a. Es un poco como el buz√≥n (¬°f√≠sico!) de su casa. No
hay manera en que pueda influenciar al mundo para modificar la cantidad de
correo que le env√≠an, ya que no puede ponerse en contacto con todo el
mundo.</P
><P
>Sin embargo, la Internet se basa en su mayor√≠a en TCP/IP, que tiene
algunas caracter√≠sticas que nos ayudar√°n. TCP/IP no tiene manera de saber
la capacidad de la red entre dos sistemas, de manera que simplemente
empieza a enviar datos m√°s y m√°s r√°pido (¬´comienzo lento¬ª) y cuando se
empiezan a perder paquetes, porque no hay espacio para enviarlos, reduce
la marcha. En realidad, es un poco m√°s inteligente que todo esto, pero
hablaremos de ello m√°s adelante.</P
><P
>Esto es equivalente a no leer la mitad del correo, y esperar que la gente
deje de envi√°rselo. Con la diferencia de que para Internet, funciona :-)</P
><P
>Si tiene un router y desea evitar que ciertas m√°quinas dentro de su red
descarguen demasiado r√°pido, necesita dar forma (shape) a la interfaz
*interna* del router, la que env√≠a los datos a sus computadores.</P
><P
>Tambi√©n tiene que asegurarse de que controla el cuello de botella del
enlace. Si tiene una NIC de 100Mbit y un router con un enlace de 256kbit,
tiene que asegurarse de que no env√≠a m√°s datos de los que el router puede
manejar. Por otro lado, ser√° el router el que controle el enlace y
ajuste el ancho de banda disponible. Necesitamos ¬´poseer la cola¬ª por
decirlo as√≠, y ser el enlace m√°s lento de la cadena. Por suerte, esto es
muy posible.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.QDISC.CLASSLESS"
>9.2. Disciplinas de cola simples, sin clases</A
></H2
><P
>Como dije, con las disciplinas de cola, cambiamos el modo en que se env√≠an
los datos. Las disciplinas de cola sin clases son aquellas que,
mayormente, aceptan datos y se limitan a reordenarlos, retrasarlos, o
descartarlos.</P
><P
>Esto se puede usar para ajustar el tr√°fico de una interfaz entera, sin
subdivisiones. ¬°Es vital que comprenda esta parte del encolado antes de
que pasemos a los qdisc-contenedores-de-qdiscs con clases!</P
><P
>La disciplina m√°s usada, con mucho, es la qdisc pfifo_fast (se usa por
defecto). Esto tambi√©n explica por qu√© estas caracter√≠sticas avanzadas
son tan robustas. No son m√°s que ¬´simplemente otra cola¬ª.</P
><P
>Cada una de estas colas tiene puntos fuertes y debilidades espec√≠ficos.
Puede que no todas est√©n bien probadas.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN666"
>9.2.1. pfifo_fast</A
></H3
><P
>Esta cola es, como su nombre indica, First In, First Out (el primero que
entra es el primero que sale), lo que significa que ning√∫n paquete recibe
un tratamiento especial. Al menos, no mucho. Esta cola tiene 3 de lo que
llamamos ¬´bandas¬ª. Dentro de cada banda, se aplican las reglas FIFO. Sin
embargo, no se procesar√° la banda 1 mientras haya paquetes esperando en la
banda 0. Lo mismo se aplica para las bandas 1 y 2.</P
><P
>El n√∫cleo obedece la marca llamada Type of Service que hay en los
paquetes, y tiene cuidado de insertar los paquetes de ¬´m√≠nimo retraso¬ª en
la banda 0.</P
><P
>¬°No confunda esta qdisc sencilla y sin clases con la PRIO con clases!
Aunque se comportan de manera similar, la pfifo_fast no tiene clases y no
puede a√±adir otras qdisc a ella con la orden tc.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN671"
>9.2.1.1. Par√°metros y forma de uso</A
></H4
><P
>No puede configurar la qdisc pfifo_fast ya que es el la cola por defecto
fija. As√≠ es como va configurada de serie:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>priomap</DT
><DD
><P
>Determina c√≥mo se corresponden las prioridades de los paquetes, tal como
las asigna el n√∫cleo, a las bandas. La correspondencia se basa en el
octeto TOS del paquete, que es as√≠:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>   0     1     2     3     4     5     6     7
+-----+-----+-----+-----+-----+-----+-----+-----+
|                 |                       |     |
|   PRECEDENCE    |          TOS          | MBZ |
|                 |                       |     |
+-----+-----+-----+-----+-----+-----+-----+-----+</PRE
>&#13;</P
><P
>Los cuatro bits TOS (el ¬´campo TOS¬ª) se define como:

<PRE
CLASS="SCREEN"
>Binary Decimcal  Meaning
-----------------------------------------
1000   8         Minimizar retraso (md)
0100   4         Maximizar transferencia (mt)
0010   2         Maximizar fiabilidad (mr)
0001   1         Minimizar el coste monetario (mmc)
0000   0         Servicio normal</PRE
>&#13;</P
><P
>Como hay 1 bit a la derecha de estos cuatro, el valor real del campo TOS
es el doble del valor de sus bits. Tcpdump -v -v muestra el valor del
campo TOS completo, no s√≥lo sus cuatro bits. Este es el valor que ve en la
primera columna de esta tabla:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>TOS     Bits  Significa                Prioridad Linux   Banda
--------------------------------------------------------------
0x0     0     Servicio normal          0 Mejor esfuerzo  1
0x2     1     Minimizar coste monet.   1 Relleno         2
0x4     2     Maximizar fiabilidad     0 Mejor esfuerzo  1
0x6     3     mmc+mr                   0 Mejor esfuerzo  1
0x8     4     Mazimizar transferencia  2 En masa         2
0xa     5     mmc+mt                   2 En masa         2
0xc     6     mr+mt                    2 En masa         2
0xe     7     mmc+mr+mt                2 En masa         2
0x10    8     Minimizar retrasos       6 Interactivo     0
0x12    9     mmc+md                   6 Interactivo     0
0x14    10    mr+md                    6 Interactivo     0
0x16    11    mmc+mr+md                6 Interactivo     0
0x18    12    mt+md                    4 Int. en masa    1
0x1a    13    mmc+mt+md                4 Int. en masa    1
0x1c    14    mr+mt+md                 4 Int. en masa    1
0x1e    15    mmc+mr+mt+md             4 Int. en masa    1</PRE
>&#13;</P
><P
>Muchos n√∫meros. La segunda columna contiene el valor de los cuatro bits
TOS relevantes, seguidos por su significado traducido. Por ejemplo, el 15
significa que un paquete espera un M√≠nimo coste monetario, la M√°xima
fiabilidad, la M√°xima transferencia Y un Retraso m√≠nimo. Yo llamar√≠a a
esto un ¬´paquete holand√©s¬ª <A
NAME="AEN687"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#FTN.AEN687"
><SPAN
CLASS="footnote"
>[2]</SPAN
></A
>.</P
><P
>La cuarta columna indica la manera en que el n√∫cleo Linux interpreta los
bits del TOS, mostrando qu√© prioridad les asigna.</P
><P
>La √∫ltima columna indica el resultado del priomap por defecto. En la l√≠nea
de √≥rdenes el priomap por defecto se parece a:

<PRE
CLASS="SCREEN"
>1, 2, 2, 2, 1, 2, 0, 0 , 1, 1, 1, 1, 1, 1, 1, 1</PRE
>&#13;</P
><P
>Esto significa que a la prioridad 4, por ejemplo, se asigna la banda
n√∫mero 1. El priomap tambi√©n le permite listar prioridades mayores (&gt;
7) que no se corresponden a asignaciones del TOS, sino que se configuran
por otros medios.</P
><P
>Esta tabla del RFC 1349 (l√©alo para obtener m√°s detalles) le dice c√≥mo
deber√≠an activar las aplicaciones los bits del TOS:

<PRE
CLASS="SCREEN"
>TELNET                   1000           (minimizar retraso)
FTP
	Control          1000           (minimizar retraso)
        Datos            0100           (maximizar transferencia)

TFTP                     1000           (minimizar retraso)

SMTP 
	Fase de √≥rdenes  1000           (minimizar retraso)
        Fase de datos    0100           (maximizar transferencia)

Domain Name Service
	Consulta UDP     1000           (minimizar retraso)
	Consulta TCP     0000
	Transf. de zona  0100           (maximizar transferencia)

NNTP                     0001           (minimizar coste monetario)

ICMP
	Errores          0000
	Peticiones       0000 (la mayor√≠a)
	Respuestas       &#60;igual que las peticiones&#62; (la mayor√≠a)</PRE
>&#13;</P
></DD
><DT
>txqueuelen</DT
><DD
><P
>La longitud de esta cola se obtiene de la configuraci√≥n de la interfaz,
que puede ver y modificar con ifconfig o ip. Para establecer la longitud
de la cola a 10, ejecute: ifconfig eth0 txqueuelen 10</P
><P
>¬°No puede establecer este par√°metro con tc!</P
></DD
></DL
></DIV
></P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN700"
>9.2.2. Token Bucket Filter</A
></H3
><P
>El Token Bucket Filter (TBF) es un qdisc sencillo que se limita a dejar
pasar paquetes que lleguen a una tasa que no exceda una impuesta
administrativamente, pero con la posibilidad de permitir r√°fagas cortas
que excedan esta tasa.</P
><P
>TBF es muy preciso, amigable para la red y el procesador. ¬°Deber√≠a ser su
primera elecci√≥n si s√≥lo quiere ralentizar una interfaz!</P
><P
>La implementaci√≥n de TBF consiste en un b√∫fer (el bucket o balde), que se
llena constatemente con piezas virtuales de informaci√≥n denominadas
tokens, a una tasa espec√≠fica (token rate). El par√°metro m√°s importante
del bucket es su tama√±o, que es el n√∫mero de tokens que puede almacenar.</P
><P
>Cada token que llega toma un paquete de datos entrante de la cola de datos
y se elimina del bucket. Asociar este algoritmo con los dos flujos (tokens
y datos), nos da tres posibles situaciones:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Los datos llegan a TBF a una tasa que es <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>igual</I
></SPAN
> a la
de tokens entrantes. En este caso, cada paquete entrante tiene su token
correspondiente y pasa a la cola sin retrasos.&#13;</P
></LI
><LI
><P
>Los datos llegan al TBF a una tasa <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>menor</I
></SPAN
> a la de los
token. S√≥lo una parte de los tokens se borran con la salida da cada
paquete que se env√≠a fuera de la cola, de manera que se acumulan los
tokens, hasta llenar el bucket. Los tokens sin usar se pueden utilizar
para enviar datos a velocidades mayores de la tasa de tokens, en cuyo caso
se produce una corta r√°faga de datos.</P
></LI
><LI
><P
>Los datos llegan al TBF a una tasa <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>mayor</I
></SPAN
> a la de los
token. Esto signigica que el bucket se quedar√° pronto sin tokens, lo que
causar√° que TBF se acelere a s√≠ mismo por un rato. Esto se llama una
¬´situaci√≥n sobrel√≠mite¬ª. Si siguen llegando paquetes, empezar√°n a ser
descartados.</P
></LI
></UL
>&#13;</P
><P
>Esta √∫ltima situaci√≥n es muy importante, porque permite ajustar
administrativamente al ancho de banda disponible a los datos que est√°n
pasando por el filtro.</P
><P
>La acumulaci√≥n de tokens permite r√°fagas cortas de datos extralimitados
para que pasen sin p√©rdidas, pero cualquier sobrecarga restante causar√°
que los paquetes se vayan retrasando constantemente, y al final sean
descartados.</P
><P
>Tenga en cuenta que en la implementaci√≥n actual, los tokens se
corresponden a bytes, no a paquetes.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN720"
>9.2.2.1. Par√°metros y uso</A
></H4
><P
>Incluso aunque probablemente no necesite hacerle cambios, tbf tiene
algunos controles ajustables. Primero, los par√°metros que estar√°n
disponibles siempre:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>limit o latency</DT
><DD
><P
>Limit es el n√∫mero de bytes que pueden ser encolados a la espera de que
haya tokens disponibles. Tambi√©n puede especificar esto estableciendo el
par√°metro latency, que indica el periodo m√°ximo de tiempo que puede pasar
un paquete en el TBF. Este √∫ltimo c√°lculo tiene en cuenta el tama√±o del
bucket, la tasa y posiblemente el peakrate (la tasa de picos, si es que la
ha configurado).</P
></DD
><DT
>burst/buffer/maxburst</DT
><DD
><P
>Tama√±o del bucket, en bytes. Esta es la m√°xima cantidad de bytes para los
que pueden haber tokens disponibles instant√°neamente. En general, grandes
tasas precisan grandes b√∫feres. Para 10mbit/s sobre Intel, ¬°necesitar√° al
menos un b√∫fer de 10kbyte si desea alcanzar la tasa que ha configurado!</P
><P
>Si el b√∫fer es demasiado peque√±o, se descartar√°n paquetes debido a que
llegan m√°s tokens por tick del temporizador de los que caben en el bucket.</P
></DD
><DT
>mpu</DT
><DD
><P
>Un paquete de tama√±o cero no usa un ancho de banda cero. En ethernet,
ning√∫n paquete usa menos de 64 bytes. La Minimum Packet Unit determina el
uso m√≠nimo de tokens por paquete.</P
></DD
><DT
>rate</DT
><DD
><P
>El ajuste de la velocidad. ¬°Vea las indicaciones hechas anteriormente
sobre la velocidad!</P
></DD
></DL
></DIV
></P
><P
>Si el paquete contiene tokens y se le permite estar vac√≠o, por defecto
tendr√° velocidad infinita. Si esto no es aceptable, use los siguientes
par√°metros:</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>peakrate</DT
><DD
><P
>Si hay tokens disponibles, y llegan paquetes, por defecto se env√≠an
inmediatamente, a ¬´la velocidad de la luz¬ª por decirlo de alguna manera.
Puede que esto no sea lo que usted quiere, especialmente si tiene un
bucket grande.</P
><P
>La tasa de picos se puede usar para especificar cu√°n r√°pido se le permite
al bucket vaciarse. Si est√° haciendo todo seg√∫n el libro, esto se consigue
enviando un paquete, y esperando despu√©s lo suficiente antes de enviar el
siguiente. Hemos calculado nuestras esperas de manera que se env√≠en justo
a la tasa de picos (peakrate).</P
><P
>Sin embargo, debido a la resoluci√≥n por defecto de 10ms del temporizador
de Unix, con paquetes de 10.000 bits de media, ¬°estaremos limitados a una
tasa de picos de 1mbit/s!</P
></DD
><DT
>mtu/minburst</DT
><DD
><P
>La peakrate de 1mbit/s no es muy √∫til si la tasa normal es mayor que √©sa.
Es posible tener una tasa de picos mayor enviando m√°s paquetes por
fracci√≥n del temporizador, ¬°lo que significa de forma efectiva que hemos
creado un segundo bucket!</P
><P
>Este segundo bucket contiene por defecto un √∫nico paquete, por lo que no
es un bucket realmente.</P
><P
>Para calcular la peakrate m√°xima posible, multiplique la mtu configurada
por 100 (o m√°s correctamente, HZ, que es 100 en Intel, y 1024 en Alpha).</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN756"
>9.2.2.2. Configuraci√≥n de ejemplo</A
></H4
><P
>Esta es una configuraci√≥n sencilla pero *muy* √∫til:

<PRE
CLASS="SCREEN"
># tc qdisc add dev ppp0 root tbf rate 220kbit latency 50ms burst 1540</PRE
>&#13;</P
><P
>Ok, ¬øpor qu√© es esto √∫til? Si tiene un dispositivo de red con una cola
grande, como un m√≥dem para DSL o un cable m√≥dem, y quiere comunicarse con
√©l mediante un dispositivo r√°pido, como una interfaz ethernet, se
encontrar√° conque enviar cualquier cosa destruye completamente la
interactividad.</P
><P
>Esto se debe a que enviar datos llena la cola del m√≥dem, que probablamente
es *enorme* porque realmente ayuda a conseguir una buena transferencia de
datos al enviar. Pero esto no es lo que usted quiere; lo que quiere es
tener una cola no tan grande de manera que la interactividad se mantenga
de manera que a√∫n pueda hacer otras cosas mientras env√≠a los datos.</P
><P
>La l√≠nea anterior reduce los env√≠os a una tasa que no lleve formar colas
en el m√≥dem (la cola estar√° en Linux, donde podemos ajustarla a un tama√±o
limitado).</P
><P
>Cambie 220kbit por su velocidad *real* de env√≠o, menos un peque√±o
porcentaje. Si tiene un m√≥dem realmente r√°pido, suba ¬´burst¬ª un poco.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.SFQ"
>9.2.3. Stochastic Fairness Queueing</A
></H3
><P
>Stochastic Fairness Queueing (SFQ) es una implementaci√≥n sencilla de la
familia de algoritmos de colas justas (fair queueing). Es menos preciso
que los otros, pero tambi√©n necesita menos c√°lculos mientras que resulta
ser casi perfectamente justo.</P
><P
>La palabra clave en SFQ es conversaci√≥n (o flujo), que se corresponde en
su mayor√≠a a una sesi√≥n TCP o a un flujo UDP. El tr√°fico se divide en un
n√∫mero bastante grande de colas FIFO, una por cada conversaci√≥n. Entonces
se env√≠a el tr√°fico de una manera parecida a round robin, dando a cada
sesi√≥n por turnos la oportunidad de enviar datos.</P
><P
>Esto lleva a un comportamiento bastante equitativo y evita que una √∫nica
conversaci√≥n ahogue a las dem√°s. SFQ se llama ¬´estoc√°stica¬ª porque
realmente no crea una cola para cada sesi√≥n, sino que tiene un algoritmo
que divide el tr√°fico en un n√∫mero limitado de colas usando un algoritmo
de hash (troceo).</P
><P
>Debido al hash, varias sesiones pueden acabar en el mismo bucket, lo que
dividir√° por dos las posibilidades de cada sesi√≥n de enviar un paquete,
reduciendo a la mitad de esta forma la velocidad efectiva disponible. Para
evitar que esta situaci√≥n acabe siendo detectable, SFQ cambia a menudo su
algoritmo hash de manera que dos sesiones s√≥lo colisionen durante unos
pocos segundos.</P
><P
>¬°Es importante tener en cuenta que SFQ s√≥lo es √∫til en caso de que la
interfaz real de salida est√© realmente llena! Si no lo est√°, entonces la
m√°quina Linux no encolar√° paquetes y no se producir√° efecto alguno. M√°s
tarde describiremos c√≥mo combinar SFQ con otros qdisc para obtener lo
mejor de ambos mundos.</P
><P
>Espec√≠ficamente, configurar SFQ sobre una interfaz ethernet que est√©
apuntando al cable m√≥dem o a un router DSL, ¬°no tiene sentido si no se
hace alg√∫n ajuste m√°s!</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN772"
>9.2.3.1. Par√°metros y uso</A
></H4
><P
>SFQ es mayormente autoajustable:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>perturb</DT
><DD
><P
>Reconfigurar el hash una vez cada estos segundos. Si no se indica, el hash
no se reconfigurar√° nunca. No es recomendable. 10 segundos es
probablemente un buen valor.</P
></DD
><DT
>quantum</DT
><DD
><P
>Cantidad de bytes de un flujo que se permiten sacar de la cola antes de
que le toque el turno a la siguiente cola. Por defecto es 1 paquete de
tama√±o m√°ximo (tama√±o MTU). ¬°No lo ponga por debajo del MTU!</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN784"
>9.2.3.2. Configuraci√≥n de ejemplo</A
></H4
><P
>Si tiene un dispositivo que tenga velocidad de enlace y tasa actual
disponible id√©nticas, como una l√≠nea telef√≥nica, esta configuraci√≥n
ayudar√° a mejorar la equitatividad:

<PRE
CLASS="SCREEN"
># tc qdisc add dev ppp0 root sfq perturb 10
# tc -s -d qdisc ls
qdisc sfq 800c: dev ppp0 quantum 1514b limit 128p flows 128/1024 perturb 10sec 
 Sent 4812 bytes 62 pkts (dropped 0, overlimits 0) </PRE
>&#13;</P
><P
>El n√∫mero 800c: es el n√∫mero de manejador asignado de forma autom√°tica,
limit indica que pueden esperar 128 paquetes en esta cola. Hay 1024
hashbuckets disponibles para la contabilidad, de los cuales puede haber
128 activos al mismo tiempo (¬°no caben m√°s paquetes en la cola!) Los hash
se reconfiguran una vez cada 10 segundos.</P
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.QDISC.ADVICE"
>9.3. Consejos sobre en qu√© momento usar qu√© cola</A
></H2
><P
>Resumiendo, estas son las colas sencillas que realmente gestionan el
tr√°fico reordenando, ralentizando o eliminando paquetes.</P
><P
>Los siguientes consejos pueden ayudarle a escoger qu√© cola usar. Menciona
algunas qdisc descritas en el cap√≠tulo
<I
CLASS="CITETITLE"
><A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.ADV-QDISC"
>Cap√≠tulo 14</A
></I
>.</P
><P
></P
><UL
><LI
><P
>Para simplemente ralentizar el tr√°fico de salida, use el Token Bucket
Filter. Funciona para grandes anchos de banda, si escala el bucket.</P
></LI
><LI
><P
>Si su enlace est√° realmente lleno y quiere asegurarse de que ninguna
sesi√≥n domina el ancho de banda de salida, use Stochastical Fairness
Queueing.</P
></LI
><LI
><P
>Si tiene un backbone grande y sabe lo que est√° haciendo, considere usar
Random Early Drop (vea el cap√≠tulo Avanzado).</P
></LI
><LI
><P
>Para ¬´dar forma¬ª al tr√°fico de entrada que no est√° reenviando, use el
Ingress Policer. El ajuste del tr√°fico de entrada se denomina ¬´policing¬ª,
por cierto, no ¬´shaping¬ª.</P
></LI
><LI
><P
>Si *lo est√°* reenviando, use un TBF en la interfaz hacia la que est√°
redirigiendo los datos. A menos que quiera ajustar el tr√°fico que vaya a
salir por varias interfaces, en cuyo caso el √∫nico factor com√∫n es la
interfaz de entrada. En tal caso, use el Ingress Policer.</P
></LI
><LI
><P
>Si no quiere ajustar, sino ver si su interfaz est√° tan cargada que tiene
una cola, use la cola pfifo (no pfifo_fast). Carece de bandas internas
pero lleva la cuenta del tama√±o de su b√∫fer.</P
></LI
><LI
><P
>Por √∫ltimo, siempre puede usar el <SPAN
CLASS="QUOTE"
>"ajuste social"</SPAN
>.
No siempre es posible usar la tecnolog√≠a para conseguir lo que se quiere.
Los usuarios se toman las limitaciones t√©cnicas como hostilidad.
¬°Una palabra amable tambi√©n puede ayudar a dividir correctamente su ancho
de banda!</P
></LI
></UL
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.QDISC.TERMINOLOGY"
>9.4. Terminolog√≠a</A
></H2
><P
>Para entender correctamente configuraciones m√°s complicadas se necesita
explicar primero algunos conceptos. Debido a la complejidad y la relativa
novedad de este tema, la gente usa un mont√≥n de t√©rminos diferentes cuando
en realidad quieren decir lo mismo.</P
><P
>Lo que sigue se basa remotamente en
<TT
CLASS="FILENAME"
>draft-ietf-diffserv-model-06.txt</TT
>,
<I
CLASS="CITETITLE"
>Un modelo informal de gesti√≥n para routers
Diffserv</I
>.
Actualmente lo puede encontrar en
<A
HREF="/web/20040611091246/http://www.ietf.org/internet-drafts/draft-ietf-diffserv-model-06.txt"
TARGET="_top"
>  http://www.ietf.org/internet-drafts/draft-ietf-diffserv-model-06.txt</A
>.</P
><P
>L√©alo para ver las definiciones estrictas de los t√©rminos usados.
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Disciplina de colas (qdisc)</DT
><DD
><P
>Un algoritmo que controla la cola de un dispositivo, sea de entrada
(ingress) o de salida (egress).</P
></DD
><DT
>qdisc ra√≠z (root qdisc)</DT
><DD
><P
>La qdisc ra√≠z es la que est√° adjunta al dispositivo.</P
></DD
><DT
>Qdisc sin clases</DT
><DD
><P
>Una qdisc sin subdivisiones internas configurables.</P
></DD
><DT
>Qdisc con clases</DT
><DD
><P
>Una qdisc con clases contiene m√∫ltiples clases. Algunas de ellas contienen
otra qdisc, que a su vez puede ser con clases, pero no tiene por qu√©. De
acuerdo con la definici√≥n estricta, pfifo_fast *es* con clases, porque
contiene tres bandas que son, en realidad, clases.  Sin embargo, desde la
perspectiva de configuraci√≥n del usuario, no tiene clases ya que las
clases no se pueden tocar con la herramienta tc.</P
></DD
><DT
>Clases</DT
><DD
><P
>Una qdisc con clases puede tener muchas clases, cada una de las cuales es
interna a ella. A una clase, a su vez, se le pueden a√±adir varias clases.
De manera que una clase puede tener como padre una qdisc u otra clase.

Una clase terminal (o clase "hoja": leaf class) es una clase que no tiene
clases hijas. Esta clase tiene 1 qdisc adjunta. Esta qdisc es responsable
de enviar datos a la clase. Cuando creas una clase, se le adjunta una
qdisc fifo. Cuando a√±ades una clase hija, se elimina esta qdisc. Para
clases terminales, esta qdisc fifo puede ser reemplazada con otra m√°s
adecuada. Incluso se puede reemplazar esta qdisc fifo por otra con clases
de manera que se puedan a√±adir m√°s clases.</P
></DD
><DT
>Clasificador</DT
><DD
><P
>Cada qdisc con clases necesita determinar a qu√© clase necesita enviar un
paquete. Esto se hace usando el clasificador.</P
></DD
><DT
>Filtro</DT
><DD
><P
>La clasificaci√≥n se puede realizar usando filtros. Un filtro contiene
varias condiciones que pueden ser cumplidas.</P
></DD
><DT
>Scheduling (ordenamiento)</DT
><DD
><P
>Una qdisc puede, con la ayuda de un clasificador, decidir que algunos
paquetes necesitan salir antes que otros. Este proceso se denomina
Scheduling, y lo realiza por ejemplo la qdisc qfifo_fast anteriormente
mencionada. El Scheduling tambi√©n se denomina ¬´reordenamiento¬ª, pero esto
es confuso.</P
></DD
><DT
>Shaping (ajuste)</DT
><DD
><P
>El proceso de retrasar paquetes antes de que salgan para hacer que el
tr√°fico sea conforme a una tasa m√°xima configurada. El Shapping se realiza
durante la salida (¬´egress¬ª). Coloquialmente, al descarte de paquetes para
ralentizar el tr√°fico tambi√©n se le suele denominar Shapping.</P
></DD
><DT
>Policing</DT
><DD
><P
>Retrasar o descartar paquetes para que el tr√°fico se mantenga por debajo
de un ancho de banda configurado. En Linux, el ¬´policing¬ª s√≥lo puede
descartar paquetes, no retrasarlo (no hay una ¬´cola de ingreso¬ª - ingress
queue).</P
></DD
><DT
>Conservativa de trabajo</DT
><DD
><P
>Una qdisc conservativa de trabajo (work-conserving) siempre distribuye
paquetes si los hay disponibles. En otras palabras, nunca retrasa un
paquete si el adaptador de red est√° preparado para enviarlo (en el caso de
una qdisc de salida - egress).</P
></DD
><DT
>No conservativa de trabajo</DT
><DD
><P
>Algunas colas, como la Token Bucket Filter, por ejemplo, pueden necesitar
retrasar un paquete durante un cierto tiempo para limitar el ancho de
banda. Esto significa que algunas veces rechazar√°n enviar un paquete,
incluso aunque los haya disponibles.</P
></DD
></DL
></DIV
></P
><P
>Ahora que conocemos la terminolog√≠a, veamos d√≥nde est√°n todas estas cosas.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>       Programas en espacio de usuario
                     ^
                     |
     +---------------+-----------------------------------------+
     |               Y                                         |
     |    -------&#62; Pila IP                                      |
     |   |              |                                      |
     |   |              Y                                      |
     |   |              Y                                      |
     |   ^              |                                      |
     |   |  / ----------&#62; Reenv√≠o -&#62;                           |
     |   ^ /                       |                           |
     |   |/                        Y                           |
     |   |                         |                           |
     |   ^                         Y              /-qdisc1-\   |
     |   |                     Clasificador de   /--qdisc2--\  |
  ---&#62;-&#62; Qdisc de              Salida (Egress)   ---qdisc3---- | -&#62;
     |   Entrada (Ingress)                       \__qdisc4__/  |
     |                                            \-qdiscN_/   |
     |                                                         |
     +----------------------------------------------------------+</PRE
>

Gracias a Jamal Hadi Salim por esta representaci√≥n ASCII.</P
><P
>El gran bloque representa al n√∫cleo. La flecha de la izquierda es el
tr√°fico entrando en la m√°quina desde la red. Entonces se le pasa a la
Qdisc de Entrada que puede aplicar filtros a los paquetes, y decidir
descartarlos. A esto se le llama ¬´Policing¬ª.</P
><P
>Esto ocurre en una etapa muy temprana, antes de que se haya visto mucho
del n√∫cleo. Por tanto, es un buen lugar para descartar tr√°fico sin
consumir mucho tiempo de CPU.</P
><P
>Si se le permite continuar al paquete, puede estar destinado a una
aplicaci√≥n local, en cuyo caso entra en la pila IP para ser procesado, y
se env√≠a a un programa en espacio de usuario. El paquete tambi√©n puede ser
reenviado sin pasar por una aplicaci√≥n, en cuyo caso se destina a la
salida (egress). Los programas de espacio de usuario tambi√©n pueden
distribuir datos, que ser√°n examinados y reenviados por el Clasificador de
Salida.</P
><P
>Ah√≠ es observado y encolado por cualquiera de varias qdisc. En el caso por
defecto, sin configurar, s√≥lo hay instalada una qdisc de salida,
pfifo_fast, que siempre recibe el paquete. A esto se le llama ¬´encolado¬ª
(enqueueing).</P
><P
>Ahora el paquete est√° en la qdisc, esperando a que el n√∫cleo pida que sea
retransmitido por la interfaz de salida. A esto se le llama ¬´desencolado¬ª.</P
><P
>Esta figura tambi√©n funciona en el caso de que haya un √∫nico adaptador de
red (las flechas de entrada y salida al n√∫cleo no se deben tomar demasiado
literalmente). Cada adaptador de red tiene ranuras tanto para entrada como
para salida.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.QDISC.CLASSFUL"
>9.5. Disciplinas de cola con clases</A
></H2
><P
>Las qdisc con clases son muy √∫tiles si tiene diferentes tipos de tr√°fico a
los que quiere dar un tratamiento separado. Una de las qdisc con clases se
denomina ¬´CBQ¬ª, ¬´Class Based Queueing¬ª, y se la menciona tan
frecuentemente que la gente suele identificar el encolado con clases s√≥lo
con CBQ, pero √©ste no es el caso.</P
><P
>CBQ es meramente la que lleva m√°s tiempo (y tambi√©n la m√°s compleja). No
siempre es la que necesita. Esto puede ser un trauma para los partidarios
del ¬´efecto sendmail¬ª, que nos ense√±a que cualquier tecnolog√≠a compleja
que no viene documentada debe ser lo mejor que hay disponible.</P
><P
>En breve diremos m√°s sobre CBQ y sus alternativas.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN882"
>9.5.1. El flujo dentro de las qdisc con clases y sus clases</A
></H3
><P
>Cuando entra tr√°fico dentro de una qdisc con clases, hay que enviarlo a
alguna de las clases que contiene (se necesita ¬´clasificarlo¬ª). Para
determinar qu√© hay que hacer con un paquete, se consulta a los ¬´filtros¬ª.
Es importante saber que los filtros se llaman desde dentro de una qdisc,
¬°y no al rev√©s!</P
><P
>Los filtros asociados a esa qdisc devuelven entonces una decisi√≥n, y la
qdisc la usa para encolar el paquete en una de las clases. Cada subclase
puede probar otros filtros para ver si se imparten m√°s instrucciones. En
caso contrario, la clase  encola el paquete en la qdisc que contiene.</P
><P
>Aparte de contener otras qdisc, la mayor√≠a de las qdisc con clases tambi√©n
realizan ¬´shaping¬ª. Esto es √∫til tanto para reordenar paquetes (con SFQ,
por ejemplo) como para controlar tasas. Necesitar√° esto en caso de tener
una interfaz de gran velocidad (por ejemplo, ethernet) enviando a un
dispositivo m√°s lento (un cable m√≥dem).</P
><P
>Si s√≥lo fuera a usar SFQ, no deber√≠a pasar nada, ya que los paquetes
entrar√≠an y saldr√≠an de su router sin retrasos: la interfaz de salida es
mucho m√°s r√°pida que la velocidad del enlace en s√≠. No habr√° cola que
reordenar.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN888"
>9.5.2. La familia qdisc: ra√≠ces, controladores, hermanos y padres</A
></H3
><P
>Cada interfaz tiene una ¬´qdisc ra√≠z¬ª de salida, que por defecto es la
disciplina de colas pfifo_fast sin clases que mencionamos anteriormente. A
cada qdisc y clase se le asigna un controlador (handle), que puede usar en
posteriores sentencias de configuraci√≥n para referirse a la qdisc. Aparte
de la qdisc de salida, la interfaz tambi√©n puede tener una de entrada, que
dicta las normas sobre el tr√°fico que entra.</P
><P
>Los controladores de estas qdisc consisten en dos partes, un n√∫mero mayor
y un n√∫mero menor: &lt;mayor&gt;:&lt;menor&gt;. Es costumbre darle a la
qdisc de ra√≠z el nombre ¬´1:¬ª, que es lo mismo que ¬´1:0¬ª. El n√∫mero menor
de una qdisc siempre es 0.</P
><P
>Las clases deben tener el mismo n√∫mero mayor que sus padres. Este n√∫mero
mayor tiene que ser √∫nico dentro de una configuraci√≥n de salida o entrada.
El n√∫mero menor debe ser √∫nico dentro de una qdisc y sus clases.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN893"
>9.5.2.1. C√≥mo se usan los filtros para clasificar el tr√°fico</A
></H4
><P
>Recapitulando, una jerarqu√≠a t√≠pica puede ser como √©sta:

<PRE
CLASS="SCREEN"
>                     1: qdisc ra√≠z
                      |
                     1:1   clase hija
                   /  |  \
                  /   |   \
                 /    |    \
              1:10  1:11  1:12   clases hijas
               |      |     |
               |     11:    |    clase terminal
               |            |
               10:         12:   qdisc
              /   \       /   \
           10:1  10:2   12:1  12:2   clases terminales</PRE
>&#13;</P
><P
>¬°Pero no deje que este √°rbol le enga√±e! *No* debe imaginarse que el n√∫cleo
est√° en la cima del √°rbol y la red abajo, ya que no es el caso. Los
paquetes se encolan y desencolan en el qdisc ra√≠z, que es la √∫nica cosa
con la que habla el n√∫cleo.</P
><P
>Un paquete se clasifica en una cadena como √©sta:</P
><P
>1: -&#62; 1:1 -&#62; 12: -&#62; 12:2</P
><P
>Ahora el paquete reside en una cola de una qdisc asociada a la clase 12:2.
En este ejemplo, se asocia un filtro a cada ¬´nodo¬ª del √°rbol, y cada cual
escoge qu√© rama se toma en su paso. Esto puede tener sentido, Sin embargo,
tambi√©n es posible:</P
><P
>1: -&#62; 12:2</P
><P
>En este caso, un filtro asociado a la ra√≠z decidi√≥ enviar el paquete
directamente a 12:2.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN903"
>9.5.2.2. C√≥mo se desencolan los paquetes para enviarlos al hardware</A
></H4
><P
>Cuando el n√∫cleo decide que necesita extraer paquetes para enviarlos a la
interfaz, la qdisc 1: ra√≠z recibe una petici√≥n de desencolar, que se pasa
a 1:1, que a su vez la pasa a 10:, 11:, y 12:, cada una de las cuales
consulta a sus descendientes, e intenta hacer dequeue() sobre ellos. En
este caso, el n√∫cleo necesita recorrer todo el √°rbol, porque s√≥lo 12:2
contiene un paquete.</P
><P
>En breve, las clases anidadas SOLO hablan a sus qdisc paternas, y nunca a
una interfaz. ¬°S√≥lo la qdisc ra√≠z recibe peticiones de desencolado del
n√∫cleo!</P
><P
>La consecuencia de esto es que las clases nunca desencolan m√°s r√°pido de
lo que sus padres permiten. Y esto es exactamente lo que queremos: de esta
manera, podemos tener SFQ como clase interna, que no hace ajustes, s√≥lo
reordena, y tenemos una qdisc externa, que es la que hace los ajustes.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN908"
>9.5.3. La qdisc PRIO</A
></H3
><P
>La qdisc PRIO en realidad no hace ajustes, sino que s√≥lo subdivide el
tr√°fico bas√°ndose en c√≥mo haya configurado los filtros. Puede considerar
la qdisc PRIO como una pfifo_fast con esteroides, en la que cada banda es
una clase separada, en lugar de una simple FIFO.</P
><P
>Cuando se encola un paquete a la qdisc PRIO, se escoge una clase bas√°ndose
en las √≥rdenes de filtrado que haya dado. Por defecto, se crean tres
clases. Estas clases contienen qdisc que son puras FIFO sin estructura
interna, pero puede sustituirlas por cualquier qdisc que haya disponible.</P
><P
>Siempre que se necesite desencolar un paquete, se intenta primero con la
clase :1. Las clases m√°s altas s√≥lo se usan si no se ha conseguido el
paquete en las clases m√°s bajas.</P
><P
>Esta qdisc es muy √∫til en caso de que quiera dar prioridad a cierto
tr√°fico sin usar s√≥lo las marcas TOS sino usando el potencial de los
filtros de tc. Tambi√©n puede contener cualquier qdisc, mientras que
pfifo_fast est√° limitada a qdisc de fifo sencillas.</P
><P
>Como en realidad no hace ajustes, se le aplica el mismo aviso que a SFQ:
√∫sela solamente si el enlace f√≠sico est√° realmente lleno o m√©tala dentro
de una qdisc con clases que haga ajustes. Esto √∫ltimo se aplica a la
mayor√≠a de dispositivos DSL y cable m√≥dems.</P
><P
>Hablando formalmente, la qdisc PRIO es un reorganizador conservativo.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN916"
>9.5.3.1. Par√°metros y uso de PRIO</A
></H4
><P
>tc reconoce los siguientes par√°metros:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>bands</DT
><DD
><P
>N√∫mero de bandas a crear. Cada banda es una clase. Si cambia este n√∫mero,
tambi√©n deber√° cambiar:</P
></DD
><DT
>priomap</DT
><DD
><P
>Si no proporciona filtros de tc para clasificar el tr√°fico, la qdisc PRIO
examina la prioridad TC_PRIO para decidir c√≥mo encolar el tr√°fico.</P
><P
>Esto funciona igual que con la qdisc pfifo_fast mencionada previamente,
refi√©rase a ella si desea m√°s detalles.</P
></DD
></DL
></DIV
>
Las bandas son clases, y todas se llaman de mayor:1 a mayor:3 por defecto,
de manera que si nuestra qdisc PRIO se llama 12:, tc filtrar√° el tr√°fico a
12:1 para garantizar la mayor prioridad.</P
><P
>Repetimos: ¬°la banda 0 va al n√∫mero menor 1! La banda 1 al n√∫mero menor 2,
etc.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN930"
>9.5.3.2. Configuraci√≥n de ejemplo</A
></H4
><P
>Crearemos este √°rbol:

<PRE
CLASS="SCREEN"
>     ra√≠z 1: prio
       /   |   \
     1:1  1:2  1:3
      |    |    |
     10:  20:  30:
     sfq  tbf  sfq
banda 0    1    2</PRE
>&#13;</P
><P
>El tr√°fico masivo ir√° a 30:, el interactivo a 20: o 10:.</P
><P
>L√≠neas de √≥rdenes:

<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 root handle 1: prio 
## Esto crea *instant√°neamente las clases 1:1, 1:2, 1:3
  
# tc qdisc add dev eth0 parent 1:1 handle 10: sfq
# tc qdisc add dev eth0 parent 1:2 handle 20: tbf rate 20kbit buffer 1600 limit 3000
# tc qdisc add dev eth0 parent 1:3 handle 30: sfq                                </PRE
>&#13;</P
><P
>Ahora veamos qu√© hemos creado:

<PRE
CLASS="SCREEN"
># tc -s qdisc ls dev eth0 
qdisc sfq 30: quantum 1514b 
 Sent 0 bytes 0 pkts (dropped 0, overlimits 0) 

 qdisc tbf 20: rate 20Kbit burst 1599b lat 667.6ms 
 Sent 0 bytes 0 pkts (dropped 0, overlimits 0) 

 qdisc sfq 10: quantum 1514b 
 Sent 132 bytes 2 pkts (dropped 0, overlimits 0) 

 qdisc prio 1: bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
 Sent 174 bytes 3 pkts (dropped 0, overlimits 0) </PRE
>

Como puede ver, la banda 0 ya ha tenido algo de tr√°fico, ¬°y se envi√≥ un
paquete mientras ejecut√°bamos la orden!</P
><P
>Ahora vamos a hacer alguna transferencia masiva con una herramienta que
ajuste pertinentemente las marcas TOS, y echemos otro vistazo:

<PRE
CLASS="SCREEN"
># scp tc ahu@10.0.0.11:./
ahu@10.0.0.11's password: 
tc                   100% |*****************************|   353 KB    00:00    
# tc -s qdisc ls dev eth0
qdisc sfq 30: quantum 1514b 
 Sent 384228 bytes 274 pkts (dropped 0, overlimits 0) 

 qdisc tbf 20: rate 20Kbit burst 1599b lat 667.6ms 
 Sent 2640 bytes 20 pkts (dropped 0, overlimits 0) 

 qdisc sfq 10: quantum 1514b 
 Sent 2230 bytes 31 pkts (dropped 0, overlimits 0) 

 qdisc prio 1: bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
 Sent 389140 bytes 326 pkts (dropped 0, overlimits 0) </PRE
>

Como puede ver, todo el tr√°fico fue al controlador 30:, que es la banda de
menor prioridad, tal como esper√°bamos. Ahora, para verificar que el tr√°fico
interactivo va a bandas m√°s altas, crearemos un poco:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc -s qdisc ls dev eth0
qdisc sfq 30: quantum 1514b 
 Sent 384228 bytes 274 pkts (dropped 0, overlimits 0) 

 qdisc tbf 20: rate 20Kbit burst 1599b lat 667.6ms 
 Sent 2640 bytes 20 pkts (dropped 0, overlimits 0) 

 qdisc sfq 10: quantum 1514b 
 Sent 14926 bytes 193 pkts (dropped 0, overlimits 0) 

 qdisc prio 1: bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
 Sent 401836 bytes 488 pkts (dropped 0, overlimits 0) </PRE
>&#13;</P
><P
>Funcion√≥ (todo el tr√°fico adicional se ha ido a 10:, que es nuestra qdisc
de m√°s alta prioridad). No se ha enviado tr√°fico a la de m√°s baja
prioridad, que recibi√≥ anteriormente todo nuestro scp.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN944"
>9.5.4. La famosa qdisc CBQ</A
></H3
><P
>Como se dijo antes, CBQ es la qdisc m√°s compleja disponible, la m√°s
publicitada, la menos comprendida, y probablemente la m√°s dif√≠cil de
configurar correctamente. Esto no se debe a que los autores sean malvados
o incompetentes, ni mucho menos, sino s√≥lo que el algoritmo CBQ no es tan
preciso y realmente no se ajusta del todo a la manera de trabajar de
Linux.</P
><P
>Adem√°s de ser de clases, CBQ tambi√©n es ajustadora (shaper) y es en este
aspecto en el que no funciona del todo bien. Deber√≠a funcionar de esta
manera. Si intenta ajustar a 1mbit/s una conexi√≥n de 10mbit/s, el enlace
deber√≠a estar ocioso el 90% del tiempo. Si no lo est√°, necesitamos
acelerar de manera que realmente ESTE ocioso el 90% del tiempo.</P
><P
>Esto es bastante dif√≠cil de medir, de manera que en su lugar CBQ deriva el
tiempo ocioso del n√∫mero de microsegundos que se tarda entre cada petici√≥n
de m√°s datos por parte de la capa de hardware. Combinados, se pueden usar
para aproximar c√≥mo de lleno o vac√≠o est√° el enlace.</P
><P
>Esto es bastante circunspecto y no siempre lleva a resultados adecuados.
Por ejemplo, ¬øqu√© pasar√≠a si la verdadera velocidad del enlace no es capaz
de transmitir realmente todos los 100mbit/s de datos, quiz√° debido a un
driver mal implementado? Una tarjeta de red PCMCIA tampoco alcanzar√° nunca
los 100mbit/s debido a la manera en que est√° dise√±ado el bus (de nuevo,
¬øc√≥mo calculamos el tiempo?)</P
><P
>Se vuelve a√∫n peor si consideramos dispositivos de red no del todo reales,
como PPP sobre Ethernet o PPTP sobre TCP/IP. El ancho de banda efectivo en
ese caso probablemente se determina por la eficiencia de los canales al
espacio de usuario (que es enorme).</P
><P
>La gente que ha hecho mediciones ha descubierto que CBQ no es siempre muy
preciso, y a veces se pierde del todo.</P
><P
>Sin embargo, en muchas circunstancias funciona bien. Con la documentaci√≥n
que proporcionamos aqu√≠, deber√≠a ser capaz de configurarlo para que
funcione bien en la mayor√≠a de los casos.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN953"
>9.5.4.1. El ¬´shaping¬ª de CBQ en detalle</A
></H4
><P
>Como dije antes, CBQ trabaja asegur√°ndose de que el enlace est√° ocioso
s√≥lo lo necesario para reducir el ancho de banda real hasta la tasa
configurada. Para hacerlo, calcula el tiempo que deber√≠a pasar entre los
paquetes medios.</P
><P
>Mientras opera, se mide el tiempo ocioso efectivo usando una media de
movimiento por exponencial proporcional (EWMA - exponential weighted moving
average), que considera los paquetes recientes exponencialmente m√°s
importantes que los pasados. La media de carga de UNIX (loadaverage) se
calcula de la misma manera.</P
><P
>El tiempo ocioso calculado se resta al medido mediante EWMA, y el n√∫mero
resultante se llama ¬´avgidle¬ª. Un enlace cargado perfectamente tiene un
avgidle de cero: los paquetes llegan exactamente una vez cada intervalo
calculado.</P
><P
>Un enlace sobrecargado tiene un avgidle negativo y si se vuelve muy
negativo, CBQ lo cierra durante un rato y entonces se produce un
¬´sobrel√≠mite¬ª.</P
><P
>Por el contrario, un enlace ocioso puede amasar un avgidle enorme, lo que
permitir√≠a anchos de banda infinitos tras unas horas de silencio. Para
evitarlo, avgidle se trunca en maxidle.</P
><P
>Si hay un sobrel√≠mite, en teor√≠a, la CBQ deber√≠a acelerarse a s√≠ misma
durante exactamente el tiempo que se ha calculado que pasa entre paquetes,
entonces pasa un paquete, y se acelera de nuevo. Pero lea m√°s adelante
sobre el par√°metro ¬´minburst¬ª.</P
><P
>Estos son par√°metros que puede especificar para configurar el ajuste:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>avpkt</DT
><DD
><P
>Tama√±o medio de un paquete, medido en bytes. Se necesita para calcular
maxidle, que se deriva de maxburst, que va especificado en paquetes.</P
></DD
><DT
>bandwidth</DT
><DD
><P
>El ancho de banda f√≠sico de su dispositivo, necesario para c√°lculos de
tiempo ocioso.</P
></DD
><DT
>cell</DT
><DD
><P
>El tiempo que tarda un paquete en ser transmitido sobre un dispositivo
est√° escalonado, y se basa en el tama√±o del paquete. Un paquete de tama√±o
800 y uno de 806 pueden tardar lo mismo en ser enviados, por ejemplo (esto
establece la granularidad). A menudo est√° a "8". Debe ser una potencia
entera de dos.</P
></DD
><DT
>maxburst</DT
><DD
><P
>Este n√∫mero de paquetes se usa para calcular maxidel de manera que cuando
avgidle est√© a maxidel, se puede enviar una r√°faga de esta cantidad de
paquetes medios antes de que avgidle caiga a 0. P√≥ngalo alto si quiere que
sea tolerante a r√°fagas. No puede establecer maxidel directamente, sino
s√≥lo mediante este par√°metro.</P
></DD
><DT
>minburst</DT
><DD
><P
>Como se mencion√≥ previamente, CBQ necesita acelerar en caso de
sobrel√≠mite. La soluci√≥n ideal es hacerlo exactamente durante el tiempo
ocioso calculado, y pasar un paquete. Sin embargo, los n√∫cleos de Unix
normalmente lo pasan mal organizando eventos menores a 10ms, de manera que
es mejor acelerar durante un periodo algo mayor, y hacer pasar entonces
"minburst" paquetes de una s√≥la tanda, para despu√©s dormir "minburst"
veces m√°s.</P
><P
>El tiempo de espera se denomina offtime. Los valores altos de minburst
llevan a ajustes m√°s precisos a largo plazo, pero a r√°fagas m√°s grandes a
escala de milisegundos.</P
></DD
><DT
>minidle</DT
><DD
><P
>Si avgidle est√° por debajo de 0, estaremos en sobrel√≠mite y necesitaremos
esperar hasta que avgidle sea suficientemente grande como para mandar un
paquete. Para prevenir una r√°faga s√∫bita despu√©s de haber detenido el
enlace durante un periodo prolongado, avgidle se reinicia a minidle si cae
demasiado bajo.</P
><P
>Minidle se especifica en microsegundos negativos, de manera que 10
significa que avgidle se corta a -10us.</P
></DD
><DT
>mpu</DT
><DD
><P
>Tama√±o m√≠nimo del paquete (necesario porque incluso los paquetes de tama√±o
cero se rellenan con 64 bytes en ethernet, y por tanto lleva cierto tiempo
transmitirlos). CBQ necesita saber esto para calcular de forma adecuada el
tiempo ocioso.</P
></DD
><DT
>rate</DT
><DD
><P
>La tasa deseada de tr√°fico saliente de esta qdisc (¬°√©ste es el control de
velocidad!)</P
></DD
></DL
></DIV
></P
><P
>Internamente, CBQ tiene un mont√≥n de ajustes m√°s precisos. Por ejemplo,
a las clases que se sabe no contienen datos encolados no se les pregunta.
Se penaliza a las clases sobrelimitadas reduciendo su prioridad efectiva.
Todo muy inteligente y complicado.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN998"
>9.5.4.2. Comportamiento de la CBQ con clases</A
></H4
><P
>Aparte del ajuste, usando las aproximaciones de tiempo ocioso ya
mencionadas, CBQ tambi√©n act√∫a igual que la cola PRIO en el sentido de que
sus clases pueden tener diferentes prioridades y que los n√∫meros peque√±os
de prioridad se examinan antes que los grandes.</P
><P
>Cada vez que la capa de hardware pide un paquete para enviarlo a la red,
se inicia un proceso de round robin por pesos (¬´WRR¬ª), comenzando por las
clases de prioridad con menor n√∫mero.</P
><P
>Estas se agrupan y se les pregunta si tienen datos disponibles. En tal
caso, se devuelven. Despu√©s de que se haya permitido desencolar una serie
de bytes a una clase, se prueba con la siguiente clase de esa misma
prioridad.</P
><P
>Los siguientes par√°metros controlan el proceso WRR:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>allot</DT
><DD
><P
>Cuando se le pide a la CBQ externa un paquete para enviar por la interfaz,
buscar√° por turnos en todas sus qdisc internas (en las clases), en el
orden del par√°metro de ¬´prioridad¬ª. Cada vez que le toca el turno a una
clase, s√≥lo puede enviar una cantidad limitada de datos. ¬´Allot¬ª es la
unidad b√°sica de esta cantidad. Vea el par√°metro ¬´weight¬ª para m√°s
informaci√≥n.</P
></DD
><DT
>prio</DT
><DD
><P
>La CBQ tambi√©n puede actuar como un dispositivo PRIO. Primero se prueba
con las clases internas de mayor prioridad y mientras tengan tr√°fico, no
se mira en las otras clases.</P
></DD
><DT
>weight</DT
><DD
><P
>Weight ayuda en el proceso de Weighted Round Robin. Cada clase tiene una
oportunidad por turnos para enviar. Si tiene una clase con un ancho de
banda significativamente menor que las otras, tiene sentido permitirle
enviar m√°s datos en su ronda que a las otras.</P
><P
>Una CBQ suma todos los pesos bajo una clase, y los normaliza, de manera
que puede usar n√∫meros arbitrarios: s√≥lo son importantes las equivalencias.
La gente viene usando ¬´tasa/10¬ª como regla general y parece que funciona
bien. El peso renormalizado se multiplica por el par√°metro ¬´allot¬ª para
determinar cu√°ntos datos se env√≠an en una ronda.</P
></DD
></DL
></DIV
></P
><P
>¬°Tenga en cuenta que todas las clases dentro de una jerarqu√≠a CBQ
necesitan compartir el mismo n√∫mero mayor!</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN1019"
>9.5.4.3. Par√°metros CBQ que determinan la compartici√≥n y pr√©stamo de
enlaces</A
></H4
><P
>Aparte de meramente limitar determinados tipos de tr√°fico, tambi√©n es
posible especificar qu√© clases pueden tomar prestada capacidad de otras
clases o, al rev√©s, prestar ancho de banda.</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Isolated/sharing</DT
><DD
><P
>Una clase que est√° configurada como ¬´isolated¬ª (aislada) no prestar√° ancho
de banda a sus hermanas. Uselo si tiene varios agentes competidores o
mutuamente hostiles sobre el enlace que no quieren dejarse espacio entre
s√≠.</P
><P
>El programa de control tc tambi√©n conoce el ¬´sharing¬ª, que es lo contrario
que ¬´isolated¬ª.</P
></DD
><DT
>bounded/borrow</DT
><DD
><P
>Una clase tambi√©n puede estar ¬´bounded¬ª (limitada), lo que significa que
no tratar√° de tomar ancho de banda prestado de sus clases hermanas. tc
tambi√©n conoce ¬´borrow¬ª, que es lo contrario de ¬´bounded¬ª.</P
></DD
></DL
></DIV
>
En una situaci√≥n t√≠pica podr√≠amos encontrarnos a dos agentes sobre un
mismo enlace que al mismo tiempo son ¬´isolated¬ª y ¬´bounded¬ª, lo que
significa que est√°n realmente limitadas a sus tasas aisladas, y que no
permitir√°n pr√©stamos entre s√≠.</P
><P
>Junto a tales clases, puede haber otras que tengan permiso de ceder ancho
de banda.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN1034"
>9.5.4.4. Configuraci√≥n de ejemplo</A
></H4
><PRE
CLASS="SCREEN"
>&#13;               1:           qdisc ra√≠z
               |
              1:1           clase hija
             /   \
            /     \
          1:3     1:4       clases terminales
           |       |
          30:     40:       qdisc
         (sfq)   (sfq)</PRE
><P
>Esta configuraci√≥n limita el tr√°fico del servidor web a 5mbit y el SMTP a
3mbit. Juntos, no pueden alcanzar m√°s de 6mbit. Tenemos una NIC de 100mbit
y las clases pueden tomar ancho de banda prestado unas de otras.

<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 root handle 1:0 cbq bandwidth 100Mbit         \
  avpkt 1000 cell 8
# tc class add dev eth0 parent 1:0 classid 1:1 cbq bandwidth 100Mbit  \
  rate 6Mbit weight 0.6Mbit prio 8 allot 1514 cell 8 maxburst 20      \
  avpkt 1000 bounded</PRE
>

Esta parte instala la ra√≠z y la clase convenida 1:1. La clase 1:1 est√°
limitada, de manera que su ancho de banda no puede pasar de 6mbit.</P
><P
>Como se dijo antes, CBQ necesita un *mont√≥n* de ajustes. Todos los
par√°metros quedaron explicados anteriormente, de todas maneras. La
configuraci√≥n HTB correspondiente es mucho m√°s sencilla.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc class add dev eth0 parent 1:1 classid 1:3 cbq bandwidth 100Mbit  \
  rate 5Mbit weight 0.5Mbit prio 5 allot 1514 cell 8 maxburst 20      \
  avpkt 1000                       
# tc class add dev eth0 parent 1:1 classid 1:4 cbq bandwidth 100Mbit  \
  rate 3Mbit weight 0.3Mbit prio 5 allot 1514 cell 8 maxburst 20      \
  avpkt 1000</PRE
>&#13;</P
><P
>Estas son nuestras dos clases terminales. F√≠jese en c√≥mo escalamos el peso
con la tasa configurada. Ninguna clase est√° limitada, pero est√°n conectadas
a la clase 1:1, que s√≠ lo est√°. De manera que la suma de anchos de banda de
las dos clases pasar√° nunca de 6mbit. ¬°Por cierto!, los identificadores de
clase deben estar dentro del mismo n√∫mero mayor que su qdisc madre.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 parent 1:3 handle 30: sfq
# tc qdisc add dev eth0 parent 1:4 handle 40: sfq</PRE
>&#13;</P
><P
>Ambas clases llevan una qdisc FIFO por defecto. Pero las hemos reemplazado
con una cola SFQ de manera que cada flujo de datos sea tratado de igual
forma.

<PRE
CLASS="SCREEN"
># tc filter add dev eth0 parent 1:0 protocol ip prio 1 u32 match ip \
  sport 80 0xffff flowid 1:3
# tc filter add dev eth0 parent 1:0 protocol ip prio 1 u32 match ip \
  sport 25 0xffff flowid 1:4</PRE
>&#13;</P
><P
>Estas √≥rdenes, asociadas directamente a al ra√≠z, env√≠an el tr√°fico a las
qdisc correctas.</P
><P
>F√≠jese que usamos ¬´tc class add¬ª para CREAR clases dentro de una qdisc,
pero que usamos ¬´tc qdisc add¬ª para a√±adir qdiscs a estas clases.</P
><P
>Puede preguntarse qu√© sucede al tr√°fico que no se clasifica en ninguna de
esasa dos reglas. Parecer√≠a que en este caso, los datos ser√°n procesados
dentro de 1:0, y estar√°n sin l√≠mites.</P
><P
>Si el tr√°fico SMTP+web conjunto intenta exceder el l√≠mite impuesto de
6mbit/s, el ancho de banda se dividir√° de acuerdo al par√°metro de peso,
dando 5/8 del tr√°fico al servidor web y 3/8 al servidor de correo.</P
><P
>Con esta configuraci√≥n tambi√©n podemos decir que el tr√°fico del servidor
web tendr√° como m√≠nimo 5/8 * 6 mbit = 3.75 mbit.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN1052"
>9.5.4.5. Otros par√°metros de CBQ: split y defmap</A
></H4
><P
>Como mencion√© anteriormente, una qdisc con clases necesita llamar a los
filtros para determinar en qu√© clase encolar un paquete.</P
><P
>Aparte de llamar al filtro, CBQ ofrece otras opciones: defmap y split. Es
bastante complicado de entender, y no es vital. Pero como √©ste es el √∫nico
sitio conocido donde se explican adecuadamente defmap y split, intentar√©
hacerlo lo mejor posible.</P
><P
>Como es probable que a menudo s√≥lo quiera filtrar el Tipo de Servicio, se
proporciona una sintaxis especial. Cuando CBQ necesita averiguar d√≥nde
encolar un paquete, comprueba si √©ste es un ¬´split node¬ª. Si lo es, una de
las sub-qdisc ha indicado que desea recibir todos los paquetes con una
determinada prioridad, que se podr√≠a derivar del campo TOS, o por
opciones de socket establecidas por las aplicaciones.</P
><P
>Se hace un AND con los bit de prioridad de los paquetes y el campo defmap
para ver si coinciden. En otras palabras, es un atajo para crear filtros
muy r√°pidos, que s√≥lo se ajustan a ciertas prioridades. Un defmap de ff
(hex) coincidir√° con todo, un mapa de 0, con nada. Quiz√° una configuraci√≥n
de ejemplo ayude a aclarar las cosas:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc qdisc add dev eth1 root handle 1: cbq bandwidth 10Mbit allot 1514 \
  cell 8 avpkt 1000 mpu 64
 
# tc class add dev eth1 parent 1:0 classid 1:1 cbq bandwidth 10Mbit    \
  rate 10Mbit allot 1514 cell 8 weight 1Mbit prio 8 maxburst 20        \
  avpkt 1000</PRE
>

Pre√°mbulo est√°ndar de CBQ. ¬°Nunca me acostumbrar√© a la inmensa cantidad de
cosas que necesita!</P
><P
>Defmap se refiere a los bits TC_PRIO, que se definen as√≠:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>TC_PRIO..          Num  Corresponde al TOS
-------------------------------------------------
BESTEFFORT         0    Maximizar fiabilidad
FILLER             1    Minimizar coste
BULK               2    Maximizar transferencia (0x8)  
INTERACTIVE_BULK   4                               
INTERACTIVE        6    Minimizar retrasos (0x10)      
CONTROL            7                               </PRE
>&#13;</P
><P
>El n√∫mero TC_PRIO.. se corresponde a bits, contando desde la derecha. Vea
la secci√≥n pfifo_fast si desea m√°s detalles sobre c√≥mo se convierten los
bits de TOS en prioridades.</P
><P
>Ahora, las clases interactiva y masiva:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc class add dev eth1 parent 1:1 classid 1:2 cbq bandwidth 10Mbit     \
  rate 1Mbit allot 1514 cell 8 weight 100Kbit prio 3 maxburst 20        \
  avpkt 1000 split 1:0 defmap c0

# tc class add dev eth1 parent 1:1 classid 1:3 cbq bandwidth 10Mbit     \
  rate 8Mbit allot 1514 cell 8 weight 800Kbit prio 7 maxburst 20        \
  avpkt 1000 split 1:0 defmap 3f</PRE
>&#13;</P
><P
>La ¬´split qdisc¬ª es la 1:0, que es donde se va a hacer la elecci√≥n. C0 es
el valor binario 11000000, 3F es 00111111, de manera que entre los dos
coinciden con todo. La primera clase coincide con los bits 7 y 6, y por
tanto se corresponde con el tr√°fico ¬´interactivo¬ª y ¬´de control¬ª. La
segunda clase coincide con el resto.</P
><P
>El nodo 1:0 tiene ahora una tabla como √©sta:

<PRE
CLASS="SCREEN"
>prioridad	enviar a
0		1:3
1		1:3
2		1:3
3		1:3
4		1:3
5		1:3
6		1:2
7		1:2</PRE
>&#13;</P
><P
>Si desea m√°s diversi√≥n, tambi√©n puede pasar una ¬´change mask¬ª (m√°scara de
cambio), que indica qu√© prioridades desea cambiar. S√≥lo necesita usar esto
si est√° ejecutando ¬´tc class change¬ª. Por ejemplo, para a√±adir los mejores
esfuerzos al tr√°fico de 1:2, podr√≠a ejecutar esto:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc class change dev eth1 classid 1:2 cbq defmap 01/01</PRE
>&#13;</P
><P
>El mapa de prioridades de 1:0 ahora es as√≠:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>prioridad	enviar a
0		1:2
1		1:3
2		1:3
3		1:3
4		1:3
5		1:3
6		1:2
7		1:2</PRE
>&#13;</P
><P
>FIMXE: no he probado ¬´tc class change¬ª, s√≥lo he mirado los fuentes.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1077"
>9.5.5. Hierarchical Token Bucket</A
></H3
><P
>Martin Devera (&lt;devik&gt;) se dio cuenta de que CBQ es complejo y que
no parece √≥ptimo en varias situaciones t√≠picas. Su enfoque Jer√°rquico se
ajusta bien a configuraciones donde se tiene una cantidad fija de ancho de
banda a dividir para diferentes prop√≥sitos, d√°ndole a cada prop√≥sito un
ancho de banda garantizado, con la posibilidad de especificar cu√°nto ancho
se puede tomar prestado.</P
><P
>HTB funciona igual que CBQ, pero no recurre a c√°lculos de tiempo ocioso
para los ajustes. En su lugar, es un Token Bucket Filter con clases (de
ah√≠ el nombre). S√≥lo tiene unos pocos par√°metros que est√°n bien
documentados en su
<A
HREF="/web/20040611091246/http://luxik.cdi.cz/~devik/qos/htb/"
TARGET="_top"
>sitio</A
>.</P
><P
>Seg√∫n se complique su configuraci√≥n HTB, ver√° que escala bien. ¬°Con CBQ
ya es complejo incluso en casos simples! HTB3 (vea los detalles sobre las
versiones de HTB en
<A
HREF="/web/20040611091246/http://luxik.cdi.cz/~devik/qos/htb/"
TARGET="_top"
>su p√°gina web</A
>) es
ahora parte de las fuentes oficiales del n√∫cleo (desde 2.4.20-pre1 y
2.5.31 en adelante). Sin embargo, quiz√° necesite una versi√≥n de ¬´tc¬ª
parcheada para HTB3: la versi√≥n de las partes del n√∫cleo y espacio de
usuario de HTB3 deben tener el mismo n√∫mero mayor, o ¬´tc¬ª no trabajar√° con
HTB.&#13;</P
><P
>Si ya tiene un n√∫cleo moderno, o est√° en posici√≥n de parchear el n√∫cleo,
considere seriamente usar HTB.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN1085"
>9.5.5.1. Configuraci√≥n de ejemplo</A
></H4
><P
>Funcionalmente es casi id√©ntica a la configuraci√≥n de ejemplo anterior de
CBQ:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 root handle 1: htb default 30

# tc class add dev eth0 parent 1: classid 1:1 htb rate 6mbit burst 15k

# tc class add dev eth0 parent 1:1 classid 1:10 htb rate 5mbit burst 15k
# tc class add dev eth0 parent 1:1 classid 1:20 htb rate 3mbit ceil 6mbit burst 15k
# tc class add dev eth0 parent 1:1 classid 1:30 htb rate 1kbit ceil 6mbit burst 15k </PRE
>&#13;</P
><P
>El autor recomienda SFQ por debajo de estas clases:

<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 parent 1:10 handle 10: sfq perturb 10
# tc qdisc add dev eth0 parent 1:20 handle 20: sfq perturb 10
# tc qdisc add dev eth0 parent 1:30 handle 30: sfq perturb 10</PRE
>
 </P
><P
>A√±ada los filtros que dirigir√°n el tr√°fico a las clases correctas:

<PRE
CLASS="SCREEN"
># U32="tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32"
# $U32 match ip dport 80 0xffff flowid 1:10
# $U32 match ip sport 25 0xffff flowid 1:20</PRE
>

Y esto es todo (nada de n√∫meros desagradables sin explicaci√≥n, ni
par√°metros sin documentar).</P
><P
>Realmente, HTB parece maravilloso (si 10: y 20: tienen ambos su ancho de
banda garantizado, y se deja m√°s a dividir, tomar√°n prestado en una
relaci√≥n de 5:3, tal como cabr√≠a esperar).</P
><P
>El tr√°fico sin clasificar va a parar a 30:, que tiene poco ancho de banda
por s√≠ mismo, pero que puede tomar prestado todo lo que queda. Como hemos
escogido SFQ internamente, ¬°de paso obtendremos equitatividad!</P
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.QDISC.FILTERS"
>9.6. Clasificar paquetes con filtros</A
></H2
><P
>Para determinar qu√© clase deber√° procesar un paquete, se llama a una
¬´cadena clasificadora¬ª cada vez que hay que tomar una decisi√≥n. Esta
cadena consiste en todos los filtros asociados a la qdisc con clases que
debe decidir.</P
><P
>Repitamos el √°rbol, que no es un √°rbol:</P
><PRE
CLASS="SCREEN"
>                    root 1:
                      |
                    _1:1_
                   /  |  \
                  /   |   \
                 /    |    \
               10:   11:   12:
              /   \       /   \
           10:1  10:2   12:1  12:2</PRE
><P
>Cuando encolamos un paquete, se consulta la cadena de filtros para cada
rama para que de las instrucciones relevantes. Una configuraci√≥n t√≠pica
podr√≠a tener un filtro en 1:1 que dirija un paquete a 12:, y uno en 12:
que env√≠e el paquete a 12:2.</P
><P
>Tambi√©n podr√≠a asociar esta √∫ltima regla a 1:1, pero puede ganar
eficiencia haciendo pruebas m√°s espec√≠ficas m√°s abajo en la cadena.</P
><P
>No se puede filtrar un paquete "hacia arriba", por cierto. Adem√°s, con
HTB, ¬°deber√≠a asociar todos los filtros a la ra√≠z!</P
><P
>Y de nuevo: ¬°los paquetes s√≥lo se encolan hacia abajo! Cuando se
desencolan, vuelven hacia arriba, donde est√° la interfaz. ¬°No caen desde
el final del √°rbol directamente al adaptador de red!</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1105"
>9.6.1. Algunos ejemplos sencillos de filtrado</A
></H3
><P
>Como se explic√≥ en el cap√≠tulo del Clasificador, puede hacer coincidencias
con literalmente cualquier cosa, usando una sintaxis bastante complicada.
Para empezar, le mostraremos c√≥mo hacer cosas obvias, que por suerte es
muy sencillo.</P
><P
>Digamos que tenemos una qdisc PRIO llamada ¬´10:¬ª que contiene tres clases,
y queremos asignar todo el tr√°fico desde y hacia el puerto 22 a la banda
de prioridad m√°s alta. Los filtros podr√≠an ser:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth0 protocol ip parent 10: prio 1 u32 match \ 
  ip dport 22 0xffff flowid 10:1
# tc filter add dev eth0 protocol ip parent 10: prio 1 u32 match \
  ip sport 80 0xffff flowid 10:1
# tc filter add dev eth0 protocol ip parent 10: prio 2 flowid 10:2</PRE
>&#13;</P
><P
>¬øQu√© dice esto? Dice: asociar a eth0, nodo 10: un filtro u32 de prioridad
1 que coincide *exactamente* con el puerto IP de destino 22 y enviarlo a la
banda 10:1. Y luego repetimos lo mismo para el puerto de origen 80. La
√∫ltima orden dice que cualquier cosa que no coincida deber√≠a ir a la banda
10:2, la de siguiente prioridad.</P
><P
>Necesita a√±adir ¬´eth0¬ª, o como sea que se llame la interfaz, porque cada
interfaz tiene un espacio de controladores propio.</P
><P
>Para escoger sobre una direcci√≥n IP, use esto:

<PRE
CLASS="SCREEN"
># tc filter add dev eth0 parent 10:0 protocol ip prio 1 u32 \ 
  match ip dst 4.3.2.1/32 flowid 10:1
# tc filter add dev eth0 parent 10:0 protocol ip prio 1 u32 \
  match ip src 1.2.3.4/32 flowid 10:1
# tc filter add dev eth0 protocol ip parent 10: prio 2      \
  flowid 10:2</PRE
>&#13;</P
><P
>Esto asigna el tr√°fico hacia 4.3.2.1 y desde 1.2.3.4 a la cola de m√°s alta
prioridad, y el resto a la de siguiente prioridad.</P
><P
>Puede concatenar coincidencias, para capturar el tr√°fico desde 1.2.3.4,
puerto 80. Se hace as√≠:

<PRE
CLASS="SCREEN"
># tc filter add dev eth0 parent 10:0 protocol ip prio 1 u32 match ip src 4.3.2.1/32
  match ip sport 80 0xffff flowid 10:1</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.FILTERING.SIMPLE"
>9.6.2. Todas las √≥rdenes de filtrado que necesitar√° normalmente</A
></H3
><P
>La mayor√≠a de las √≥rdenes de ajuste que se presentan aqu√≠ empiezan con
√©ste pre√°mbulo:

<PRE
CLASS="SCREEN"
># tc filter add dev eth0 parent 1:0 protocol ip prio 1 u32 ..</PRE
>

Estas son las coincidencias llamadas ¬´u32¬ª, que pueden coincidir con
CUALQUIER parte de un paquete.
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Sobre la direcci√≥n de origen/destino</DT
><DD
><P
>M√°scara de origen ¬´match ip src 1.2.3.0/24¬ª, m√°scara de destino ¬´match ip
dst 4.3.2.0/24¬ª. Para coincidir con una √∫nica m√°quina, use /32 u omita la
m√°scara.</P
></DD
><DT
>Sobre puerto de origen/destino, todos los protocolos de IP</DT
><DD
><P
>Origen: ¬´match ip sport 80 0xffff¬ª, destino: ¬´match ip dport 0xffff¬ª</P
></DD
><DT
>Sobre protocolo IP (tcp, udp, icmp, gre, ipsec)</DT
><DD
><P
>Use los n√∫meros de /etc/protocols. Por ejemplo, icmp es 1: ¬´match ip
protocol 1 0xff¬ª.</P
></DD
><DT
>Sobre fwmark</DT
><DD
><P
>Puede marcar los paquetes tanto con ipchains como con iptables y hacer que
la marca sobreviva al rutado a trav√©s de interfaces. Esto es realmente
√∫til para por ejemplo ajustar el tr√°fico de eth1 s√≥lo si viene de eth0.
Sintaxis:
<PRE
CLASS="SCREEN"
># tc filter add dev eth1 protocol ip parent 1:0 prio 1 handle 6 fw flowid
1:1</PRE
>
¬°F√≠jese que √©sta no es una coincidencia u32!</P
><P
>Puede poner una marca as√≠:

<PRE
CLASS="SCREEN"
># iptables -A PREROUTING -t mangle -i eth0 -j MARK --set-mark 6</PRE
>

El n√∫mero 6 es arbitrario.</P
><P
>Si no desea entender toda la sintaxis de tc, lim√≠tese a usar iptables, y
aprenda s√≥lo a seleccionar sobre fwmark.</P
></DD
><DT
>Sobre el campo TOS</DT
><DD
><P
>Para escoger el tr√°fico interactivo, de retraso m√≠nimo:

<PRE
CLASS="SCREEN"
># tc filter add dev ppp0 parent 1:0 protocol ip prio 10 u32 \
      match ip tos 0x10 0xff \
     flowid 1:4</PRE
>

Use 0x08 0xff para el tr√°fico masivo.</P
></DD
></DL
></DIV
></P
><P
>Si desea ver m√°s √≥rdenes de filtrado, vea el cap√≠tulo de Filtros
avanzados.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.IMQ"
>9.7. El dispositivo intermedio de encolado (IMQ)</A
></H2
><P
>El dispositivo intermedio de encolado (Intermediate queueing device) no es
una qdisc pero su uso est√° muy unido a las qdisc. Dentro de Linux, las
qdisc se asocian a dispositivos de red y todo lo que se encola en el
dispositivo se encola antes en la qdisc. Partiendo de este concepto,
surgen dos limitaciones:</P
><P
>1. S√≥lo se pueden hacer ajustes de salida (existe una qdisc de entrada,
pero sus posibilidades son muy limitadas comparadas a las qdisc con
clases).</P
><P
>2. Una qdisc s√≥lo puede ver el tr√°fico de una interfaz, de manera que no
se pueden imponer limitaciones globales.</P
><P
>IMQ est√° aqu√≠ para resolver ambas limitaciones. En breve, se puede poner
todo lo que se quiera en una qdisc. Los paquetes marcados de forma
especial los interceptan las ranuras NF_IP_PRE_ROUTING y
NF_IP_POST_ROUTING de netfilter y pasan por una qdisc asociada a un
dispositivo imq. Se usa un objetivo de iptables para marcar los paquetes.</P
><P
>Esto permite que haga ajustes de entrada ya que puede marcar los paquetes
que vienen de cualquier sitio o tratar las interfaces como clases para
imponer l√≠mites globales. Tambi√©n puede hacer muchas otras cosas como
poner el tr√°fico http en una qdisc, poner las peticiones de conexiones
nuevas en una qdisc, ...</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1156"
>9.7.1. Configuraci√≥n de ejemplo</A
></H3
><P
>La primera cosa que me viene a la mente es usar el ajuste de entrada para
darnos a nosotros mismos un ancho de banda garantizado. ;)
La configuraci√≥n es igual que la de cualquier otra interfaz:

<PRE
CLASS="SCREEN"
>tc qdisc add dev imq0 root handle 1: htb default 20

tc class add dev imq0 parent 1: classid 1:1 htb rate 2mbit burst 15k

tc class add dev imq0 parent 1:1 classid 1:10 htb rate 1mbit
tc class add dev imq0 parent 1:1 classid 1:20 htb rate 1mbit

tc qdisc add dev imq0 parent 1:10 handle 10: pfifo
tc qdisc add dev imq0 parent 1:20 handle 20: sfq

tc filter add dev imq0 parent 10:0 protocol ip prio 1 u32 match \
		ip dst 10.0.0.230/32 flowid 1:10</PRE
>

En este ejemplo, se usa u32 para la clasificaci√≥n. Otros clasificadores
podr√≠an funcionar como queremos. Lo siguiente es escoger y marcar el
tr√°fico para encolarlo en imq0.

<PRE
CLASS="SCREEN"
>iptables -t mangle -A PREROUTING -i eth0 -j IMQ --todev 0

ip link set imq0 up</PRE
>&#13;</P
><P
>Los objetivos IMQ de iptables son v√°lidos en las cadenas PREROUTING y
POSTROUTING de la tabla mangle. Su sintaxis es

<PRE
CLASS="SCREEN"
>IMQ [ --todev n ]	n : n√∫mero del dispositivo imq</PRE
>

Tambi√©n se proporciona un objetivo para ip6tables.</P
><P
>Tenga en cuenta que el tr√°fico no se encola cuando coincide con el
objetivo, sino despu√©s. La localizaci√≥n exacta del punto donde el tr√°fico
entra en el dispositivo imq depende de la direcci√≥n del tr√°fico
(entrada/salida).
Estas son las ranuras predefinidas de netfilter que usa iptables:

<PRE
CLASS="SCREEN"
>enum nf_ip_hook_priorities {
        NF_IP_PRI_FIRST = INT_MIN,
        NF_IP_PRI_CONNTRACK = -200,
        NF_IP_PRI_MANGLE = -150,
        NF_IP_PRI_NAT_DST = -100,
        NF_IP_PRI_FILTER = 0,
        NF_IP_PRI_NAT_SRC = 100,
        NF_IP_PRI_LAST = INT_MAX,
};</PRE
>&#13;</P
><P
>Para el tr√°fico de entrada, imp se registra con prioridad NF_IP_PRI_MANGLE
+ 1, lo que significa que los paquetes entran en el dispositivo imq justo
despu√©s de que se haya pasado de la cadena PREROUTING de mangle.</P
><P
>Para la salida imq usa NF_IP_PRI_LAST, que obedece al hecho de que los
paquetes eliminados por la tabla filter no deben ocupar ancho de banda.</P
><P
>Encontrar√° parches e informaci√≥n en el
<A
HREF="/web/20040611091246/http://luxik.cdi.cz/~patrick/imq/"
TARGET="_top"
>sitio de imq</A
>.</P
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.LOADSHARE"
></A
>Cap√≠tulo 10. Compartir la carga sobre varias interfaces</H1
><P
>Hay varias maneras de hacer esto. Una de las m√°s sencillas y directas es
¬´TEQL¬ª ("True" - o "trivial" - link equalizer). Como la mayor√≠a de las
cosas que tienen que ver con las colas, la divisi√≥n de cargas va en ambos
sentidos. Puede que ambos extremos del enlace deban participar para
conseguir un efecto completo.</P
><P
>Imagine esta situaci√≥n:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>                 +-------+   eth1   +-------+
                 |       |==========|       |
     'red 1' ----|   A   |          |   B   |---- 'red 2'
                 |       |==========|       |
                 +-------+   eth2   +-------+</PRE
>&#13;</P
><P
>A y B son routers, y por el momento asumiremos que ambos funcionan con
Linux. Si el tr√°fico va de la red 1 a la red 2, el router A necesita
distribuir los paquetes sobre ambos enlaces hacia B. Se necesita
configurar el router B para que acepte esto. Lo mismo sucede en la otra
direcci√≥n: cuando los paquetes van desde la red 2 a la red 1, el router B
necesita enviar paquetes tanto sobre eth1 como eth2.</P
><P
>La parte de distribuci√≥n la hace un dispositivo ¬´TEQL¬ª, as√≠ (no podr√≠a ser
m√°s sencillo):</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc qdisc add dev eth1 root teql0
# tc qdisc add dev eth2 root teql0
# ip link set dev teql0 up</PRE
>&#13;</P
><P
>¬°No olvide la orden ¬´ip link set up¬ª!</P
><P
>Esto debe hacerse en ambas m√°quinas. El dispositivo teql0 b√°sicamente es
un distribuidor roundrobin sobre eth1 y eth2, para enviar paquetes. Nunca
aparecer√°n datos viniendo por un dispositivo teql, sino que simplemente
aparecen en las eth1 y eth2 "b√°sicas".</P
><P
>Pero ahora s√≥lo tenemos dispositivos, de manera que necesitamos hacer un
rutado adecuado. Una manera de hacerlo es asignar una red /31 para ambos
enlaces, y tambi√©n al dispositivo teql0.</P
><P
>En el router A:

<PRE
CLASS="SCREEN"
># ip addr add dev eth1 10.0.0.0/31
# ip addr add dev eth2 10.0.0.2/31
# ip addr add dev teql0 10.0.0.4/31</PRE
>&#13;</P
><P
>En el router B:

<PRE
CLASS="SCREEN"
># ip addr add dev eth1 10.0.0.1/31
# ip addr add dev eth2 10.0.0.3/31
# ip addr add dev teql0 10.0.0.5/31</PRE
>&#13;</P
><P
>El router A deber√≠a ser capaz ahora de hacer ping a 10.0.0.1, 10.0.0.3 y
10.0.0.5 sobre los dos enlaces reales y el ecualizado. El router B deber√≠a
ser capaz de hacer ping a 10.0.0.0, 10.0.0.2 y 10.0.0.4 sobre los enlaces.</P
><P
>Si esto funciona, el router A deber√≠a hacer que 10.0.0.5 sea su ruta para
alcanzar la red 2, y el router B deber√≠a hacer de 10.0.0.4 su ruta para
alcanzar la red 1. Para el caso especial en que la red 1 sea su red casera
y la red 2 Internet, el router A deber√≠a hacer de 10.0.0.5 su ruta por
defecto.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.LOADSHARE.CAVEATS"
>10.1. Problemas</A
></H2
><P
>Nada es tan f√°cil como parece. Se necesita desactivar el filtrado de
ruta de vuelta (return path filtering) en eth1 y eth2 de ambos router,
porque en caso contrario descartar√°n los paquetes destinados direcciones
IP que no sean las suyas:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># echo 0 &#62; /proc/sys/net/ipv4/conf/eth1/rp_filter
# echo 0 &#62; /proc/sys/net/ipv4/conf/eth2/rp_filter</PRE
>&#13;</P
><P
>Entonces nos encontramos con el desagradable problema de la reordenaci√≥n
de paquetes. Digamos que A env√≠a 6 paquetes a B (eth1 podr√≠a llevar los 1,
3 y 5. eth2 llevar√≠a entonces los 2, 4 y 6). En un mundo ideal, el router
B los recibir√≠a en este orden, 1, 2, 3, 4, 5, 6. Pero hay una posibilidad
muy cierta de que el n√∫cleo haga esto: 2, 1, 4, 3, 6, 5. El problema es
que esto confunde a TCP/IP. Mientras que esto no es un problema para
enlaces que llevan sesiones TCP/IP diferentes, no ser√° capaz de juntar
varios enlaces y conseguir enviar un √∫nico fichero por ftp mucho m√°s
r√°pido, a menos que el SO emisor o receptor sea Linux, que no se asusta
f√°cilmente por un reordenado sencillo.</P
><P
>Sin embargo, para muchas aplicaciones, el equilibrio de carga sobre
enlaces es una gran idea.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.LOADSHARE.OTHER"
>10.2. Otras posibilidades</A
></H2
><P
>William Stearns ha usado una configuraci√≥n avanzada de t√∫neles para
conseguir un buen uso simult√°neo de varias conexiones de internet sin
relaci√≥n entre ellas. Puede encontrarlo en
<A
HREF="/web/20040611091246/http://www.stearns.org/tunnel/"
TARGET="_top"
>su p√°gina sobre t√∫neles</A
>.</P
><P
>Puede que en el futuro este C√≥mo diga m√°s cosas a este respecto.</P
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.NETFILTER"
></A
>Cap√≠tulo 11. Netfilter e iproute (marcado de paquetes)</H1
><P
>Hasta ahora hemos visto c√≥mo funciona iproute, y hemos mencionado algunas
veces netfilter. Este podr√≠a ser un buen momento para mirar las <A
HREF="/web/20040611091246/http://netfilter.samba.org/unreliable-guides/"
TARGET="_top"
>Rusty's Remarkably Unreliable Guides</A
>. Netfilter en s√≠ lo puede encontrar <A
HREF="/web/20040611091246/http://netfilter.filewatcher.org/"
TARGET="_top"
>aqu√≠</A
>.</P
><P
>Netfilter nos permite filtrar paquetes, o cambiar sus cabeceras. Una
capacidad especial es que podemos marcar un paquete con un n√∫mero. Esto se
hace con la estructura --set-mark.</P
><P
>Como ejemplo, esta orden marca todos los paquetes destinados al puerto 25,
correo saliente:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># iptables -A PREROUTING -i eth0 -t mangle -p tcp --dport 25 \
 -j MARK --set-mark 1</PRE
>&#13;</P
><P
>Ahora digamos que tenemos varias conexiones, una que es r√°pida (y cara,
por megabyte), y otra m√°s lenta, pero de tarifa fija. Lo m√°s seguro es que
queramos hacer salir el correo mediante la ruta barata.</P
><P
>Ya hemos marcado los paquetes con un ¬´1¬ª, y ahora le daremos instrucciones
a la base de normas de rutado para que act√∫e sobre esto:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># echo 201 mail.out &#62;&#62; /etc/iproute2/rt_tables
# ip rule add fwmark 1 table correo.salida
# ip rule ls
0:	from all lookup local 
32764:	from all fwmark        1 lookup correo.salida
32766:	from all lookup main 
32767:	from all lookup default </PRE
>&#13;</P
><P
>Ahora generaremos la tabla correo.salida con una ruta al enlace lento pero
barato:

<PRE
CLASS="SCREEN"
># /sbin/ip route add default via 195.96.98.253 dev ppp0 table# correo.salida</PRE
>&#13;</P
><P
>Y ya est√°. Si quisi√©ramos hacer algunas excepciones, hay muchas maneras de
conseguirlo. Podemos modificar la orden de netfilter para excluir ciertas
m√°quinas, o podemos insertar una regla con mayor prioridad que apunte a la
tabla principal para dichas m√°quinas.</P
><P
>Tambi√©n podemos usar esta caracter√≠sticas para obedecer a los bits TOS
marcando los paquetes con un tipo diferente de servicio con diferentes
n√∫meros, y creando reglas que act√∫en sobre esto. De esta manera podr√≠a
dedicar, digamos, una l√≠nea RDSI a las sesiones interactivas.</P
><P
>No hace falta decir que esto funciona bien en una m√°quina que est√©
haciendo NAT (¬´enmascaramiento¬ª).</P
><P
>IMPORTANTE: Hemos recibido informes de que al menos MASQ y SNAT colisionan
con el marcado de paquetes. Rusty Russell lo explica en
<A
HREF="/web/20040611091246/http://lists.samba.org/pipermail/netfilter/2000-November/006089.html"
TARGET="_top"
>este mensaje</A
>. Deshabilite el filtro de ruta inversa (reverse path filter) para que
funcione correctamente.</P
><P
>Nota: para marcar paquetes, necesita activar algunas opciones en el
n√∫cleo:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>IP: advanced router (CONFIG_IP_ADVANCED_ROUTER) [Y/n/?]
IP: policy routing (CONFIG_IP_MULTIPLE_TABLES) [Y/n/?]
IP: use netfilter MARK value as routing key (CONFIG_IP_ROUTE_FWMARK) [Y/n/?]</PRE
>&#13;</P
><P
>Vea tambi√©n el <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK.SQUID"
>Secci√≥n 15.5</A
> en el
<I
CLASS="CITETITLE"
><A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK"
>Cookbook</A
></I
>.</P
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.ADV-FILTER"
></A
>Cap√≠tulo 12. Filtros avanzados para (re)clasificar paquetes</H1
><P
>Como se explic√≥ en la secci√≥n de disciplinas de cola con clases, se
necesitan filtros para clasificar los paquetes en cualquiera de las
subcolas. Estos filtros se llaman desde dentro de las qdisc con clases.</P
><P
>Aqu√≠ tiene una lista incompleta de los clasificadores disponibles:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>fw</DT
><DD
><P
>Basa la decisi√≥n en la forma en que el cortafuegos ha marcado el paquete.
Es una manera sencilla si no quiere aprender la sintaxis de filtros de tc.
Vea el cap√≠tulo de Colas para m√°s detalles.</P
></DD
><DT
>u32</DT
><DD
><P
>Basa la decisi√≥n en campos del interior del paquete (direcci√≥n IP de
origen, etc)</P
></DD
><DT
>route</DT
><DD
><P
>Basa la decisi√≥n en la ruta a la que ser√° enviado el paquete.
Bases the decision on which route the packet will be routed by</P
></DD
><DT
>rsvp, rsvp6</DT
><DD
><P
>Encamina los paquetes bas√°ndose en <A
HREF="/web/20040611091246/http://www.isi.edu/div7/rsvp/overview.html"
TARGET="_top"
>RSVP </A
>. S√≥lo es √∫til
en las redes que usted controle (Internet no respeta RSVP).</P
></DD
><DT
>tcindex</DT
><DD
><P
>Se usa con la qdisc DSMARK. Vea la secci√≥n relevante.</P
></DD
></DL
></DIV
></P
><P
>F√≠jese que en general hay muchas maneras de clasificar los paquetes y que
generalmente el sistema de que desea usar se reduce a sus preferencias.</P
><P
>En general los clasificadores aceptan unos pocos argumentos comunes.
Aparecen aqu√≠ por conveniencia:</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>protocol</DT
><DD
><P
>El protocolo que aceptar√° este clasificador. Generalmente s√≥lo querr√°
aceptar tr√°fico IP. Se requiere.</P
></DD
><DT
>parent</DT
><DD
><P
>El controlador al que estar√° asociado este clasificador. Este controlador
debe ser una clase ya existente. Requerido.</P
></DD
><DT
>prio</DT
><DD
><P
>La prioridad de este clasificador. Los n√∫meros m√°s bajos se comprueban
antes.</P
></DD
><DT
>handle</DT
><DD
><P
>Este controlador significa cosas diferentes para filtros diferentes.</P
></DD
></DL
></DIV
></P
><P
>Todas las secciones que siguen asumen que est√° intentando dar forma al
tr√°fico que va hacia <VAR
CLASS="LITERAL"
>M√°quinaA</VAR
>. Asumen que se
ha configurado la clase ra√≠z en 1: y que la clase a la que desea enviar el
tr√°fico elegido es 1:1.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-FILTER.U32"
>12.1. El clasificador <VAR
CLASS="OPTION"
>u32</VAR
></A
></H2
><P
>El filtro U32 es el m√°s avanzado disponible en la implementaci√≥n actual.
Se basa completamente en tablas hash, lo que lo hace robusto cuando hay
muchas reglas de filtrado.</P
><P
>En su forma m√°s simple el filtro U32 es una lista de registros,
consistente cada una en dos campos: un selector y una acci√≥n. Los
selectores, descritos m√°s adelante, se comparan con el paquete IP que se
est√° procesando hasta encontrar la primera coincidencia, y entonces se
ejecuta la acci√≥n asociada. El tipo m√°s sencillo de acci√≥n ser√≠a dirijir
el paquete en una clase CBQ definida.</P
><P
>La l√≠nea de √≥rdenes del programa <VAR
CLASS="LITERAL"
>tc filter</VAR
>,
que se usa para configura el filtro, consiste en tres partes:
especificaci√≥n del filtro, selector y acci√≥n. La especificaci√≥n del filtro
puede definirse as√≠:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>tc filter add dev IF [ protocol PROTO ]
                     [ (preference|priority) PRIO ]
                     [ parent CBQ ]</PRE
>&#13;</P
><P
>El campo <VAR
CLASS="LITERAL"
>protocol</VAR
> describe el protocolo al
que se aplicar√° el filtro. S√≥lo comentaremos el caso del protocolo
<VAR
CLASS="LITERAL"
>ip</VAR
>. El campo <VAR
CLASS="LITERAL"
>preference</VAR
> (alternativamente se puede usar <VAR
CLASS="LITERAL"
>priority</VAR
>) establece la prioridad del filtro escogido.
Esto es importante, porque puede tener varios filtros (listas de reglas)
con diferentes prioridades. Se pasar√° por cada lista en el orden en que se
agreguen las reglas, y entonces se procesar√°n las listas de menor
prioridad (numero "preference" m√°s alto). El campo <VAR
CLASS="LITERAL"
>parent</VAR
> define la cima del √°rbol CBQ (por ejemplo,
1:0), a la que se asociar√° el filtro.</P
><P
>Las opciones descritas anterioremente se aplican a todos los filtros, no
s√≥lo a los U32.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1291"
>12.1.1. Selector U32</A
></H3
><P
>El selector U32 contiene definiciones de los patrones, que ser√°n
comparados con el paquete procesado en cada momento. Para ser m√°s
precisos, define qu√© bits hay que comparar en la cabecera del paquete y
nada m√°s, pero este m√©todo sencillo es muy poderoso. Veamos los ejemplos
siguientes, tomados directamente de un filtro muy complejo, del mundo
real:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth0 protocol ip parent 1:0 pref 10 u32 \
  match u32 00100000 00ff0000 at 0 flowid 1:10</PRE
>&#13;</P
><P
>Por ahora, olvid√©monos de la primera l√≠nea (todos estos par√°metros
describen las tablas hash del filtro). Centr√©monos en la l√≠nea del
selector, que contiene la palabra clave <VAR
CLASS="LITERAL"
>match</VAR
>. Este selector coincidir√° con cabeceras IP cuyo
segundo byte sea 0x10 (0010). Como puede adivinar, el n√∫mero 00ff es la
m√°scara de comparaci√≥n, que le dice al filtro qu√© bits exactamente tiene
que comparar. Aqu√≠ es 0xff, de manera que el byte coincidir√° si es
exactamente 0x10. La clave <VAR
CLASS="LITERAL"
>at</VAR
> indica que la
coincidencia debe comenzar en un desplazamiento espec√≠fico (en bytes) (en
este caso, al principio del paquete). Traduciendo todo esto a lenguaje
humano, el paquete coincidir√° si su campo Tipo de Servicio tiene los bits
de ¬´poco retraso¬ª activos. Analicemos otra regla:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth0 protocol ip parent 1:0 pref 10 u32 \
  match u32 00000016 0000ffff at nexthdr+0 flowid 1:10</PRE
>&#13;</P
><P
>La opci√≥n <VAR
CLASS="LITERAL"
>nexthdr</VAR
> indica la siguiente
cabecera encapsulada en el paquete IP, esto es, la cabecera del protocolo
de la capa superior. La coincidencia tambi√©n debe empezar al principio de
la siguiente cabecera. La coincidencia deber√≠a ocurrir en la segunda
palabra de 32 bits te la cabecera. En los protocolos TCP y UDP este campo
contiene el puerto de destino del paquete. El puerto se da en formato
big-endian, es decir, los bits m√°s significativos primero, de manera que
simplemente leemos 0x0016 como 22 decimal, lo que indicar√≠a el servicio SSH
si fuera TCP. Como puede adivinar, esta coincidencia es ambigua sin un
contexto, y de eso hablaremos m√°s tarde.</P
><P
>Habiendo entendido todo lo anterior, encontraremos f√°cil de leer el
siguiente selector: <VAR
CLASS="LITERAL"
>match c0a80100 ffffff00 at
16</VAR
>. Lo que tenemos aqu√≠ es una coincidencia de tres bytes
partiendo del decimos√©ptimo byte, contando desde el principio de la
cabecera IP. Coincidir√° con los paquetes cuya direcci√≥n de destino sea
cualquiera dentro de la red 192.168.1/24. Tras analizar los ejemplo,
podemos resumir lo que hemos aprendido.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1305"
>12.1.2. Selectores generales</A
></H3
><P
>Los selectores generales definen el patr√≥n, m√°scara y desplazamiento del
patr√≥n que ser√° comparado con el contenido del paquete. Usando los
selectores generales se puede coincidir con virtualmente cualquier bit de
la cabecera IP (o capas superiores). Sin embargo, son m√°s dif√≠ciles de
leer y escribir que los selectores espec√≠ficos descritos m√°s adelante. La
sintaxis general del selector es:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>match [ u32 | u16 | u8 ] PATRON MASCARA [ at DESPL | nexthdr+DESPL]</PRE
>&#13;</P
><P
>Una de las palabras clave <VAR
CLASS="LITERAL"
>u32</VAR
>, <VAR
CLASS="LITERAL"
>u16</VAR
> o <VAR
CLASS="LITERAL"
>u8</VAR
> especifica la
longitud en bits de los patrones. Deber√≠an seguirle PATRON y MASCARA, de
la longitud definida por la palabra clave anterior. El par√°metro DESPL es
el desplazamiento, en bytes, desde donde empezar a comparar. Si se da la
palabra clave <VAR
CLASS="LITERAL"
>nexthdr+</VAR
>, el desplazamiento es
relativo al inicio de una cabecera de capa superior.</P
><P
>Algunos ejemplos:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev ppp14 parent 1:0 prio 10 u32 \
     match u8 64 0xff at 8 \
     flowid 1:4</PRE
>&#13;</P
><P
>Un paquete coincidir√° con esta regla si su tiempo de vida (TTL) es 64.
TTL es el campo que empieza justo despu√©s del octavo byte de la cabecera
IP.</P
><P
>Coincide con todos los paqutes TCP que tienen activo el bit ACK:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev ppp14 parent 1:0 prio 10 u32 \
     match ip protocol 6 0xff \
     match u8 0x10 0xff at nexthdr+13 \
     flowid 1:3 </PRE
>&#13;</P
><P
>Use esto para capturar los ACK en paquetes menores de 64 bytes:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>## captura de acks a la manera dif√≠cil:
## IP protocol 6,
## IP header length 0x5(32 bit words),
## IP Total length 0x34 (ACK + 12 bytes of TCP options)
## TCP ack set (bit 5, offset 33)
# tc filter add dev ppp14 parent 1:0 protocol ip prio 10 u32 \
            match ip protocol 6 0xff \
            match u8 0x05 0x0f at 0 \
            match u16 0x0000 0xffc0 at 2 \
            match u8 0x10 0xff at 33 \
            flowid 1:3</PRE
>&#13;</P
><P
>Esta regla s√≥lo coincidir√° con paquetes TCP cuando est√© activo el bit ACK,
y no haya contenido. Aqu√≠ podemos ver un ejemplo de uso de dos selectores,
siendo el resultado final el AND l√≥gico de sus resultados. Si echamos un
vistazo al diagrama de la cabecera TCP, podemos ver que el bit ACK es el
tercer bit de m√°s peso (0x10) en el catorceavo byte de la cabecera TCP
(<VAR
CLASS="LITERAL"
>at nexthdr+13</VAR
>). En lo que respecta al
segundo selector, si quisi√©ramos hacernos la vida m√°s complicada,
podr√≠amos escribir <VAR
CLASS="LITERAL"
>match u8 0x06 0xff at 9</VAR
>
en lugar de usar el selector espec√≠fico <VAR
CLASS="LITERAL"
>protocol
tcp</VAR
>, porque 6 es el n√∫mero del protocolo TCP, presente en el
d√©cimo byte de la cabecera IP. Por otro lado, en este ejemplo no podr√≠amos
usar selectores espec√≠ficos para la primera coincidencia (simplemente
porque no hay selectores espec√≠ficos para el bit ACK de TCP).</P
><P
>El siguiente filtro es una versi√≥n modificada del filtro anterior. La
diferencia est√° en que no comprueba la longitud de la cabecera. ¬øPor qu√©?
Porque el filtro anterior s√≥lo funciona en m√°quinas de 32 bits.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>tc filter add dev ppp14 parent 1:0 protocol ip prio 10 u32 \
     match ip protocol 6 0xff \
     match u8 0x10 0xff at nexthdr+13 \
     match u16 0x0000 0xffc0 at 2 \
     flowid 1:3</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1332"
>12.1.3. Selectores espec√≠ficos</A
></H3
><P
>La siguiente tabla contiene una lista de todos los selectores espec√≠ficos
que ha encontrado el autor de esta secci√≥n en el c√≥digo fuente del
programa <VAR
CLASS="LITERAL"
>tc</VAR
>. Simplemente te hacen la vida
m√°s sencilla e incrementan la legibilidad de la configuraci√≥n de los
filtros.</P
><P
>FIXME: aqu√≠ ir√≠a la tabla (la tabla est√° en un fichero aparte,
"selector.html"</P
><P
>FIXME: y todav√≠a est√° en polaco :-(</P
><P
>FIXME: debe ser sgmlizada</P
><P
>Algunos ejemplos:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev ppp0 parent 1:0 prio 10 u32 \
     match ip tos 0x10 0xff \
     flowid 1:4</PRE
>&#13;</P
><P
>FIXME: el filtro tcp dport no funciona como se describe:</P
><P
>La regla anterior coincidir√° con paquetes que tengan el campo TOS a 0x10.
El campo TOS empieza en el segundo byte del paquete y es de un byte de
largo, de manera que podr√≠amos escribir un selector general equivalente:
<VAR
CLASS="LITERAL"
>match u8 0x10 0xff at 1</VAR
>. Esto nos da una
pista de las interioridades del filtro U32 (las reglas espec√≠ficas siempre
se traducen a generales, y es de esta manera que se almacenan en la
memoria del n√∫cleo). Lo que nos lleva a otra conclusi√≥n: los selectores
<VAR
CLASS="LITERAL"
>tcp</VAR
> y <VAR
CLASS="LITERAL"
>udp</VAR
> son
exactamente el mismo, y √©sta es la raz√≥n de que no podamos usar un √∫nico
selector <VAR
CLASS="LITERAL"
>match tcp dport 53 0xffff</VAR
> para
capturar paquetes TCP enviados a dicho puerto (tambi√©n coincidir√≠a con los
paquetes UDP). Tambi√©n debe recordar especificar el protocolo y terminar√°
con la siguiente regla:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev ppp0 parent 1:0 prio 10 u32 \
        match tcp dport 53 0xffff \
        match ip protocol 0x6 0xff \
        flowid 1:2</PRE
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-FILTER.ROUTE"
>12.2. El clasificador <VAR
CLASS="OPTION"
>route</VAR
></A
></H2
><P
>Este clasificador filtra bas√°ndose en los resultados de las tablas de
rutas. Cuando un paquete que est√° pasando por las clases llega a uno
marcado con el filtro ¬´route¬ª, queda clasificado bas√°ndose en la
informaci√≥n de la tabla de rutas.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth1 parent 1:0 protocol ip prio 100 route</PRE
>&#13;</P
><P
>Aqu√≠ a√±adimos un clasificador de rutas al nodo padre 1:0 con prioridad
100. Cuando un paquete alcanza este nodo (que, como es el ra√≠z, suceder√°
de inmediato) consultar√° la tabla de rutas y si una coincide, lo enviar√° a
la clase dada y le dar√° prioridad 100. Entonces, para entrar en acci√≥n del
todo, deber√° a√±adir la ruta apropiada:</P
><P
>El truco aqu√≠ es definir ¬´realm¬ª (dominio) bas√°ndose en el destino o el
origen. La forma de hacerlo es √©sta:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># ip route add M√°quina/Red via Pasarela dev Dispositivo realm N√∫meroDominio</PRE
>&#13;</P
><P
>Por ejemplo, podemos definir nuestra red de destino 192.168.10.0 con un
n√∫mero de dominio 10:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># ip route add 192.168.10.0/24 via 192.168.10.1 dev eth1 realm 10</PRE
>
  </P
><P
>Cuando a√±adimos filtros de rutas, podemos usar n√∫meros de dominios para
representar las redes o m√°quinas y especificar c√≥mo se comparan estas
redes con los filtros.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth1 parent 1:0 protocol ip prio 100 \
  route to 10 classid 1:10</PRE
>
  </P
><P
>La regla anterior dice que los paquetes que vayan a la red 192.168.10.0
coinciden con la clase de id 1:10.</P
><P
>El filtro de rutas tambi√©n se puede usar para coincidir con rutas de
origen. Por ejemplo, hay una subred asociada al router Linux en eth2.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># ip route add 192.168.2.0/24 dev eth2 realm 2
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 \
  route from 2 classid 1:2</PRE
>&#13;</P
><P
>Aqu√≠ el filtro especifica que el paquete de la subred 192.168.2.0 (dominio
2) coincidir√° con la clase de id 1:2.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-FILTER.POLICING"
>12.3. Filtros de control (Policing filters)</A
></H2
><P
>Para hacer las configuraciones incluso m√°s complicadas, puede tener
filtros que s√≥lo funcionen hasta un determinado ancho de banda, o que s√≥lo
salten cuando el ancho de banda exceda una tasa determinada.</P
><P
>De manera que si decide controlar 4mbit/s pero hay 5mbit/s de tr√°fico,
puede dejar de comprobar los 5mbit/s al completo, o s√≥lo 1mbit/s y enviar
4mbit/s del total a la clase configurada.</P
><P
>Si el ancho de banda excede la tasa configurada, puede descartar un
paquete, reclasificarlo, o ver si alg√∫n otro filtro lo captura.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1376"
>12.3.1. Formas de control</A
></H3
><P
>B√°sicamente hay dos formas de control. Si compil√≥ ¬´Estimadores¬ª en el
n√∫cleo, entonces se puede medir cu√°nto tr√°fico est√° pasando por cada
filtro, m√°s o menos. Estos estimadores consumen poca CPU, ya que s√≥lo
cuentan cu√°ntos datos han estado pasando 25 veces por segundo, y con eso
calculan la tasa de bits.</P
><P
>La otra forma es de nuevo mediante un Token Bucket Filter, que esta vez
residir√° dentro del filtro. El TBF s√≥lo trabaja con tr√°fico HASTA el ancho
de banda configurado, y si se ofrece m√°s, s√≥lo el exceso es sujeto a la
acci√≥n de sobrel√≠mite configurada.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN1380"
>12.3.1.1. Con el estimador del n√∫cleo</A
></H4
><P
>Es muy simple y s√≥lo tiene un par√°metro: avrate. O el flujo se mantiene
por debajo de avrate, y el filtro clasifica el tr√°fico en el id de clase
indicado, o la tasa excede en cuyo caso se ejecuta la acci√≥n especificada,
que es ¬´reclassify¬ª por defecto.</P
><P
>El n√∫cleo usa una Media de Movimiento Exponencial Proporcional
(Exponential Weighted Moving Average) que lo hace menos sensible a r√°fagas
cortas.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN1384"
>12.3.1.2. Con Token Bucket Filter</A
></H4
><P
>Usa los siguientes par√°metros:

<P
></P
><UL
><LI
><P
>buffer/maxburst</P
></LI
><LI
><P
>mtu/minburst</P
></LI
><LI
><P
>mpu</P
></LI
><LI
><P
>rate</P
></LI
></UL
>&#13;</P
><P
>Que se comportan de forma casi id√©ntica que las descritas en la secci√≥n
del Token Bucket Filter. Sin embargo, tenga en cuenta que si establece
demasiado bajo el mtu de un control TBF, no pasar√° *ning√∫n* paquete,
mientras que la qdisc TBF de salida se limitar√° a pasarlos m√°s lentamente.</P
><P
>Otra diferencia es que un filtro de control s√≥lo puede dejar pasar un
paquete, o descartarlo. No puede mantenerlo dentro de s√≠ para retrasarlo.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1398"
>12.3.2. Acciones de sobrel√≠mite</A
></H3
><P
>Si nuestro filtro decide que est√° sobrelimitado, puede tomar ¬´acciones¬ª.
Actualmente, disponemos de tres:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>continue</DT
><DD
><P
>Hace que el filtro no de coincidencia, aunque puede que lo hagan otros
filtros.</P
></DD
><DT
>drop</DT
><DD
><P
>Esta es una opci√≥n muy salvaje que se limita a descartar el tr√°fico que
excede de una cierta tasa. Se usa a menudo en el control deentrada y tiene
usos limitados. Por ejemplo, puede tener un servidor de nombres que se cae
si se le pasa m√°s de 5mbit/s de paquetes, en cuyo caso se deber√≠a usar un
filtro de entrada para asegurarse de que no se le ofrecen m√°s.</P
></DD
><DT
>Pass/OK</DT
><DD
><P
>Dejar pasar el tr√°fico. Se puede usar para desactivar un filtro
complicado, sin eliminarlo de su sitio.</P
></DD
><DT
>reclassify</DT
><DD
><P
>M√°s a menudo se tiene a una reclasificaci√≥n al Mejor Esfuerzo. Esta es la
acci√≥n por defecto.</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1418"
>12.3.3. Ejemplos</A
></H3
><P
>El √∫nico ejemplo real conocido se menciona en la secci√≥n ¬´Protecci√≥n de la
m√°quina frente a inundaciones por SYN¬ª.</P
><P
>FIXME: si ha usado esto, comparta su experiencia con nosotros</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-FILTER.HASHING"
>12.4. Filtros de hash para filtrado masivo muy r√°pido</A
></H2
><P
>Si alguna vez ha necesitado miles de reglas, por ejemplo si tiene muchos
clientes o m√°quinas, todas con especificaciones QoS diferentes, habr√°
comprobado que el n√∫cleo se pasa mucho tiempo comprobando todas esas
reglas.</P
><P
>Por defecto, muchos filtros residen en una gran cadena que se comprueba en
orden descendiente de prioridad. Si tiene 1000 reglas, puede hacer falta
1000 comprobaciones para determinar qu√© hacer con un paquete.</P
><P
>La comprobaci√≥n podr√≠a ser mucho m√°s r√°pida si tuviera 256 reglas cada una
con cuatro reglas (si pudiera dividir los paquetes en esas 256 cadenas, de
manera que ajustasen).</P
><P
>El hash hace esto posible. Digamosq ue tiene 1024 clientes de cable m√≥dem
en su red, con direcciones IP desde 1.2.0.0 a 1.2.3.255, y que cada una va
en otra categor√≠a, por ejemplo ¬´peque√±a¬ª, ¬´normal¬ª y ¬´premium¬ª. Entonces
podr√≠a tener 1024 reglas como √©sta:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.0 classid 1:1
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.1 classid 1:1
...
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.3.254 classid 1:3
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.3.255 classid 1:2</PRE
>&#13;</P
><P
>Para acelerar esto, podemos usar la √∫ltima parte de la direcci√≥n IP como
una "clave hash". Entonces obtenemos 256 tablas, la primera de las cuales
ser√≠a as√≠:

<PRE
CLASS="SCREEN"
># tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.0 classid 1:1
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.1.0 classid 1:1
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.2.0 classid 1:3
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.3.0 classid 1:2</PRE
>&#13;</P
><P
>La siguiente empezar√≠a as√≠:

<PRE
CLASS="SCREEN"
># tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.1 classid 1:1
...</PRE
>&#13;</P
><P
>De esta manera, s√≥lo se necesitan cuatro comprobaciones como mucho, y dos
de media.</P
><P
>La configuraci√≥n es muy complicada, pero valdr√° la pena cuando llegue el
momento en que tenga tantos clientes. Primero hacemos un filtro ra√≠z, y
luego creamos una tabla con 256 entradas:

<PRE
CLASS="SCREEN"
># tc filter add dev eth1 parent 1:0 prio 5 protocol ip u32
# tc filter add dev eth1 parent 1:0 prio 5 handle 2: protocol ip u32 divisor 256</PRE
>&#13;</P
><P
>Ahora a√±adimos algunas reglas a las entradas que hemos creado en la tabla:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.0.123 flowid 1:1
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.1.123 flowid 1:2
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.3.123 flowid 1:3
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.4.123 flowid 1:2</PRE
>

Esta es la entrada 123, que contiene coincidencias para 1.2.0.123,
1.2.1.123, 1.2.2.123, 1.2.3.123, y las env√≠a a 1:1, 1:2, 1:3 y 1:2
respectivamente. F√≠jese que necesitamos especificar nuestro hash en
hexadecimal, 0x7b is 123.</P
><P
>Luego creamos un ¬´filtro de hash¬ª que dirige el tr√°fico a la entrada
adecuada de la tabla de hash:

<PRE
CLASS="SCREEN"
># tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 800:: \
        match ip src 1.2.0.0/16 \
        hashkey mask 0x000000ff at 12 \
        link 2:</PRE
>

Bueno, hace falta explicar algunos n√∫meros. La tabla de hash por defecto
se llama 800:: y todo el filtrado empieza aqu√≠. Entonces escogemos la
direcci√≥n de origen, que reside en las posiciones 12, 13, 14 y 15 de la
cabecera IP, e indicamos que s√≥lo estamos interesados en la √∫ltima parte.
Entonces lo enviamos a la tabla de hash 2:, que creamos previamente.</P
><P
>Es bastante complicado, pero funciona en la pr√°ctica y el rendimiento ser√°
asombroso. Sepa que este ejemplo se puede mejorar hasta el caso ideal en
que cada cadena ¬°s√≥lo contenga 1 filtro!</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-FILTER.IPV6"
>12.5. Filtrado de tr√°fico IPv6</A
></H2
><DIV
CLASS="SECT2"
><H3
CLASS="SECT2"
><A
NAME="AEN1445"
>12.5.1. ¬øC√≥mo es que no funcionan los filtros tc para IPv6?</A
></H3
><P
>La Routing Policy Database (RPDB) reemplaz√≥ el encaminamiento IPv4 y la
estructura de direccionamiento dentro del N√∫cleo de Linux, lo que llev√≥ a
todas las capacidades maravillosas que describe este COMO.
Desafortunadamente, la estructura de IPv6 dentro de Linux se implement√≥
fuera de esta estructura central. Aunque comparten algunos servicios, la
estructura esencial de RPDB no participa en o con las estructuras de
direccionamiento y encaminamiento de IPv6.</P
><P
>Esto cambiar√°, seguramente, s√≥lo que tenemos que esperar un poco m√°s.</P
><P
>FIXME: ¬øAlguna idea sobre si hay alguien trabajando en esto? ¬øPlanes?</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1450"
>12.5.2. Marcar paquetes IPv6 usando ip6tables</A
></H3
><P
>ip6tables puede marcar un paquete y asignarle un n√∫mero:</P
><PRE
CLASS="SCREEN"
># ip6tables -A PREROUTING -i eth0 -t mangle -p tcp -j MARK --mark 1</PRE
><P
>Pero de todas maneras, esto no ayuda porque el paquete no pasar√° por la
estructura RPDB.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1455"
>12.5.3. Usar el selector u32 para filtrar paquetes IPv6</A
></H3
><P
>Normalmente IPv6 va encapsulado en un t√∫nel SIT y transportado sobre redes
IPv4. Lea la secci√≥n sobre T√∫neles IPv6 si desea informaci√≥n sobre c√≥mo
establecer uno de esos t√∫neles. Esto nos permite filtrar los paquetes IPv4
que contienen los paquetes IPv6 como carga.</P
><P
>Los siguientes filtros coinciden con todo el IPv6 encapsulado en paquetes
IPv4:</P
><PRE
CLASS="SCREEN"
># tc filter add dev $DEV parent 10:0 protocol ip prio 10 u32 \
            match ip protocol 41 0xff flowid 42:42</PRE
><P
>Sigamos con esto. Asumamos que nuestros paquetes IPv6 salen sobre IPv4 y
que estos paquetes no tienen establecidas opciones. Se podr√≠a usar el
siguiente filtro para encontrar ICMPv6 sobre IPv6 sobre IPv4 sin opciones.
0x3a (58) es el tipo de Next-Header para ICMPv6.</P
><PRE
CLASS="SCREEN"
># tc filter add dev $DEV parent 10:0 protocol ip prio 10 u32 \
           match ip protocol 41 0xff \
           match u8 0x05 0x0f at 0 \
           match u8 0x3a 0xff at 26 \
           flowid 42:42</PRE
><P
>Encontrar la direcci√≥n IPv6 de destino precisa de un poco m√°s de trabajo.
El siguiente filtro coincide con la direcci√≥n de destino
3ffe:202c:ffff:32:230:4fff:fe08:358d:</P
><PRE
CLASS="SCREEN"
># tc filter add dev $DEV parent 10:0 protocol ip prio 10 u32 \
            match ip protocol 41 0xff \
            match u8 0x05 0x0f at 0 \
            match u8 0x3f 0xff at 44 \
            match u8 0xfe 0xff at 45 \
            match u8 0x20 0xff at 46 \
            match u8 0x2c 0xff at 47 \
            match u8 0xff 0xff at 48 \
            match u8 0xff 0xff at 49 \
            match u8 0x00 0xff at 50 \
            match u8 0x32 0xff at 51 \
            match u8 0x02 0xff at 52 \
            match u8 0x30 0xff at 53 \
            match u8 0x4f 0xff at 54 \
            match u8 0xff 0xff at 55 \
            match u8 0xfe 0xff at 56 \
            match u8 0x08 0xff at 57 \
            match u8 0x35 0xff at 58 \
            match u8 0x8d 0xff at 59 \
            flowid 10:13</PRE
><P
>Se usa la misma t√©cnica para buscar subredes. Por ejemplo 2001::</P
><PRE
CLASS="SCREEN"
># tc filter add dev $DEV parent 10:0 protocol ip prio 10 u32 \
            match ip protocol 41 0xff \
            match u8 0x05 0x0f at 0 \
            match u8 0x20 0xff at 28 \
            match u8 0x01 0xff at 29 \
            flowid 10:13</PRE
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.KERNEL"
></A
>Cap√≠tulo 13. Par√°metros de red del n√∫cleo</H1
><P
> 
El n√∫cleo tiene muchos par√°metros que se
pueden ajustar para diferentes circunstancias. Aunque, como de costumbre,
los par√°metros por defecto sirven muy bien para el 99% de las
instalaciones, ¬°no llamamos a √©ste el C√≥mo Avanzado s√≥lo por diversi√≥n!</P
><P
>Las cosas interesantes est√°n en /proc/sys/net, as√≠ que eche un vistazo
ah√≠. No todo lo documentaremos aqu√≠ al principio, pero estamos trabajando
en ello.</P
><P
>Mientras tanto, puede que quiera echar un vistazo a las fuentes del n√∫cleo
de Linux; lea el fichero Documentation/filesystems/proc.txt. La mayoria de
las caracter√≠sticas se explican all√≠.</P
><P
>(FIXME)</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.KERNEL.RPF"
>13.1. Reverse Path Filtering</A
></H2
><P
>Por defecto, los routers encaminan todo, incluyendo paquetes que
¬´obviamente¬ª no pertenecen a nuestra red. Un ejemplo com√∫n es un escape de
un espacio IP privado a Internet. Si tiene una interfaz con una ruta de
195.96.96.0/24 hacia ella, no esperar√° que lleguen all√≠ paquetes de
212.64.94.1.</P
><P
>Mucha gente querr√≠a desactivar esto, de manera que los hacker n√∫cleo lo
han hecho sencillo. Hay ficheros en /proc donde decir que quiere que el
n√∫cleo haga esto por usted. El m√©todo se llama ¬´"Reverse Path Filtering¬ª.
B√°sicamente, si la respuesta a un paquete no deber√≠a haber salido de la
interfaz por la que vino, entonces este paquete es err√≥neo y deber√≠a ser
ignorado.</P
><P
>El siguiente fragmento lo activar√° para todas las interfaces actuales y
futuras.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># for i in /proc/sys/net/ipv4/conf/*/rp_filter ; do
&gt;  echo 2 &#62; $i 
&gt; done</PRE
>&#13;</P
><P
>Siguiendo el ejemplo anterior, si un paquete llega al router Linux por
eth1 diciendo que viene de la red Oficina+ISP, deber√≠a ser eliminado. De
forma similar, si un paquete viene de la subred Oficina, diciendo que
viene de alg√∫n sitio de fuera del cortafuegos, tambi√©n deber√≠a ser
eliminado.</P
><P
>Lo anterior es un ¬´reverse path filtering¬ª completo. La acci√≥n por defecto
es filtrar bas√°ndose s√≥lo en direcciones IP que est√©n en las redes
conectadas directamente. Esto se debe a que el filtrado completo a veces
no funciona en el caso de encaminamiento asim√©trico, cuando los paquetes
vienen por una v√≠a y salen por otra, como tr√°fico de sat√©lite, o si tiene
rutas din√°micas (bgp, ospf, rip) en la red. Los datos vienen por la antena
del sat√©lite y las respuestas van mediante l√≠neas terrestres normales.</P
><P
>Si esta excepci√≥n se le aplica (y probablemente lo sabr√° si esto es as√≠)
sencillamente puede desactivar el rp_filter de la interfaz por donde
vienen los datos del sat√©lite. Si quiere ver si se est√°n descartando
paquetes, el fichero log_martians de ese mismo directorio le dir√° al
n√∫cleo que los registre mediante syslog.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># echo 1 &#62;/proc/sys/net/ipv4/conf/&#60;nombredeinterfaz&#62;/log_martians</PRE
>&#13;</P
><P
>FIXME: ¬øbasta con activar los ficheros conf/&lcub;default,all&rcub;/*? -
martijn</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.KERNEL.OBSCURE"
>13.2. Configuraciones oscuras</A
></H2
><P
>Bien, hay muchos par√°metros que se pueden modificar. Intentaremos dar una
lista de todos. Tambi√©n est√°n documentados (parcialmente) en
Documentation/ip-sysctl.txt.</P
><P
>Algunas de estas configuraciones tienen valores por defecto diferentes
dependiendo de si ha respondido ¬´S√≠¬ª a la pregunta ¬´Configure as router
and not host¬ª al compilar el n√∫cleo.</P
><P
>Oskar Andreasson tambi√©n tiene una p√°gina con todas estas opciones y
parece que es mejor que lo nuestro, de manera que mire tambi√©n en
<A
HREF="/web/20040611091246/http://ipsysctl-tutorial.frozentux.net/"
TARGET="_top"
>http://ipsysctl-tutorial.frozentux.net/</A
>.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1491"
>13.2.1. ipv4 gen√©rica</A
></H3
><P
>Como nota general, la mayor√≠a de las capacidades de limitaci√≥n de
velocidad no funcionan sobre el loopback, de manera que no las pruebe de
forma local. Los l√≠mites se indican en ¬´jiffies¬ª, y se fuerzan usando el
token bucket filter que mencionamos anteriormente.</P
><P
>El n√∫cleo tiene un reloj interno que funciona a ¬´HZ¬ª tics (o ¬´jiffies¬ª)
por segundo. En Intel, ¬´HZ¬ª suele ser 100. De manera que cambiar el
fichero _rate a, digamos 50, permitir√° 2 paquetes por segundo. El token
bucket filter est√° configurado tambi√©n para permitir r√°fagas de como mucho
6 paquetes, si se han recibido ya suficientes paquetes.</P
><P
>Mucho del contenido de la siguiente lista se ha copiado de
/usr/src/linux/Documentation/networking/ip-sysctl.txt, escrito por Alexey
Kuznetsov &lt;kuznet@ms2.inr.ac.ru&gt; y Andi Kleen &lt;ak@muc.de&gt;
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>/proc/sys/net/ipv4/icmp_destunreach_rate</DT
><DD
><P
>Si el n√∫cleo decide que no puede entregar un paquete, lo descartar√°, y
enviar√° a su origen un aviso ICMP al efecto.</P
></DD
><DT
>/proc/sys/net/ipv4/icmp_echo_ignore_all</DT
><DD
><P
>No actuar sobre los paquetes de eco. Por favor, no active esto por
defecto, pero en caso de ser usado como reenv√≠o para un ataque DoS, puede
ser √∫til.</P
></DD
><DT
>/proc/sys/net/ipv4/icmp_echo_ignore_broadcasts &lsqb;Util&rsqb;</DT
><DD
><P
>Si hace ping a la direcci√≥n de difusi√≥n de una red, se supone que
responder√°n todas las m√°quinas. Esto se convierte en una herramienta de
negaci√≥n de servicio bastante buena. P√≥ngalo a 1 para ignorar estos
mensajes de difusi√≥n.</P
></DD
><DT
>/proc/sys/net/ipv4/icmp_echoreply_rate</DT
><DD
><P
>La tasa a la que se env√≠an mensajes de eco hacia cualquier destino.</P
></DD
><DT
>/proc/sys/net/ipv4/icmp_ignore_bogus_error_responses</DT
><DD
><P
>Active esto para ignorar los errores ICMP causados por m√°quinas de la red
que reaccionen mal a tramas enviadas a lo que perciben como la direcci√≥n
de difusi√≥n.</P
></DD
><DT
>/proc/sys/net/ipv4/icmp_paramprob_rate</DT
><DD
><P
>Un mensaje ICMP relativamente desconocido, que se env√≠a en respuesta a
paquetes incorrectos con cabeceras IP o TCP inv√°lidas. Con este fichero
puede controlar la tasa a la que son enviados.</P
></DD
><DT
>/proc/sys/net/ipv4/icmp_timeexceed_rate</DT
><DD
><P
>Esta es la causa de la famosa ¬´estrella del centro de Solaris¬ª en las
trazas de ruta. Limita el n√∫mero de mensajes Time Exceeded ICMP que se
env√≠an.</P
></DD
><DT
>/proc/sys/net/ipv4/igmp_max_memberships</DT
><DD
><P
>N√∫mero m√°ximo de sockets igmp (multicast) a la escucha en la m√°quina.
FIXME: ¬øEs esto cierto?</P
></DD
><DT
>/proc/sys/net/ipv4/inet_peer_gc_maxtime</DT
><DD
><P
>FIXME: ¬øA√±adir una breve explicaci√≥n sobre el almacenamiento de inet peer?

Intervalo m√≠nimo entre las pasadas de recolecci√≥n de basuras. Este
intervalo toma efecto mientras hay baja (o no hay) presi√≥n de memoria en
la reserva. Se mide en jiffies.</P
></DD
><DT
>/proc/sys/net/ipv4/inet_peer_gc_mintime</DT
><DD
><P
>Intervalo m√≠nimo entre pasadas de recolecci√≥n de basura. Este intervalo
tiene efecto durante presiones altas de memoria en la reserva. Se mide en
jiffies.</P
></DD
><DT
>/proc/sys/net/ipv4/inet_peer_maxttl</DT
><DD
><P
>Tiempo m√°ximo de vida de las entradas. Las que no se usan expirar√°n tras
este periodo de tiempo si no hay presi√≥n de memoria en la reserva (osea,
cuando el n√∫mero de entradas en la reserva sea muy peque√±o). Se mide en
jiffies.</P
></DD
><DT
>/proc/sys/net/ipv4/inet_peer_minttl</DT
><DD
><P
>Tiempo m√≠nimo de vida de las entradas. Deber√≠a ser suficiente para cubrir
el tiempo de vida de los fragmentos en el lado del reensamblaje. Este
tiempo de vida m√≠nimo queda garantizado si el tama√±o de la reserva es
menor que inet_peer_threshold. Se mide en jiffies.</P
></DD
><DT
>/proc/sys/net/ipv4/inet_peer_threshold</DT
><DD
><P
>Tama√±o aproximado del almacenamiento INET peer. Pasado este umbral, se
eliminar√°n entradas de forma agresiva. Este umbral tambi√©n determina el
tiempo de vida de las entradas y los intervalos de tiempo entre pasadas de
la recolecci√≥n de basura. M√°s entradas, menos tiempo de vida, menos
intervalos de recolecci√≥n de basuras.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_autoconfig</DT
><DD
><P
>Este fichero contiene el n√∫mero 1 si la m√°quina recibi√≥ su configuraci√≥n
IP mediante RARP, BOOTP, DHCP o un mecanismo similar. En caso contrario,
es cero.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_default_ttl</DT
><DD
><P
>Tiempo de vida de los paquetes. Viene con un valor sensato de 64.
Aum√©ntelo si tiene una red enorme. No lo haga por diversi√≥n (los bucles de
rutas causan mucho m√°s da√±o de esta manera). Incluso podr√≠a considerar
reducirlo bajo ciertas circunstancias.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_dynaddr</DT
><DD
><P
>Necesita configurarlo si usa llamada bajo demanda (dial on demand) con una
direcci√≥n de interfaz din√°mica. Una vez que la demanda levanta la
interfaz, se reenlazar√° con la direcci√≥n correcta cualquier socket TCP
local que no haya visto respuestas. Esto resuelve el problema de que la
conexi√≥n que levanta la interfaz en s√≠ misma no funcione, sino al segundo
intento.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_forward</DT
><DD
><P
>Si el n√∫cleo deber√≠a intentar reenviar paquetes. Inactivo por defecto.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_local_port_range</DT
><DD
><P
>Rango de puertos locales para las conexiones de salida. En realidad es muy
peque√±o por defecto, 1024 a 4999.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_no_pmtu_disc</DT
><DD
><P
>Active esto si desea desactivar Path MTU discovery (una t√©cnica para
determinar la Maximum Transfer Unit m√°s grande posible en su ruta.
Consulte tambi√©n la secci√≥n sobre Path MTU discovery en el cap√≠tulo
<I
CLASS="CITETITLE"
><A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.COOKBOOK"
>Cookbook</A
></I
>.</P
></DD
><DT
>/proc/sys/net/ipv4/ipfrag_high_thresh</DT
><DD
><P
>Cantidad m√°xima de memoria a usar para reensamblar los fragmentos IP.
Cuando se llegan a reservar ipfrag_high_thresh bytes de memoria para este
prop√≥sito, el gestor de fragmentos descartar√° paquetes hasta que se
alcance ipfrag_low_thresh.</P
></DD
><DT
>/proc/sys/net/ipv4/ip_nonlocal_bind</DT
><DD
><P
>Active esto si desea que sus aplicaciones sean capaces de asociarse a una
direcci√≥n que no pertenezca a un dispositivo de su sistema. Esto puede ser
√∫til cuando la m√°quina est√© en un enlace no permanente (o incluso
din√°mico), de manera que los servicios puedan arrancar y asociarse a una
direcci√≥n espec√≠fica incluso cuando el enlace no est√° presente.</P
></DD
><DT
>/proc/sys/net/ipv4/ipfrag_low_thresh</DT
><DD
><P
>Memoria m√≠nima usada para reensamblar fragmentos IP.</P
></DD
><DT
>/proc/sys/net/ipv4/ipfrag_time</DT
><DD
><P
>Tiempo en segundos que se mantendr√° un fragmento IP en memoria.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_abort_on_overflow</DT
><DD
><P
>Marca booleana que controla el comportamiento bajo gran cantidad de
peticiones de conexi√≥n. Cuando se activa, hace que el n√∫cleo env√≠e
paquetes RST de forma activa si un servicio est√° sobrecargado.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_fin_timeout</DT
><DD
><P
>Tiempo que se mantendr√° un socket en estado FIN-WAIT-2, si ha sido cerrado
en su lado. El otro extremo puede estar mal y no cerrar nunca por ese
lado, o incluso terminar de forma inesperada. El valor por defecto es de
60 segundos. El valor habitual usado en 2.2 era 180 segundos, y puede
restaurarlo, pero recuerde que incluso si su m√°quina es un servidor WEB de
poca carga, se arriesga a inundar la memoria con kilotones de sockets
muertos, ya que aunque los sockets FIN-WAIT-2 son menos peligrosos que los
FIN-WAIT-1, porque consumen 1.5K de memoria, tienden a vivir m√°s. Vea
tcp_max_orphans.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_keepalive_time</DT
><DD
><P
>Frecuencia con que TCP env√≠a mensajes keepalive cuando se activa
keepalive.

Por defecto: 2 horas.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_keepalive_intvl</DT
><DD
><P
>Con qu√© frecuencia se retransmiten sondas, cuando no son recibe respuesta
a ellas.

Por defecto: 75 segundos.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_keepalive_probes</DT
><DD
><P
>Cuantas sondas keepalive enviar√° TCP, hasta que decida que la conexi√≥n
est√° mal.

Valor por defecto: 9. 

Multiplicada por tcp_keepalive_intvl, nos da el tiempo que puede estar un
enlace sin responder tras haber enviado un keepalive.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_max_orphans</DT
><DD
><P
>N√∫mero m√°ximo de sockets TCP que no est√°n asociados con ning√∫n controlador
de fichero de usuario, mantenido por el sistema. Si se excede de este
n√∫mero, se reinician inmediatamente las conexiones hu√©rfanas y se imprime
un mensaje de aviso. Este l√≠mite existe s√≥lo para prevenir ataques DoS
sencillos, y _no debe_ depender de √©l o reducirlo de forma artificial,
sino incrementarlo, en todo caso (probablemente, tras un aumento de la
memoria instalada), si las condiciones de red precisan m√°s que el valor
por defecto, y ajuste los servicios de red para que hagan persistir y
destruyan tales estados de forma m√°s en√©rgica. Perm√≠tame record√°rselo de
nuevo: cada hu√©rfano consume hasta &nbsp;64K de memoria f√≠sica no
intercambiable.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_orphan_retries</DT
><DD
><P
>Cu√°ntas veces hay que reintentar antes de matar una conexi√≥n TCP, cerrada
por su lado. El valor por defecto de 7 corresponde a &nbsp;50seg-16min
dependiendo en el RTO. Si la m√°quina es un servidor web muy cargado,
deber√≠a pensar en reducir este valor, ya que tales sockets pueden consumir
recursos significativos. Vea tcp_max_orphans.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_max_syn_backlog</DT
><DD
><P
>N√∫mero m√°ximo de peticiones de conexi√≥n a recordar, que a√∫n no hayan
recibido confirmaci√≥n del cliente que conecta. El valor por defecto es
1023 para sistemas con m√°s de 128Mb de memoria, y 128 para m√°quinas con
poca memoria. Si el servidor sufre sobrecargas, intente aumentar este
n√∫mero. ¬°Cuidado! Si lo hace m√°s grande que 1024, ser√≠a mejor que cambiase
TCP_SYNQ_HSIZE en include/net/tcp.h para hacer que
TCP_SYNQ_HSIZE*16&#60;=tcp_max_syn_backlog y despu√©s recompile el n√∫cleo.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_max_tw_buckets</DT
><DD
><P
>N√∫mero m√°ximo de sockets en estado time-wait mantenidos de forma
simult√°nea por el sistema. Si se excede este n√∫mero se destruyen estos
sockets inmediatamente y se imprime un aviso. Este l√≠mite existe s√≥lo para
prevenir ataques DoS sencillos, y _no debe_ bajar el l√≠mite de forma
artificial, sino en todo caso aumentarlo (probablemente, tras incrementar
la memoria instalada), si las condiciones de la red precisan m√°s que el
valor por defecto.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_retrans_collapse</DT
><DD
><P
>Compatibilidad fallo-por-fallo con determinadas impresoras defectuosas.
Durante la retransmisi√≥n intentar√° enviar paquetes m√°s grandes para
saltarse los fallos de ciertas pilas TCP.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_retries1</DT
><DD
><P
>Cu√°ntas veces hay que reintentar antes de decidir que algo est√° mal y que
se necesita informar de esta sospecha a la capa de red. El valor m√≠nimo
seg√∫n el RFC es 3, y es el valor por defecto, que corresponde con
&nbsp;3seg-8min dependiendo del RTO.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_retries2</DT
><DD
><P
>Cu√°ntas veces hay que reintentar antes de matar una conexi√≥n TCP viva.
El <A
HREF="/web/20040611091246/http://www.ietf.org/rfc/rfc1122.txt"
TARGET="_top"
>RFC 1122</A
>
dice que este l√≠mite deber√≠a ser mayor de 100 segundos.
Este n√∫mero es demasiado peque√±o. El valor por defecto de 15 corresponde a
&nbsp;13-30min dependiendo del RTO.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_rfc1337</DT
><DD
><P
>Este booleano activa una correcci√≥n para los ¬´riesgos de asesinato de
time-wait en tcp¬ª, descritos en el RFC
1337. Si se activa, hace que el n√∫cleo descarte paquetes RST para los
sockets que est√°n en el estado time-wait.

Por defecto: 0</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_sack</DT
><DD
><P
>Usar ACK Selectivo que puede servir para comprobar si se est√°n perdiendo
paquetes espec√≠ficos (por tanto, ayuda a una recuperaci√≥n r√°pida).</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_stdurg</DT
><DD
><P
>Usa la interpretaci√≥n de requerimientos de la m√°quina del campo puntero
urg de TCP.

Muchas m√°quinas usan la interpretaci√≥n BSD antigua, de manera que si pone
esto en marcha en Linux podr√≠a no comunicarse correctamente con ellas.

Por defecto: FALSO</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_syn_retries</DT
><DD
><P
>N√∫mero de paquete SYN que enviar√° el n√∫cleo antes de rendirse durante el
inicio de una conexi√≥n.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_synack_retries</DT
><DD
><P
>Para abrir el otro lado de una conexi√≥n, en n√∫cleo env√≠a un SYN junto con
un ACK, para confirmar el SYN que recibi√≥ anteriormente. Esta es la
segunda parte del saludo de tres v√≠as <A
NAME="AEN1660"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#FTN.AEN1660"
><SPAN
CLASS="footnote"
>[3]</SPAN
></A
>.
Esta configuraci√≥n determina el n√∫mero de paquetes SYN+ACK a enviar antes
de que el kernel decida rendirse.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_timestamps</DT
><DD
><P
>Los registros de tiempo se usan, entre otras cosas, para protegerse contra
n√∫meros de secuencia que se solapen. Es concebible que un enlace de 1
gigabit reencuentre un n√∫mero de secuencia previo con un valor fuera de
l√≠nea, porque fue de una generaci√≥n previa. El registro de tiempo le
ayudar√° a reconocer este "paquete antiguo".</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_tw_recycle</DT
><DD
><P
>Activar un reciclado r√°pido de sockets TIME-WAIT. El valor por defecto es
1. No deber√≠a cambiarlo si no es por consejo/petici√≥n de expertos
t√©cnicos.</P
></DD
><DT
>/proc/sys/net/ipv4/tcp_window_scaling</DT
><DD
><P
>TCP/IP normalmente permite ventanas de hasta 65535 bytes. En redes
realmente r√°pido, esto podr√≠a no ser suficiente. Las opciones de escalado
permiten ventanas de hasta casi un gigabyte, lo cual es bueno para
productos con gran ancho de banda y mucho retraso.</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1674"
>13.2.2. Configuraci√≥n por dispositivo</A
></H3
><P
>DEV puede significar una interfaz real, o "todas" o "por defecto". Por
defecto tambi√©n cambia la configuraci√≥n de las interfaces que a√∫n est√°n
por crear.
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>/proc/sys/net/ipv4/conf/DEV/accept_redirects</DT
><DD
><P
>Si un router decide que estamos us√°ndolo para un prop√≥sigo equivocado
(necesita reenviar los paquetes por la misma interfa que los recibi√≥n),
nos enviar√° un ICMP Redirect. Sin embargo, esto implica un peque√±o riesgo
de seguridad, y puede que quiera desactivarlo, o usar secure redirects.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/accept_source_route</DT
><DD
><P
>Ya no se usa mucho. Antes se pod√≠a dar a un paquete una lista de
direcciones IP que deber√≠a visitar por el camino. Linux puede obedecer a
esta opci√≥n de IP.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/bootp_relay</DT
><DD
><P
>Aceptar paquetes con direcci√≥n de origen 0.b.c.d y destino diferente a
esta m√°quina como si fueran locales. Se supone que un demonio de reenv√≠o
de BOOTP atrapar√° y reenviar√° estos paquetes.</P
><P
>Por defecto es 0, ya que esta caracter√≠stica no est√° implementada a√∫n
(hablamos de la versi√≥n del n√∫cleo 2.2.12).</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/forwarding</DT
><DD
><P
>Activar o desactivar el reenv√≠o de IP por esta interfaz.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/log_martians</DT
><DD
><P
>Vea la secci√≥n sobre
<I
CLASS="CITETITLE"
><A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.KERNEL.RPF"
>Reverse Path Filtering</A
></I
>.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/mc_forwarding</DT
><DD
><P
>Para hacer reenv√≠o de multicast en esta interfaz.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/proxy_arp</DT
><DD
><P
>Si lo pone a 1, esta interfaz responder√° a consultas ARP para direcciones
hacia las que el n√∫cleo tiene rutas. Puede ser √∫til cuando se construyen
"pseudo bridges ip". ¬°Tenga cuidado de que las m√°scaras de red sean
correctas antes de activar esto! ¬°Tenga en cuenta tambi√©n que rp_filter,
mencionado anteriormente, tambi√©n opera sobre las consultas ARP!</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/rp_filter</DT
><DD
><P
>Vea la secci√≥n sobre
<I
CLASS="CITETITLE"
><A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.KERNEL.RPF"
>Reverse Path Filtering</A
></I
>.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/secure_redirects</DT
><DD
><P
>Aceptar mensajes ICMP redirect s√≥lo en las pasarelas, que aparecen en la
lista de pasarelas por defecto. Activo por defecto.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/send_redirects</DT
><DD
><P
>Si vamos a enviar las redirecciones mencionadas previamente.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/shared_media</DT
><DD
><P
>Si no est√° activo, el n√∫cleo no asume que que las diferentes subredes a
las que accede este dispositivo se puedan comunicar directamente. El valor
por defecto es ¬´s√≠¬ª.</P
></DD
><DT
>/proc/sys/net/ipv4/conf/DEV/tag</DT
><DD
><P
>FIXME: hay que rellenar esto</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1731"
>13.2.3. Normas de vecinos (Neighbor policy)</A
></H3
><P
>Dev puede significar una interfaz real, o "todas" o "por defecto". Por
defecto tambi√©n cambia la configuraci√≥n de las interfaces que a√∫n est√°n
por crear.
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>/proc/sys/net/ipv4/neigh/DEV/anycast_delay</DT
><DD
><P
>Retraso aleatorio m√°ximo de las respuestas a los mensajes Neigbor
Solicitation en jiffies (1/100 seg). A√∫n no est√°
implementado (Linux todav√≠a no soporta anycast).</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/app_solicit</DT
><DD
><P
>Determina el n√∫mero de peticiones a enviar al demonio ARP de nivel de
usuario. Use 0 para apagarlo.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/base_reachable_time</DT
><DD
><P
>Un valor de base usado para calcular al azar el tiempo de accesibilidad
(Reachable Time) tal como se especifica en el RFC2461.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/delay_first_probe_time</DT
><DD
><P
>Retraso de la primera sonda de tiempo si se puede acceder al vecino (vea
gc_stale_time)</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/gc_stale_time</DT
><DD
><P
>Determina con qu√© frecuencia se comprueban las entradas congeladas en ARP.
Tras congelarse una entrada ARP se intentar√° resolver de nuevo (lo cual es
√∫til cuando una direcci√≥n IP pasa a otra m√°quina). Cuando ucast_solicit es
mayor que 0, primero intenta enviar un paquete ARP directamente a la
m√°quina conocida. Si esto falla y mcast_solicit es mayor que 0, se
difunde una petici√≥n ARP.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/locktime</DT
><DD
><P
>Una entrada de ARP/neighbor s√≥lo se reemplaza con una nueva si el valor
antiguo es de hace al menos "locktime". Esto evita sacudidas en la cach√©
ARP.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/mcast_solicit</DT
><DD
><P
>N√∫mero m√°ximo de reintetnos para una solicitud multicast.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/proxy_delay</DT
><DD
><P
>Tiempo m√°ximo (el tiempo real es aleatorio &lsqb;0..proxytime]) antes de
contestar a una consulta ARP para la cual tenemos una entrada proxy ARP.
En algunos casos, se usa para evitar inundaciones de red.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/proxy_qlen</DT
><DD
><P
>Longitud m√°xima de la cola del temporizador proxy arp retrasado. (vea
proxy_delay).</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/retrans_time</DT
><DD
><P
>El tiempo, expresado en jiffies (1/100 sec), entre mensajes Neighbor
Solicitation retransmitidos. Se usa para resolver direcciones y determinar
si se puede alcanzar a un vecino.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/ucast_solicit</DT
><DD
><P
>N√∫mero m√°ximo de reintentos para una solicitud unicast.</P
></DD
><DT
>/proc/sys/net/ipv4/neigh/DEV/unres_qlen</DT
><DD
><P
>Tama√±o m√°ximo de la cola para una consulta arp pendiente (el n√∫mero de
paquetes que se aceptan de otras capas mientras a√∫n est√° por resolver una
direcci√≥n ARP).</P
></DD
><DT
>Internet QoS: Architectures and Mechanisms for Quality of Service,
Zheng Wang, ISBN 1-55860-608-4</DT
><DD
><P
>Libro en tapas duras que cubre temas
relacionados con la Calidad de Servicio. Bueno para comprender los
conceptos b√°sicos.</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1787"
>13.2.4. Configuraci√≥n de encaminamiento</A
></H3
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>/proc/sys/net/ipv4/route/error_burst</DT
><DD
><P
>Estos par√°metros se usan para limitar los mensajes de aviso escritos desde
el c√≥digo de encaminamiento al registro del n√∫cleo. Cuanto m√°s grande sea
error_cost, menos mensajes se escriben. Error_burst controla cuando
descartar mensajes. Los valores por defecto limitan los mensajes de aviso
a uno cada cinco segundos.</P
></DD
><DT
>/proc/sys/net/ipv4/route/error_cost</DT
><DD
><P
>Estos par√°metros se usan para limitar los mensajes de aviso escritos desde
el c√≥digo de encaminamiento al registro del n√∫cleo. Cuanto m√°s grande sea
error_cost, menos mensajes se escriben. Error_burst controla cuando
descartar mensajes. Los valores por defecto limitan los mensajes de aviso
a uno cada cinco segundos.</P
></DD
><DT
>/proc/sys/net/ipv4/route/flush</DT
><DD
><P
>Escribir en este fichero hace que se vac√≠e la cach√© de rutas.</P
></DD
><DT
>/proc/sys/net/ipv4/route/gc_elasticity</DT
><DD
><P
>Valores para controlar la frecuencia y comportamiento del algoritmo
recolector de basuras de la cach√© de rutas. Puede ser importante en alta
disponibilidad cuando se hace el cambio de m√°quina. Pasar√°n al menos
gc_timeout segundos antes de que Linux salte a otra ruta porque la
anterior ha muerto. Por defecto se pone a 300, pero puede que quiera
rebajarla para tener un cambio r√°pido.</P
><P
>Vea tambi√©n <A
HREF="/web/20040611091246/http://mailman.ds9a.nl/pipermail/lartc/2002q1/002667.html"
TARGET="_top"
>este mensaje</A
> de Ard van Breemen.</P
></DD
><DT
>/proc/sys/net/ipv4/route/gc_interval</DT
><DD
><P
>Vea /proc/sys/net/ipv4/route/gc_elasticity.</P
></DD
><DT
>/proc/sys/net/ipv4/route/gc_min_interval</DT
><DD
><P
>Vea /proc/sys/net/ipv4/route/gc_elasticity.</P
></DD
><DT
>/proc/sys/net/ipv4/route/gc_thresh</DT
><DD
><P
>Vea /proc/sys/net/ipv4/route/gc_elasticity.</P
></DD
><DT
>/proc/sys/net/ipv4/route/gc_timeout</DT
><DD
><P
>Vea /proc/sys/net/ipv4/route/gc_elasticity.</P
></DD
><DT
>/proc/sys/net/ipv4/route/max_delay</DT
><DD
><P
>Retrasos para vaciar la cach√© de rutas.</P
></DD
><DT
>/proc/sys/net/ipv4/route/max_size</DT
><DD
><P
>Tama√±o m√°ximo de la cach√© de rutas. Las entradas viejas se purgan una vez
que la cach√© alcance este tama√±o.</P
></DD
><DT
>/proc/sys/net/ipv4/route/min_adv_mss</DT
><DD
><P
>FIXME: rellenar esto</P
></DD
><DT
>/proc/sys/net/ipv4/route/min_delay</DT
><DD
><P
>Retrasos al vaciar la cach√© de rutas.</P
></DD
><DT
>/proc/sys/net/ipv4/route/min_pmtu</DT
><DD
><P
>FIXME: rellenar esto</P
></DD
><DT
>/proc/sys/net/ipv4/route/mtu_expires</DT
><DD
><P
>FIXME: rellenar esto</P
></DD
><DT
>/proc/sys/net/ipv4/route/redirect_load</DT
><DD
><P
>Factores que determinan si se deber√≠an enviar m√°s ICMP Redirect a una
m√°quina espec√≠fica. No se enviar√°n m√°s redirect una vez que se haya
alcanzado el l√≠mite de carga o el n√∫mero m√°ximo de redirecciones.</P
></DD
><DT
>/proc/sys/net/ipv4/route/redirect_number</DT
><DD
><P
>Vea /proc/sys/net/ipv4/route/redirect_load.</P
></DD
><DT
>/proc/sys/net/ipv4/route/redirect_silence</DT
><DD
><P
>L√≠mite de tiempo para los redirect. Tras este periodo se enviar√° de nuevo
un redirect, incluso si se hab√≠a parado por alcanzar el l√≠mite de carga o
de env√≠os.</P
></DD
></DL
></DIV
></P
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.ADV-QDISC"
></A
>Cap√≠tulo 14. Disciplinas de cola avanzadas y poco conocidas</H1
><P
>Si encuentra que tiene necesidades que no cubren las colas mencionadas
anteriormente, el n√∫cleo contiene algunas otras colas m√°s especializadas
que se mencionan aqu√≠.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.BFIFO-PFIFO"
>14.1. <VAR
CLASS="LITERAL"
>bfifo</VAR
>/<VAR
CLASS="LITERAL"
>pfifo</VAR
></A
></H2
><P
>Estas colas sin clases son incluso m√°s sencillas que pfifo_fast ya que no
tienen bandas internas (realmente todo el tr√°fico es igual). Sin embargo
tienen un beneficio importante, dan estad√≠sticas. De manera que si no
necesita ajustar o priorizar tr√°fico, puede usar estas colas para
determinar cu√°n llena est√° la interfaz.</P
><P
>pfifo mide en paquetes, y bfifo en bytes.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1870"
>14.1.1. Par√°metros y uso</A
></H3
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>limit</DT
><DD
><P
>Especifica la longitud de la cola. Se mide en bytes para bfifo, y en
paquetes para pfifo. Por defecto es txqueuelen de la interfaz (vea el
cap√≠tulo sobre pfifo_fast) en paquetes o txqueuelen*mtu bytes para bfifo.</P
></DD
></DL
></DIV
></P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.CSZ"
>14.2. Algoritmo Clark-Shenker-Zhang (CSZ)</A
></H2
><P
>Es tan te√≥rico que ni siquiera Alexey (el autor principal de CBQ) dice
entenderlo. De su c√≥digo fuente:</P
><A
NAME="AEN1881"
></A
><BLOCKQUOTE
CLASS="BLOCKQUOTE"
><P
>David D. Clark, Scott Shenker y Lixia Zhang
<I
CLASS="CITETITLE"
>Soporte para aplicaciones de tiempo real en una red de paquetes
de servicios integrados: Arquitectura y mecanismos</I
>.</P
><P
>Hasta donde lo entiendo, la idea principal es crear flujos WFQ para cada
servicio garantizado y reservar el resto de ancho de banda para el
flujo-0. El flujo-0 comprende los servicios predictivos y el tr√°fico de
mejor esfuerzo; lo controla un organizador de prioridades con la banda de
m√°xima prioridad reservada para los servicios restringidos, y el resto a
los paquetes de mejor esfuerzo.</P
><P
>Tenga en cuenta que en CSZ los flujos NO est√°n limitados a su ancho de
banda. Se supone que el flujo pasa un control de admisi√≥n al borde de la
red QoS y no necesita m√°s ajustes. Cualquier intento de mejorar el flujo o
de ajustarlo a un tocken bucket en saltos intermedios producir√° retrasos
indeseados y aumentar√° las variaciones (jitter).</P
><P
>Por el momento CSZ es el √∫nico organizador que proporciona servicio
garantizado real. Otros esquemas (incluido CBQ) no proporcionan un retraso
garantizado ni variaciones aleatorias."</P
><P
>No parece un buen candidato para ser usado, a menos que haya le√≠do y
entendido el art√≠culo mencionado.</P
></BLOCKQUOTE
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.DSMARK"
>14.3. DSMARK</A
></H2
><BLOCKQUOTE
CLASS="ABSTRACT"
><DIV
CLASS="ABSTRACT"
><P
></P
><A
NAME="AEN1890"
></A
><P
>      Esteve Camps
      <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:marvin@grn.es"
>marvin@grn.es</A
>&#62;</CODE
></P
>
      Este texto es un extracto de mi tesis sobre
      <I
CLASS="CITETITLE"
>Soporte de QoS en Linux</I
>, septiembre de 2000.
    </P
><P
></P
></DIV
></BLOCKQUOTE
><P
>Documentos fuente:</P
><P
></P
><UL
><LI
><P
>    <A
HREF="/web/20040611091246/ftp://icaftp.epfl.ch/pub/linux/diffserv/misc/dsid-01.txt.gz"
TARGET="_top"
>      Draft-almesberger-wajhak-diffserv-linux-01.txt</A
>.
  </P
></LI
><LI
><P
>Ejemplos en la distribuci√≥n de iproute2.
  </P
></LI
><LI
><P
>    <A
HREF="/web/20040611091246/http://www.qosforum.com/white-papers/qosprot_v3.pdf"
TARGET="_top"
>      White Paper sobre protoclos y arquitecturas QoS</A
> y
    <A
HREF="/web/20040611091246/http://www.qosforum.com/docs/faq"
TARGET="_top"
>      Preguntas frecuentes sobre QoS IP</A
> ambos del
    <I
CLASS="CITETITLE"
>Quality of Service Forum</I
>.
  </P
></LI
></UL
><P
>Este cap√≠tulo ha sido escrito por Esteve Camps
&lt;esteve@hades.udg.es&gt;.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1911"
>14.3.1. Introducci√≥n</A
></H3
><P
>Antes de nada, ser√≠a una buena idea leer los RFC escritos a este respecto
(RFC2474, RFC2475, RFC2597 y RFC2598) que encontrar√° en el
<A
HREF="/web/20040611091246/http://www.ietf.org/html.charters/diffserv-charter.html"
TARGET="_top"
>  sitio web del Grupo de trabajo IETF DiffServ</A
> y
<A
HREF="/web/20040611091246/http://diffserv.sf.net/"
TARGET="_top"
>  el sitio web de Werner Almesberger</A
>
(ha escrito el c√≥digo para dar soporte en Linux a los Servicios
Diferenciados).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1916"
>14.3.2. ¬øCon qu√© se relaciona Dsmark?</A
></H3
><P
>Dsmark es una disciplina de colas que ofrece las capacidades necesarias
para los Servicios Diferenciados (tambi√©n conocidos como DiffServ o
simplemente DS). DiffServ es una de las dos arquitecturas QoS actuales (la
otra se llama Servicios Integrados) que se basa en un valor transportado
por los paquetes en el campo DS de la cabecera IP.</P
><P
>Una de las primeras soluciones en IP dise√±adas a ofrecer alg√∫n nivel de
QoS fue el campo Type of Service (el byte TOS) de la cabecera IP.
Cambiando este valor, pod√≠amos escoger un nivel alto/bajo de
transferencia, retraso o fiabilidad. Pero esto no proporcionaba suficiente
flexibilidad para las necesidades de los nuevos servicios (como las
aplicaciones en tiempo real, las interactivas y otras). Tras esto,
aparecieron nuevas arquitecturas. Una de ellas fue DiffServ, que mantuvo
los bits TOS y los renombr√≥ como el campo DS.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1920"
>14.3.3. Principios de los Servicios Diferenciados</A
></H3
><P
>Los Servicios Diferenciados est√°n orientados al grupo. Quiero decir, no
sabemos nada sobre flujos (√©ste es el prop√≥sito de los Servicios
Integrados); s√≥lo sabemos sobre agregaciones de flujos y aplicaremos
diferentes comportamientosdependiendo a qu√© agregaci√≥n pertenezca un
paquete.</P
><P
>Cuando llega un paquete a un nodo exterior (edge node - nodo de entrada a
un dominio DiffServ) entrando a un Dominio DiffServ, tendremos que
controlar, ajustar o marcar estos paquetes (el marcado se refiere a
asignar un valor al campo DS; exactamente igual que con las vacas :-) ).
Esta ser√° la marca/valor que mirar√°n los nodos internos de nuestro Dominio
DiffServ para determinar qu√© comportamiento o nivel de QoS aplicar.</P
><P
>Como puede deducir, los Servicios Diferenciados implican un dominio dentro
del cual se deber√°n aplicar todas las reglas de DS. En realidad, puede
pensar que voy a clasificar todos los paquetes que entran en mi dominio.
Una vez que entran todos estar√°n sujetos a las normas que mi clasificaci√≥n
dicta y cada nodo que atraviesen aplicar√° ese nivel de QoS.</P
><P
>En realidad, se pueden aplicar normas propias en los dominios locales,
pero se deben tener en cuenta algunos <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>Acuerdos de nivel de
servicio</I
></SPAN
> (Service Level Agreements) cuando se conecta a otros
dominios DS.</P
><P
>En este punto, debe tener muchas preguntas. DiffServ es m√°s de lo que he
explicado. En realidad, entender√° que no puedo resumir m√°s de 3 RFC en
s√≥lo 50 l√≠neas :-).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1928"
>14.3.4. Trabajar con Dsmark</A
></H3
><P
>Como especifica la bibliograf√≠a de DiffServ, diferenciamos entre nodos
externos (o lim√≠trofes) e internos. Son dos puntos importantes en el
camino del tr√°fico. Ambos tipos realizan una clasificaci√≥n cuando llega el
paquete. Su resultado puede usarse en diferentes lugares a lo largo del
proceso de DS antes de que se envi√© el paquete a la red. Es por esto que
el c√≥digo de diffserv proporciona una estructura llamada sk_buff, que
incluye un campo nuevo llamado skb-&gt;tc_index donde almacenaremos el
resultado de la clasificaci√≥n inicial que puede usarse en varios momentos
del tratamiento DS.</P
><P
>El valor de skb-&gt;tc_index lo establecer√° inicialmente la qdisc DSMARK,
sac√°ndola del campo DS de la cabecera IP de cada paquete recibido. Aparte,
el clasificador cls_tcindex leer√° todo o parte del valor de
skb-&gt;tcindex y lo usar√° para escoger las clases.</P
><P
>Pero antes que nada, echemos un vistazo a la orden de la qdisc DSMAR y sus
par√°metros:

<PRE
CLASS="SCREEN"
>... dsmark indices INDICES [ default_index INDICE_DEFECTO ] [ set_tc_index ]</PRE
>

¬øQu√© significan estos par√°metros?

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>indices</I
></SPAN
>: tama√±o de la tabla de pares
(m√°scara,valor). El tama√±o m√°ximo es 2&circ;n, siendo n&gt;=0.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>default_index</I
></SPAN
>: La entrada por defecto del
√≠ndice de la tabla si el clasificador no encuentra coincidencia.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>Set_tc_index</I
></SPAN
>: instruye a la disciplina
dsmark para que obtenga el campo DS y lo almacene en skb-&gt;tc_index.</P
></LI
></UL
>

Veamos el proceso de DSMARK.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1944"
>14.3.5. C√≥mo trabaja SCH_DSMARK.</A
></H3
><P
>Esta qdisc seguir√° los siguientes pasos:

<P
></P
><UL
><LI
><P
>Si hemos declarado la opci√≥n set_tc_index en la orden de la qdisc, se
obtiene el campo DS y se almacena en la variable skb-&gt;tc_index.</P
></LI
><LI
><P
>Se invoca al clasificador. Ser√° ejecutado y devolver√° un ID de clase que
ser√° almacenado en la variable skb-&gt;tc_index. Si no se encuentra ning√∫n
filtro que concuerde, optaremos por la opci√≥n default_index como classId
a almacenar. Si no se ha declarado ni set_tc_index ni default_index el
resultado puede ser impredecible.</P
></LI
><LI
><P
>Despues de ser enviado a las qdisc internas donde se puede reutilizar el
resultado del filtro, se almacena el classid devuelto por la qdisc interna
en skb-&gt;tc_index. Usaremos este valor en adelante para indizar una
tabla m√°scara-valor. El resultado final a asignar al paquete ser√° el que
resulte de la siguiente operaci√≥n:

<PRE
CLASS="SCREEN"
>Nuevo_Campo_Ds = ( Viejo_Campo_Ds &#38; m√°scara ) | valor</PRE
>
&#13;</P
></LI
><LI
><P
>Por tanto, el nuevo valor saldr√° de aplicar AND a los valores ds_field y
m√°scara, para despu√©s aplicar al resultado un OR con el par√°metro valor.
Vea el siguiente diagrama para entender todo el proceso:</P
></LI
></UL
>


<PRE
CLASS="SCREEN"
>                         skb-&gt;ihp-&gt;tos
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;
     |                                                       |     ^
     | -- Si declara set_tc_index, almacenamos el            |     |  &lt;-----Puede cambiar
     |    valor de DS en la variable skb-&gt;tc_index           |     |O       el campo DS
     |                                                      A|     |R
   +-|-+      +------+    +---+-+     Qdisc     +-+     +---N|-----|----+
   | | |      |filtro|---&gt;|   | |--&gt;  . . .  --&gt;| |     |   D|     |    |
   | | |-----&gt;|√≠ndice|---&gt;|   | |    Interna    | |----&gt;|    v     |    |
   | | |      | tc   |---&gt;| | | +---------------+ |   ----&gt;(m√°sc,valor) |
--&gt;| O |      +------+    +-|-+--------------^----+  /  |  (.  ,  .)    |
   | | |          ^         |                |       |  |  (.  ,  .)    |
   | | +----------|---------|----------------|-------|--+  (.  ,  .)    |
   | | sch_dsmark |         |                |       |                  |
   +-|------------|---------|----------------|-------|------------------+
     |            |         | &lt;- tc_index -&gt; |       |
     |            |(leer)   |  puede cambiar |       |  &lt;--------------Indice a la
     |            |         |                |       |                    tabla de pares
     v            |         v                v       |                    (m√°sc,valor)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&gt;
                         skb-&gt;tc_index</PRE
>&#13;</P
><P
>¬øC√≥mo se marca? Cambie la m√°scara y el valor de la clase que quiere
remarcar. Vea la siguiente l√≠nea de c√≥digo:

<PRE
CLASS="SCREEN"
>tc class change dev eth0 classid 1:1 dsmark mask 0x3 value 0xb8</PRE
>

Esto cambia el par (m√°sc,valor) de la tabla hash, para remarcar paquete
que pertenecen a la clase 1:1. Tiene que "cambiar" estos valores por los
valores por defecto que obtiene inicialmente (m√°sc,valor). (Vea la tabla
m√°s adelante)</P
><P
>Ahora, explicaremos c√≥mo funciona el filtro TC_INDEX y c√≥mo cuadra en todo
esto. Adem√°s, se puede usar el filtro TC_INDEX en otras configuraciones
aparte de las que incluyen servicios DS.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1961"
>14.3.6. Filtro TC_INDEX</A
></H3
><P
>Esta es la orden b√°sica para declarar un filtro TC_INDEX:

<PRE
CLASS="SCREEN"
>... tcindex [ hash TAMA√ëO ] [ mask MASCARA ] [ shift SHIFT ]
            [ pass_on | fall_through ]
            [ classid CLASSID ] [ police ESPEC_NORMA ]</PRE
>

Luego, mostramos unos ejemplos para explicar el modo de operaci√≥n de
TC_INDEx. Preste atenci√≥n a las palabras resaltadas:


tc qdisc add dev eth0 handle 1:0 root dsmark indices 64 <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>set_tc_index</I
></SPAN
>

tc filter add dev eth0 parent 1:0 protocol ip prio 1 tcindex <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>mask 0xfc  shift 2</I
></SPAN
>

tc qdisc add dev eth0 parent 1:0 handle 2:0 cbq bandwidth 10Mbit cell 8 avpkt 1000 mpu 64

&num; class de tr√°fico EF

tc class add dev eth0 parent 2:0 classid 2:1 cbq bandwidth 10Mbit rate 1500Kbit avpkt 1000 prio 1 bounded isolated allot 1514 weight 1 maxburst 10

&num; qdisc fifo de paquetes para tr√°fico EF

tc qdisc add dev eth0 parent 2:1 pfifo limit 5

tc filter add dev eth0 parent 2:0 protocol ip prio 1 <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>handle 0x2e</I
></SPAN
> tcindex <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>classid 2:1 pass_on</I
></SPAN
>



(Este c√≥digo no est√° completo. Es s√≥lo un extracto del ejemplo EFCBQ
incluido en la distribuci√≥n de iproute2).</P
><P
>Antes de nada, supongamos que recibimos un paquete marcado como EF. Si lee
el RFC2598, ver√° que el valor DSCP recomendado para el tr√°fico EF es
101110. Esto significa que el campo DS ser√° 101110 (recuerde que los bits
menos significativos en el byte TOS no se usan en DS) o 0xb8 en c√≥digo
hexadecimal.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>              FILTRO
              TC INDEX
   +---+      +-------+    +---+-+    +------+                +-+    +-------+
   |   |      |       |    |   | |    |MANEJA|  +-+    +-+    | |    |       |
   |   |-----&gt;| MASC  | -&gt; |   | | -&gt; |FILTRO|-&gt;| |    | | -&gt; | | -&gt; |       |
   |   |  .   | =0xfc |    |   | |    |0x2E  |  | +----+ |    | |    |       |
   |   |  .   |       |    |   | |    +------+  +--------+    | |    |       |
   |   |  .   |       |    |   | |                            | |    |       |
--&gt;|   |  .   | SHIFT |    |   | |                            | |    |       |--&gt;
   |   |  .   | =2    |    |   | +----------------------------+ |    |       |
   |   |      |       |    |   |       CBQ 2:0                  |    |       |
   |   |      +-------+    +---+--------------------------------+    |       |
   |   |                                                             |       |
   |   +-------------------------------------------------------------+       |
   |                          DSMARK 1:0                                     |
   +-------------------------------------------------------------------------+&#13;</PRE
>&#13;</P
><P
>Entonces llega el paquete con el valor del campo DS puesto a 0xb8. Como
explicamos anteriormente, la qdisc dsmark identificada por el id 1:0 en el
ejemplo toma el campo DS y lo almacena en la variable skb-&gt;tc_index. El
siguiente paso del ejemplo corresponde al filtro asociado con esta qdisc
(segunda l√≠nea del ejemplo).
Esto realizar√° las siguientes operaciones:

<PRE
CLASS="SCREEN"
>Valor1 = skb-&#62;tc_index &#38; MASK
Clave = Valor1 &#62;&#62; SHIFT</PRE
>&#13;</P
><P
>En el ejemplo, MASC=0xFC i SHIFT=2.

<PRE
CLASS="SCREEN"
>Valor1 = 10111000 &#38; 11111100 = 10111000
Clave = 10111000 &#62;&#62; 2 = 00101110 -&#62; 0x2E en hexadecimal</PRE
>&#13;</P
><P
>El valor de recotno corresponder√° a un controlador de filtro de una qdisc
interna (en el ejemplo, el identificador 2:0). Si existe un filtro con
este id, se verificar√°n las condiciones de control y medida (en caso de
que el filtro las incluya) y se devolver√° y almacenar√° en la variable
skb-&gt;tc_index el classid (en nuestro ejemplo, classid 2:1).</P
><P
>Pero si se encuentra un filtro con ese identificador, el resultado
depender√° de la declaraci√≥n de fall_through. Si la hay, se devolver√° como
classid el valor clave. Si no, se devuelve un error y contin√∫a el proceso
con el resto de filtros. Sea cuidadoso si usa fall_through; se puede hacer
si existe una relaci√≥n simple entre los valores de la variable
skb-&gt;tc_index y el id de la clase.</P
><P
>Los √∫ltimos par√°metros que hay que comentar son hash y pass_on. El primero
se refiere al tama√±o de la tabla hash. Pass_on se usa para indicar que si
no se encuentra un classid igual al resultado de este filtro, se debe
intentar con el siguiente filtro. La acci√≥n por defecto es fall_through
(vea la siguiente tabla)</P
><P
>Por √∫ltimo, veamos qu√© valores posibles se pueden dar a todos estos
par√°metros de TCINDEX:

<PRE
CLASS="SCREEN"
>Nombre TC               Valor           Por defecto
-----------------------------------------------------------------
Hash                    1...0x10000     Dependiente de la implementaci√≥n
Mask                    0...0xffff      0xffff
Shift                   0...15          0
Fall through / Pass_on  Flag            Fall_through
Classid                 Mayor:menor     Nada
Police                  .....           Nada</PRE
>&#13;</P
><P
>Este tipo de filtro es muy poderoso. Es necesario explorar todas sus
posibilidades. M√°s a√∫n, este filtro no se usa s√≥lo en las configuraciones
con DiffServ. Lo puede usar como cualquier otro tipo de filtro.</P
><P
>Recomiendo que mire todos los ejemplos de DiffServ que se incluyen en la
distribuci√≥n de iproute2. Prometo que tratar√© de completar este texto lo
m√°s pronto que pueda. Adem√°s, todo lo que he explicado es el resultado de
muchas pruebas. Le agradecer√≠a que me dijese si me he equivocado en alg√∫n
momento.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.INGRESS"
>14.4. Qdisc de entrada (Ingress)</A
></H2
><P
>Todas las qdisc comentadas hasta ahora eran de salida. Sin embargo, cada
interfaz tiene tambi√©n una qdisc de entrada que no se usa para enviar
paquetes hacia el adaptador de red. En su lugar, permite aplicar filtros
de tc a los paquetes que vienen desde la interfaz, independientemente de
si su destino es local o han de ser reenviados.</P
><P
>Como los filtros de tc contienen una implementaci√≥n completa del Token
Bucket Filter, y tambi√©n son capaces de trabajar con el estimador de flujo
del n√∫cleo, hay mucha funcionalidad disponible. Esto permite de forma
efectiva controlar el tr√°fico entrante, antes incluso de que entre en la
pila IP.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN1987"
>14.4.1. Par√°metros y uso</A
></H3
><P
>La qdisc de entrada en s√≠ misma no precisa par√°metros. Difiere de las otas
qdisc en que no ocupa la ra√≠z de un dispositivo. As√≥ciela de esta manera:

<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 ingress</PRE
>

Esto le permite tener otras qdisc de env√≠o en el dispositivo aparte de la
de entrada.</P
><P
>Encontrar√° un ejemplo contribuido sobre el posible uso de la qdisc de
entrada en el Recetario.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.RED"
>14.5. Random Early Detection (RED)</A
></H2
><P
>Esta secci√≥n pretende ser una introducci√≥n al encaminamiento en
¬´backbones¬ª <A
NAME="AEN1995"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#FTN.AEN1995"
><SPAN
CLASS="footnote"
>[4]</SPAN
></A
>, que a menudo implica
anchos de banda de &gt;100 megabits, lo que precisa de un enfoque
diferente que para el m√≥dem ADSL de casa.</P
><P
>El comportamiento normal de las colas de router en la Internet se denomina
"tail-drop". El tail-drop (descarte de √∫ltimos) funciona encolando hasta
una cierta cantidad, y descartando despu√©s todo el tr√°fico que "se
rebose". Esto es bastante poco justo, y lleva a sincronizaci√≥n de
retransmisi√≥n. Cuando sucede esta sincronizaci√≥n, la s√∫bita r√°faja de
descartes del router que ha llegado a su tope causa una r√°faga retardada
de retransmisiones, que vuelve a llenar en exceso el router congestionado.</P
><P
>Para copar con la congesti√≥n transitoria de los enlaces, los router de
backbone a menudo implementan grandes colas. Desafortunadamente, mientras
que estas colas est√°n bien para la transferencia, pueden incrementar
sustancialmente la latencia y causar que las conexiones TCP se comporten
a r√°fagas durante la congesti√≥n.</P
><P
>Los problemas de tail-drop est√°n empezando a ser cada vez m√°s acuciantes
en Internet debido al uso creciente de aplicaciones poco amigables para
las redes. El n√∫cleo de Linux nos ofrece RED, abreviatura de Random Early
Detect (detecci√≥n aleatoria temprana), tambi√©n denominada Random Early
Drop (descarte aleatorio temprano), ya que es as√≠ como funciona.</P
><P
>RED no es un remedio milagroso para todo esto, y las aplicaciones que no
implementen esperas tras colisi√≥n (backoff) exponenciales seguir√°n
llenando una porci√≥n demasiado grande del ancho de banda, pero con RED no
causan tanto da√±o a la transferencia y la latencia de otras conexiones.</P
><P
>RED descarta paquetes de los flujos estad√≠sticamente antes de que lleguen
a un l√≠mite absoluto (hard). Esto hace que un enlace congestionado en un
backbone reduzca la marcha de una manera m√°s elegante, y evita la
sincronizaci√≥n de retransmisiones. Tambi√©n ayuda a TCP a encontrar su
velocidad "correcta" m√°s r√°pido permitiendo que algunos paquetes caigan
pronto manteniendo bajo el tama√±o de las colas y la latencia bajo control.
La probabilidad de que se descarte un paquete de una conexi√≥n particular
es proporcional a su uso de ancho de banda en lugar de al n√∫mero de
paquetes que transmite.</P
><P
>RED es una buena cola para backbones, donde no te puedes permitir la
complejidad de supervisar el estado por sesi√≥n que se necesita para un
encolado correcto.</P
><P
>Para usar RED, debe decidir tres par√°metros: Min, Max, y burst. Min
establece el tama√±o m√≠nimo de la cola en bytes antes de que empiecen los
descartes, Max es un m√°ximo preventivo (soft) bajo el que intenta
mantenerse el algoritmo, y burst especifica el n√∫mero m√°ximo de paquetes
que pueden "pasar en r√°faga".</P
><P
>Deber√≠a establecer min calculando la latencia b√°sica m√°s alta aceptable
que desea en las colas, multiplic√°ndola por el ancho de banda. Por
ejemplo, en mi enlace RDSI de 64kbit/s, querr√≠a una latencia base de cola
de 200ms de manera que pongo un m√≠nimo de 1600 bytes. Poner un min
demasiado peque√±o degradar√° la transferencia y demasiado grande degradar√°
la latencia. Poner un min peque√±o no es un reemplazo de la reducci√≥n de la
MTU en un enlace lento para mejorar la respuesta interactiva.</P
><P
>Deber√≠a poner un max de al menos el doble que min para evitar la
sincronizaci√≥n. En enlaces lentos con Min peque√±o quiz√° fuera m√°s sensato
hacer max cuatro o cinco veces m√°s grande que min.</P
><P
>Burst controla c√≥mo responde el algoritmo RED a las r√°fagas. Burst se debe
hacer m√°s grande que min/avpkt. De forma experimental he establecido que
(min+min+max)/(3*avpkt) funciona bien.</P
><P
>Adem√°s, necesita indicar limit y avpkt. Limit es un valor de seguridad, y
tras pasar la cola de limit bytes, RED "se pone en modo" tail-drop.
Normalmente pongo el l√≠mite en ocho veces max. Avpkt deber√≠a ser el tama√±o
medio de los paquetes. 1000 funciona BIEN en enlaces de Internet de alta
velocidad con una MTU de 1500.</P
><P
>Lea el <A
HREF="/web/20040611091246/http://www.aciri.org/floyd/papers/red/red.html"
TARGET="_top"
>documento sobre colas RED</A
> de Sally Floyd y Van Jacobson si de sea informaci√≥n
t√©cnica.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.GRED"
>14.6. Generic Random Early Detection</A
></H2
><P
>No se sabe mucho sobre GRED. Se parece a RED con varias colas internas,
siendo escogidas estas colas internas bas√°ndose en el campo tcindex de
DiffServ. De acuerdo a una transparencia que se encuentra
<A
HREF="/web/20040611091246/http://www.davin.ottawa.on.ca/ols/img22.htm"
TARGET="_top"
>aqu√≠</A
>,
contiene las capacidades del ¬´Distributed Weighted RED¬ª de Cisco, as√≠ como
del RIO de Dave Clark.</P
><P
>Cada paquete virtual puede tener especificados sus propios par√°metros de
descarte (Drop Parameters).</P
><P
>FIXME: hacer que Jamal o Werner nos cuenten m√°s</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.VC-ATM"
>14.7. Emulaci√≥n VC/ATM</A
></H2
><P
>Este es un gran esfuerzo de Werner Almesberger para permitirle construir
Circuitos Virtuales sobre sockets TCP/IP. Un Circuito Virtual es un
concepto que viene de la teor√≠a de redes ATM.</P
><P
>Si desea m√°s informaci√≥n, consulte la <A
HREF="/web/20040611091246/http://linux-atm.sourceforge.net/"
TARGET="_top"
>p√°gina web de ATM sobre Linux</A
>. </P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.ADV-QDISC.WRR"
>14.8. Weighted Round Robin (WRR)</A
></H2
><P
>Esta qdisc no se incluye en los n√∫cleos est√°ndar pero la puede descargar
de <A
HREF="/web/20040611091246/http://wipl-wrr.dkik.dk/wrr/"
TARGET="_top"
>aqu√≠</A
>.
Actualmente la qdisc s√≥lo est√° probada con n√∫cleos Linux 2.2 pero
probablemente funcionar√° tambi√©n con n√∫cleos 2.4/2.5.</P
><P
>La qdisc WRR distribuye ancho de banda entre sus clases usando el esquema
de weighted round robin. Osea, que al igual que la qdisc CBQ contiene
clases dentro de las cuales se pueden colocar qdisc arbitrarias. Todas las
clases que tengan suficiente demanda obtendr√°n un ancho de banda
proporcional a los pesos asociados con las clases.
Se puede establecer los pesos de forma manual usando el programa <VAR
CLASS="LITERAL"
>tc</VAR
>. Pero tambi√©n pueden decrementarse de forma
autom√°tica para clases que transfieran demasiados datos.</P
><P
>La qdisc incluye un clasificador que asigna a diferentes clases los
paquetes que vienen o van a diferentes m√°quinas. Se puede usar tanto la
MAC como la IP y las direcciones de origen o destino. Sin embargo, la
direcci√≥n MAC s√≥lo se puede usar cuando la m√°quina Linux est√© actuando
como bridge ethernet. Las clases se van asignando autom√°ticamente a
m√°quinas bas√°ndose en los paquetes vistos.</P
><P
>Esta qdisc puede ser muy √∫til en sitios como una residencia estudiantil
donde muchos individuos sin relaci√≥n alguna comparten una conexi√≥n a
Internet. La distribuci√≥n de WRR contiene como uno de sus elementos
centrales varios script que configuran un comportamiento relevante a tales
sitios.</P
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.COOKBOOK"
></A
>Cap√≠tulo 15. Recetario</H1
><P
>Esta secci√≥n contiene "recetas" que pueden ayudarle a resolver problemas.
A√∫n as√≠, un recetario no reemplaza al conocimiento, de manera que intente
comprender qu√© es lo que sucede.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.SLA"
>15.1. Llevar varios sitios con diferentes SLA<A
NAME="AEN2034"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#FTN.AEN2034"
><SPAN
CLASS="footnote"
>[5]</SPAN
></A
></A
></H2
><P
>Esto se puede hacer de varias maneras. Apache tiene soporte para esto en
un m√≥dulo, pero mostraremos c√≥mo puede hacerse con Linux, y por tanto con
otros servicios. Estas √≥rdenes las robamos de una presentaci√≥n de Jamal
Hadi a la que se hace referencia m√°s adelante.</P
><P
>Digamos que tenemos dos clientes, con http, ftp y streaming de sonido, y
queremos venderle una cantidad limitada de ancho de banda. Lo haremos en
el propio servidor. </P
><P
>El cliente A deber√≠a tener al menos 2 megabits, el cliente B ha pagado por
5 megabits. Separamos nuestros clientes creando IP virtuales en nuestro
servidor.</P
><P
>&#13;<PRE
CLASS="SCREEN"
># ip address add 188.177.166.1 dev eth0
# ip address add 188.177.166.2 dev eth0</PRE
>&#13;</P
><P
>Es su responsabilidad asociar los diferentes servidores a la direcci√≥n IP
correcta. Todos los demonios populares soportan esto.</P
><P
>Primero asociamos una qdisc CBQ a eth0:

<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 root handle 1: cbq bandwidth 10Mbit cell 8 avpkt 1000 \
  mpu 64</PRE
>&#13;</P
><P
>Entonces creamos clases para nuestros clientes:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc class add dev eth0 parent 1:0 classid 1:1 cbq bandwidth 10Mbit rate \
  2MBit avpkt 1000 prio 5 bounded isolated allot 1514 weight 1 maxburst 21
# tc class add dev eth0 parent 1:0 classid 1:2 cbq bandwidth 10Mbit rate \
  5Mbit avpkt 1000 prio 5 bounded isolated allot 1514 weight 1 maxburst 21</PRE
>&#13;</P
><P
>Luego a√±adimos filtros para nuestras dos clases:

<PRE
CLASS="SCREEN"
>##FIXME: ¬øPor qu√© esta l√≠nea, qu√© hace?, ¬øqu√© es un divisor?:
##FIXME: Un divisor tiene algo que ver con una tabla hash, y el n√∫mero de
#        buckets - ahu
# tc filter add dev eth0 parent 1:0 protocol ip prio 5 handle 1: u32 divisor 1
# tc filter add dev eth0 parent 1:0 prio 5 u32 match ip src 188.177.166.1
  flowid 1:1
# tc filter add dev eth0 parent 1:0 prio 5 u32 match ip src 188.177.166.2
  flowid 1:2</PRE
>&#13;</P
><P
>Y ya est√°.</P
><P
>FIXME: ¬øpor qu√© no usar el token bucket filter? ¬øhay alguna pfifo_fast por
defecto de respaldo en alg√∫n lado?</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.SYNFLOOD-PROTECT"
>15.2. Proteger la m√°quina frente a inundaciones SYN</A
></H2
><P
>De la documentaci√≥n de Alexey sobre iproute, adaptado a netfilter y con
m√°s v√≠as plausibles. Si usa esto, aseg√∫rese de ajustar los n√∫meros a
valores razonables para su sistema.</P
><P
>Si quiere proteger una red entera, s√°ltese este script, que se ajusta
mejor a una √∫nica m√°quina.</P
><P
>Parece que se necesita la √∫ltima versi√≥n de las herramientas iproute2 para
que esto funcione con 2.4.0.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>#! /bin/sh -x
#
# sample script on using the ingress capabilities
# this script shows how one can rate limit incoming SYNs
# Useful for TCP-SYN attack protection. You can use
# IPchains to have more powerful additions to the SYN (eg 
# in addition the subnet)
#
#path to various utilities;
#change to reflect yours.
#
TC=/sbin/tc
IP=/sbin/ip
IPTABLES=/sbin/iptables
INDEV=eth2
#
# tag all incoming SYN packets through $INDEV as mark value 1
############################################################ 
$iptables -A PREROUTING -i $INDEV -t mangle -p tcp --syn \
  -j MARK --set-mark 1
############################################################ 
#
# install the ingress qdisc on the ingress interface
############################################################ 
$TC qdisc add dev $INDEV handle ffff: ingress
############################################################ 

#
# 
# SYN packets are 40 bytes (320 bits) so three SYNs equals
# 960 bits (approximately 1kbit); so we rate limit below
# the incoming SYNs to 3/sec (not very useful really; but
#serves to show the point - JHS
############################################################ 
$TC filter add dev $INDEV parent ffff: protocol ip prio 50 handle 1 fw \
police rate 1kbit burst 40 mtu 9k drop flowid :1
############################################################ 


#
echo "---- qdisc parameters Ingress  ----------"
$TC qdisc ls dev $INDEV
echo "---- Class parameters Ingress  ----------"
$TC class ls dev $INDEV
echo "---- filter parameters Ingress ----------"
$TC filter ls dev $INDEV parent ffff:

#deleting the ingress qdisc
#$TC qdisc del $INDEV ingress</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.ICMP-RATELIMIT"
>15.3. Limitar la tasa de ICMP para prevenir dDoS</A
></H2
><P
>Recientemente, los ataques distribuidos de negaci√≥n de servicio se han
convertido en una amenaza importante para la Internet. Filtrando y
limitando tasas de forma adecuada en nuestra red, podemos evitar tanto ser
una v√≠ctima como la causa de uno de estos ataques.</P
><P
>Deber√≠a filtrar sus redes de manera que no permita abandonarlas a ning√∫n
paquete con IP de origen no local. Esto hace que la gente no pueda enviar
porquer√≠a a la Internet de forma an√≥nima.</P
><P
>La limitaci√≥n de tasas va como dijimos antes. Para refrescarle la memoria,
aqu√≠ tiene de nuevo nuestro ASCIIgrama.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>[La Internet] ---&#60;E3, T3, da igual&#62;--- [router Linux] --- [Oficina+ISP]
                                      eth1          eth0</PRE
>&#13;</P
><P
>Primero configuramos los prerequisitos:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># tc qdisc add dev eth0 root handle 10: cbq bandwidth 10Mbit avpkt 1000
# tc class add dev eth0 parent 10:0 classid 10:1 cbq bandwidth 10Mbit rate \
  10Mbit allot 1514 prio 5 maxburst 20 avpkt 1000</PRE
>&#13;</P
><P
>Si tenemos interfaces de 100Mbit o m√°s, hay que ajustar estos n√∫meros.
Ahora tenemos que determinar c√∫anto tr√°fico ICMP deseamos permitir. Se
pueden hacer mediciones con tcpdump, haciendo que escriba en un fichero
durante un rato, y viendo cu√°nto ICMP pasa por la red. ¬°No olvide aumentar
la longitud de la captura!</P
><P
>Si hacer mediciones es poco pr√°ctico, quiz√° quiera escoger un 5%
del ancho de banda disponible. Configuremos nuestra clase:

<PRE
CLASS="SCREEN"
># tc class add dev eth0 parent 10:1 classid 10:100 cbq bandwidth 10Mbit rate \
  100Kbit allot 1514 weight 800Kbit prio 5 maxburst 20 avpkt 250 \
  bounded</PRE
>&#13;</P
><P
>Esto limita a 100Kbit. Ahora necesitamos un filtro para asignarle el
tr√°fico ICMP a esta clase:

<PRE
CLASS="SCREEN"
># tc filter add dev eth0 parent 10:0 protocol ip prio 100 u32 match ip
  protocol 1 0xFF flowid 10:100&#13;</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.INTERACTIVE-PRIO"
>15.4. Priorizado de tr√°fico interactivo</A
></H2
><P
>Si est√°n saliendo muchos datos por su enlace, o entrando que para el caso
es lo mismo, y est√° intentando hacer mantenimiento v√≠a telnet o ssh, puede
que la cosa no vaya muy bien. Los otros paquetes est√°n bloqueando nuestras
pulsaciones. ¬øNo ser√≠a maravilloso si hubiera una manera de que nuestros
paquetes interactivois se colasen por entre el tr√°fico masivo? ¬°Linux
puede hacerlo!</P
><P
>Como antes, necesitamos gestionar el tr√°fico que va en ambas direcciones.
Evidentemente, esto funciona mejor si hay m√°quinas Linux a ambos lados del
enlace, aunque otros UNIX son capaces de hacerlo. Consulte a su gur√∫ local
de Solaris/BSD al respecto.</P
><P
>El organizador pfifo_fast est√°ndar tiene 3 "bandas" diferentes. El tr√°fico
del a banda 0 se transmite antes, tras lo cual se toma en consideraci√≥n el
tr√°fico de las bandas 1 y 2. ¬°Es vital que nuestro tr√°fico interactivo
vaya a la banda 0!</P
><P
>Hemos adaptado esto desvergonzadamente directamente del ipchains HOWTO
(que pronto estar√° obsoleto):</P
><P
>Hay cuatro bits en la cabecera IP que se usan rara vez, llamados los bits
de Tipo de Servicio (TOS). Afectan la manera en que se trata un paquete;
los cuatro bits son "Retraso M√≠nimo", "Transferencia M√°xima", "Fiabilidad
M√°xima" y "Coste M√≠nimo". S√≥lo se permite activar uno de estos bits. Rob
van Nieuwkerk, el autor del c√≥digo de ipchains que trabaja con el TOS, lo
dice as√≠:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>El "M√≠nimum Delay" es especialmente importante para m√≠. Lo activo para
paquetes "interactivos" en mi router (Linux) de salida. Estoy tras un
enlace por m√≥dem a 33k6. Linux prioriza los paquetes en tres colas. De
esta manera, consigo un rendimiento interactivo aceptable mientras realizo
descargas masivas al mismo tiempo.</PRE
>&#13;</P
><P
>El uso m√°s com√∫n es marcar las conexiones de telnet y control de ftp con
"Retraso M√≠nimo", y la de datos de FTP a "Transferencia M√°xima". Esto
deber√≠a hacerse de la siguiente manera, en el router de salida:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># iptables -A PREROUTING -t mangle -p tcp --sport telnet \
  -j TOS --set-tos Minimize-Delay
# iptables -A PREROUTING -t mangle -p tcp --sport ftp \
  -j TOS --set-tos Minimize-Delay
# iptables -A PREROUTING -t mangle -p tcp --sport ftp-data \
  -j TOS --set-tos Maximize-Throughput</PRE
>&#13;</P
><P
>Lo hecho hasta ahora s√≥lo sirve para los datos que vienen de la m√°quina
remota hacia la suya. Para los que van en el otro sentido parece que ya
est√° hecho, ya que telnet, ssh y amigos activan el campo TOS
autom√°ticamente en los paquetes que salen.</P
><P
>Si tuviera una aplicaci√≥n que no lo hace, siempre puede controlarlo con
netfilter. En la m√°quina local:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># iptables -A OUTPUT -t mangle -p tcp --dport telnet \
  -j TOS --set-tos Minimize-Delay
# iptables -A OUTPUT -t mangle -p tcp --dport ftp \
  -j TOS --set-tos Minimize-Delay
# iptables -A OUTPUT -t mangle -p tcp --dport ftp-data \
  -j TOS --set-tos Maximize-Throughput</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.SQUID"
>15.5. Cach√© transparente de web usando <SPAN
CLASS="APPLICATION"
>netfilter</SPAN
>,
	<SPAN
CLASS="APPLICATION"
>iproute2</SPAN
>, <SPAN
CLASS="APPLICATION"
>ipchains</SPAN
> y
	<SPAN
CLASS="APPLICATION"
>squid</SPAN
></A
></H2
><P
>        Esta secci√≥n nos la envi√≥ el lector Ram Narula de Internet para la
	Educaci√≥n (Tailandia).
      </P
><P
>	La t√©cnica habitual para conseguir esto en Linux probablemente
	es usar ipchains DESPUES de asegurarse que el tr√°fico de "salida"
	del puerto 80(web) se dirige al servidor que ejecuta el squid.
      </P
><P
>	Hay 3 m√©todos comunes para asegurarse de que el tr√°fico "saliente"
	del puerto 80 se env√≠a al servidor que ejecuta el squid, y aqu√≠
	vamos a introducir una cuarta.
      </P
><P
>	<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Que el router pasarela lo haga por t√≠.</DT
><DD
><P
>		Si puede decirle a su pasarela que haga que los
		paquetes que salen hacia el puerto 80 sean enviados
		hacia la direcci√≥n IP del servidor squid.
	      </P
><P
>		PERO
	      </P
><P
>	        Esto a√±adir√≠a una carga adicional al router y algunos
		router comerciales podr√≠an no soportarlo siquiera.
	      </P
></DD
><DT
>Usar un switch de capa 4.</DT
><DD
><P
>		Los switchs de capa 4 pueden gestionar esto sin problemas.
	      </P
><P
>		PERO
	      </P
><P
>		El coste de este equipamiento suele ser muy alto. Un
		switch de capa 4 t√≠pico normalmente costar√° m√°s que el
		router t√≠pico + un buen servidor linux.
	      </P
></DD
><DT
>Usar un servidor cach√© como pasarela de la red.</DT
><DD
><P
>		Puede forzar que TODO el tr√°fico pase por el servidor
		cach√©.
	      </P
><P
>		PERO
	      </P
><P
>		Esto es muy arriesgado porque Squid utiliza gran cantidad
		de CPU y podr√≠a acabar ralentizando el rendimiento de la
		red entera o que el propio servidor se caiga, y nadie de
		la red podr√° acceder a Internet si esto ocurre.
	      </P
></DD
><DT
>Linux+router NetFilter.</DT
><DD
><P
>		Con NetFilter se puede implementar otra t√©cnica que usa
		NetFilter para "marcar" los paquetes con puerto de destino
		80 e iproute2 para encaminar los paquetes marcados al
		servidor Squid.
	      </P
></DD
></DL
></DIV
>
	<PRE
CLASS="SCREEN"
>|----------------|
| Implementaci√≥n |
|----------------|

 Direcciones usadas
 10.0.0.1 naret (Servidor NetFilter)
 10.0.0.2 silom (Servidor Squid)
 10.0.0.3 donmuang (Router conectado a Internet)
 10.0.0.4 kaosarn (otro servidor de la red)
 10.0.0.5 RAS
 10.0.0.0/24 red principal
 10.0.0.0/19 red total

|---------------|
|Diagrama de red|
|---------------|

Internet
|
donmuang
|
------------hub/switch----------
|        |             |       |
naret   silom        kaosarn  RAS etc.
	</PRE
>

	Primero, hagamos pasar todo el tr√°fico a trav√©s de naret
	asegur√°ndonos de que es la pasarela por defecto excepto para
	silom. La pasarela por defecto de silom ser√° donmuang (10.0.0.3) o
	crear√≠amos un bucle de tr√°fico.
      </P
><P
>	(todos los servidores de mi red tienen como pasarela por defecto a
	10.0.0.1, que era la anterior direcci√≥n IP del router donmuang,
	as√≠ que lo que he hecho es cambiar la direcci√≥n IP de donmuang a
	10.0.0.3 y darle a naret la direcci√≥n ip 10.0.0.1)
      </P
><P
>	<PRE
CLASS="SCREEN"
>Silom
-----
-configurar squid e ipchains
	</PRE
>
      </P
><P
>	Configuramos el servidor Squid de silom, y nos aseguramos de que soporte
	proxy/cach√© transparente; el puerto por defecto suele ser 3218, de
	manera que se tiene que redirigir localmente todo el tr√°fico hacia
	el puerto 80 al puerto 3128. Esto se puede hacer con ipchains con
	lo siguiente:
      </P
><P
>	<PRE
CLASS="SCREEN"
>silom# ipchains -N allow1
silom# ipchains -A allow1 -p TCP -s 10.0.0.0/19 -d 0/0 80 -j REDIRECT 3128
silom# ipchains -I input -j allow1
	</PRE
>
      </P
><P
>O, en el idioma de netfilter:
	<PRE
CLASS="SCREEN"
>silom# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3128
	</PRE
>
      </P
><P
>	(nota: podr√≠a tener otras entradas tambi√©n)
      </P
><P
>	Si desea m√°s informaci√≥n sobre configuraci√≥n del servidor Squid,
	por favor, rem√≠tase a la p√°gina de las FAQ de Squid en <A
HREF="/web/20040611091246/http://squid.nlanr.net/"
TARGET="_top"
>http://squid.nlanr.net</A
>).
      </P
><P
>	Nos aseguramos de que este servidor tiene activo el reenv√≠o de ip
	(forwarding) y de que su pasarela por defecto es el router
	donmuang (NO naret).
      </P
><P
>	<PRE
CLASS="SCREEN"
>Naret
-----
-configurar iptables e iproute2
-desactivar los mensajes icmp REDIRECT (si es necesario)
	</PRE
>
      </P
><P
>	<P
></P
><OL
TYPE="1"
><LI
><P
>	      "Marca" con el valor 2 los paquetes con destino al puerto 80
	      <PRE
CLASS="SCREEN"
>naret# iptables -A PREROUTING -i eth0 -t mangle -p tcp --dport 80 \
 -j MARK --set-mark 2
	      </PRE
>
	    </P
></LI
><LI
><P
>	      Configuramos iproute2 para que env√≠e los paquetes con la
	      marca 2 a silom
	      <PRE
CLASS="SCREEN"
>naret# echo 202 www.out &#62;&#62; /etc/iproute2/rt_tables
naret# ip rule add fwmark 2 table www.out
naret# ip route add default via 10.0.0.2 dev eth0 table www.out
naret# ip route flush cache
	      </PRE
>
	    </P
><P
>	      Si donmuang y naret est√°n en la misma subred entonces naret
	      no deber√≠a enviar mensajes icmp REDIRECT.
	      En este caso, deber√≠amos desactivar los icmp REDIRECT as√≠:
	      <PRE
CLASS="SCREEN"
>naret# echo 0 &#62; /proc/sys/net/ipv4/conf/all/send_redirects
naret# echo 0 &#62; /proc/sys/net/ipv4/conf/default/send_redirects
naret# echo 0 &#62; /proc/sys/net/ipv4/conf/eth0/send_redirects
	      </PRE
>
	    </P
></LI
></OL
>
      </P
><P
>	Hemos terminado el montaje, comprobemos la configuraci√≥n
      </P
><P
>	<PRE
CLASS="SCREEN"
>En naret:

naret# iptables -t mangle -L
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
MARK       tcp  --  anywhere             anywhere           tcp dpt:www MARK set 0x2 

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

naret# ip rule ls
0:      from all lookup local 
32765:  from all fwmark        2 lookup www.out 
32766:  from all lookup main 
32767:  from all lookup default 

naret# ip route list table www.out
default via 203.114.224.8 dev eth0 

naret# ip route   
10.0.0.1 dev eth0  scope link 
10.0.0.0/24 dev eth0  proto kernel  scope link  src 10.0.0.1
127.0.0.0/8 dev lo  scope link 
default via 10.0.0.3 dev eth0 

(hay que asegurarse de que silom aparece en una de las l√≠neas anteriores,
en este caso es la l√≠nea con 10.0.0.0/24)

|-------|
|-HECHO-|
|-------|
	</PRE
>
      </P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2150"
>15.5.1. Diagrama de flujo del tr√°fico tras la implementaci√≥n</A
></H3
><PRE
CLASS="SCREEN"
>&#13;|----------------------------------------------------|
|Diagrama de flujo del tr√°fico tras la implementaci√≥n|
|----------------------------------------------------|

INTERNET
/\
||
\/
-----------------router donmuang---------------------
/\                                      /\         ||
||                                      ||         ||
||                                      \/         ||
naret                                  silom       ||
*tr√°fico hacia el puerto 80==========&#62;(cach√©)      ||
/\                                      ||         ||
||                                      \/         \/
\\===================================kaosarn, RAS, etc.&#13;</PRE
><P
>Tengan en cuenta que la red es asim√©trica ya que hay un salto extra en la
ruta general de salida.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>Este es el camino seguido por los paquetes que atraviesan la red desde
kaosarn hacia y desde Internet.

Tr√°fico web/http:
consulta http de kaosarn-&#62;naret-&#62;silom-&#62;donmuang-&#62;internet
respuestas http desde Internet-&#62;donmuang-&#62;silom-&#62;kaosarn

consultas no web/http (ej: telnet):
datos salientes de kaosarn-&#62;naret-&#62;donmuang-&#62;internet
datos entrantes de Internet-&#62;donmuang-&#62;kaosarn</PRE
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.MTU-DISCOVERY"
>15.6. Sortear los problemas de Path MTU Discovery con configuraciones de MTU por ruta</A
></H2
><P
>Generalmente, Internet funciona mejor enviando tr√°fico masivo si se usan
paquetes grandes. Cada paquete implica una decisi√≥n de encaminamiento, y
cuando se env√≠a un fichero de 1 megabyte, podemos estar hablando de
alrededor de 700 paquetes si se env√≠an del mayor tama√±o posible, o 4000 si
se usa el valor peque√±o por defecto.</P
><P
>Sin embargo, no todas las partes de Internet soportan 1460 bytes de carga
por paquete. Por tanto, se hace necesario probar hasta encontrar el mayor
paquete que "encaje", para optimizar una conexi√≥n.</P
><P
>Este proceso se denomina ¬´Descubrimiento de MTU de la ruta¬ª (Path MTU
Discovery), siendo MTU la ¬´Maximum Transfer Unit¬ª.</P
><P
>Cuando un router encuentra un paquete que es demasiado grande para
enviarlo de una sola pieza, Y que est√° marcado con el bit ¬´Don't
Fragment¬ª, devuelve un mensaje ICMP que indica que se vio obligado a
descartar un paquete por esta causa. La m√°quina que lo envi√≥ reacciona a
esto enviando paquetes m√°s peque√±os, y repitiendo puede encontrar el
tama√±o de paquete √≥ptimo para una conexi√≥n sobre determinada ruta.</P
><P
>Esto funcion√≥ bien hasta que los hooligans que se dedican a interferir en
las comunicaciones descubrieron la Internet. Esto hizo que los
administradores bloqueasen o ajustasen el tr√°fico ICMP en un intento
equivocado de mejorar la seguridad o robustez de su servicio de Internet.</P
><P
>Lo que ocurre ahora es que el Path MTU Discovery funciona cada vez peor y
falla en determinadas rutas, lo que lleva a sesiones TCP/IP extra√±as que
mueren al cabo de un tiempo.</P
><P
>Aunque no tengo pruebas de esto, dos sitios con los que sol√≠a tener este
problema ten√≠an Alteon Acedirectors delante de los sistemas afectados
(quiz√° alguien con m√°s conocimientos pueda darme pistas de por qu√© sucede
esto).</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2165"
>15.6.1. Soluci√≥n</A
></H3
><P
>Cuando encuentre sitios que sufren este problema, puede desactivar el Path
MTU discovery configur√°ndolo manualmente. Koos van den Hout, con peque√±os
cambios, escribe:</P
><A
NAME="AEN2168"
></A
><BLOCKQUOTE
CLASS="BLOCKQUOTE"
><P
>El siguiente problema: configuro la mtu/mru de mi l√≠nea dedicada con ppp a
296 porque s√≥lo es una 33k6 y no puedo influenciar el encolado en el otro
extremo. A 296, la respuesta a una pulsaci√≥n de tecla est√° dentro de un
margen razonable.</P
><P
>Y por mi lado tengo un masqrouter con Linux (por supuesto).</P
><P
>Recientemente, separ√© el "servidor" y el "router", de manera que la mayor√≠a
de mis aplicaciones funcionan en una m√°quina diferente a la que hace el
encaminamiento.</P
><P
>Entonces tuve problemas al entrar en irc. ¬°P√°nico! Escarbando un poco
averigu√© que s√≠ conectaba a irc, e incluso aparec√≠a como conectado all√≠,
pero no recib√≠a el motd. Busqu√© lo que pod√≠a estar mal y me acord√© que ya
hab√≠a tenido problemas relacionados con la MTU para acceder a ciertos
sitios web, ya que no ten√≠a problemas para acceder cuando pon√≠a la MTU a
1500, y el problema s√≥lo aparec√≠a cunado la pon√≠a a 296. Como los
servidores de irc bloquean casi cualquier tipo de tr√°fico que no sea
necesario para su operaci√≥n inmediata, tambi√©n bloquean icmp.</P
><P
>Consegu√≠ convencer a los operadores de un servidor web de que √©sta era la
causa del problema, pero los operadores del servidor de irc no iban
arreglarlo.</P
><P
>De manera que ten√≠a que asegurarme de que el tr√°fico enmascarado empezaba
con la mtu m√°s baja del enlace externo. Pero quer√≠a que mi tr√°fico
ethernet local tuviera una mtu normal (para cosas como el tr√°fico nfs).</P
><P
>Solucion:</P
><PRE
CLASS="SCREEN"
>ip route add default via 10.0.0.1 mtu 296</PRE
><P
>(siendo 10.0.0.1 la pasarela por defecto, la direcci√≥n interna del router
enmascarador)</P
></BLOCKQUOTE
><P
>En general, es posible saltarse el PMTU Discovery configurando rutas
espec√≠ficas. Por ejemplo, si s√≥lo da problemas cierta subred, esto podr√≠a
ayudar:</P
><PRE
CLASS="SCREEN"
>ip route add 195.96.96.0/24 via 10.0.0.1 mtu 1000</PRE
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.MTU-MSS"
>15.7. Sortear los problemas de Path MTU Discovery con MSS Clamping
  (para usuarios de ADSL, cable, PPPoE y PPtP)</A
></H2
><P
>Como explicamos anteriormente, el Path MTU Discovery ya no funciona bien.
Si sabe de hecho que alg√∫n salto en alg√∫n lado de su red tiene una MTU
limitada (&lt;1500), no puede depender de PMTU Discovery para encontrarlo.</P
><P
>Aparte de la MTU, hay otra manera m√°s de establecer el tama√±o m√°ximo de un
paquete, denominada Tama√±o M√°ximo de Segmento (Maximum Segment Size.).
Este es un campo en la parte de Opciones TCP de un paquete SYN.</P
><P
>Los n√∫cleos Linux recientes, y unos pocos controladores PPPoE (en especial
el excelente de Roaring Penguin), permiten la posibilidad de ¬´fijar el MSS¬ª.</P
><P
>Lo bueno de esto es que estableciendo el valor del MSS, le est√° diciendo
inequ√≠vocamente al otro extremo ¬´nunca intentes siquiera mandarme paquetes
m√°s grandes que este valor¬ª. No se necesita tr√°fico ICMP para que esto
funcione.</P
><P
>Lo malo es que obviamente es un "hack" (rompe el "end to end" modificando
los paquetes). Dicho esto, usamos este truco en varios sitios, y funciona
de maravilla.</P
><P
>Para que esto funcione necesitaremos al menos iptables-1.2.1a y Linux
2.4.3 o mayor. La l√≠nea de √≥rdenes es:

<PRE
CLASS="SCREEN"
># iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS  --clamp-mss-to-pmtu</PRE
>&#13;</P
><P
>Esto calcula el MSS adecuado para su enlace. Si nos sentimos valientes, o
pensamos que tenemos m√°s idea, podemos hacer algo como esto:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 128</PRE
>&#13;</P
><P
>Esto establece el MSS de los paquetes SYN que pasen a 128. Uselo si
tiene VoIP con paquetes peque√±os, y grandes paquetes de http est√°n
provocando que sus llamadas se entrecorten.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.ULTIMATE-TC"
>15.8. El acondicionador de tr√°fico definitivo: baja latencia, env√≠os y
descargas r√°pidos</A
></H2
><P
>Nota: este script ha sido actualizado recientemente ¬°y anteriormente s√≥lo
funcionaba con los clientes Linux de su red! De manera que quiz√° quiera
actualizarlo, si tiene m√°quinas Windows o Mac en la red, y ha comprobado
que no son capaces de descargar m√°s r√°pido mientras los otros est√°n
enviando datos.</P
><P
>He intentado crear el santo grial:
<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Mantener una latencia baja todo el tiempo para el tr√°fico
interactivo</DT
><DD
><P
>Esto significa que descargar o enviar ficheros no deber√≠a molestar a SSH o
incluso a telnet. Estas son las cosas m√°s importantes, y es lent√≠simo
trabajar incluso con una latencia de 200ms.</P
></DD
><DT
>Permitir la "navegaci√≥n" a velocidades razonables mientras se env√≠a
o descarga informaci√≥n</DT
><DD
><P
>Incluso pensando que http es tr√°fico "masivo", el resto de tr√°fico no
deber√≠a ahogarlo demasiado.</P
></DD
><DT
>Asegurarse de que los env√≠os no da√±an las descargas, y viceversa</DT
><DD
><P
>Se observa a menudo el fen√≥meno de que el tr√°fico de subida destruye la
velocidad de descarga.</P
></DD
></DL
></DIV
>
Resulta que todo esto es posible, al coste de una peque√±a cantidad de
ancho de banda. La raz√≥n de que los env√≠os, descargas y ssh se maten entre
ellos es la presencia de grandes colas en muchos dispositivos dom√©sticos
de acceso como los m√≥dem de cable y DSL.</P
><P
>La siguiente secci√≥n explica en profundidad lo que causa los retrasos, y
c√≥mo podemos corregirlo. Puede salt√°rselo tranquilamente y pasar
directamente al script si no le importa c√≥mo se realiza esta magia.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2211"
>15.8.1. Por qu√© no funciona bien por defecto</A
></H3
><P
>Los ISP saben que se les compara s√≥lamente seg√∫n lo r√°pido que puede
descargar la gente. Aparte del ancho de banda disponible, la velocidad de
descarga viene muy influenciada por la p√©rdida de paquetes, que
obstaculiza seriamente el rendimiento de TCP/IP. Las colas grandes pueden
ayudar a evitar la p√©rdida de paquetes, y acelera las descargas. De manera
que los ISP configuran colas grandes.</P
><P
>Sin embargo, estas grandes colas da√±an la interactividad. Una pulsaci√≥n
tiene que pasar primero por la cola de env√≠o, lo que puede tardar varios
segundos (!) y llegar a la m√°quina remota. Entonces se muestra, lo que
genera un paquete de vuelta, que debe atravesar otra cola, situada en el
ISP, antes de aparecer en la pantalla.</P
><P
>Esta C√≥mo le explica c√≥mo cambiar y procesar la cola de varias maneras,
pero tristemente, no todas estas colas est√°n a nuestro alcance. La cola
del ISP est√° completamente fuera de nuestros l√≠mites, mientras que la cola
de env√≠o probablemente reside en el cable m√≥dem o en el dispositivo DSL.
Puede ser o no que haya posibilidad de configurarla. Lo m√°s probable es
que no.</P
><P
>De manera que, ¬øqu√© sigue? Ya que no podemos controlar ninguna de esas
colas, debemos eliminarlas, y trasladarlas a nuestro router Linux. Por
suerte, esto es posible.</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Limitar la velocidad de env√≠o</DT
><DD
><P
>Limitando nuestra velocidad de env√≠o a poco menos de la verdadera tasa
disponible, no creamos colas en nuestro m√≥dem. La cola se ha trasladado al
Linux.</P
></DD
><DT
>Limitar la velocidad de descarga</DT
><DD
><P
>Esto tiene algo m√°s de truco, ya que no podemos influenciar realmente lo
r√°pido que internet nos entrega los datos. Sin embargo, podemos descartar
paquetes que vengan demasiado r√°pido, lo que hace que TCP/IP frene justo
hasta la tasa que deseamos. Como no deseamos descartar tr√°fico
innecesariamente, configuraremos el tama√±o de la "r√°faga" que permitiremos
a altas velocidades.</P
></DD
></DL
></DIV
></P
><P
>Ahora, una vez hecho esto, hemos eliminado totalmente la cola de descarga
(exceptuando peque√±as r√°fagas), y ganado la capacidad de gestionar la cola
de env√≠o con todo el potencial que ofrece Linux.</P
><P
>Lo que queda por hacer es asegurarnos de que el tr√°fico interactivo pase a
primera l√≠nea de la cola de subida. Para asegurarnos de que los env√≠os no
obstaculizan las descargas, tambi√©n pasaremos los paquetes ACK a primera
l√≠nea. Esto es lo que normalmente produce la gran reducci√≥n de velocidad
cuando se genera tr√°fico masivo en ambas direcciones. Las confirmaciones
(ACKnowledgements) del tr√°fico de descarga deben competir con el tr√°fico
de env√≠o, y quedan retrasados en el proceso.</P
><P
>Si hacemos todo esto, obtenemos las siguientes mediciones usando una
conexi√≥n ADSL excelente de xs4all en Holanda:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>Latencia de base:
round-trip min/avg/max = 14.4/17.1/21.7 ms

Sin condicionador de tr√°fico, mientras descargamos:
round-trip min/avg/max = 560.9/573.6/586.4 ms

Sin condicionador de tr√°fico, mientras enviamos:
round-trip min/avg/max = 2041.4/2332.1/2427.6 ms

Con el condicionador, durante un env√≠o a 220kbit/s:
round-trip min/avg/max = 15.7/51.8/79.9 ms

Con el condicionador, durante una descarga a 850kbit/s:
round-trip min/avg/max = 20.4/46.9/74.0 ms

Al enviar, las descargas se producen aproximadamente al 80% de la
velocidad disponible. Los env√≠os alrededor de al 90%. La latencia salta
entonces a 850ms, y a√∫n intentamos averiguar por qu√©.</PRE
>&#13;</P
><P
>Lo que pueda esperar de este script depende mucho de la velocidad real del
enlace de salida. Cuando se env√≠a a toda velocidad, siempre habr√° un √∫nico
paquete por delante de sus pulsaciones. Este es el l√≠mite inferior de
latencia que puede alcanzar (divida el MTU por la velocidad de subida para
calcularlo). Los valores normales ser√°n algo m√°s altos que esto. ¬°Reduzca
la MTU para obtener mejores efectos!</P
><P
>Ahora, dos versiones del script, una con el excelente HTB de Devik, y la
otra con el CBQ que viene en cada n√∫cleo de Linux, al contrario que HTB.
Hemos probado ambos, y funcionan bien.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2234"
>15.8.2. El script (CBQ)</A
></H3
><P
>Funciona en todos los n√∫cleos. Dentro de la qdisk
CBQ colocamos dos Stochastic Fairness Queues que se aseguran de que varios
flujos masivos no se ahoguen uno a otro.</P
><P
>El tr√°fico de descarga se ajusta usando un filtro tc que contenga un Token
Bucket Filter.</P
><P
>Puede mejorar este script a√±adiendo ¬´bounded¬ª a la l√≠nea que comienza con
¬´tc class add .. classid 1:20¬ª. Si disminuy√≥ la MTU, ¬°reduzca tambi√©n los
n√∫meros allot y avpkt!</P
><P
>&#13;<PRE
CLASS="SCREEN"
>#!/bin/bash 

# The Ultimate Setup For Your Internet Connection At Home
# 
#
# Set the following values to somewhat less than your actual download
# and uplink speed. In kilobits
DOWNLINK=800
UPLINK=220
DEV=ppp0

# clean existing down- and uplink qdiscs, hide errors
tc qdisc del dev $DEV root    2&#62; /dev/null &#62; /dev/null
tc qdisc del dev $DEV ingress 2&#62; /dev/null &#62; /dev/null

###### uplink

# install root CBQ

tc qdisc add dev $DEV root handle 1: cbq avpkt 1000 bandwidth 10mbit 

# shape everything at $UPLINK speed - this prevents huge queues in your
# DSL modem which destroy latency:
# main class

tc class add dev $DEV parent 1: classid 1:1 cbq rate ${UPLINK}kbit \
allot 1500 prio 5 bounded isolated 

# high prio class 1:10:

tc class add dev $DEV parent 1:1 classid 1:10 cbq rate ${UPLINK}kbit \
   allot 1600 prio 1 avpkt 1000

# bulk and default class 1:20 - gets slightly less traffic, 
#  and a lower priority:

tc class add dev $DEV parent 1:1 classid 1:20 cbq rate $[9*$UPLINK/10]kbit \
   allot 1600 prio 2 avpkt 1000

# both get Stochastic Fairness:
tc qdisc add dev $DEV parent 1:10 handle 10: sfq perturb 10
tc qdisc add dev $DEV parent 1:20 handle 20: sfq perturb 10

# start filters
# TOS Minimum Delay (ssh, NOT scp) in 1:10:
tc filter add dev $DEV parent 1:0 protocol ip prio 10 u32 \
      match ip tos 0x10 0xff  flowid 1:10

# ICMP (ip protocol 1) in the interactive class 1:10 so we 
# can do measurements &#38; impress our friends:
tc filter add dev $DEV parent 1:0 protocol ip prio 11 u32 \
	match ip protocol 1 0xff flowid 1:10

# To speed up downloads while an upload is going on, put ACK packets in
# the interactive class:

tc filter add dev $DEV parent 1: protocol ip prio 12 u32 \
   match ip protocol 6 0xff \
   match u8 0x05 0x0f at 0 \
   match u16 0x0000 0xffc0 at 2 \
   match u8 0x10 0xff at 33 \
   flowid 1:10

# rest is 'non-interactive' ie 'bulk' and ends up in 1:20

tc filter add dev $DEV parent 1: protocol ip prio 13 u32 \
   match ip dst 0.0.0.0/0 flowid 1:20

########## downlink #############
# slow downloads down to somewhat less than the real speed  to prevent 
# queuing at our ISP. Tune to see how high you can set it.
# ISPs tend to have *huge* queues to make sure big downloads are fast
#
# attach ingress policer:

tc qdisc add dev $DEV handle ffff: ingress

# filter *everything* to it (0.0.0.0/0), drop everything that's
# coming in too fast:

tc filter add dev $DEV parent ffff: protocol ip prio 50 u32 match ip src \
   0.0.0.0/0 police rate ${DOWNLINK}kbit burst 10k drop flowid :1</PRE
>

Si desea que ppp ejecute este script al conectar, c√≥pielo en 
/etc/ppp/ip-up.d.</P
><P
>Si las √∫ltimas dos l√≠neas dan error, ¬°actualice la herramienta tc a una
versi√≥n m√°s moderna!</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2242"
>15.8.3. El script (HTB)</A
></H3
><P
>El siguiente script alcanza todas nuestras metas usando la maravillosa
cola HTB (vea el cap√≠tulo relevante). ¬°Vale la pena parchear el n√∫cleo!

<PRE
CLASS="SCREEN"
>#!/bin/bash

# The Ultimate Setup For Your Internet Connection At Home
# 
#
# Set the following values to somewhat less than your actual download
# and uplink speed. In kilobits
DOWNLINK=800
UPLINK=220
DEV=ppp0

# clean existing down- and uplink qdiscs, hide errors
tc qdisc del dev $DEV root    2&#62; /dev/null &#62; /dev/null
tc qdisc del dev $DEV ingress 2&#62; /dev/null &#62; /dev/null

###### uplink

# install root HTB, point default traffic to 1:20:

tc qdisc add dev $DEV root handle 1: htb default 20

# shape everything at $UPLINK speed - this prevents huge queues in your
# DSL modem which destroy latency:

tc class add dev $DEV parent 1: classid 1:1 htb rate ${UPLINK}kbit burst 6k

# high prio class 1:10:

tc class add dev $DEV parent 1:1 classid 1:10 htb rate ${UPLINK}kbit \
   burst 6k prio 1

# bulk &#38; default class 1:20 - gets slightly less traffic, 
# and a lower priority:

tc class add dev $DEV parent 1:1 classid 1:20 htb rate $[9*$UPLINK/10]kbit \
   burst 6k prio 2

# both get Stochastic Fairness:
tc qdisc add dev $DEV parent 1:10 handle 10: sfq perturb 10
tc qdisc add dev $DEV parent 1:20 handle 20: sfq perturb 10

# TOS Minimum Delay (ssh, NOT scp) in 1:10:
tc filter add dev $DEV parent 1:0 protocol ip prio 10 u32 \
      match ip tos 0x10 0xff  flowid 1:10

# ICMP (ip protocol 1) in the interactive class 1:10 so we 
# can do measurements &#38; impress our friends:
tc filter add dev $DEV parent 1:0 protocol ip prio 10 u32 \
	match ip protocol 1 0xff flowid 1:10

# To speed up downloads while an upload is going on, put ACK packets in
# the interactive class:

tc filter add dev $DEV parent 1: protocol ip prio 10 u32 \
   match ip protocol 6 0xff \
   match u8 0x05 0x0f at 0 \
   match u16 0x0000 0xffc0 at 2 \
   match u8 0x10 0xff at 33 \
   flowid 1:10

# rest is 'non-interactive' ie 'bulk' and ends up in 1:20


########## downlink #############
# slow downloads down to somewhat less than the real speed  to prevent 
# queuing at our ISP. Tune to see how high you can set it.
# ISPs tend to have *huge* queues to make sure big downloads are fast
#
# attach ingress policer:

tc qdisc add dev $DEV handle ffff: ingress

# filter *everything* to it (0.0.0.0/0), drop everything that's
# coming in too fast:

tc filter add dev $DEV parent ffff: protocol ip prio 50 u32 match ip src \
   0.0.0.0/0 police rate ${DOWNLINK}kbit burst 10k drop flowid :1</PRE
>&#13;</P
><P
>Si desea que ppp ejecute este script al conectar, c√≥pielo en 
/etc/ppp/ip-up.d.</P
><P
>Si las √∫ltimas dos l√≠neas dan error, ¬°actualice la herramienta tc a una
versi√≥n m√°s moderna!</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.RATELIMIT.SINGLE"
>15.9. Limitar la tasa a una √∫nica m√°quina o m√°scara de red</A
></H2
><P
>	Aunque esto se describe con much√≠simo detalle en alg√∫n otro lado
	en las p√°ginas de manual, a menudo nos hacen esta pregunta y por
	suerte hay una respuesta sencilla que no necesita de una
	comprensi√≥n profunda del control de tr√°fico.
      </P
><P
>	Este script de tres l√≠neas hace el truco:
      </P
><P
>	<PRE
CLASS="SCREEN"
>	  tc qdisc add dev $DEV root handle 1: cbq avpkt 1000 bandwidth 10mbit 

	  tc class add dev $DEV parent 1: classid 1:1 cbq rate 512kbit \
	  allot 1500 prio 5 bounded isolated 

	  tc filter add dev $DEV parent 1: protocol ip prio 16 u32 \
	  match ip dst 195.96.96.97 flowid 1:1
	</PRE
>
      </P
><P
>        La primera l√≠nea instala una clase basada en la cola de la
	interfaz, y le dice al n√∫cleo que debe asumir para los c√°lculos que
	la interfaz es de 10mbit. Si se equivoca con esto, no pasa nada
	malo. Pero dejarlo correctamente har√° todo m√°s preciso.
      </P
><P
>	La segunda l√≠nea crea una clase de 512kbit con algunos valores por
	defecto razonables. Si desea detalles, lea las p√°ginas de manual
	de cbq y
	<A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.QDISC"
>Cap√≠tulo 9</A
>.
      </P
><P
>	La √∫ltima l√≠nea indica qu√© tr√°fico deber√≠a ir a la clase ajustada.
	El tr√°fico que no sea captado por esta regla NO ser√° ajustado. Si
	quiere captar cosas m√°s complicadas (subredes, puertos de origen o
	destino), lea <A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.FILTERING.SIMPLE"
>Secci√≥n 9.6.2</A
>.
      </P
><P
>	Si cambia cualquier cosa y quiere reiniciar el script, ejecuta "tc
	qdisc del dev $DEV root" para borrar la configuraci√≥n existente.
      </P
><P
>	Se puede mejorar el script a√±adiendo la √∫ltima l√≠nea opcional "tc
	qdisc add dev $DEV parent 1:1 sfq perturb 10". Vea
	<A
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#LARTC.SFQ"
>Secci√≥n 9.2.3</A
> si desea detalles sobre la forma de
	hacerlo.
      </P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.COOKBOOK.FULLNAT.INTRO"
>15.10. Ejemplo de una soluci√≥n de nat completo con QoS</A
></H2
><P
>			Soy Pedro Larroy <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:piotr@member.fsf.org"
>piotr@member.fsf.org</A
>&#62;</CODE
></P
>. Voy a describir una configuraci√≥n com√∫n donde tenemos muchos usuarios en una red privada conectada a la Internet mediante un router Linux con una direcci√≥n IP p√∫blica que est√° haciendo traducci√≥n de direcciones de red (NAT). Uso esta configuraci√≥n de QoS para dar acceso a la Internet a 198 usuarios en una residencia universitaria, en la que vivo y de la que soy administrador de red. Los usuarios hacen uso indiscriminado de programas "peer to peer", de manera que es esencial un control de tr√°fico adecuado. Espero que esto sirva de ejemplo pr√°ctico para todos los lectores de lartc interesados.
		</P
><P
>			Primero expondr√© un acercamiento pr√°ctico con configuraci√≥n paso a paso, y al final explicar√© c√≥mo automatizar el proceso durante el arranque. La red a la que se aplica este ejemplo es una LAN privada conectada a la Internet mediante un router Linux que tiene una direcci√≥n IP p√∫blica. Extenderlo a varias direcciones IP p√∫blicas deber√≠a ser sencillo, a√±adiendo un par de reglas de iptables.
			Para obtener las cosas que necesitamos:
			<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>N√∫cleo Linux versi√≥n 2.4.18 o superior instalado</DT
><DD
><P
>					Si usa 2.4.18 tendr√° que aplicar el parche para HTB.
					</P
></DD
><DT
>iproute</DT
><DD
><P
>					Tambi√©n hay que asegurarse de que el programa "tc" est√° preparado para HTB; se distribuye uno precompilado con HTB.
					</P
></DD
><DT
>iptables</DT
><DD
><P
>					</P
></DD
></DL
></DIV
>
		</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2281"
>15.10.1. Empecemos optimizando ese ancho de banda escaso</A
></H3
><P
>			Primero necesitamos configurar algunas qdisc en las que clasificaremos el tr√°fico. Creamos una qdisc htb con 6 clases con prioridad ascendente. Entonces tenemos clases que siempre obtendr√°n la tasa establecida, pero podemos usar el ancho de banda que no necesitan las otras clases. Recuerde que se asignar√° primero el exceso de ancho de banda a las clases con mayor prioridad (con n√∫mero prio mayor). Nuestra conexi√≥n es una ADSL con 2Mb de descarga y 300kbit/s de env√≠o. Uso 240kbit/s como tasa superior s√≥lo porque es lo m√°s alto que puedo configurar antes de que la latencia empiece a crecer, debido a llenados de b√∫fer en alg√∫n sitio entre nosotros y la m√°quina remota. Este par√°metro deber√≠ medirse de forma experimental, aument√°ndolo y haci√©ndolo bajar si se observa latencia entre m√°quinas cercanas.
		</P
><P
>			Ajuste CEIL al 75% de l√≠mite del ancho de banda por ahora, y donde uso eth0, deber√≠a poner la interfaz que tiene la direcci√≥n p√∫blica de Internet. Para empezar nuestro ejemplo, ejecute lo siguiente en una sesi√≥n de root:
			<PRE
CLASS="SCREEN"
>			CEIL=240
			tc qdisc add dev eth0 root handle 1: htb default 15
			tc class add dev eth0 parent 1: classid 1:1 htb rate ${CEIL}kbit ceil ${CEIL}kbit
			tc class add dev eth0 parent 1:1 classid 1:10 htb rate 80kbit ceil 80kbit prio 0
			tc class add dev eth0 parent 1:1 classid 1:11 htb rate 80kbit ceil ${CEIL}kbit prio 1
			tc class add dev eth0 parent 1:1 classid 1:12 htb rate 20kbit ceil ${CEIL}kbit prio 2
			tc class add dev eth0 parent 1:1 classid 1:13 htb rate 20kbit ceil ${CEIL}kbit prio 2
			tc class add dev eth0 parent 1:1 classid 1:14 htb rate 10kbit ceil ${CEIL}kbit prio 3
			tc class add dev eth0 parent 1:1 classid 1:15 htb rate 30kbit ceil ${CEIL}kbit prio 3
			tc qdisc add dev eth0 parent 1:12 handle 120: sfq perturb 10
			tc qdisc add dev eth0 parent 1:13 handle 130: sfq perturb 10
			tc qdisc add dev eth0 parent 1:14 handle 140: sfq perturb 10
			tc qdisc add dev eth0 parent 1:15 handle 150: sfq perturb 10
			</PRE
>
			Ahora hemos creado un √°rbol htb con un nivel de profundidad. Algo como esto:

			<PRE
CLASS="SCREEN"
>			+---------+
			| root 1: |
			+---------+
			     |
			+---------------------------------------+
			| class 1:1                             |
			+---------------------------------------+
			  |      |      |      |      |      |
			+----+ +----+ +----+ +----+ +----+ +----+
			|1:10| |1:11| |1:12| |1:13| |1:14| |1:15|
			+----+ +----+ +----+ +----+ +----+ +----+
			</PRE
>

			<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>classid 1:10 htb rate 80kbit ceil 80kbit prio 0</DT
><DD
><P
>					Esta es la clase de mayor prioridad. Los paquetes de esta clase tendr√°n el menor retraso y ser√° la primera en cargar con exceso de tr√°fico, de manera que no es buena idea limitar la tasa superior a esta clase. Enviaremos mediante esta clase los siguientes paquetes que se benefician de una latencia baja, como el tr√°fico interactivo: <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>ssh, telnet, dns, quake3, irc, y paquetes con la etiqueta SYN</I
></SPAN
>
					</P
></DD
><DT
>classid 1:11 htb rate 80kbit ceil ${CEIL}kbit prio 1</DT
><DD
><P
>					Aqu√≠ tenemos la primera clase en la que podemos empezar a poner tr√°fico masivo. En mi ejemplo tenemos tr√°fico de un servidor web local y peticiones de p√°ginas web: puerto de origen 80, y puerto de destino 80, respectivamente.
					</P
></DD
><DT
>classid 1:12 htb rate 20kbit ceil ${CEIL}kbit prio 2</DT
><DD
><P
>+                                       In this class I will put traffic with Maximize-Throughput TOS bit set and the rest of the traffic that goes from <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>local processes</I
></SPAN
> on the router to the Internet. So the following classes will only have traffic that is <SPAN
CLASS="QUOTE"
>"routed through"</SPAN
> the box.
					En esta clase pondr√© el tr√°fico con el bit TOS Maximize-Throughput activo, y el resto del tr√°fico que viene del <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>procesamiento local</I
></SPAN
> del router hacia Internet. De manera que las siguientes clases s√≥lo tendr√°n tr√°fico que <SPAN
CLASS="QUOTE"
>"es encaminado a trav√©s de"</SPAN
> la m√°quina.
					</P
></DD
><DT
>classid 1:13 htb rate 20kbit ceil ${CEIL}kbit prio 2</DT
><DD
><P
>					Esta clase es para el tr√°fico de otras m√°quinas NAT-eadas que necesitan mayor prioridad en su tr√°fico masivo.
					</P
></DD
><DT
>classid 1:14 htb rate 10kbit ceil ${CEIL}kbit prio 3</DT
><DD
><P
>					Aqu√≠ va el tr√°fico de correo (SMTP, pop3...) y los paquetes con el bit TOS Minimize-Cost activo.
					</P
></DD
><DT
>classid 1:15 htb rate 30kbit ceil ${CEIL}kbit prio 3</DT
><DD
><P
>					Y finalmente, aqu√≠ tenemos el tr√°fico masivo de las m√°quinas NAT-eadas tras el router. Kazaa, edonkey y otros ir√°n aqu√≠, de manera que no interfieran con otros servicios.
				</P
></DD
></DL
></DIV
>




		</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2317"
>15.10.2. Clasifici√≥n de paquetes</A
></H3
><P
>			Hemos creado la configuraci√≥n de qdisc pero no hemos hecho clasificaci√≥n de paquetes, de manera que todos los paquetes salientes est√°n pasando por la clase 1:15 (porque hemos usado c qdisc add dev eth0 root handle 1: htb <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>default 15</I
></SPAN
>). Ahora necesitamos decir qu√© paquetes van d√≥nde. Esta es la parte m√°s importante.
		</P
><P
>			Ahora establecemos los filtros de manera que clasificamos los paquetes con iptables. Realmente prefiero hacerlo con iptables, porque son muy flexibles y puedes hacer conteo de paquetes por cada regla. Adem√°s, con el objetivo RETURN los paquetes no necesitan pasar por todas las reglas. Ejecutamos las siguientes √≥rdenes:
			<PRE
CLASS="SCREEN"
>			tc filter add dev eth0 parent 1:0 protocol ip prio 1 handle 1 fw classid 1:10
			tc filter add dev eth0 parent 1:0 protocol ip prio 2 handle 2 fw classid 1:11
			tc filter add dev eth0 parent 1:0 protocol ip prio 3 handle 3 fw classid 1:12
			tc filter add dev eth0 parent 1:0 protocol ip prio 4 handle 4 fw classid 1:13
			tc filter add dev eth0 parent 1:0 protocol ip prio 5 handle 5 fw classid 1:14
			tc filter add dev eth0 parent 1:0 protocol ip prio 6 handle 6 fw classid 1:15
			</PRE
>
+                       We have just told the kernel that packets that has a specific FWMARK value ( hanlde x fw ) go in the specified class ( classid x:x). Next you will see how to mark packets with iptables.
			Acabamos de decirle al n√∫cleo que los paquetes que tienen un valor espec√≠fico de FWMARK (handle x fw) van en la clase indicada (classid x:x). Lo siguiente que veremos es c√≥mo marcar paquetes con iptables.
		</P
><P
>			Antes hay que entender c√≥mo atraviesan los paquetes los filtros con iptables:
			<PRE
CLASS="SCREEN"
>				+------------+                +---------+               +-------------+
			Packet -| PREROUTING |--- routing-----| FORWARD |-------+-------| POSTROUTING |- Packets
			input   +------------+    decision    +---------+       |       +-------------+    out
			                             |                          |
			                        +-------+                    +--------+
			                        | INPUT |---- Local process -| OUTPUT |
			                        +-------+                    +--------+

			</PRE
>
			Asumo que tiene todas las tablas vac√≠as y con norma por defecto ACCEPT ( -P ACCEPT ); si no ha jugado a√∫n con iptables, deber√≠a estar todo correcto por defecto. Nuestra red privada es una clase B con direcci√≥n 172.17.0.0/16 y la IP p√∫blica es 212.170.21.172
		</P
><P
>			Ahora le decimos al kernel que <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>haga NAT</I
></SPAN
>, de manera que los clientes de la red privada puedan empezar a hablar con el exterior.

			<PRE
CLASS="SCREEN"
>			echo 1 &#62; /proc/sys/net/ipv4/ip_forward
			iptables -t nat -A POSTROUTING -s 172.17.0.0/255.255.0.0 -o eth0 -j SNAT --to-source 212.170.21.172
			</PRE
>
			Ahora compruebe que hay paquetes pasando por 1:15:
			<PRE
CLASS="SCREEN"
>			tc -s class show dev eth0
			</PRE
>
		</P
><P
>			Puede empezar a marcar los paquetes a√±adiendo reglas a la cadena PREROUTING de la tabla mangle:
			<PRE
CLASS="SCREEN"
>			iptables -t mangle -A PREROUTING -p icmp -j MARK --set-mark 0x1
			iptables -t mangle -A PREROUTING -p icmp -j RETURN
			</PRE
>
			Ahora deber√≠a ver incrementarse la cuenta de paquetes cuando haga ping de m√°quinas dentro de la red privada a otras en la Internet. Compruebe el incremento en 1:10
			<PRE
CLASS="SCREEN"
>			tc -s class show dev eth0
			</PRE
>
			Hemos hecho -j RETURN de manera que los paquetes no atraviesen todas las reglas. No se comprobar√°n otras reglas por debajo de RETURN para los paquetes Icmp. T√©ngalo en cuenta.
			Ahora podemos a√±adir m√°s reglas. Hagamos un control adecuado de TOS:
			<PRE
CLASS="SCREEN"
>			iptables -t mangle -A PREROUTING -m tos --tos Minimize-Delay -j MARK --set-mark 0x1
			iptables -t mangle -A PREROUTING -m tos --tos Minimize-Delay -j RETURN
			iptables -t mangle -A PREROUTING -m tos --tos Minimize-Cost -j MARK --set-mark 0x5
			iptables -t mangle -A PREROUTING -m tos --tos Minimize-Cost -j RETURN
			iptables -t mangle -A PREROUTING -m tos --tos Maximize-Throughput -j MARK --set-mark 0x6
			iptables -t mangle -A PREROUTING -m tos --tos Maximize-Throughput -j RETURN
			</PRE
>

			Ahora prioricemos los paquetes ssh:
			<PRE
CLASS="SCREEN"
>			iptables -t mangle -A PREROUTING -p tcp -m tcp --sport 22 -j MARK --set-mark 0x1
			iptables -t mangle -A PREROUTING -p tcp -m tcp --sport 22 -j RETURN
			</PRE
>
			Una buena idea es dar prioridad a los paquetes que empiezan conexiones tcp, aquellos con el indicador SYN activo:
			<PRE
CLASS="SCREEN"
>			iptables -t mangle -I PREROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j MARK --set-mark 0x1
			iptables -t mangle -I PREROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j RETURN
			</PRE
>
			Y as√≠ con todo.

			Cuando acabemos de a√±adir reglas a PREROUTING en mangle, terminaremos la cadena de PREROUTING con
			<PRE
CLASS="SCREEN"
>			iptables -t mangle -A PREROUTING -j MARK --set-mark 0x6
			</PRE
>
			De manera que el tr√°fico que no hayamos marcado se vaya a 1:15. De hecho, este √∫ltimo paso es innecesario ya que la clase por defecto era 1:15, pero lo marcar√© para ser consistente con el resto de la configuraci√≥n, y adem√°s es √∫til para ver el contador de esa regla.
		</P
><P
>			Ser√≠a buena idea hacer lo mismo en la cadena OUTPUT, repitiendo aquellas √≥rdenes con -A OUTPUT en lugar de PREROUTING. (s/PREROUTING/OUTPUT/) Entonces tambi√©n clasificaremos el tr√°fico generado de forma local (en el router Linux). Termino la cadena OUTPUT con -j MARK --set-mark 0x3 de manera que el tr√°fico local tenga mayor prioridad.
		</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2337"
>15.10.3. Mejora de nuestra configuraci√≥n</A
></H3
><P
>			Ahora tenemos todo funcionando. T√≥mese su tiempo mirando las gr√°ficas, y viendo d√≥nde se emplea el tr√°fico y c√≥mo lo quiere. Hacerlo durante muchas horas, acab√© teniendo la conexi√≥n a Internet funcionando realmente bien. De otra manera, observar√° continuamente timeouts y casi no se le asignar√° ancho de banda a las conexiones tcp reci√©n creadas.
		</P
><P
>			Si encuentra que algunas clases est√°n m√°s llenas la mayor parte del tiempo, puede ser buena idea adjuntarles otras disciplinas de cola de manera que el reparto de ancho de banda sea m√°s justo:
			<PRE
CLASS="SCREEN"
>			tc qdisc add dev eth0 parent 1:13 handle 130: sfq perturb 10
			tc qdisc add dev eth0 parent 1:14 handle 140: sfq perturb 10
			tc qdisc add dev eth0 parent 1:15 handle 150: sfq perturb 10
			</PRE
>
		</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2342"
>15.10.4. Hacer todo lo anterior durante el arranque</A
></H3
><P
>			Seguramente se puede hacer de muchas maneras. Yo tengo un script en /etc/init.d/packetfilter que acepta [start | stop | stop-tables | start-tables | reload-tables], que configura las qdisc y carga los m√≥dulos del n√∫cleo necesarios, de manera que se comporta bastante como un demonio. El mismo script carga reglas iptables de /etc/network/iptables-rules. Lo arreglar√© un poco y lo pondr√© en mi p√°gina web <A
HREF="/web/20040611091246/http://omega.resa.es/piotr/files/packetfilter.tar.bz2"
TARGET="_top"
>aqu√≠</A
>
		</P
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.BRIDGING"
></A
>Cap√≠tulo 16. Hacer bridges y pseudo-bridges con Proxy ARP</H1
><P
>Los bridges son dispositivos que se pueden instalar en una red sin tener
que reconfigurar. Un switch de red es b√°sicamente un bridge de muchos
puertos. Un bridge a menudo es un switch de 2 puertos. Linux, sin embargo,
soporta varias interfaces en un bridge, lo que le convierte en un
verdadero switch.</P
><P
>A menudo se usan bridges cuando nos encontramos con una red mal
configurada que debe ser arreglada sin alteraciones. Como un bridge es un
dispositivo de capa 2, una capa por debajo de IP, los router y los
servidores no se percatan de su existencia. Esto significa que puede
bloquear o modificar ciertos paquetes de una manera transparente, o hacer
ajustes.</P
><P
>Otra cosa buena es que a menudo se puede reemplazar un bridge con un cable
cruzado o un hub, en caso de que se estropee.</P
><P
>La mala noticia es que un bridge puede causar una gran confusi√≥n a
menos que est√© muy bien documentado. No aparece en las trazas de ruta,
pero algunos paquetes pueden desaparecer o cambiar entre los puntos A y B
(¬´¬°esta red est√° EMBRUJADA!¬ª). Tambi√©n deber√≠a preguntarse si una
organizaci√≥n que ¬´no quiere cambiar nada¬ª est√° haciendo lo correcto.</P
><P
>El bridge de Linux 2.4/2.5 est√° documentado en
<A
HREF="/web/20040611091246/http://bridge.sourceforge.net/"
TARGET="_top"
>esta p√°gina</A
>.</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.BRIDGING.IPTABLES"
>16.1. Estado del bridging e iptables</A
></H2
><P
>Hasta Linux 2.4.20, el bridging e iptables no se "ven" uno a otro sin
ayuda. Si se puentean los paquetes de eth0 a eth1, no "pasan" por
iptables. Esto significa que no podr√° filtrarlos, hacer NAT, modificarlos,
o lo que sea. En Linux 2.5.45 y superiores, esto est√° corregido.</P
><P
>Puede que haya visto mencionar "ebtables", que es otro proyecto m√°s (puede
hacer cosas realmente bestiales con MACNAT y "brouting"). Da mucho miedo.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.BRIDGING.SHAPING"
>16.2. Bridging y ajustes (shaping)</A
></H2
><P
>Funciona tal como sugiere. Aseg√∫rese de averiguar en qu√© lado est√° cada
interfaz, o puede acabar haciendo ajustes al tr√°fico saliente en la
interfaz interna, que no es lo que se quiere. Use tcpdump en caso
necesario.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.BRIDGING.PROXY-ARP"
>16.3. Pseudo-bridges con Proxy-ARP</A
></H2
><P
>Si simplemente quiere implementar un Pseudo-bridge, s√°ltese un par de
secciones hasta "Implement√°ndolo", pero es interesante leer un poco sobre
la manera en que funciona en la pr√°ctica.</P
><P
>Un Pseudo-bridge funciona de manera ligeramente diferente. Por defecto, un
bridge pasa los paquetes inalterados de una interfaz a la otra. S√≥lo
comprueba las direcciones hardware de los paquetes para determinar a d√≥nde
va qu√©. Esto a su vez significa que se puede hacer bridge sobre tr√°fico
que Linux no entienda, siempre y cu√°ndo tenga una direcci√≥n hardware que
s√≠ comprenda.</P
><P
>Un "Pseudo-bridge" funciona ligeramente diferente y es m√°s un router
oculto que un bridge, pero al igual que un bridge, tiene poco impacto en
el dise√±o de la red.</P
><P
>Una ventaja de que no sea un bridge recae en el hecho de que los paquetes
pasan realmente por el kernel, y se pueden filtrar, cambiar, redirigir y
reencaminar.</P
><P
>Un bridge real tambi√©n puede realizar estas tareas, pero necesita c√≥digo
especial como el Ethernet Frame Diverter, o el parche mencionado
anteriormente.</P
><P
>Otra ventaja de un pseudo-bridge es que no pasa paquetes que no entienda
(limpiando la red de esta manera de un mont√≥n de porquer√≠a). En casos en
que necesite esta porquer√≠a (como paquetes SAP o Netbeui), use un bridge
de verdad.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2369"
>16.3.1. ARP y Proxy-ARP</A
></H3
><P
>Cuando una m√°quina desea hablar con otra en la mismo segmento f√≠sico de
red, env√≠a un paquete del Address Resolution Protocol, que, simplificando,
es algo as√≠ como ¬´quien tenga 10.0.0.1, que se lo diga a 10.0.0.7¬ª. En
respuesta a esto, 10.0.0.1 responde con un breve paquete ¬´aqu√≠¬ª.</P
><P
>10.0.0.7 env√≠a entonces paquetes a la direcci√≥n de hardware mencionada en
el paquete ¬´aqu√≠¬ª. Hace cach√© de esta direcci√≥n hardware durante un tiempo
relativamente largo, y tras que expire, vuelve a lanzar la pregunta.</P
><P
>Cuando creamos un Pseudo-bridge, le indicamos que conteste a estos paquetes
ARP, lo que hace que las m√°quinas de la red env√≠en sus paquetes al bridge.
Entonces el bridge procesa los paquetes, y los env√≠a a la interfaz
relevante.</P
><P
>De manera que, en breve, siempre que una m√°quina a un lado del bridge
pregunta por la direcci√≥n de una m√°quina en el otro lado, el bridge
responde con un paquete que dice ¬´env√≠amelo a m√≠¬ª.</P
><P
>De esta manera, todo el tr√°fico se transmite al sitio correcto, y siempre
pasa por el bridge.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2376"
>16.3.2. Implement√°ndolo</A
></H3
><P
>En tiempos m√°s oscuros, se pod√≠a instruir al n√∫cleo de Linux para realizar
"proxy-ARP" para cualquier subred. De manera que, para configurar un
pseudo-bridge, tendr√≠a tanto que especificar las rutas correctas hacia
ambos lados del bridge COMO crear reglas proxy-ARP correspondientes. Esto
es malo porque precisa escribir mucho, pero tambi√©n porque le permite
cometer con facilidad errores que har√°n que el bridge responda a consultas
ARP para redes a las que no sabe c√≥mo llegar.</P
><P
>Con Linux 2.4/2.5 (y posiblemente 2.2), se ha retirado esta posibilidad y
se sustituye con una marca en el directorio /proc, denominada "proxy_arp".
Por tanto, el procedimiento para construir un pseudo-bridge, es:</P
><P
>&#13;<P
></P
><OL
TYPE="1"
><LI
><P
>Asignar una direcci√≥n IP a ambas interfaces, la "izquierda" y la "derecha".</P
></LI
><LI
><P
>Crear rutas de manera que la m√°quina sepa qu√© m√°quinas residen a la
izquierda y cuales a la derecha.</P
></LI
><LI
><P
>Ponga en marcha en ambas int
Turn on proxy-ARP on both interfaces, echo 1 &#62;
/proc/sys/net/ipv4/conf/ethI/proxy_arp, echo 1 &#62;
/proc/sys/net/ipv4/conf/ethD/proxy_arp, siendo L y R los n√∫meros de las
interfaces de la izquierda y derecha respectivamente.</P
></LI
></OL
>&#13;</P
><P
>Adem√°s, ¬°no debe olvidar activar el indicador de ip_forwarding! Al pasar a
ser un bridge verdadero, podr√≠a ver que este indicador est√° inactivo, ya
que no es necesario al hacer un puenteo.</P
><P
>Otra cosa que podr√≠a observar al dar este paso es que necesita borrar la
cach√© arp de los computadores de la red (la cach√© arp puede contener
direcciones antiguas pre-bridge que ya no son correctas).</P
><P
>En un Cisco, esto se hace usando la orden "clear arp-cache", y en Linux,
utilice "arp -d ip.address". Tambi√©n puede esperar a que la cach√© expire
de forma autom√°tica, pero puede tardar un buen rato.</P
><P
>Puede acelerar esto usando la maravillosa herramienta "arping", que en
muchas distribuciones es parte del paquete "iputils". Usando "arping" se
puede enviar muchos mensajes ARP no solicitados para actualizar las cach√©
arp remotas.</P
><P
>¬°Esta es una t√©cnica muy poderosa que tambi√©n usan los "sombreros negros"
(black hats) para subvertir el rutado!</P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="/web/20040611091246im_/http://www.gulic.org/usr/share/sgml/docbook/stylesheet/dsssl/modular/images/note.gif"
HSPACE="5"
ALT="Nota"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>En Linux 2.4, ¬°puede ser que necesite ejecutar
"echo 1 &gt; /proc/sys/net/ipv4/ip_nonlocal_bind" antes de poder enviar
paquetes ARP no solicitados!</P
></TD
></TR
></TABLE
></DIV
><P
>Tambi√©n puede descubrir que la red estaba mal configurada si tiene/ten√≠a
el h√°bito de especificar rutas sin m√°scaras de red. Me explico, podr√≠a ser
que en el pasado, algunas versiones de route hayan acertado con la m√°scara
de red correcta, o no, sin que usted se haya dado cuenta. Cuando haga
encaminamiento quir√∫rgico como el descrito anteriormente, ¬°es *vital* que
compruebe las m√°scaras de red!</P
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.DYNAMIC-ROUTING"
></A
>Cap√≠tulo 17. Encaminamiento din√°mico - OSPF y BGP</H1
><P
>Una vez que su red empiece a hacerse realmente grande, o empiece a
considerar "la Internet" como su red, necesitar√° herramientas que
encaminen los datos de forma din√°mica. A menudo los sitios est√°n
conectados unos con otros mediante enlaces m√∫ltiples, y aparecen otros de
cuando en cuando.</P
><P
>La Internet pr√°cticamente ha estandarizado OSPF (RFC 2328) y BGP4 (RFC 1771).
Linux soporta ambos, mediante <SPAN
CLASS="APPLICATION"
>gated</SPAN
> y
<SPAN
CLASS="APPLICATION"
>zebra</SPAN
></P
><P
>Aunque en estos momentos no se encuentra en el √°mbito de este documento,
nos gustar√≠a se√±alarla las obras definitivas:</P
><P
>Introducci√≥n:</P
><P
>Cisco Systems
<A
HREF="/web/20040611091246/http://www.cisco.com/univercd/cc/td/doc/cisintwk/idg4/nd2003.htm"
TARGET="_top"
>Designing large-scale IP Internetworks</A
></P
><P
>Para OSPF:</P
><P
>Moy, John T.
"OSPF.  The anatomy of an Internet routing protocol"
Addison Wesley. Reading, MA. 1998.</P
><P
>Halabi tambi√©n ha escrito una buena gu√≠a al dise√±o de encaminamiento con
OSPF, pero parece que la han eliminado del sitio web de Cisco.</P
><P
>Para BGP:</P
><P
>Halabi, Bassam
"Internet routing architectures"
Cisco Press (New Riders Publishing). Indianapolis, IN. 1997.</P
><P
>tambi√©n</P
><P
>Cisco Systems</P
><P
><A
HREF="/web/20040611091246/http://www.cisco.com/univercd/cc/td/doc/cisintwk/ics/icsbgp4.htm"
TARGET="_top"
>Using the Border Gateway Protocol for interdomain routing</A
></P
><P
>Aunque los ejemplos son espec√≠fics de Cisco, son notablemente similares al
lenguaje de configuraci√≥n de Zebra :-)</P
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.DYNAMIC-ROUTING.OSPF"
>17.1. Configurar OSPF con Zebra</A
></H2
><P
>		Por favor, <A
HREF="mailto:piotr%member.fsf.org"
TARGET="_top"
>h√°game</A
> saber si esta informaci√≥n no es correcta o si tiene alguna sugerencia.
		<A
HREF="/web/20040611091246/http://www.zebra.org/"
TARGET="_top"
>Zebra</A
> es un gran software de encaminamiento din√°mico escrito por Kunihiro Ishiguro, Toshiaki Takada y Yashuhiro Ohara. Con Zebra, configurar OSPF es r√°pido y simple, pero en la pr√°ctica hay un mont√≥n de par√°metros que ajustar si tiene muchas necesidades espec√≠ficas. OSPF significa Open Shortest Path First, y algunas de sus caracter√≠sticas principales son:
		<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Jerarqu√≠a</DT
><DD
><P
>				Las redes se agrupan por <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>√°reas</I
></SPAN
>, que est√°n interconectadas por un <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>√°rea backbone</I
></SPAN
> que ser√° se√±alada como <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>√°rea 0</I
></SPAN
>. Todo el tr√°fico pasa por el √°rea 0, y todos los router en el √°rea 0 tienen informaci√≥n de encaminamiento sobre todas las otras √°reas.
				</P
></DD
><DT
>Convergencia r√°pida</DT
><DD
><P
>				Las rutas se propagan muy r√°pido, comparado con RIP, por ejemplo.
				</P
></DD
><DT
>Eficiente con el ancho de banda</DT
><DD
><P
>				Usa multicasting en lugar de broadcastin, de manera que no inunda otras m√°quinas con informaci√≥n de encaminamiento que pueda no ser de inter√©s para ellas, reduciendo por tanto la carga de la red. Adem√°s, los <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>Router Internos</I
></SPAN
> (aquellos que s√≥lo tienen interfaces en un √°rea) no tienen informaci√≥n de encaminamiento sobre otras √°reas. Los router con interfaces en m√°s de un √°rea se denominan <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>Area Border Routers</I
></SPAN
>, y mantienen informaci√≥n topol√≥gica sobre las √°reas a las que est√°n conectados.
				</P
></DD
><DT
>Intensivo en Cpu</DT
><DD
><P
>				OSPF se basa en el <A
HREF="/web/20040611091246/http://www.soi.wide.ad.jp/class/99007/slides/13/07.html"
TARGET="_top"
>algoritmo Shortest Path First</A
> (Primero la ruta m√°s corta) de Dijkstra, que es costoso comparado con otros algoritmos de encaminamiento. Pero en realidad esto no es malo, ya que el camino m√°s corto se calcula s√≥lo una vez por cada √°rea, y adem√°s, para redes peque√±as y medianas esto no es un problema, y ni siquiera lo notar√°.
				</P
></DD
><DT
>Estado del enlace</DT
><DD
><P
>				OSPF cuenta con las caracter√≠sticas especiales de las redes e interfaces, tales como ancho de banda, fallo de enlace, y coste monetario.
				</P
></DD
><DT
>Protocolo abierto y software GPL</DT
><DD
><P
>				OSPF es un protocolo abierto, y Zebra es software GPL, lo que tiene ventajas obvias sobre software y protocolos en propiedad.
				</P
></DD
></DL
></DIV
>
  </P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.DYNAMIC-ROUTING.OSPF.PREREQ"
>17.1.1. Prerequisitos</A
></H3
><P
>&#13;			<P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>N√∫cleo Linux:</DT
><DD
><P
>					Compilado con CONFIG_NETLINK_DEV y CONFIG_IP_MULTICAST (no estoy seguro de si se necesita algo m√°s).
					</P
></DD
><DT
>Iproute</DT
><DD
><P
>					</P
></DD
><DT
>Zebra</DT
><DD
><P
>					Obt√©ngalo con su gestor de paquetes favorito o desde <A
HREF="/web/20040611091246/http://www.zebra.org/"
TARGET="_top"
>http://www.zebra.org</A
>.
					</P
></DD
></DL
></DIV
>
		</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.DYNAMIC-ROUTING.OSPF.ZEBRACFG"
>17.1.2. Configuraci√≥n de Zebra</A
></H3
><P
>			Tomemos esta red como ejemplo
			<PRE
CLASS="SCREEN"
>			----------------------------------------------------
			| 192.168.0.0/24                                   |
			|                                                  |
			|      Area 0    100BaseTX Switched                |
			|     Backbone     Ethernet                        |
			----------------------------------------------------
			  |           |                |              |
			  |           |                |              |
			  |eth1       |eth1            |eth0          |
			  |100BaseTX  |100BaseTX       |100BaseTX     |100BaseTX
			  |.1         |.2              |.253          |
			 ---------   ------------   -----------      ----------------
			 |R Omega|   |R Atlantis|   |R Legolas|      |R Frodo       |
			 ---------   ------------   -----------      ----------------
			  |eth0         |eth0             |             |          |
			  |             |                 |             |          |
			  |2MbDSL/ATM   |100BaseTX        |10BaseT      |10BaseT   |10BaseT
			------------   ------------------------------------       -------------------------------
			| Internet |   | 172.17.0.0/16        Area 1      |       |  192.168.1.0/24 wlan  Area 2|
			------------   |  Red de estudiantes (residencia) |       |       barcelonawireless     |
			               ------------------------------------       -------------------------------
			</PRE
>
			No se asuste de este diagrama, ya que zebra hace la mayor parte del trabajo de forma autom√°tica, de manera que no le costar√° nada poner todas las rutas en marcha. Ser√≠a doloroso mantener todas estas rutas a mano diariamente. La cosa m√°s importante que debe tener claro, es la topolog√≠a de la red. Y tenga especial cuidado con el Area 0, ya que es la m√°s importante.
			Primero configure zebra, editando zebra.conf y adapt√°ndolo a sus necesidades:
			<PRE
CLASS="SCREEN"
>			hostname omega
			password xxx 
			enable password xxx
			!
			! Interface's description.
			!
			!interface lo
			! description test of desc.
			!
			interface eth1
			multicast
			!
			! Static default route
			!
			ip route 0.0.0.0/0 212.170.21.129
			!
			log file /var/log/zebra/zebra.log
			</PRE
>
			En Debian, tambi√©n editaremos /etc/zebra/daemons para que se lancen durante el arranque:
			<PRE
CLASS="SCREEN"
>			zebra=yes
			ospfd=yes
			</PRE
>
			Ahora tenemos que editar ospfd.conf si todav√≠a estamos trabajando con IPv4 u ospf6d.conf si trabajamos con IPv6. Mi ospfd.conf se parece a esto:
			<PRE
CLASS="SCREEN"
>			hostname omega
			password xxx
			enable password xxx
			!
			router ospf
			  network 192.168.0.0/24 area 0
			  network 172.17.0.0/16 area 1
			!
			! log stdout
			log file /var/log/zebra/ospfd.log
			</PRE
>
			Aqu√≠ le informamos a ospf sobre la topolog√≠a de nuestra red.
		</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.DYNAMIC-ROUTING.OSPF.RUNNING"
>17.1.3. Ejecutar Zebra</A
></H3
><P
>			Now, we have to start Zebra; either by hand by typing "zebra -d" or with some script like "/etc/init.d/zebra start". Then carefully watching the ospdfd logs we should see something like:
			Ahora, tenemos que arrancar Zebra; bien a mano, escribiendo "zebra -d" o con alg√∫n script como "/etc/init.d/zebra start". Entonces, leyendo cuidadosamente los registros de ospfd, deber√≠amos ver algo como:
			<PRE
CLASS="SCREEN"
>			2002/12/13 22:46:24 OSPF: interface 192.168.0.1 join AllSPFRouters Multicast group.
			2002/12/13 22:46:34 OSPF: SMUX_CLOSE with reason: 5   
			2002/12/13 22:46:44 OSPF: SMUX_CLOSE with reason: 5
			2002/12/13 22:46:54 OSPF: SMUX_CLOSE with reason: 5   
			2002/12/13 22:47:04 OSPF: SMUX_CLOSE with reason: 5   
			2002/12/13 22:47:04 OSPF: DR-Election[1st]: Backup 192.168.0.1
			2002/12/13 22:47:04 OSPF: DR-Election[1st]: DR     192.168.0.1
			2002/12/13 22:47:04 OSPF: DR-Election[2nd]: Backup 0.0.0.0
			2002/12/13 22:47:04 OSPF: DR-Election[2nd]: DR     192.168.0.1
			2002/12/13 22:47:04 OSPF: interface 192.168.0.1 join AllDRouters Multicast group.
			2002/12/13 22:47:06 OSPF: DR-Election[1st]: Backup 192.168.0.2
			2002/12/13 22:47:06 OSPF: DR-Election[1st]: DR     192.168.0.1
			2002/12/13 22:47:06 OSPF: Packet[DD]: Negotiation done (Slave).
			2002/12/13 22:47:06 OSPF: nsm_change_status(): scheduling new router-LSA origination
			2002/12/13 22:47:11 OSPF: ospf_intra_add_router: Start
			</PRE
>
			Ignore por ahora el mensaje SMUX_CLOSE, ya que es sobre SNMP. Podemos ver que 192.168.0.1 es el <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>Designated Router</I
></SPAN
> (enrutador designado) y 192.168.0.2 es el <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>Backup Designated Router</I
></SPAN
> (enrutador de reserva designado)
		</P
><P
>			Tambi√©n podemos interactuar con zebra o la ospfd ejecutando:
			<PRE
CLASS="SCREEN"
>			<SAMP
CLASS="PROMPT"
>$ </SAMP
>telnet localhost zebra
			<SAMP
CLASS="PROMPT"
>$ </SAMP
>telnet localhost ospfd
			</PRE
>

			Veamos ahora c√≥mo comprobar si se est√°n propagando las rutas. Abra una sesi√≥n en zebra y escriba:
			
			<PRE
CLASS="SCREEN"
>			root@atlantis:~# telnet localhost zebra
			Trying 127.0.0.1...
			Connected to atlantis.
			Escape character is '^]'.

			Hello, this is zebra (version 0.92a).
			Copyright 1996-2001 Kunihiro Ishiguro.

			User Access Verification

			Password: 
			atlantis&gt; show ip route
			Codes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF,
			       B - BGP, &gt; - selected route, * - FIB route

			K&gt;* 0.0.0.0/0 via 192.168.0.1, eth1
			C&gt;* 127.0.0.0/8 is directly connected, lo
			O   172.17.0.0/16 [110/10] is directly connected, eth0, 06:21:53
			C&gt;* 172.17.0.0/16 is directly connected, eth0
			O   192.168.0.0/24 [110/10] is directly connected, eth1, 06:21:53
			C&gt;* 192.168.0.0/24 is directly connected, eth1
			atlantis&gt; show ip ospf border-routers
			============ OSPF router routing table =============
			R    192.168.0.253         [10] area: (0.0.0.0), ABR
						   via 192.168.0.253, eth1
							 [10] area: (0.0.0.1), ABR
						   via 172.17.0.2, eth0
			</PRE
>
			O directamente con iproute:
			<PRE
CLASS="SCREEN"
>			root@omega:~# ip route
			212.170.21.128/26 dev eth0  proto kernel  scope link  src 212.170.21.172 
			192.168.0.0/24 dev eth1  proto kernel  scope link  src 192.168.0.1 
			172.17.0.0/16 via 192.168.0.2 dev eth1  proto zebra  metric 20 
			default via 212.170.21.129 dev eth0  proto zebra 
			root@omega:~# 
			</PRE
>
			Podemos ver las rutas de zebra, que no estaban ah√≠ antes. Es maravilloso ver aparecer rutas s√≥lo unos pocos segundos tras arrancar zebra y ospfd. Puede comprobar la conectividad con otras m√°quinas y hacer ping. Las rutas de zebra son autom√°ticas; simplemente a√±ada un nuevo router a la red, configure zebra, y ¬°voil√°!
		</P
><P
>			Consejo: Puede usar:
			<PRE
CLASS="SCREEN"
>			tcpdump -i eth1 ip[9] == 89
			</PRE
>
			Para capturar paquetes OSPF para su an√°lisis. El n√∫mero de protocolo IP de OSPF es el 80, y el campo del protocolo es el noveno en la cabecera IP.
		</P
><P
>			OSPF tiene un mont√≥n de par√°metros ajustables, especialmente para redes grandes. En posteriores ampliaciones del documento, mostraremos algunas metodolog√≠as para afinar OSPF.
		</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="LARTC.DYNAMIC-ROUTING.BGP"
>17.2. Configurar BGP4 con Zebra</A
></H2
><P
>El Border Gateway Protocol Version 4 (BGP4) es un protocolo de
encaminamiento din√°mico descrito en RFC 1771. Permite la distribuci√≥n de
informaci√≥n de alcance (reachability), osea, tablas de rutas, a otros
nodos que sepan BGP4. Puede usarse como EGP o IGP, debiando tener cada
nodo su propio n√∫mero de Sistema Aut√≥nomo (AS) en modo EGP. BGP4 soporta
Classless Inter Domain Routing (CIDR) y agregaci√≥n de rutas (fundir varias
rutas en una).</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.DYNAMIC-ROUTING.BGP.NETMAP"
>17.2.1. Mapa de red (Ejemplo)</A
></H3
><P
>El siguiente mapa de red se usa en el resto de ejemplos. AS 1 y 50 tienen
m√°s vecinos, pero s√≥lo necesitamos configurar 1 y 50 como nuestros
vecinos. Los nodos se comunican mediante t√∫neles en este ejemplo, pero no
es obligatorio.</P
><P
>Nota: Los n√∫meros AS que usamos en este ejemplo est√°n reservados, por
favor, obtenga su propio AS de RIPE si va a configurar enlaces oficiales.</P
><PRE
CLASS="SCREEN"
>&#13;                  --------------------
                  | 192.168.23.12/24 |
                  |    AS: 23        |
                  --------------------
                    /             \
                   /               \
                  /                 \
        ------------------       ------------------
        | 192.168.1.1/24 |-------| 10.10.1.1/16   |
        |    AS: 1       |       |    AS: 50      |
        ------------------       ------------------</PRE
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="LARTC.DYNAMIC-ROUTING.BGP.CONFIG"
>17.2.2. Configuraci√≥n (Ejemplo)</A
></H3
><P
>La siguiente configuraci√≥n est√° escrita para el nodo 192.168.23.12/24,
y es f√°cil de adaptar para los otros nodos.</P
><P
>Empieza con cosas generales como el nombre de la m√°quina, claves y
opciones de depuraci√≥n:</P
><PRE
CLASS="SCREEN"
>! nombre de la m√°quina
hostname anakin

! password de login
password xxx

! activar password (modo super usuario)
enable password xxx

! fichero para registro
log file /var/log/zebra/bgpd.log

! depuraci√≥n: s√© prolijo (se puede eliminar despu√©s)
debug bgp events
debug bgp filters
debug bgp fsm
debug bgp keepalives
debug bgp updates</PRE
><P
>Lista de acceso, usada para limitar la redistribuci√≥n a redes privadas
(RFC 1918).</P
><PRE
CLASS="SCREEN"
>! RFC 1918 networks
access-list local_nets permit 192.168.0.0/16
access-list local_nets permit 172.16.0.0/12
access-list local_nets permit 10.0.0.0/8
access-list local_nets deny any</PRE
><P
>El siguiente paso es hacer la configuraci√≥n por cada AS:</P
><PRE
CLASS="SCREEN"
>! Nuestro n√∫mero de AS
router bgp 23

    ! Direcci√≥n IP del router
    bgp router-id 192.168.23.12

    ! anunciar nuestra red a los vecinos
    network 192.168.23.0/24

    ! anunciar todas las rutas conectadas (= interfaces directas)
    redistribute connected

    ! anunciar rutas kernel (= rutas insertadas manualmente)
    redistribute kernel</PRE
><P
>Cada bloque 'router bgp' contiene una lista de vecinos a los que el router
est√° conectado:</P
><PRE
CLASS="SCREEN"
>    neighbor 192.168.1.1 remote-as 1
    neighbor 192.168.1.1 distribute-list local_nets in
    neighbor 10.10.1.1   remote-as 50
    neighbor 10.10.1.1   distribute-list local_nets in</PRE
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN2517"
>17.2.3. Comprobar la configuraci√≥n</A
></H3
><P
>Nota: vtysh es un multiplexor y conecta todas las interfaces Zebra juntas.</P
><PRE
CLASS="SCREEN"
>anakin# sh ip bgp summary 
BGP router identifier 192.168.23.12, local AS number 23
2 BGP AS-PATH entries
0 BGP community entries

Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
10.10.0.1       4    50      35      40        0    0    0 00:28:40        1
192.168.1.1     4     1   27574   27644        0    0    0 03:26:04       14

Total number of neighbors 2
anakin#
anakin# sh ip bgp neighbors 10.10.0.1
BGP neighbor is 10.10.0.1, remote AS 50, local AS 23, external link
  BGP version 4, remote router ID 10.10.0.1
  BGP state = Established, up for 00:29:01
  ....
anakin#</PRE
><P
>Veamos qu√© rutas obtuvimos de nuestros vecinos:</P
><PRE
CLASS="SCREEN"
>anakin# sh ip ro bgp 
Codes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF,
       B - BGP, &#62; - selected route, * - FIB route

B&#62;* 172.16.0.0/14 [20/0] via 192.168.1.1, tun0, 2d10h19m
B&#62;* 172.30.0.0/16 [20/0] via 192.168.1.1, tun0, 10:09:24
B&#62;* 192.168.5.10/32 [20/0] via 192.168.1.1, tun0, 2d10h27m
B&#62;* 192.168.5.26/32 [20/0] via 192.168.1.1, tun0, 10:09:24
B&#62;* 192.168.5.36/32 [20/0] via 192.168.1.1, tun0, 2d10h19m
B&#62;* 192.168.17.0/24 [20/0] via 192.168.1.1, tun0, 3d05h07m
B&#62;* 192.168.17.1/32 [20/0] via 192.168.1.1, tun0, 3d05h07m
B&#62;* 192.168.32.0/24 [20/0] via 192.168.1.1, tun0, 2d10h27m
anakin#</PRE
></DIV
></DIV
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.OTHER"
></A
>Cap√≠tulo 18. Otras posibilidades</H1
><P
>Este cap√≠tulo es una lista de proyectos que tienen que ver con el
encaminamiento y el control de tr√°fico avanzados en Linux. Algunos de
estos enlaces merecer√≠an cap√≠tulos completos por s√≠ solos, mientras que
otros est√°n muy bien documentados por s√≠ mismos, y no necesitan m√°s C√≥mos.</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Implementaci√≥n para Linux de 802.1Q VLAN <A
HREF="/web/20040611091246/http://scry.wanfear.com/~greear/vlan.html"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Las VLAN son una manera muy guay de separar sus
redes de una manera m√°s virtual que f√≠sica. Puede encontrar buena
informaci√≥n sobre las VLAN <A
HREF="/web/20040611091246/ftp://ftp.netlab.ohio-state.edu/pub/jain/courses/cis788-97/virtual_lans/index.htm"
TARGET="_top"
>aqu√≠</A
>. Con esta implementaci√≥n, puede hacer que su m√°quina Linux hable
VLAN con m√°quinas como Cisco Catalyst, 3Com: &lcub;Corebuilder, Netbuilder
II, SuperStack II switch 630&rcub;, Extreme Ntwks Summit 48, Foundry:
&lcub;ServerIronXL, FastIron&rcub;.</P
><P
><A
HREF="/web/20040611091246/http://scry.wanfear.com/~greear/vlan/cisco_howto.html"
TARGET="_top"
>Aqu√≠</A
> puede encontrar un gran C√≥mo sobre VLAN.</P
><P
>Actualizaci√≥n: incluido en el n√∫cleo desde 2.4.14 (quiz√° 13).</P
></DD
><DT
>Implementaci√≥n alternativa para Linux de 802.1Q VLAN <A
HREF="/web/20040611091246/http://vlan.sourceforge.net/"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Implementaci√≥n alternativa de VLAN para Linux. Este proyecto empez√≥ por un
desacuerdo con la arquitectura y el estilo de programaci√≥n del proyecto
"establecido" de VLAN, lo que ha resultado en un dise√±o general m√°s limpio.</P
></DD
><DT
>Linux Virtual Server <A
HREF="/web/20040611091246/http://www.linuxvirtualserver.org/"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Esta gente es brillante. El Linux Virtual Server es un servidor de alta
escalabilidad y disponibilidad construido sobre un cl√∫ster de servidores
reales, con el equilibrador de carga ejecut√°ndose en el sistema operativo
Linux. La arquitectura del cl√∫ster es transparente al usuario final. Este
s√≥lo ver√° un √∫nico servidor virtual.</P
><P
>En breve, siempre que necesite equilibrio de carga, a cualquier nivel de
tr√°fico, LVS es el camino a seguir. ¬°Algunas de sus t√©cnicas son
verdaderamente malvadas! Por ejemplo, permiten que varias m√°quinas tengan
la misma direcci√≥n IP en el mismo segmento, pero desactiv√°ndoles ARP. S√≥lo
la m√°quina LVS hace ARP, y decide cual de las m√°quinas posteriores deber√°
gestionar un paquete entrante, envi√°ndoselo directamente a la direcci√≥n
MAC correcta. El tr√°fico saliente se env√≠a directamente al router, y no a
trav√©s de la m√°quina LVS, que por tanto no necesita ver sus 5Gbit de
contenido saliendo hacia el mundo, y por tanto no ser√° un cuello de
botella.</P
><P
>El LVS se implementa como un parche para el n√∫cleo en Linux 2.0 y 2.2,
y como m√≥dulo para Netfilter en 2.4/2.5, ¬°de manera que no necesitar√°
parches! El soporte para 2.4 a√∫n se encuentra en principio de desarrollo,
de manera que pru√©belo y proporcione realimentaci√≥n o parches.</P
></DD
><DT
>CBQ.init <A
HREF="/web/20040611091246/ftp://ftp.equinox.gu.net/pub/linux/cbq/"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Configurar CBQ puede ser un poco intimidante, especialmente si todo lo que
desea es ajustar el tr√°fico de algunos computadores hacia un router.
CBQ.init puede ayudarle a configurar Linux con una sintaxis simplificada.</P
><P
>Por ejemplo, si desea que todos los computadores de su subred
192.168.1.0/24 (en una eth1 10mbit) tengan limitada la velocidad de
descarga a 28kbit/s, ponga esto en el fichero de configuraci√≥n de
CBQ.init:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>DEVICE=eth1,10Mbit,1Mbit
RATE=28Kbit
WEIGHT=2Kbit
PRIO=5
RULE=192.168.1.0/24</PRE
>&#13;</P
><P
>Use este programa siempre que no le interese el "c√≥mo y por qu√©". Estamos
usando CBQ.init en producci√≥n y funciona muy bien. La documentaci√≥n est√°
inscrita en el script, lo cual explica por qu√© no encontrar√° un README.</P
></DD
><DT
>Scripts sencillos de regulado de Chronox <A
HREF="/web/20040611091246/http://www.chronox.de/"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Stephan Mueller (smueller@chronox.de) escribi√≥ dos scripts √∫tils,
"limit.conn" y "shaper". El primero permite acelerar f√°cilmente una √∫nica
sesi√≥n de descarga, as√≠:</P
><P
>&#13;<PRE
CLASS="SCREEN"
># limit.conn -s SERVERIP -p SERVERPORT -l LIMIT</PRE
>&#13;</P
><P
>Funciona con Linux 2.2 y 2.4/2.5.</P
><P
>El segundo script es m√°s complicado, y se puede usar para hacer muchas
colas diferentes basadas en reglas iptables, que se usan para marcar
paquetes que van a ser regulados.</P
></DD
><DT
>Implementaci√≥n de Virtual Router
Redundancy Protocol <A
HREF="/web/20040611091246/http://w3.arobas.net/~jetienne/vrrpd/index.html"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Esto es puramente para redundancia. Dos m√°quinas con sus propias
direcciones IP y MAC juntas, crean una tercera direcci√≥n IP y MAC, que es
virtual. Pensado originalmente s√≥lo para routers, necesitados de una
direcci√≥n MAC constante, tambi√©n funciona para otros servidores.</P
><P
>La belleza de esta soluci√≥n es lo increiblemente sencillo de su
configuraci√≥n. No hay que compilar o parchear el n√∫cleo, todo en espacio
de usuario.</P
><P
>Simplemente ejecute esto en todas las m√°quinas que participen en el
servicio:

<PRE
CLASS="SCREEN"
># vrrpd -i eth0 -v 50 10.0.0.22</PRE
>&#13;</P
><P
>¬°Y ya est√° en marcha! Ahora 10.0.0.22 la lleva uno de los servidores,
probablemente el primero en ejecutar el demonio vrrp. Ahora desconecte ese
computador de la red y r√°pidamente uno de los otros asumir√° la direcci√≥n
10.0.0.22, as√≠ como la direcci√≥n MAC.</P
><P
>Intent√© esto aqu√≠ y lo tuve en marcha y funcionando en 1 minuto. Por
alguna raz√≥n extra√±a decidi√≥ eliminar mi pasarela por defecto, pero el
indicador -n lo evita.</P
><P
>Esto es un fallo "en vivo":</P
><P
>&#13;<PRE
CLASS="SCREEN"
>64 bytes from 10.0.0.22: icmp_seq=3 ttl=255 time=0.2 ms
64 bytes from 10.0.0.22: icmp_seq=4 ttl=255 time=0.2 ms
64 bytes from 10.0.0.22: icmp_seq=5 ttl=255 time=16.8 ms
64 bytes from 10.0.0.22: icmp_seq=6 ttl=255 time=1.8 ms
64 bytes from 10.0.0.22: icmp_seq=7 ttl=255 time=1.7 ms</PRE
>&#13;</P
><P
>¬°No se perdi√≥ ni *un* paquete de ping! Justo tras el cuarto paquete,
desconect√© el P200 de mi red, y el 486 tom√≥ su lugar, lo que se puede ver
por la latencia mayor.</P
></DD
></DL
></DIV
></P
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.FURTHER"
></A
>Cap√≠tulo 19. Otras lecturas</H1
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
><A
HREF="/web/20040611091246/http://snafu.freedom.org/linux2.2/iproute-notes.html"
TARGET="_top"
>http://snafu.freedom.org/linux2.2/iproute-notes.html</A
></DT
><DD
><P
>Contiene mucha informaci√≥n t√©cnica, comentarios del n√∫cleo</P
></DD
><DT
><A
HREF="/web/20040611091246/http://www.davin.ottawa.on.ca/ols/"
TARGET="_top"
>http://www.davin.ottawa.on.ca/ols/</A
></DT
><DD
><P
>Transparencias de Jamal Hadi Salim, uno de los autores del control de
tr√°fico de Linux</P
></DD
><DT
><A
HREF="/web/20040611091246/http://defiant.coinet.com/iproute2/ip-cref/"
TARGET="_top"
>http://defiant.coinet.com/iproute2/ip-cref/</A
></DT
><DD
><P
>Versi√≥n HTML de la documentaci√≥n en LaTeX de Alexey (explica parte de
iproute2 con gran detalle)</P
></DD
><DT
><A
HREF="/web/20040611091246/http://www.aciri.org/floyd/cbq.html"
TARGET="_top"
>http://www.aciri.org/floyd/cbq.html</A
></DT
><DD
><P
>Very technical stuff, but good reading for those so inclined. 
Sally Floyd tiene una buena p√°gina sobre CBQ, incluidos sus documentos
originales. Ninguno es espec√≠fico a Linux, pero hace un buen trabajo
argumentando la teor√≠a y usos de CBQ.</P
></DD
><DT
>Servicios Diferenciados en Linux</DT
><DD
><P
>Este <A
HREF="/web/20040611091246/ftp://icaftp.epfl.ch/pub/linux/diffserv/misc/dsid-01.txt.gz"
TARGET="_top"
>documento</A
> de Werner Almesberger, Jamal Hadi Salim y Alexey
Kuznetsov describe los servicios DiffServ del n√∫cleo de Linux, entre los
que est√°n TBF, GRED, la qdisc DSMARK y el clasificador tcindex.</P
></DD
><DT
><A
HREF="/web/20040611091246/http://ceti.pl/~kravietz/cbq/NET4_tc.html"
TARGET="_top"
>http://ceti.pl/~kravietz/cbq/NET4_tc.html</A
></DT
><DD
><P
>Otro COMO, ¬°esta vez en polaco! Puede copiar y pegar l√≠neas de √≥rdenes,
sin embargo, ya que funcionan igual en cualquier idioma. El autor est√°
cooperando con nosotros y puede que pronto a√±ada secciones a este
documento.</P
></DD
><DT
><A
HREF="/web/20040611091246/http://www.cisco.com/univercd/cc/td/doc/product/software/ios111/cc111/car.htm"
TARGET="_top"
>IOS Committed Access Rate</A
></DT
><DD
><P
><A
NAME="CAR"
></A
>
De los buenos chicos de Cisco que tienen la elogiable costumbre de poner
su documentaci√≥n en l√≠nea. La sintaxis de Cisco es diferente pero los
conceptos son los mismos, excepto que nosotros podemos hacer m√°s sin
routers al precio de coches :-)</P
></DD
><DT
>Sitio experimental de Docum <A
HREF="/web/20040611091246/http://www.docum.org/"
TARGET="_top"
>(sitio)</A
></DT
><DD
><P
>Stef Coene est√° ocupado convenciendo a su jefe de vender soporte de Linux,
y por tanto experimenta un mont√≥n, especialmente con la gesti√≥n del ancho
de banda. Su sitio tiene un mont√≥n de informaci√≥n pr√°ctica, ejemplos,
pruebas y tambi√©n se√±ala algunos de los fallos de CBQ/tc.</P
></DD
><DT
>TCP/IP Illustrated, volume 1, W. Richard Stevens, ISBN 0-201-63346-9</DT
><DD
><P
>Lectura necesaria si realmente quiere entender TCP/IP. Entretenido adem√°s.</P
></DD
></DL
></DIV
> </P
></DIV
><DIV
CLASS="CHAPTER"
><HR><H1
><A
NAME="LARTC.ACK"
></A
>Cap√≠tulo 20. Reconocimientos </H1
><P
> 
Es nuestro objetivo listar a todo el mundo que ha contribuido a este
documento, o ayudado a desmitificar c√≥mo funcionan las cosas. Aunque no
hay planes a√∫n de poner un tablero de puntuaciones como Netfilter, nos
gustar√≠a dar reconocimiento a la gente que nos ayuda.</P
><P
>&#13;<P
></P
><UL
COMPACT="COMPACT"
><LI
><P
>   Junk Alins
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:juanjo@mat.upc.es"
>juanjo@mat.upc.es</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Joe Van Andel
   </P
></LI
><LI
><P
>   Michael T. Babcock
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:mbabcock@fibrespeed.net"
>mbabcock@fibrespeed.net</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Christopher Barton
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:cpbarton%uiuc.edu"
>cpbarton%uiuc.edu</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Ard van Breemen
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:ard%kwaak.net"
>ard%kwaak.net</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Ron Brinker
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:service%emcis.com"
>service%emcis.com</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   ?ukasz Bromirski
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:l.bromirski@mr0vka.eu.org"
>l.bromirski@mr0vka.eu.org</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Lennert Buytenhek
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:buytenh@gnu.org"
>buytenh@gnu.org</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Esteve Camps
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:esteve@hades.udg.es"
>esteve@hades.udg.es</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Ricardo Javier Cardenes
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:ricardo%conysis.com"
>ricardo%conysis.com</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Stef Coene
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:stef.coene@docum.org"
>stef.coene@docum.org</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Don Cohen
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:don-lartc%isis.cs3-inc.com"
>don-lartc%isis.cs3-inc.com</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Jonathan Corbet
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:lwn%lwn.net"
>lwn%lwn.net</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Gerry N5JXS Creager
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:gerry%cs.tamu.edu"
>gerry%cs.tamu.edu</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Marco Davids
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:marco@sara.nl"
>marco@sara.nl</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Jonathan Day
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:jd9812@my-deja.com"
>jd9812@my-deja.com</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Martin aka devik Devera
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:devik@cdi.cz"
>devik@cdi.cz</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Hannes Ebner
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:he%fli4l.de"
>he%fli4l.de</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Derek Fawcus
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:dfawcus%cisco.com"
>dfawcus%cisco.com</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   David Fries
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:dfries%mail.win.org"
>dfries%mail.win.org</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Stephan "Kobold" Gehring
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:Stephan.Gehring@bechtle.de"
>Stephan.Gehring@bechtle.de</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Jacek Glinkowski
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:jglinkow%hns.com"
>jglinkow%hns.com</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Andrea Glorioso
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:sama%perchetopi.org"
>sama%perchetopi.org</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Thomas Graaf
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:tgraf%suug.ch"
>tgraf%suug.ch</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Sandy Harris
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:sandy%storm.ca"
>sandy%storm.ca</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Nadeem Hasan
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:nhasan@usa.net"
>nhasan@usa.net</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Erik Hensema
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:erik%hensema.xs4all.nl"
>erik%hensema.xs4all.nl</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Vik Heyndrickx
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:vik.heyndrickx@edchq.com"
>vik.heyndrickx@edchq.com</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Spauldo Da Hippie
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:spauldo%usa.net"
>spauldo%usa.net</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Koos van den Hout
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:koos@kzdoos.xs4all.nl"
>koos@kzdoos.xs4all.nl</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>Stefan Huelbrock &lt;shuelbrock%datasystems.de&gt;</P
></LI
><LI
><P
>Alexander W. Janssen &lt;yalla%ynfonatic.de&gt;</P
></LI
><LI
><P
>Andreas Jellinghaus &lt;aj%dungeon.inka.de&gt;</P
></LI
><LI
><P
>Gareth John &lt;gdjohn%zepler.org&gt;</P
></LI
><LI
><P
>   Dave Johnson
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:dj@www.uk.linux.org"
>dj@www.uk.linux.org</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>Martin Josefsson &lt;gandalf%wlug.westbo.se&gt;</P
></LI
><LI
><P
>Andi Kleen &lt;ak%suse.de&gt;</P
></LI
><LI
><P
>Andreas J. Koenig &lt;andreas.koenig%anima.de&gt;</P
></LI
><LI
><P
>Pawel Krawczyk &lt;kravietz%alfa.ceti.pl&gt;</P
></LI
><LI
><P
>Amit Kucheria &lt;amitk@ittc.ku.edu&gt;</P
></LI
><LI
><P
>Edmund Lau &lt;edlau%ucf.ics.uci.edu&gt;</P
></LI
><LI
><P
>Philippe Latu &lt;philippe.latu%linux-france.org&gt;</P
></LI
><LI
><P
>Arthur van Leeuwen &lt;arthurvl%sci.kun.nl&gt;</P
></LI
><LI
><P
>   Jose Luis Domingo Lopez
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:jdomingo@24x7linux.com"
>jdomingo@24x7linux.com</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>   Robert Lowe
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:robert.h.lowe@lawrence.edu"
>robert.h.lowe@lawrence.edu</A
>&#62;</CODE
></P
>
  </P
></LI
><LI
><P
>Jason Lunz &lt;j@cc.gatech.edu&gt;</P
></LI
><LI
><P
>Stuart Lynne &lt;sl@fireplug.net&gt;</P
></LI
><LI
><P
>Alexey Mahotkin &lt;alexm@formulabez.ru&gt;</P
></LI
><LI
><P
>Predrag Malicevic &lt;pmalic@ieee.org&gt;</P
></LI
><LI
><P
>Patrick McHardy &lt;kaber@trash.net&gt;</P
></LI
><LI
><P
>Andreas Mohr &lt;andi%lisas.de&gt;</P
></LI
><LI
><P
>James Morris &lt;jmorris@intercode.com.au&gt;</P
></LI
><LI
><P
>Andrew Morton &lt;akpm%zip.com.au&gt;</P
></LI
><LI
><P
>Wim van der Most </P
></LI
><LI
><P
>Stephan Mueller &lt;smueller@chronox.de&gt;</P
></LI
><LI
><P
>Togan Muftuoglu &lt;toganm%yahoo.com&gt;</P
></LI
><LI
><P
>Chris Murray &lt;cmurray@stargate.ca&gt;</P
></LI
><LI
><P
>Patrick Nagelschmidt &lt;dto%gmx.net&gt;</P
></LI
><LI
><P
>Ram Narula &lt;ram@princess1.net&gt;</P
></LI
><LI
><P
>Jorge Novo &lt;jnovo@educanet.net&gt;</P
></LI
><LI
><P
>Patrik &lt;ph@kurd.nu&gt;</P
></LI
><LI
><P
>P?l Osgy?ny &lt;oplab%westel900.net&gt;</P
></LI
><LI
><P
>Lutz Pre&szlig;ler &lt;Lutz.Pressler%SerNet.DE&gt;</P
></LI
><LI
><P
>Jason Pyeron &lt;jason%pyeron.com&gt;</P
></LI
><LI
><P
>Rod Roark &lt;rod%sunsetsystems.com&gt;</P
></LI
><LI
><P
>Pavel Roskin &lt;proski@gnu.org&gt;</P
></LI
><LI
><P
>Rusty Russell &lt;rusty%rustcorp.com.au&gt;</P
></LI
><LI
><P
>Mihai RUSU &lt;dizzy%roedu.net&gt;</P
></LI
><LI
><P
>Rob Pitman &lt;rob%pitman.co.za&gt;</P
></LI
><LI
><P
>Jamal Hadi Salim &lt;hadi%cyberus.ca&gt;</P
></LI
><LI
><P
>Ren? Serral &lt;rserral%ac.upc.es&gt; </P
></LI
><LI
><P
>David Sauer &lt;davids%penguin.cz&gt;</P
></LI
><LI
><P
>Sheharyar Suleman Shaikh &lt;sss23@drexel.edu&gt;</P
></LI
><LI
><P
>Stewart Shields &lt;MourningBlade%bigfoot.com&gt;</P
></LI
><LI
><P
>Nick Silberstein &lt;nhsilber%yahoo.com&gt;</P
></LI
><LI
><P
>Konrads Smelkov &lt;konrads@interbaltika.com&gt;</P
></LI
><LI
><P
>William Stearns
<P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:wstearns@pobox.com"
>wstearns@pobox.com</A
>&#62;</CODE
></P
></P
></LI
><LI
><P
>Andreas Steinmetz &lt;ast%domdv.de&gt;</P
></LI
><LI
><P
>Matthew Strait &lt;straitm%mathcs.carleton.edu&gt;</P
></LI
><LI
><P
>Jason Tackaberry &lt;tack@linux.com&gt;</P
></LI
><LI
><P
>Charles Tassell &lt;ctassell%isn.net&gt;</P
></LI
><LI
><P
>Glen Turner &lt;glen.turner%aarnet.edu.au&gt;</P
></LI
><LI
><P
>Tea Sponsor: Eric Veldhuyzen &lt;eric%terra.nu&gt; </P
></LI
><LI
><P
>Thomas Walpuski &lt;thomas%bender.thinknerd.de&gt;</P
></LI
><LI
><P
>Song Wang &lt;wsong@ece.uci.edu&gt;</P
></LI
><LI
><P
>   Chris Wilson
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:chris@netservers.co.uk"
>chris@netservers.co.uk</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Lazar Yanackiev
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:Lyanackiev%gmx.net"
>Lyanackiev%gmx.net</A
>&#62;</CODE
></P
>
   </P
></LI
><LI
><P
>   Pedro Larroy
   <P
CLASS="ADDRESS"
><CODE
CLASS="EMAIL"
>&#60;<A
HREF="mailto:piotr%member.fsf.org"
>piotr%member.fsf.org</A
>&#62;</CODE
></P
>
   <P
></P
><UL
><LI
><P
>       Chapter 15, section 10: Example of a full nat solution with QoS
       </P
></LI
><LI
><P
>       Chapter 17, section 1: Setting up OSPF with Zebra
       </P
></LI
></UL
>
   </P
></LI
></UL
>&#13;</P
></DIV
></DIV
><H3
CLASS="FOOTNOTES"
>Notas</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN588"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN588"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>N. del T.: "man in the
	middle", un tipo de ataque</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN687"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN687"
><SPAN
CLASS="footnote"
>[2]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>N. del T: el autor es holand√©s,
y supongo que se reir√° mucho con este chiste</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN1660"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1660"
><SPAN
CLASS="footnote"
>[3]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>N. del T: threeway
handshake, el inicio de una conexi√≥n TCP</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN1995"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN1995"
><SPAN
CLASS="footnote"
>[4]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>N. del T.: espinas dorsales, las v√≠as m√°s
anchas y r√°pidas de Internet</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN2034"
HREF="/web/20040611091246/http://www.gulic.org/comos/LARTC/lartc.html#AEN2034"
><SPAN
CLASS="footnote"
>[5]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>N del T: SLA es Service Level Agreement. Se refiere a
clientes que han firmado por tener diferentes servicios.</P
></TD
></TR
></TABLE
></BODY
></HTML
>




<!--
     FILE ARCHIVED ON 9:12:46 Jun 11, 2004 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 11:43:31 Jan 16, 2014.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
